'use strict';var lng=function(){class t{static mergeNumbers(a,b,c){return a*c+b*(1-c)}static rgb(a,b,c){return(a<<16)+(b<<8)+c+4278190080}static rgba(a,b,c,d){return(a<<16)+(b<<8)+c+16777216*(255*d|0)}static getRgbString(a){return"rgb("+(a/65536|0)%256+","+(a/256|0)%256+","+a%256+")"}static getRgbaString(a){return"rgba("+(a/65536|0)%256+","+(a/256|0)%256+","+a%256+","+((a/16777216|0)/255).toFixed(4)+")"}static getRgbaStringFromArray(a){return"rgba("+Math.floor(255*a[0])+","+Math.floor(255*a[1])+","+
Math.floor(255*a[2])+","+(Math.floor(255*a[3])/255).toFixed(4)+")"}static getRgbaComponentsNormalized(a){return[(a/65536|0)%256/255,(a/256|0)%256/255,a%256/255,(a/16777216|0)/255]}static getRgbComponentsNormalized(a){return[(a/65536|0)%256/255,(a/256|0)%256/255,a%256/255]}static getRgbaComponents(a){return[(a/65536|0)%256,(a/256|0)%256,a%256,a/16777216|0]}static getArgbNumber(a){a[0]=Math.max(0,Math.min(255,a[0]));a[1]=Math.max(0,Math.min(255,a[1]));a[2]=Math.max(0,Math.min(255,a[2]));a[3]=Math.max(0,
Math.min(255,a[3]));a=((a[3]|0)<<24)+((a[0]|0)<<16)+((a[1]|0)<<8)+(a[2]|0);0>a&&(a=4294967295+a+1);return a}static mergeColors(a,b,c){return 16777216*Math.round((a/16777216|0)*c+(b/16777216|0)*(1-c)|0)+65536*Math.round((a/65536|0)%256*c+(b/65536|0)%256*(1-c)|0)+256*Math.round((a/256|0)%256*c+(b/256|0)%256*(1-c)|0)+Math.round(a%256*c+b%256*(1-c)|0)}static mergeMultiColors(a,b){let c=0,d=0,e=0,f=0,g=0,h=a.length;for(let k=0;k<h;k++){let h=(a[k]/256|0)%256,r=a[k]%256,l=a[k]/16777216|0;c+=(a[k]/65536|
0)%256*b[k];d+=h*b[k];e+=r*b[k];f+=l*b[k];g+=b[k]}g=1/g;return 16777216*Math.round(f*g)+65536*Math.round(c*g)+256*Math.round(d*g)+Math.round(e*g)}static mergeMultiColorsEqual(a){let b=0,c=0,d=0,e=0,f=0,g=a.length;for(let h=0;h<g;h++){let g=(a[h]/256|0)%256,m=a[h]%256,r=a[h]/16777216|0;b+=(a[h]/65536|0)%256;c+=g;d+=m;e+=r;f+=1}f=1/f;return 16777216*Math.round(e*f)+65536*Math.round(b*f)+256*Math.round(c*f)+Math.round(d*f)}static mergeColorAlpha(a,b){b=(a/16777216|0)*b|0;return((a>>16&255)*b/255&255)+
((a&65280)*b/255&65280)+(((a&255)<<16)*b/255&16711680)+(b<<24)}static rad(a){return Math.PI/180*a}static getTimingBezier(a,b,c,d){let e=3*a,f=3*(c-a)-e,g=1-e-f,h=3*b,k=3*(d-b)-h,m=1-h-k;return function(a){if(1<=a)return 1;if(0>=a)return 0;let b=.5;for(var c=0;20>c;c++){var d=b*(b*(b*g+f)+e);d=a-d;if(-1E-8<d&&1E-8>d)return b*(b*(b*m+k)+h);var r=b*(3*b*g+2*f)+e;if(1E-10<r&&1E-10>r)break;b+=d/r}c=0;r=1;for(let l=0;20>l;l++){b=.5*(c+r);d=b*(b*(b*g+f)+e);d=a-d;if(-1E-8<d&&1E-8>d)return b*(b*(b*m+k)+h);
0>d?r=b:c=b}}}static getTimingFunction(a){switch(a){case "linear":return function(a){return a};case "ease":return t.getTimingBezier(.25,.1,.25,1);case "ease-in":return t.getTimingBezier(.42,0,1,1);case "ease-out":return t.getTimingBezier(0,0,.58,1);case "ease-in-out":return t.getTimingBezier(.42,0,.58,1);case "step-start":return function(){return 1};case "step-end":return function(a){return 1===a?1:0};default:if(a&&0===a.indexOf("cubic-bezier(")){var b=a.substr(13,a.length-13-1).split(",");if(4!==
b.length)return console.warn("Unknown timing function: "+a),function(a){return a};let c=parseFloat(b[0]),d=parseFloat(b[1]),e=parseFloat(b[2]);b=parseFloat(b[3]);return isNaN(c)||isNaN(d)||isNaN(e)||isNaN(b)?(console.warn("Unknown timing function: "+a),function(a){return a}):t.getTimingBezier(c,d,e,b)}console.warn("Unknown timing function: "+a);return function(a){return a}}}}class l{static isFunction(a){return"function"===typeof a}static isNumber(a){return"number"===typeof a}static isInteger(a){return"number"===
typeof a&&0===a%1}static isBoolean(a){return!0===a||!1===a}static isString(a){return"string"==typeof a}static clone(a){return l.isObjectLiteral(a)||Array.isArray(a)?l.getDeepClone(a):a}static cloneObjShallow(a){let b=Object.keys(a),c={};for(let d=0;d<b.length;d++)c[b[d]]=a[b[d]];return c}static merge(a,b){let c=Object.keys(b);for(let d=0;d<c.length;d++)a[c[d]]=b[c[d]];return a}static isObject(a){let b=typeof a;return!!a&&("object"==b||"function"==b)}static isPlainObject(a){return!!a&&"object"==typeof a}static isObjectLiteral(a){return"object"===
typeof a&&a&&a.constructor===Object}static getArrayIndex(a,b){return l.getModuloIndex(a,b.length)}static getModuloIndex(a,b){if(0==b)return a;for(;0>a;)a+=Math.ceil(-a/b)*b;return a%b}static getDeepClone(a){let b,c;if(l.isFunction(a))return a;if(Array.isArray(a)){c=[];var d=Object.keys(a);for(b=0;b<d.length;b++)c[d[b]]=l.getDeepClone(a[d[b]]);return c}if(l.isObject(a)){c={};d=Object.keys(a);for(b=0;b<d.length;b++)c[d[b]]=l.getDeepClone(a[d[b]]);return c}return a}static equalValues(a,b){return typeof a!==
typeof b?!1:l.isObjectLiteral(a)?l.isObjectLiteral(b)&&l.equalObjectLiterals(a,b):Array.isArray(a)?Array.isArray(b)&&l.equalArrays(a,b):a===b}static equalObjectLiterals(a,b){let c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(let e=0,f=c.length;e<f;e++){const f=c[e],h=d[e];if(f!==h||!l.equalValues(a[f],b[h]))return!1}return!0}static equalArrays(a,b){if(a.length!==b.length)return!1;for(let c=0,d=a.length;c<d;c++)if(!this.equalValues(a[c],b[c]))return!1;return!0}static setToArray(a){let b=
[];a.forEach(function(a){b.push(a)});return b}static iteratorToArray(a){let b=[],c=a.next();for(;!c.done;)b.push(c.value),c=a.next();return b}static isUcChar(a){return 65<=a&&90>=a}}l.isNode="undefined"===typeof window;l.isWeb="undefined"!==typeof window;class K{constructor(a,b=void 0){this.id=K.id++;this.manager=a;this.stage=a.stage;this.textures=new Set;this._activeTextureCount=0;this.loader=b;this._cancelCb=this.lookupId=null;this.h=this.w=this.loadingSince=0;this._nativeTexture=null;this.permanent=
!1;this.renderInfo=null;this._isResultTexture=!this.loader;this._loadError=void 0}get loadError(){return this._loadError}addTexture(a){this.textures.has(a)||this.textures.add(a)}removeTexture(a){this.textures.delete(a)}incActiveTextureCount(){this._activeTextureCount++;1===this._activeTextureCount&&this.becomesUsed()}decActiveTextureCount(){this._activeTextureCount--;0===this._activeTextureCount&&this.becomesUnused()}get isResultTexture(){return this._isResultTexture}set isResultTexture(a){this._isResultTexture=
a}forEachEnabledView(a){this.textures.forEach((b)=>{b.views.forEach(a)})}hasEnabledViews(){return 0<this.textures.size}forEachActiveView(a){this.textures.forEach((b)=>{b.views.forEach((b)=>{b.active&&a(b)})})}getRenderWidth(){return this.w}getRenderHeight(){return this.h}allowCleanup(){return!this.permanent&&!this.isUsed()}becomesUsed(){this.load()}becomesUnused(){this.cancel()}cancel(){this.isLoading()&&this._cancelCb&&(this._cancelCb(this),this.loadingSince=0);this._checkRemoveFromLookupMap()}_checkRemoveFromLookupMap(){this.permanent||
0!==this.textures.size||this.manager.removeFromLookupMap(this)}isLoaded(){return!!this._nativeTexture}isLoading(){return 0<this.loadingSince}isError(){return!!this._loadError}reload(){this.free();this.isUsed()&&this.load()}load(){this.isResultTexture||this._nativeTexture||this.isLoading()||(this.loadingSince=(new Date).getTime(),this._cancelCb=this.loader((a,b)=>{this._cancelCb=void 0;this.manager.stage.destroyed||(a?(this._checkRemoveFromLookupMap(),this.onError(a)):b&&b.source&&(this.loadingSince=
0,this.setSource(b)))},this))}setSource(a){const b=a.source;this.w=b.width||a&&a.w||0;this.h=b.height||a&&a.h||0;a&&a.renderInfo&&(this.renderInfo=a.renderInfo);this.permanent=!!a.permanent;this._isNativeTexture(b)?(this._nativeTexture=b,this.w=b.w,this.h=b.h,this.permanent=a.hasOwnProperty("permanent")?a.permanent:!0):this.manager.uploadTextureSource(this,a);this._loadError=void 0;this.onLoad()}isUsed(){return 0<this._activeTextureCount}onLoad(){this.isUsed()&&this.forEachActiveView(function(a){a.onTextureSourceLoaded()})}forceRenderUpdate(){this._nativeTexture&&
(this._nativeTexture.update=this.stage.frameCounter);this.forEachActiveView(function(a){a.forceRenderUpdate()})}forceUpdateRenderCoords(){this.forEachActiveView(function(a){a._updateTextureCoords()})}get nativeTexture(){return this._nativeTexture}clearNativeTexture(){this._nativeTexture=null}replaceNativeTexture(a,b,c){let d=this._nativeTexture;this._nativeTexture=a;this.w=b;this.h=c;!d&&this._nativeTexture&&this.forEachActiveView((a)=>a.onTextureSourceLoaded());this._nativeTexture||this.forEachActiveView((a)=>
a._setDisplayedTexture(null));this.forEachEnabledView((a)=>a._updateDimensions())}onError(a){this._loadError=a;console.error("texture load error",a,this.lookupId);this.forEachActiveView((b)=>b.onTextureSourceLoadError(a))}free(){this.manager.freeTextureSource(this)}_isNativeTexture(a){return l.isNode?"WebGLTexture"===a.constructor.name:a instanceof WebGLTexture}}K.prototype.isTextureSource=!0;K.id=1;class ia{constructor(a){this._view=a.view;this._core=a;this.ctx=this._core.ctx;this._colorize=this.lazy=
this._enabled=!1;this._renderTexture=null;this._renderTextureReused=!1;this._resultTextureSource=null;this.empty=this._renderOffscreen=!1}get enabled(){return this._enabled}set enabled(a){this._enabled=a;this._core.updateRenderToTextureEnabled()}get renderOffscreen(){return this._renderOffscreen}set renderOffscreen(a){this._renderOffscreen=a;this._core.setHasRenderUpdates(1);this._core._setRecalc(6)}get colorize(){return this._colorize}set colorize(a){this._colorize!==a&&(this._colorize=a,this._core.setHasRenderUpdates(1))}_getTextureSource(){this._resultTextureSource||
(this._resultTextureSource=new K(this._view.stage.textureManager),this.updateResultTexture());return this._resultTextureSource}hasResultTexture(){return!!this._resultTextureSource}resultTextureInUse(){return this._resultTextureSource&&this._resultTextureSource.hasEnabledViews()}updateResultTexture(){let a=this.getResultTexture();this._resultTextureSource&&(this._resultTextureSource.nativeTexture!==a&&this._resultTextureSource.replaceNativeTexture(a,a?a.w:0,a?a.h:0),this._resultTextureSource.forEachEnabledView((a)=>
{a._updateDimensions();a.core.setHasRenderUpdates(3)}))}mustRenderToTexture(){return this._enabled&&!this.lazy||this._enabled&&this.lazy&&3>this._core._hasRenderUpdates?!0:!1}deactivate(){this.release()}get renderTextureReused(){return this._renderTextureReused}release(){this.releaseRenderTexture()}releaseRenderTexture(){this._renderTexture&&(this._renderTextureReused||this.ctx.releaseRenderTexture(this._renderTexture),this._renderTexture=null,this._renderTextureReused=!1,this.updateResultTexture())}reuseTextureAsRenderTexture(a){this._renderTexture!==
a&&(this.releaseRenderTexture(),this._renderTexture=a,this._renderTextureReused=!0)}hasRenderTexture(){return!!this._renderTexture}getRenderTexture(){this._renderTexture||(this._renderTexture=this.ctx.allocateRenderTexture(this._core._rw,this._core._rh),this._renderTextureReused=!1);return this._renderTexture}getResultTexture(){return this._renderTexture}}class L{constructor(a){this._view=a;this.ctx=a.stage.ctx;this._recalc=0;this._parent=null;this._onUpdate=void 0;this._pRecalc=0;this._worldContext=
new H;this._hasUpdates=!1;this._localAlpha=1;this._onAfterUpdate=this._onAfterCalcs=void 0;this._localPy=this._localPx=0;this._localTa=1;this._localTc=this._localTb=0;this._localTd=1;this._isComplex=!1;this._rh=this._rw=0;this._zSort=this._clipping=this._rwhEstimate=!1;this._outOfBounds=0;this._displayedTextureSource=null;this._zContextUsage=0;this._children=null;this._hasRenderUpdates=0;this._zIndexedChildren=null;this._renderContext=this._worldContext;this.renderState=this.ctx.renderState;this._scissor=
void 0;this._shaderOwner=null;this._updateTreeOrder=0;this._colorUl=this._colorUr=this._colorBl=this._colorBr=4294967295;this._h=this._w=this._y=this._x=0;this._scaleY=this._scaleX=1;this._pivotY=this._pivotX=.5;this._rotation=this._mountY=this._mountX=0;this._alpha=1;this._visible=!0;this._uly=this._ulx=0;this._bry=this._brx=1;this._zIndex=0;this._forceZIndexContext=!1;this._zParent=null;this._zIndexResort=this._isRoot=!1;this._shader=null;this._renderToTextureEnabled=!1;this._texturizer=null;this._useRenderToTexture=
!1;this._recBoundsMargin=this._boundsMargin=void 0;this._withinBoundsMargin=!1;this._viewport=void 0;this._clipbox=!1;this.render=this._renderSimple}get x(){return this._x}set x(a){this._x!==a&&(this._updateLocalTranslateDelta(a-this._x,0),this._x=a)}get y(){return this._y}set y(a){this._y!==a&&(this._updateLocalTranslateDelta(0,a-this._y),this._y=a)}get w(){return this._w}set w(a){this._w!==a&&(this._w=Math.max(0,a),this._view._updateDimensions())}get h(){return this._h}set h(a){this._h!==a&&(this._h=
Math.max(0,a),this._view._updateDimensions())}get scaleX(){return this._scaleX}set scaleX(a){this._scaleX!==a&&(this._scaleX=a,this._updateLocalTransform())}get scaleY(){return this._scaleY}set scaleY(a){this._scaleY!==a&&(this._scaleY=a,this._updateLocalTransform())}get scale(){return this.scaleX}set scale(a){if(this._scaleX!==a||this._scaleY!==a)this._scaleY=this._scaleX=a,this._updateLocalTransform()}get pivotX(){return this._pivotX}set pivotX(a){this._pivotX!==a&&(this._pivotX=a,this._updateLocalTranslate())}get pivotY(){return this._pivotY}set pivotY(a){this._pivotY!==
a&&(this._pivotY=a,this._updateLocalTranslate())}get pivot(){return this._pivotX}set pivot(a){if(this._pivotX!==a||this._pivotY!==a)this._pivotY=this._pivotX=a,this._updateLocalTranslate()}get mountX(){return this._mountX}set mountX(a){this._mountX!==a&&(this._mountX=a,this._updateLocalTranslate())}get mountY(){return this._mountY}set mountY(a){this._mountY!==a&&(this._mountY=a,this._updateLocalTranslate())}get mount(){return this._mountX}set mount(a){if(this._mountX!==a||this._mountY!==a)this._mountY=
this._mountX=a,this._updateLocalTranslate()}get rotation(){return this._rotation}set rotation(a){this._rotation!==a&&(this._rotation=a,this._updateLocalTransform())}get alpha(){return this._alpha}set alpha(a){a=1<a?1:1E-14>a?0:a;if(this._alpha!==a){let b=this._alpha;this._alpha=a;this._updateLocalAlpha();0===b!==(0===a)&&this._view._updateEnabledFlag()}}get visible(){return this._visible}set visible(a){this._visible!==a&&(this._visible=a,this._updateLocalAlpha(),this._view._updateEnabledFlag())}_updateLocalTransform(){if(0!==
this._rotation&&this._rotation%(2*Math.PI)){let a=Math.sin(this._rotation),b=Math.cos(this._rotation);this._setLocalTransform(b*this._scaleX,-a*this._scaleY,a*this._scaleX,b*this._scaleY)}else this._setLocalTransform(this._scaleX,0,0,this._scaleY);this._updateLocalTranslate()}_updateLocalTranslate(){var a=this._pivotX*this.rw;let b=this._pivotY*this.rh,c=this._x-(a*this.localTa+b*this.localTb)+a;a=this._y-(a*this.localTc+b*this.localTd)+b;c-=this._mountX*this.rw;a-=this._mountY*this.rh;this._setLocalTranslate(c,
a)}_updateLocalTranslateDelta(a,b){this._addLocalTranslate(a,b)}_updateLocalAlpha(){this._setLocalAlpha(this._visible?this._alpha:0)}setHasRenderUpdates(a){if(this._worldContext.alpha){let b=this;for(b._hasRenderUpdates=Math.max(a,b._hasRenderUpdates);(b=b._parent)&&3!=b._hasRenderUpdates;)b._hasRenderUpdates=3}}_setRecalc(a){this._recalc|=a;this._setHasUpdates();this._parent&&this._parent.setHasRenderUpdates(3)}_setHasUpdates(){let a=this;for(;a&&!a._hasUpdates;)a._hasUpdates=!0,a=a._parent}setParent(a){if(a!==
this._parent){let b=this.isZContext(),c=this._parent;this._parent=a;c&&c.setHasRenderUpdates(3);this._setRecalc(7);this._parent&&this._parent._setHasUpdates();0===this._zIndex?this.setZParent(a):this.setZParent(a?a.findZContext():null);b!==this.isZContext()&&(this.isZContext()?this.enableZContext(c.findZContext()):this.disableZContext());this._zIndexResort=!0;this._zParent&&this._zParent.enableZSort();this._shader||(a=a&&!a._renderToTextureEnabled?a._shaderOwner:null,a!==this._shaderOwner&&(this.setHasRenderUpdates(1),
this._setShaderOwnerRecursive(a)))}}enableZSort(a=!1){!this._zSort&&0<this._zContextUsage&&(this._zSort=!0,a&&this.ctx.forceZSort(this))}addChildAt(a,b){this._children||(this._children=[]);this._children.splice(a,0,b);b.setParent(this)}setChildAt(a,b){this._children||(this._children=[]);this._children[a].setParent(null);this._children[a]=b;b.setParent(this)}removeChildAt(a){let b=this._children[a];this._children.splice(a,1);b.setParent(null)}removeChildren(){if(this._children){for(let a=0,b=this._children.length;a<
b;a++)this._children[a].setParent(null);this._children.splice(0);this._zIndexedChildren&&this._zIndexedChildren.splice(0)}}syncChildren(a,b,c){this._children=c;for(let b=0,c=a.length;b<c;b++)a[b].setParent(null);for(let a=0,c=b.length;a<c;a++)b[a].setParent(this)}moveChild(a,b){let c=this._children[a];this._children.splice(a,1);this._children.splice(b,0,c);this._zIndexResort=!0;this._zParent&&this._zParent.enableZSort()}_setLocalTransform(a,b,c,d){this._setRecalc(4);this._localTa=a;this._localTb=
b;this._localTc=c;this._localTd=d;this._isComplex=0!=b||0!=c||0>a||0>d}_setLocalTranslate(a,b){this._setRecalc(2);this._localPx=a;this._localPy=b}_addLocalTranslate(a,b){this._setLocalTranslate(this._localPx+a,this._localPy+b)}_setLocalAlpha(a){!this._worldContext.alpha&&this._parent&&this._parent._worldContext.alpha&&a?this._setRecalc(129):this._setRecalc(1);1E-14>a&&(a=0);this._localAlpha=a}setDimensions(a,b,c){return this._rw!==a||this._rh!==b?(this._rw=a,this._rh=b,this._rwhEstimate=c,this._setRecalc(2),
this._texturizer&&(this._texturizer.releaseRenderTexture(),this._texturizer.updateResultTexture()),this._updateLocalTranslate(),!0):!1}setTextureCoords(a,b,c,d){this.setHasRenderUpdates(3);this._ulx=a;this._uly=b;this._brx=c;this._bry=d}get displayedTextureSource(){return this._displayedTextureSource}setDisplayedTextureSource(a){this.setHasRenderUpdates(3);this._displayedTextureSource=a}get isRoot(){return this._isRoot}setAsRoot(){this._parent=new L(this._view);this._parent._hasRenderUpdates=3;this._isRoot=
this._parent._hasUpdates=!0;this.ctx.root=this;this._parent._viewport=[0,0,this.ctx.stage.rw,this.ctx.stage.rh];this._parent._scissor=this._parent._viewport;this._parent._recBoundsMargin=[100,100,100,100];this._parent._boundsMargin=null;this._setRecalc(7)}isAncestorOf(a){for(;a=a._parent;)if(this===a)return!0;return!1}isZContext(){return this._forceZIndexContext||this._renderToTextureEnabled||0!==this._zIndex||this._isRoot||!this._parent}findZContext(){return this.isZContext()?this:this._parent.findZContext()}setZParent(a){if(this._zParent!==
a){null!==this._zParent&&(0!==this._zIndex&&this._zParent.decZContextUsage(),this._zParent.enableZSort());if(null!==a){let b=0<a._zContextUsage;0!==this._zIndex&&a.incZContextUsage();0<a._zContextUsage&&((b||this._parent!==a)&&a._zIndexedChildren.push(this),a.enableZSort())}this._zParent=a;this._zIndexResort=!0}}incZContextUsage(){this._zContextUsage++;if(1===this._zContextUsage&&(this._zIndexedChildren||(this._zIndexedChildren=[]),this._children)){for(let a=0,b=this._children.length;a<b;a++)this._zIndexedChildren.push(this._children[a]);
this._zSort=!1}}decZContextUsage(){this._zContextUsage--;0===this._zContextUsage&&(this._zSort=!1,this._zIndexedChildren.splice(0))}get zIndex(){return this._zIndex}set zIndex(a){if(this._zIndex!==a){this.setHasRenderUpdates(1);let b=this._zParent,c=this.isZContext();0===a&&0!==this._zIndex?this._parent===this._zParent?this._zParent&&this._zParent.decZContextUsage():b=this._parent:0!==a&&0===this._zIndex?(b=this._parent?this._parent.findZContext():null,b===this._zParent&&this._zParent&&(this._zParent.incZContextUsage(),
this._zParent.enableZSort())):a!==this._zIndex&&this._zParent&&this._zParent._zContextUsage&&this._zParent.enableZSort();b!==this._zParent&&this.setZParent(null);this._zIndex=a;b!==this._zParent&&this.setZParent(b);c!==this.isZContext()&&(this.isZContext()?this.enableZContext(this._parent.findZContext()):this.disableZContext());this._zIndexResort=!0;this._zParent&&this._zParent.enableZSort()}}get forceZIndexContext(){return this._forceZIndexContext}set forceZIndexContext(a){this.setHasRenderUpdates(1);
let b=this.isZContext();this._forceZIndexContext=a;b!==this.isZContext()&&(this.isZContext()?this.enableZContext(this._parent.findZContext()):this.disableZContext())}enableZContext(a){a&&0<a._zContextUsage&&this._getZIndexedDescs().forEach((a)=>{this.isAncestorOf(a)&&0!==a._zIndex&&a.setZParent(this)})}_getZIndexedDescs(){const a=[];if(this._children)for(let b=0,c=this._children.length;b<c;b++)this._children[b]._getZIndexedDescsRec(a);return a}_getZIndexedDescsRec(a){if(this._zIndex)a.push(this);
else if(this._children&&!this.isZContext())for(let b=0,c=this._children.length;b<c;b++)this._children[b]._getZIndexedDescsRec(a)}disableZContext(){if(0<this._zContextUsage){let a=this._parent.findZContext();this._zSort&&this.sortZIndexedChildren();this._zIndexedChildren.slice().forEach(function(b){0!==b._zIndex&&b.setZParent(a)})}}get colorUl(){return this._colorUl}set colorUl(a){this._colorUl!==a&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorUl=a)}get colorUr(){return this._colorUr}set colorUr(a){this._colorUr!==
a&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorUr=a)}get colorBl(){return this._colorBl}set colorBl(a){this._colorBl!==a&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorBl=a)}get colorBr(){return this._colorBr}set colorBr(a){this._colorBr!==a&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorBr=a)}set onUpdate(a){this._onUpdate=a}set onAfterUpdate(a){this._onAfterUpdate=a}set onAfterCalcs(a){this._onAfterCalcs=a}get shader(){return this._shader}set shader(a){this.setHasRenderUpdates(1);
let b=this._shader;this._shader=a;!a&&b?this._setShaderOwnerRecursive(this._parent&&!this._parent._renderToTextureEnabled?this._parent._shaderOwner:null):a&&this._setShaderOwnerRecursive(this)}get activeShader(){return this._shaderOwner?this._shaderOwner.shader:this.renderState.defaultShader}get activeShaderOwner(){return this._shaderOwner}get clipping(){return this._clipping}set clipping(a){this._clipping!==a&&(this._clipping=a,this._setRecalc(3))}get clipbox(){return this._clipbox}set clipbox(a){this._clipbox=
a}_setShaderOwnerRecursive(a){this._shaderOwner=a;if(this._children&&!this._renderToTextureEnabled)for(let b=0,c=this._children.length;b<c;b++){let c=this._children[b];c._shader||(c._setShaderOwnerRecursive(a),c._hasRenderUpdates=3)}}_setShaderOwnerChildrenRecursive(a){if(this._children)for(let b=0,c=this._children.length;b<c;b++){let c=this._children[b];c._shader||(c._setShaderOwnerRecursive(a),c._hasRenderUpdates=3)}}_hasRenderContext(){return this._renderContext!==this._worldContext}get renderContext(){return this._renderContext}updateRenderToTextureEnabled(){this.texturizer._enabled?
this._enableRenderToTexture():(this._disableRenderToTexture(),this._texturizer.releaseRenderTexture())}_enableRenderToTexture(){if(!this._renderToTextureEnabled){let a=this.isZContext();this._renderToTextureEnabled=!0;this._renderContext=new H;this._setShaderOwnerChildrenRecursive(null);a||this.enableZContext(this._parent?this._parent.findZContext():null);this.setHasRenderUpdates(3);this._setRecalc(7);this.render=this._renderAdvanced}}_disableRenderToTexture(){this._renderToTextureEnabled&&(this._renderToTextureEnabled=
!1,this._setShaderOwnerChildrenRecursive(this._shaderOwner),this._renderContext=this._worldContext,this.isZContext()||this.disableZContext(),this._setRecalc(7),this.setHasRenderUpdates(3),this.render=this._renderSimple)}isWhite(){return 4294967295===this._colorUl&&4294967295===this._colorUr&&4294967295===this._colorBl&&4294967295===this._colorBr}hasSimpleTexCoords(){return 0===this._ulx&&0===this._uly&&1===this._brx&&1===this._bry}_stashTexCoords(){this._stashedTexCoords=[this._ulx,this._uly,this._brx,
this._bry];this._uly=this._ulx=0;this._bry=this._brx=1}_unstashTexCoords(){this._ulx=this._stashedTexCoords[0];this._uly=this._stashedTexCoords[1];this._brx=this._stashedTexCoords[2];this._bry=this._stashedTexCoords[3];this._stashedTexCoords=null}_stashColors(){this._stashedColors=[this._colorUl,this._colorUr,this._colorBr,this._colorBl];this._colorBl=this._colorBr=this._colorUr=this._colorUl=4294967295}_unstashColors(){this._colorUl=this._stashedColors[0];this._colorUr=this._stashedColors[1];this._colorBr=
this._stashedColors[2];this._colorBl=this._stashedColors[3];this._stashedColors=null}isVisible(){return 1E-14<this._localAlpha}get outOfBounds(){return this._outOfBounds}set boundsMargin(a){this._boundsMargin=a?a.slice():void 0;this._setRecalc(2)}get boundsMargin(){return this._boundsMargin}update(){this._recalc|=this._parent._pRecalc;this._onUpdate&&(this._hasUpdates=!0,this._onUpdate(this.view,this));var a=this._parent._worldContext,b=this._worldContext,c=a.alpha&&this._localAlpha;if(this._hasUpdates||
this._recalc&&c||b.alpha&&!c){var d=this._recalc;d&1&&(!b.alpha&&c&&(this._hasRenderUpdates=3),b.alpha=a.alpha*this._localAlpha,1E-14>b.alpha&&(b.alpha=0));d&6&&(b.px=a.px+this._localPx*a.ta,b.py=a.py+this._localPy*a.td,0!==a.tb&&(b.px+=this._localPy*a.tb),0!==a.tc&&(b.py+=this._localPx*a.tc));d&4&&(b.ta=this._localTa*a.ta,b.tb=this._localTd*a.tb,b.tc=this._localTa*a.tc,b.td=this._localTd*a.td,this._isComplex&&(b.ta+=this._localTc*a.tb,b.tb+=this._localTb*a.ta,b.tc+=this._localTc*a.td,b.td+=this._localTb*
a.tc));a=this._parent._renderContext;if(this._parent._hasRenderContext()){if(b=this._renderContext===this._worldContext)this._renderContext=new H;c=this._renderContext;if(b||d&1)c.alpha=a.alpha*this._localAlpha,1E-14>c.alpha&&(c.alpha=0);if(b||d&6)c.px=a.px+this._localPx*a.ta,c.py=a.py+this._localPy*a.td,0!==a.tb&&(c.px+=this._localPy*a.tb),0!==a.tc&&(c.py+=this._localPx*a.tc);b&&(d|=2);if(b||d&4)c.ta=this._localTa*a.ta,c.tb=this._localTd*a.tb,c.tc=this._localTa*a.tc,c.td=this._localTd*a.td,this._isComplex&&
(c.ta+=this._localTc*a.tb,c.tb+=this._localTb*a.ta,c.tc+=this._localTc*a.td,c.td+=this._localTb*a.tc)}else this._renderContext=this._worldContext;-1===this.ctx.updateTreeOrder?this.ctx.updateTreeOrder=this._updateTreeOrder+1:this._updateTreeOrder=this.ctx.updateTreeOrder++;b=this._renderToTextureEnabled&&this._texturizer.mustRenderToTexture();this._useRenderToTexture!==b&&(this._recalc|=6,d|=2,this._useRenderToTexture||this._texturizer.release());this._useRenderToTexture=b;b=this._renderContext;let h,
k,m;var e=0!=b.tb||0!=b.tc||0>b.ta||0>b.td;e?(c=Math.min(0,this._rw*b.ta,this._rw*b.ta+this._rh*b.tb,this._rh*b.tb)+b.px,k=Math.max(0,this._rw*b.ta,this._rw*b.ta+this._rh*b.tb,this._rh*b.tb)+b.px,h=Math.min(0,this._rw*b.tc,this._rw*b.tc+this._rh*b.td,this._rh*b.td)+b.py,m=Math.max(0,this._rw*b.tc,this._rw*b.tc+this._rh*b.td,this._rh*b.td)+b.py):(c=b.px,k=b.px+b.ta*this._rw,h=b.py,m=b.py+b.td*this._rh);if(this._rwhEstimate&&(e||1>this._localTa||1>this._localTb)){var f=this._x*a.ta+this._y*a.tb+a.px,
g=this._x*a.tc+this._y*a.td+a.py;f<c&&(c=f);g<h&&(h=g);f>k&&(k=f);g>m&&(m=g)}if(d&6||!this._scissor)if(this._clipping&&b.isSquare())if(f=this._parent._useRenderToTexture?this._parent._viewport:this._parent._scissor){g=Math.max(f[0],c);const a=Math.max(f[1],h);this._scissor=[g,a,Math.min(f[2]+f[0],k)-g,Math.min(f[3]+f[1],m)-a]}else this._scissor=[c,h,k-c,m-h];else this._scissor=this._parent._useRenderToTexture?this._parent._viewport:this._parent._scissor;this._recBoundsMargin=void 0!==this._boundsMargin?
this._boundsMargin:this._parent._recBoundsMargin;this._onAfterCalcs&&this._onAfterCalcs(this.view)&&(e?(c=Math.min(0,this._rw*b.ta,this._rw*b.ta+this._rh*b.tb,this._rh*b.tb)+b.px,k=Math.max(0,this._rw*b.ta,this._rw*b.ta+this._rh*b.tb,this._rh*b.tb)+b.px,h=Math.min(0,this._rw*b.tc,this._rw*b.tc+this._rh*b.td,this._rh*b.td)+b.py,m=Math.max(0,this._rw*b.tc,this._rw*b.tc+this._rh*b.td,this._rh*b.td)+b.py):(c=b.px,k=b.px+b.ta*this._rw,h=b.py,m=b.py+b.td*this._rh),this._rwhEstimate&&(e||1>this._localTa||
1>this._localTb)&&(e=this._x*a.ta+this._y*a.tb+a.px,a=this._x*a.tc+this._y*a.td+a.py,e<c&&(c=e),a<h&&(h=a),e>k&&(k=e),a>m&&(m=a)));if(2===this._parent._outOfBounds)this._outOfBounds=2,this._withinBoundsMargin&&(this._withinBoundsMargin=!1,this.view._disableWithinBoundsMargin());else if(d&6){this._outOfBounds=0;d=!0;if(!this._renderToTextureEnabled||!this._texturizer||!this._texturizer.renderOffscreen){if(this._scissor&&(0>=this._scissor[2]||0>=this._scissor[3]))this._outOfBounds=2;else{if(this._scissor[0]>
k||this._scissor[1]>m||c>this._scissor[0]+this._scissor[2]||h>this._scissor[1]+this._scissor[3])this._outOfBounds=1;this._outOfBounds&&(this._clipping||this._useRenderToTexture||this._clipbox)&&(this._outOfBounds=2)}d=0===this._outOfBounds;!d&&this._recBoundsMargin&&(d=!(k<this._scissor[0]-this._recBoundsMargin[2]||m<this._scissor[1]-this._recBoundsMargin[3]||c>this._scissor[0]+this._scissor[2]+this._recBoundsMargin[0]||h>this._scissor[1]+this._scissor[3]+this._recBoundsMargin[1]))&&2===this._outOfBounds&&
(this._outOfBounds=1)}if(this._withinBoundsMargin!==d)if(this._withinBoundsMargin=d){this._hasUpdates=!0;d=this._recalc;this._recalc=0;this.view._enableWithinBoundsMargin();if(this._recalc)return this.update();this._recalc=d}else this.view._disableWithinBoundsMargin()}this._useRenderToTexture&&(this._viewport?(this._viewport[2]=this._rw,this._viewport[3]=this._rh):this._viewport=[0,0,this._rw,this._rh]);this._pRecalc=this._recalc&135;this._recalc=0;this._hasUpdates=!1;if(2>this._outOfBounds){this._useRenderToTexture&&
(this._worldContext.isIdentity()?this._renderContext=this._worldContext:this._renderContext=H.IDENTITY);if(this._children)for(let a=0,b=this._children.length;a<b;a++)this._children[a].update();this._useRenderToTexture&&(this._renderContext=b)}else if(this._children)for(let a=0,b=this._children.length;a<b;a++)this._children[a]._hasUpdates?this._children[a].update():(this._children[a]._recalc|=this._pRecalc,this._children[a].updateOutOfBounds());this._onAfterUpdate&&this._onAfterUpdate(this.view)}else-1===
this.ctx.updateTreeOrder||this._updateTreeOrder>=this.ctx.updateTreeOrder?this.ctx.updateTreeOrder=-1:this.updateTreeOrder()}updateOutOfBounds(){if(2!==this._outOfBounds&&0<this._renderContext.alpha&&(this._outOfBounds=2,this._withinBoundsMargin&&(this._withinBoundsMargin=!1,this.view._disableWithinBoundsMargin()),this._children))for(let a=0,b=this._children.length;a<b;a++)this._children[a].updateOutOfBounds()}updateTreeOrder(){if(this._localAlpha&&2!==this._outOfBounds&&(this._updateTreeOrder=this.ctx.updateTreeOrder++,
this._children))for(let a=0,b=this._children.length;a<b;a++)this._children[a].updateTreeOrder()}_renderSimple(){this._zSort&&this.sortZIndexedChildren();if(2>this._outOfBounds&&this._renderContext.alpha){let a=this.renderState;0===this._outOfBounds&&this._displayedTextureSource&&(a.setShader(this.activeShader,this._shaderOwner),a.setScissor(this._scissor),this.renderState.addQuad(this));if(this._children)if(this._zContextUsage)for(let a=0,c=this._zIndexedChildren.length;a<c;a++)this._zIndexedChildren[a].render();
else for(let a=0,c=this._children.length;a<c;a++)0===this._children[a]._zIndex&&this._children[a].render();this._hasRenderUpdates=0}}_renderAdvanced(){this._zSort&&this.sortZIndexedChildren();if(2>this._outOfBounds&&this._renderContext.alpha){let c=this.renderState;var a=!0;let d,e;if(this._useRenderToTexture){if(0===this._rw||0===this._rh){this._hasRenderUpdates=0;return}if(!this._texturizer.hasRenderTexture()||3<=this._hasRenderUpdates){c.setShader(c.defaultShader,this);e=c.renderTextureInfo;d=
{nativeTexture:null,offset:0,w:this._rw,h:this._rh,empty:!0,cleared:!1,ignore:!1,cache:!1};if(this._texturizer.hasResultTexture()||!c.isCachingTexturizer&&3>this._hasRenderUpdates)d.cache=!0,c.isCachingTexturizer=!0;this._texturizer.hasResultTexture()||this._texturizer.releaseRenderTexture();c.setRenderTextureInfo(d);c.setScissor(void 0);if(this._displayedTextureSource){var b=this._renderContext;this._renderContext=H.IDENTITY;this.renderState.addQuad(this);this._renderContext=b}}else a=!1}else 0===
this._outOfBounds&&this._displayedTextureSource&&(c.setShader(this.activeShader,this._shaderOwner),c.setScissor(this._scissor),this.renderState.addQuad(this));if(a&&this._children)if(this._zContextUsage)for(let a=0,b=this._zIndexedChildren.length;a<b;a++)this._zIndexedChildren[a].render();else for(let a=0,b=this._children.length;a<b;a++)0===this._children[a]._zIndex&&this._children[a].render();this._useRenderToTexture&&(b=!1,a&&(c.finishedRenderTexture(),(this._texturizer.empty=d.empty)?this._texturizer.releaseRenderTexture():
d.nativeTexture?(this._texturizer.reuseTextureAsRenderTexture(d.nativeTexture),d.ignore=!0):(this._texturizer.renderTextureReused&&this._texturizer.releaseRenderTexture(),d.nativeTexture=this._texturizer.getRenderTexture()),c.setRenderTextureInfo(e),b=!0),this._texturizer.empty||(a=this._texturizer.getResultTexture(),b&&(a&&(a.update=c.stage.frameCounter),this._texturizer.updateResultTexture()),this._texturizer.renderOffscreen||(c.setShader(this.activeShader,this._shaderOwner),c.setScissor(this._scissor),
c.setTexturizer(this._texturizer,!d||d.cache),this._stashTexCoords(),this._texturizer.colorize||this._stashColors(),this.renderState.addQuad(this,!0),this._texturizer.colorize||this._unstashColors(),this._unstashTexCoords(),c.setTexturizer(null))));d&&d.cache&&(c.isCachingTexturizer=!1);this._hasRenderUpdates=0}}get zSort(){return this._zSort}sortZIndexedChildren(){var a=this._zIndexedChildren.length;let b=0;var c=this._zIndexedChildren,d=[];for(var e=0;e<a;e++)c[e]._zParent===this&&(c[e]._zIndexResort?
(c[e]._zIndexResort=!1,d.push(c[e])):(b!==e&&(c[b]=c[e]),b++));if(a=d.length){d.sort(L.sortZIndexedChildren);const f=b;if(f){let g=b=0,h=0;e=[];do{const k=0<(c[g]._zIndex===d[h]._zIndex?c[g]._updateTreeOrder-d[h]._updateTreeOrder:c[g]._zIndex-d[h]._zIndex)?d[h++]:c[g++];if(0===b||e[b-1]!==k)e[b++]=k;if(g>=f){do if(c=d[h++],0===b||e[b-1]!==c)e[b++]=c;while(h<a);break}else if(h>=a){do if(d=c[g++],0===b||e[b-1]!==d)e[b++]=d;while(g<f);break}}while(1);this._zIndexedChildren=e}else{e=b=0;do c[b++]=d[e++];
while(e<a);c.length>b&&c.splice(b)}}else c.length>b&&c.splice(b);this._zSort=!1}get localTa(){return this._localTa}get localTb(){return this._localTb}get localTc(){return this._localTc}get localTd(){return this._localTd}get rw(){return this._rw}get rh(){return this._rh}get view(){return this._view}get renderUpdates(){return this._hasRenderUpdates}get texturizer(){this._texturizer||(this._texturizer=new ia(this));return this._texturizer}getCornerPoints(){let a=this._worldContext;return[a.px,a.py,a.px+
this._rw*a.ta,a.py+this._rw*a.tc,a.px+this._rw*a.ta+this._rh*this.tb,a.py+this._rw*a.tc+this._rh*this.td,a.px+this._rh*this.tb,a.py+this._rh*this.td]}getRenderTextureCoords(a,b){let c=this._renderContext;return[c.px+c.ta*a+c.tb*b,c.py+c.tc*a+c.td*b]}getAbsoluteCoords(a,b){let c=this._renderContext;return[c.px+c.ta*a+c.tb*b,c.py+c.tc*a+c.td*b]}}class H{constructor(){this.alpha=1;this.py=this.px=0;this.ta=1;this.tc=this.tb=0;this.td=1}isIdentity(){return 1===this.alpha&&0===this.px&&0===this.py&&1===
this.ta&&0===this.tb&&0===this.tc&&1===this.td}isSquare(){return 0===this.tb&&0===this.tc}}H.IDENTITY=new H;L.sortZIndexedChildren=function(a,b){return a._zIndex===b._zIndex?a._updateTreeOrder-b._updateTreeOrder:a._zIndex-b._zIndex};class E{static defaultSetter(a,b,c){a[b]=c}static patchObject(a,b){if(l.isObjectLiteral(b)){let c=Object.keys(b);for(let d=0,e=c.length;d<e;d++){let e=c[d];this.patchObjectProperty(a,e,b[e])}}else console.error("Settings must be object literal")}static preparePatchSettings(a,
b){if(b)return this._preparePatchSettings(a,"_$"+b)}static _preparePatchSettings(a,b){b&&a[b]&&(a=Object.assign({},a,a[b]),delete a[b]);return a}static patchObjectProperty(a,b,c){let d=a.setSetting||E.defaultSetter;"_"===b.charAt(0)?"$"!==b.charAt(1)&&"__create"!==b&&console.error("Patch of private property '"+b+"' is not allowed"):"type"!==b&&(l.isFunction(c)&&c.__local&&(c=c.__local(a)),d(a,b,c))}static local(a){a.__local=!0}}class v{constructor(){this._hasEventListeners=!1}on(a,b){this._hasEventListeners||
(this._eventFunction={},this._eventListeners={},this._hasEventListeners=!0);this._eventFunction[a]?this._eventFunction[a]!==v.combiner?(this._eventListeners[a]=[this._eventFunction[a],b],this._eventFunction[a]=v.combiner):this._eventListeners[a].push(b):this._eventFunction[a]=b}has(a,b){if(this._hasEventListeners){const c=this._eventFunction[a];if(c){if(c===v.combiner)return 0<=this._eventListeners[a].indexOf(b);if(this._eventFunction[a]===b)return!0}}return!1}off(a,b){if(this._hasEventListeners){var c=
this._eventFunction[a];c&&(c===v.combiner?(c=this._eventListeners[a],b=c.indexOf(b),0<=b&&c.splice(b,1),1===c.length&&(this._eventFunction[a]=c[0],this._eventListeners[a]=void 0)):this._eventFunction[a]===b&&(this._eventFunction[a]=void 0))}}removeListener(a,b){this.off(a,b)}emit(a,b,c,d){if(this._hasEventListeners){const e=this._eventFunction[a];e&&(e===v.combiner?e(this,a,b,c,d):e(b,c,d))}}listenerCount(a){if(this._hasEventListeners){const b=this._eventFunction[a];if(b)return b===v.combiner?this._eventListeners[a].length:
1}else return 0}removeAllListeners(a){this._hasEventListeners&&(delete this._eventFunction[a],delete this._eventListeners[a])}}v.combiner=function(a,b,c,d,e){(a=a._eventListeners[b])&&a.forEach((a)=>{a(c,d,e)})};v.addAsMixin=function(a){a.prototype.on=v.prototype.on;a.prototype.has=v.prototype.has;a.prototype.off=v.prototype.off;a.prototype.removeListener=v.prototype.removeListener;a.prototype.emit=v.prototype.emit;a.prototype.listenerCount=v.prototype.listenerCount};class M{constructor(a){this._initialized=
!1;this.ctx=a;this._views=new Set}static create(a,b){let c;if(l.isObjectLiteral(b))(c=b.type?a.renderer.createShader(a.ctx,b):this.shader)&&a.patchObject(c,b);else if(null===b)c=a.ctx.renderState.defaultShader;else if(void 0===b)c=null;else if(b.isShader)a.renderer.isValidShaderType(b.constructor)||(console.error("Invalid shader type"),b=null),c=b;else{console.error("Please specify a shader type.");return}return c}static getWebGL(){}static getC2d(){}addView(a){this._views.add(a)}removeView(a){this._views.delete(a);
this._views||this.cleanup()}redraw(){this._views.forEach((a)=>{a.setHasRenderUpdates(2)})}patch(a){this.ctx.stage.patchObject(this,a)}useDefault(){return!1}addEmpty(){return!1}cleanup(){}get isShader(){return!0}}class A{constructor(a){this.stage=a;this.manager=this.stage.textureManager;this.id=A.id++;this.views=new Set;this._activeCount=0;this._source=void 0;this._h=this._w=this._y=this._x=0;this._precision=1;this.mh=this.mw=2048;this.clipping=!1;this._mustUpdate=!0}get source(){this._mustUpdate&&
(this._performUpdateSource(!0),this.stage.removeUpdateSourceTexture(this));return this._source}addView(a){this.views.has(a)||(this.views.add(a),1===this.views.size&&this._source&&this._source.addTexture(this),a.active&&this.incActiveCount())}removeView(a){this.views.delete(a)&&(0===this.views.size&&this._source&&this._source.removeTexture(this),a.active&&this.decActiveCount())}incActiveCount(){this._activeCount++;1===this._activeCount&&this.becomesUsed()}decActiveCount(){this._activeCount--;this._activeCount||
this.becomesUnused()}becomesUsed(){this.source&&this.source.incActiveTextureCount()}becomesUnused(){this.source&&this.source.decActiveTextureCount()}isUsed(){return 0<this._activeCount}_getLookupId(){}_getSourceLoader(){throw Error("Texture.generate must be implemented.");}get isValid(){return this._getIsValid()}_getIsValid(){return!0}_changed(){this.isUsed()?this._updateSource():this._mustUpdate=!0}_updateSource(){this.stage.addUpdateSourceTexture(this)}_performUpdateSource(a=!1){if(a||this.isUsed())this._mustUpdate=
!1,a=this._getTextureSource(),this._replaceTextureSource(a)}_getTextureSource(){let a=void 0;if(this._getIsValid()){const b=this._getLookupId();b&&(a=this.manager.getReusableTextureSource(b));a||(a=this.manager.getTextureSource(this._getSourceLoader(),b))}return a}_replaceTextureSource(a=void 0){let b=this._source;this._source=a;this.views.size&&(b&&(this._activeCount&&b.decActiveTextureCount(),b.removeTexture(this)),a&&(a.addTexture(this),this._activeCount&&a.incActiveTextureCount()));if(this.isUsed())if(a)if(a.isLoaded())this.views.forEach((a)=>
{a.active&&a._setDisplayedTexture(this)});else{const b=a.loadError;b&&this.views.forEach((a)=>{if(a.active)a.onTextureSourceLoadError(b)})}else this.views.forEach((a)=>{a.active&&a._setDisplayedTexture(null)})}load(){this.source&&(this.isLoaded()||this.source.load())}isLoaded(){return this._source&&this._source.isLoaded()}get loadError(){return this._source&&this._source.loadError}free(){this._source&&this._source.free()}enableClipping(a,b,c,d){a*=this._precision;b*=this._precision;c*=this._precision;
d*=this._precision;if(this._x!==a||this._y!==b||this._w!==c||this._h!==d)this._x=a,this._y=b,this._w=c,this._h=d,this.updateClipping(!0)}disableClipping(){if(this._x||this._y||this._w||this._h)this._h=this._w=this._y=this._x=0,this.updateClipping(!1)}updateClipping(a){this.clipping=!0===a||!1===a?a:!!(this._x||this._y||this._w||this._h);let b=this;this.views.forEach(function(a){if(a.displayedTexture===b)a.onDisplayedTextureClippingChanged()})}updatePrecision(){let a=this;this.views.forEach(function(b){if(b.displayedTexture===
a)b.onPrecisionChanged()})}getNonDefaults(){let a={};a.type=this.constructor.name;0!==this.x&&(a.x=this.x);0!==this.y&&(a.y=this.y);0!==this.w&&(a.w=this.w);0!==this.h&&(a.h=this.h);1!==this.precision&&(a.precision=this.precision);return a}get px(){return this._x}get py(){return this._y}get pw(){return this._w}get ph(){return this._h}get x(){return this._x/this._precision}set x(a){a*=this._precision;this._x!==a&&(this._x=a,this.updateClipping())}get y(){return this._y/this._precision}set y(a){a*=
this._precision;this._y!==a&&(this._y=a,this.updateClipping())}get w(){return this._w/this._precision}set w(a){a*=this._precision;this._w!==a&&(this._w=a,this.updateClipping())}get h(){return this._h/this._precision}set h(a){a*=this._precision;this._h!==a&&(this._h=a,this.updateClipping())}get precision(){return this._precision}set precision(a){this._precision!==a&&(this._precision=a,this.updatePrecision())}getRenderWidth(){return(this._w||(this._source?this._source.getRenderWidth()-this._x:0))/this._precision}getRenderHeight(){return(this._h||
(this._source?this._source.getRenderHeight()-this._y:0))/this._precision}patch(a){this.stage.patchObject(this,a)}}A.prototype.isTexture=!0;A.id=0;class Q extends A{constructor(a){super(a);this._src=void 0;this._hasAlpha=!1}get src(){return this._src}set src(a){this._src!==a&&(this._src=a,this._changed())}get hasAlpha(){return this._hasAlpha}set hasAlpha(a){this._hasAlpha!==a&&(this._hasAlpha=a,this._changed())}_getIsValid(){return!!this._src}_getLookupId(){return this._src}_getSourceLoader(){let a=
this._src,b=this._hasAlpha;if(this.stage.getOption("srcBasePath")){var c=a.charCodeAt(0);-1===a.indexOf("//")&&(65<=c&&90>=c||97<=c&&122>=c||46==c)&&(a=this.stage.getOption("srcBasePath")+a)}const d=this.stage.platform;return function(c){return d.loadSrcTexture({src:a,hasAlpha:b},c)}}getNonDefaults(){const a=super.getNonDefaults();this._src&&(a.src=this._src);return a}}class Ea{constructor(a,b,c){this._stage=a;this._canvas=b;this._context=this._canvas.getContext("2d");this._settings=c}getPrecision(){return this._settings.precision}setFontProperties(){this._context.font=
this._getFontSetting();this._context.textBaseline=this._settings.textBaseline}_getFontSetting(){var a=this._settings.fontFace;a='"'+(Array.isArray(a)?this._settings.fontFace.join('","'):a)+'"';return`${this._settings.fontStyle} ${this._settings.fontSize*this.getPrecision()}px ${a}`}_load(){if(l.isWeb&&document.fonts){const a=this._getFontSetting();try{if(!document.fonts.check(a,this._settings.text))return document.fonts.load(a,this._settings.text).catch((b)=>{console.warn("Font load error",b,a)}).then(()=>
{document.fonts.check(a,this._settings.text)||console.warn("Font not found",a)})}catch(b){console.warn("Can't check font loading for "+a)}}}draw(){const a=this._load();if(a)return a.then(()=>{this._draw()});this._draw()}_draw(){let a={};var b=this.getPrecision(),c=this._settings.paddingLeft*b,d=this._settings.paddingRight*b,e=this._settings.fontSize*b,f=null===this._settings.offsetY?null:this._settings.offsetY*b,g=this._settings.lineHeight*b,h=this._settings.w*b;const k=this._settings.h*b;var m=this._settings.wordWrapWidth*
b;const l=this._settings.cutSx*b;var D=this._settings.cutEx*b;const n=this._settings.cutSy*b;var p=this._settings.cutEy*b;this.setFontProperties();var q=h||2048/this.getPrecision(),u=q-c;10>u&&(q+=10-u,u+=10-u);m||(m=u);if(this._settings.wordWrap)var v=this.wrapText(this._settings.text,m);else{v={l:this._settings.text.split(/(?:\r\n|\r|\n)/),n:[]};var w=v.l.length;for(var y=0;y<w-1;y++)v.n.push(y)}w=v.l;if(this._settings.maxLines&&w.length>this._settings.maxLines){y=w.slice(0,this._settings.maxLines);
if(this._settings.maxLinesSuffix){var x=this._settings.maxLinesSuffix?this._context.measureText(this._settings.maxLinesSuffix).width:0;m=this.wrapText(y[y.length-1],m-x);y[y.length-1]=m.l[0]+this._settings.maxLinesSuffix;m=[1<m.l.length?m.l[1]:""]}else m=[""];let b=w.length,c=0,d=v.n.length;for(x=this._settings.maxLines;x<b;x++)m[c]+=(m[c]?" ":"")+w[x],x+1<d&&v.n[x+1]&&c++;a.remainingText=m.join("\n");a.moreTextLines=!0;w=y}else a.moreTextLines=!1,a.remainingText="";y=0;v=[];for(m=0;m<w.length;m++)x=
this._context.measureText(w[m]).width,v.push(x),y=Math.max(y,x);a.lineWidths=v;h||(q=y+c+d,u=y);g=g||e;h=k?k:g*(w.length-1)+.5*e+Math.max(g,e)+f;null===f&&(f=e);a.w=q;a.h=h;a.lines=w;a.precision=b;q||(q=1);h||(h=1);if(l||D)q=Math.min(q,D-l);if(n||p)h=Math.min(h,p-n);this._canvas.width=Math.ceil(q+this._stage.getOption("textRenderIssueMargin"));this._canvas.height=Math.ceil(h);this.setFontProperties();128<=e&&(this._context.globalAlpha=.01,this._context.fillRect(0,0,.01,.01),this._context.globalAlpha=
1);(l||n)&&this._context.translate(-l,-n);D=[];for(let a=0,b=w.length;a<b;a++)p=0,q=a*g+f,"right"===this._settings.textAlign?p+=u-v[a]:"center"===this._settings.textAlign&&(p+=(u-v[a])/2),p+=c,D.push({text:w[a],x:p,y:q,w:v[a]});if(this._settings.highlight)for(f=this._settings.highlightHeight*b||1.5*e,e=null!==this._settings.highlightOffset?this._settings.highlightOffset*b:-.5*e,c=null!==this._settings.highlightPaddingLeft?this._settings.highlightPaddingLeft*b:c,d=null!==this._settings.highlightPaddingRight?
this._settings.highlightPaddingRight*b:d,this._context.fillStyle=t.getRgbaString(this._settings.highlightColor||0),g=0;g<D.length;g++)u=D[g],this._context.fillRect(u.x-c,u.y+e,u.w+d+c,f);d=null;this._settings.shadow&&(d=[this._context.shadowColor,this._context.shadowOffsetX,this._context.shadowOffsetY,this._context.shadowBlur],this._context.shadowColor=t.getRgbaString(this._settings.shadowColor),this._context.shadowOffsetX=this._settings.shadowOffsetX*b,this._context.shadowOffsetY=this._settings.shadowOffsetY*
b,this._context.shadowBlur=this._settings.shadowBlur*b);this._context.fillStyle=t.getRgbaString(this._settings.textColor);for(let a=0,c=D.length;a<c;a++)b=D[a],this._context.fillText(b.text,b.x,b.y);d&&(this._context.shadowColor=d[0],this._context.shadowOffsetX=d[1],this._context.shadowOffsetY=d[2],this._context.shadowBlur=d[3]);(l||n)&&this._context.translate(l,n);this.renderInfo=a}wrapText(a,b){a=a.split(/\r?\n/g);let c=[],d=[];for(let e=0;e<a.length;e++){let f=[],g="",h=b,k=a[e].split(" ");for(let a=
0;a<k.length;a++){let c=this._context.measureText(k[a]).width,d=c+this._context.measureText(" ").width;0===a||d>h?(0<a&&(f.push(g),g=""),g+=k[a],h=b-c):(h-=d,g+=" "+k[a])}g&&f.push(g);c=c.concat(f);e<a.length-1&&d.push(c.length)}return{l:c,n:d}}}class J extends A{constructor(a){super(a);this._precision=this.stage.getOption("precision")}get text(){return this._text}set text(a){this._text!==a&&(this._text=""+a,this._changed())}get w(){return this._w}set w(a){this._w!==a&&(this._w=a,this._changed())}get h(){return this._h}set h(a){this._h!==
a&&(this._h=a,this._changed())}get fontStyle(){return this._fontStyle}set fontStyle(a){this._fontStyle!==a&&(this._fontStyle=a,this._changed())}get fontSize(){return this._fontSize}set fontSize(a){this._fontSize!==a&&(this._fontSize=a,this._changed())}get fontFace(){return this._fontFace}set fontFace(a){this._fontFace!==a&&(this._fontFace=a,this._changed())}get wordWrap(){return this._wordWrap}set wordWrap(a){this._wordWrap!==a&&(this._wordWrap=a,this._changed())}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(a){this._wordWrapWidth!==
a&&(this._wordWrapWidth=a,this._changed())}get lineHeight(){return this._lineHeight}set lineHeight(a){this._lineHeight!==a&&(this._lineHeight=a,this._changed())}get textBaseline(){return this._textBaseline}set textBaseline(a){this._textBaseline!==a&&(this._textBaseline=a,this._changed())}get textAlign(){return this._textAlign}set textAlign(a){this._textAlign!==a&&(this._textAlign=a,this._changed())}get offsetY(){return this._offsetY}set offsetY(a){this._offsetY!==a&&(this._offsetY=a,this._changed())}get maxLines(){return this._maxLines}set maxLines(a){this._maxLines!==
a&&(this._maxLines=a,this._changed())}get maxLinesSuffix(){return this._maxLinesSuffix}set maxLinesSuffix(a){this._maxLinesSuffix!==a&&(this._maxLinesSuffix=a,this._changed())}get textColor(){return this._textColor}set textColor(a){this._textColor!==a&&(this._textColor=a,this._changed())}get paddingLeft(){return this._paddingLeft}set paddingLeft(a){this._paddingLeft!==a&&(this._paddingLeft=a,this._changed())}get paddingRight(){return this._paddingRight}set paddingRight(a){this._paddingRight!==a&&
(this._paddingRight=a,this._changed())}get shadow(){return this._shadow}set shadow(a){this._shadow!==a&&(this._shadow=a,this._changed())}get shadowColor(){return this._shadowColor}set shadowColor(a){this._shadowColor!==a&&(this._shadowColor=a,this._changed())}get shadowOffsetX(){return this._shadowOffsetX}set shadowOffsetX(a){this._shadowOffsetX!==a&&(this._shadowOffsetX=a,this._changed())}get shadowOffsetY(){return this._shadowOffsetY}set shadowOffsetY(a){this._shadowOffsetY!==a&&(this._shadowOffsetY=
a,this._changed())}get shadowBlur(){return this._shadowBlur}set shadowBlur(a){this._shadowBlur!==a&&(this._shadowBlur=a,this._changed())}get highlight(){return this._highlight}set highlight(a){this._highlight!==a&&(this._highlight=a,this._changed())}get highlightHeight(){return this._highlightHeight}set highlightHeight(a){this._highlightHeight!==a&&(this._highlightHeight=a,this._changed())}get highlightColor(){return this._highlightColor}set highlightColor(a){this._highlightColor!==a&&(this._highlightColor=
a,this._changed())}get highlightOffset(){return this._highlightOffset}set highlightOffset(a){this._highlightOffset!==a&&(this._highlightOffset=a,this._changed())}get highlightPaddingLeft(){return this._highlightPaddingLeft}set highlightPaddingLeft(a){this._highlightPaddingLeft!==a&&(this._highlightPaddingLeft=a,this._changed())}get highlightPaddingRight(){return this._highlightPaddingRight}set highlightPaddingRight(a){this._highlightPaddingRight!==a&&(this._highlightPaddingRight=a,this._changed())}get cutSx(){return this._cutSx}set cutSx(a){this._cutSx!==
a&&(this._cutSx=a,this._changed())}get cutEx(){return this._cutEx}set cutEx(a){this._cutEx!==a&&(this._cutEx=a,this._changed())}get cutSy(){return this._cutSy}set cutSy(a){this._cutSy!==a&&(this._cutSy=a,this._changed())}get cutEy(){return this._cutEy}set cutEy(a){this._cutEy!==a&&(this._cutEy=a,this._changed())}get precision(){return super.precision}set precision(a){this.precision!==a&&(super.precision=a,this._changed())}_getIsValid(){return!!this.text}_getLookupId(){let a=[];0!==this.w&&a.push("w "+
this.w);0!==this.h&&a.push("h "+this.h);"normal"!==this.fontStyle&&a.push("fS"+this.fontStyle);40!==this.fontSize&&a.push("fs"+this.fontSize);null!==this.fontFace&&a.push("ff"+(Array.isArray(this.fontFace)?this.fontFace.join(","):this.fontFace));!0!==this.wordWrap&&a.push("wr"+(this.wordWrap?1:0));0!==this.wordWrapWidth&&a.push("ww"+this.wordWrapWidth);null!==this.lineHeight&&a.push("lh"+this.lineHeight);"alphabetic"!==this.textBaseline&&a.push("tb"+this.textBaseline);"left"!==this.textAlign&&a.push("ta"+
this.textAlign);null!==this.offsetY&&a.push("oy"+this.offsetY);0!==this.maxLines&&a.push("ml"+this.maxLines);".."!==this.maxLinesSuffix&&a.push("ms"+this.maxLinesSuffix);a.push("pc"+this.precision);4294967295!==this.textColor&&a.push("co"+this.textColor.toString(16));0!==this.paddingLeft&&a.push("pl"+this.paddingLeft);0!==this.paddingRight&&a.push("pr"+this.paddingRight);!1!==this.shadow&&a.push("sh"+(this.shadow?1:0));4278190080!==this.shadowColor&&a.push("sc"+this.shadowColor.toString(16));0!==
this.shadowOffsetX&&a.push("sx"+this.shadowOffsetX);0!==this.shadowOffsetY&&a.push("sy"+this.shadowOffsetY);5!==this.shadowBlur&&a.push("sb"+this.shadowBlur);!1!==this.highlight&&a.push("hL"+(this.highlight?1:0));0!==this.highlightHeight&&a.push("hh"+this.highlightHeight);4278190080!==this.highlightColor&&a.push("hc"+this.highlightColor.toString(16));null!==this.highlightOffset&&a.push("ho"+this.highlightOffset);null!==this.highlightPaddingLeft&&a.push("hl"+this.highlightPaddingLeft);null!==this.highlightPaddingRight&&
a.push("hr"+this.highlightPaddingRight);this.cutSx&&a.push("csx"+this.cutSx);this.cutEx&&a.push("cex"+this.cutEx);this.cutSy&&a.push("csy"+this.cutSy);this.cutEy&&a.push("cey"+this.cutEy);return"TX$"+a.join("|")+":"+this.text}_getSourceLoader(){const a=this.cloneArgs();null===a.fontFace&&(a.fontFace=this.stage.getOption("defaultFontFace"));return function(b){const c=this.stage.platform.getDrawingCanvas(),d=new Ea(this.stage,c,a),e=d.draw();e?e.then(()=>{b(null,Object.assign({renderInfo:d.renderInfo},
this.stage.platform.getTextureOptionsForDrawingCanvas(c)))}).catch((a)=>{b(a)}):b(null,Object.assign({renderInfo:d.renderInfo},this.stage.platform.getTextureOptionsForDrawingCanvas(c)))}}getNonDefaults(){const a=super.getNonDefaults();""!==this.text&&(a.text=this.text);0!==this.w&&(a.w=this.w);0!==this.h&&(a.h=this.h);"normal"!==this.fontStyle&&(a.fontStyle=this.fontStyle);40!==this.fontSize&&(a.fontSize=this.fontSize);null!==this.fontFace&&(a.fontFace=this.fontFace);!0!==this.wordWrap&&(a.wordWrap=
this.wordWrap);0!==this.wordWrapWidth&&(a.wordWrapWidth=this.wordWrapWidth);null!==this.lineHeight&&(a.lineHeight=this.lineHeight);"alphabetic"!==this.textBaseline&&(a.textBaseline=this.textBaseline);"left"!==this.textAlign&&(a.textAlign=this.textAlign);null!==this.offsetY&&(a.offsetY=this.offsetY);0!==this.maxLines&&(a.maxLines=this.maxLines);".."!==this.maxLinesSuffix&&(a.maxLinesSuffix=this.maxLinesSuffix);this.precision!==this.stage.getOption("precision")&&(a.precision=this.precision);4294967295!==
this.textColor&&(a.textColor=this.textColor);0!==this.paddingLeft&&(a.paddingLeft=this.paddingLeft);0!==this.paddingRight&&(a.paddingRight=this.paddingRight);!1!==this.shadow&&(a.shadow=this.shadow);4278190080!==this.shadowColor&&(a.shadowColor=this.shadowColor);0!==this.shadowOffsetX&&(a.shadowOffsetX=this.shadowOffsetX);0!==this.shadowOffsetY&&(a.shadowOffsetY=this.shadowOffsetY);5!==this.shadowBlur&&(a.shadowBlur=this.shadowBlur);!1!==this.highlight&&(a.highlight=this.highlight);0!==this.highlightHeight&&
(a.highlightHeight=this.highlightHeight);4278190080!==this.highlightColor&&(a.highlightColor=this.highlightColor);0!==this.highlightOffset&&(a.highlightOffset=this.highlightOffset);0!==this.highlightPaddingLeft&&(a.highlightPaddingLeft=this.highlightPaddingLeft);0!==this.highlightPaddingRight&&(a.highlightPaddingRight=this.highlightPaddingRight);this.cutSx&&(a.cutSx=this.cutSx);this.cutEx&&(a.cutEx=this.cutEx);this.cutSy&&(a.cutSy=this.cutSy);this.cutEy&&(a.cutEy=this.cutEy);return a}cloneArgs(){let a=
{};a.text=this._text;a.w=this._w;a.h=this._h;a.fontStyle=this._fontStyle;a.fontSize=this._fontSize;a.fontFace=this._fontFace;a.wordWrap=this._wordWrap;a.wordWrapWidth=this._wordWrapWidth;a.lineHeight=this._lineHeight;a.textBaseline=this._textBaseline;a.textAlign=this._textAlign;a.offsetY=this._offsetY;a.maxLines=this._maxLines;a.maxLinesSuffix=this._maxLinesSuffix;a.precision=this._precision;a.textColor=this._textColor;a.paddingLeft=this._paddingLeft;a.paddingRight=this._paddingRight;a.shadow=this._shadow;
a.shadowColor=this._shadowColor;a.shadowOffsetX=this._shadowOffsetX;a.shadowOffsetY=this._shadowOffsetY;a.shadowBlur=this._shadowBlur;a.highlight=this._highlight;a.highlightHeight=this._highlightHeight;a.highlightColor=this._highlightColor;a.highlightOffset=this._highlightOffset;a.highlightPaddingLeft=this._highlightPaddingLeft;a.highlightPaddingRight=this._highlightPaddingRight;a.cutSx=this._cutSx;a.cutEx=this._cutEx;a.cutSy=this._cutSy;a.cutEy=this._cutEy;return a}}let p=J.prototype;p._text="";
p._w=0;p._h=0;p._fontStyle="normal";p._fontSize=40;p._fontFace=null;p._wordWrap=!0;p._wordWrapWidth=0;p._lineHeight=null;p._textBaseline="alphabetic";p._textAlign="left";p._offsetY=null;p._maxLines=0;p._maxLinesSuffix="..";p._textColor=4294967295;p._paddingLeft=0;p._paddingRight=0;p._shadow=!1;p._shadowColor=4278190080;p._shadowOffsetX=0;p._shadowOffsetY=0;p._shadowBlur=5;p._highlight=!1;p._highlightHeight=0;p._highlightColor=4278190080;p._highlightOffset=0;p._highlightPaddingLeft=0;p._highlightPaddingRight=
0;p._cutSx=0;p._cutEx=0;p._cutSy=0;p._cutEy=0;class ja extends A{constructor(a){super(a);this._textureSource=void 0}get textureSource(){return this._textureSource}set textureSource(a){a!==this._textureSource&&(a.isResultTexture&&(this._precision=this.stage.getRenderPrecision()),this._textureSource=a,this._changed())}_getTextureSource(){return this._textureSource}}class R extends v{constructor(a,b,c,d){super();this.manager=a;this._settings=b;this._view=c;this._getter=q.getGetter(d);this._setter=q.getSetter(d);
this._merger=b.merger;this._merger||(this._merger=q.getMerger(d));this._targetValue=this._startValue=this._getter(this._view);this._p=1;this._delayLeft=0}start(a){this._startValue=this._getter(this._view);this.isAttached()?a===this._startValue?this.reset(a,1):(this._targetValue=a,this._p=0,this._delayLeft=this._settings.delay,this.emit("start"),this.add()):(this._targetValue=a,this._p=1,this._updateDrawValue())}finish(){1>this._p&&(this._p=1)}stop(){this.manager.removeActive(this)}pause(){this.stop()}play(){this.manager.addActive(this)}reset(a,
b){this.isAttached()?(this._startValue=this._getter(this._view),this._targetValue=a,this._p=b,this.add()):(this._startValue=this._getter(this._view),this._targetValue=a,this._p=1,this._updateDrawValue())}_updateDrawValue(){this._setter(this._view,this.getDrawValue())}add(){this.manager.addActive(this)}isAttached(){return this._view.attached}isRunning(){return 1>this._p}progress(a){this.isAttached()||(this._p=1);if(1>this.p){if(0<this.delayLeft)if(this._delayLeft-=a,0>this.delayLeft)a=-this.delayLeft,
this._delayLeft=0,this.emit("delayEnd");else return;this._p=0==this._settings.duration?1:this._p+a/this._settings.duration;1<=this._p&&(this._p=1)}this._updateDrawValue();this.invokeListeners()}invokeListeners(){this.emit("progress",this.p);1===this.p&&this.emit("finish")}updateTargetValue(a){let b=this._settings.timingFunctionImpl(this.p);1!==b&&(this._startValue=0===b?this._targetValue:a-(a-this._targetValue)/(1-b));this._targetValue=a}getDrawValue(){if(1<=this.p)return this.targetValue;{let a=
this._settings._timingFunctionImpl(this.p);return this._merger(this.targetValue,this.startValue,a)}}skipDelay(){this._delayLeft=0}get startValue(){return this._startValue}get targetValue(){return this._targetValue}get p(){return this._p}get delayLeft(){return this._delayLeft}get view(){return this._view}get settings(){return this._settings}set settings(a){this._settings=a}}R.prototype.isTransition=!0;class ka{constructor(){this._items=[];this._refs={}}get(){return this._items}get first(){return this._items[0]}get last(){return this._items.length?
this._items[this._items.length-1]:void 0}add(a){this.addAt(a,this._items.length)}addAt(a,b){if(0<=b&&b<=this._items.length){let c=this._items.indexOf(a);if(c===b)return a;-1!=c?this.setAt(a,b):(a.ref&&(this._refs[a.ref]=a),this._items.splice(b,0,a),this.onAdd(a,b))}else throw Error("addAt: The index "+b+" is out of bounds "+this._items.length);}replaceByRef(a){if(a.ref){const b=this.getByRef(a.ref);if(!b)throw Error("replaceByRef: no item found with reference: "+a.ref);this.replace(a,b)}else throw Error("replaceByRef: no ref specified in item");
this.addAt(a,this._items.length)}replace(a,b){b=this.getIndex(b);if(-1===b)throw Error("replace: The previous item does not exist");this.setAt(a,b)}setAt(a,b){if(0<=b&&b<=this._items.length){var c=this._items.indexOf(a);-1!=c?c!==b&&c!==b&&(this._items.splice(c,1),this._items.splice(b,0,a),this.onMove(a,c,b)):(b<this._items.length&&this._items[b].ref&&(this._refs[this._items[b].ref]=void 0),c=this._items[b],this._items[b]=a,a.ref&&(this._refs[a.ref]=a),this.onSet(a,b,c))}else throw Error("setAt: The index "+
b+" is out of bounds "+this._items.length);}getAt(a){return this._items[a]}getIndex(a){return this._items.indexOf(a)}remove(a){a=this._items.indexOf(a);-1!==a&&this.removeAt(a)}removeAt(a){let b=this._items[a];b.ref&&(this._refs[b.ref]=void 0);this._items.splice(a,1);this.onRemove(b,a);return b}clear(){if(this._items.length){let a=this._items;this._items=[];this._refs={};this.onSync(a,[],[])}}a(a){if(l.isObjectLiteral(a)){let b=this.createItem(a);b.patch(a);this.add(b);return b}if(Array.isArray(a)){for(let b=
0,c=a.length;b<c;b++)this.a(a[b]);return null}if(this.isItem(a))return this.add(a),a}get length(){return this._items.length}_getRefs(){return this._refs}getByRef(a){return this._refs[a]}clearRef(a){delete this._refs[a]}setRef(a,b){this._refs[a]=b}patch(a){l.isObjectLiteral(a)?this._setByObject(a):Array.isArray(a)&&this._setByArray(a)}_setByObject(a){let b=this._getRefs(),c=Object.keys(a);for(let e=0,f=c.length;e<f;e++){let f=c[e],h=a[f];var d=b[f];d?this.isItem(h)?d!==h&&(d=this.getIndex(d),h.ref=
f,this.setAt(h,d)):d.patch(h):this.isItem(h)?(h.ref=f,this.add(h)):(d=this.createItem(h),d.ref=f,d.patch(h),this.add(d))}}_equalsArray(a){let b=!0;if(a.length===this._items.length)for(let c=0,d=this._items.length;c<d&&b;c++)b=b&&this._items[c]===a[c];else b=!1;return b}_setByArray(a){if(!this._equalsArray(a)){for(let a=0,b=this._items.length;a<b;a++)this._items[a].marker=!0;var b,c=[];for(let d=0,e=a.length;d<e;d++){let e=a[d];if(this.isItem(e))e.marker=!1,c.push(e);else{let a=e.ref,d;a&&(b||(b=this._getRefs()),
d=b[a]);d?d.marker=!1:d=this.createItem(e);l.isObjectLiteral(e)&&d.patch(e);c.push(d)}}this._setItems(c)}}_setItems(a){let b=this._items;this._items=a;let c=b.filter((a)=>{let b=a.marker;delete a.marker;return b}),d=a.filter((a)=>-1===b.indexOf(a));if(c.length||d.length){this._refs={};for(let a=0,b=this._items.length;a<b;a++){let b=this._items[a].ref;b&&(this._refs[b]=this._items[a])}}this.onSync(c,d,a)}sort(a){const b=this._items.slice();b.sort(a);this._setByArray(b)}onAdd(a,b){}onRemove(a,b){}onSync(a,
b,c){}onSet(a,b,c){}onMove(a,b,c){}createItem(a){throw Error("ObjectList.createItem must create and return a new object");}isItem(a){return!1}}class Fa extends ka{constructor(a){super();this._view=a}_connectParent(a){const b=a.parent;if(b&&b!==this._view){const c=a.parent.childList,d=c.getIndex(a);a.ref&&(c._refs[a.ref]=void 0);c._items.splice(d,1);b.core.removeChildAt(d)}a._setParent(this._view)}onAdd(a,b){this._connectParent(a);this._view.core.addChildAt(b,a.core)}onRemove(a,b){a._setParent(null);
this._view.core.removeChildAt(b)}onSync(a,b,c){for(let b=0,c=a.length;b<c;b++)a[b]._setParent(null);for(let a=0,c=b.length;a<c;a++)this._connectParent(b[a]);let d=(a)=>a.core;this._view.core.syncChildren(a.map(d),b.map(d),c.map(d))}onSet(a,b,c){c._setParent(null);this._connectParent(a);this._view.core.setChildAt(b,a.core)}onMove(a,b,c){this._view.core.moveChild(b,c)}createItem(a){return a.type?new a.type(this._view.stage):this._view.stage.createView()}isItem(a){return a.isView}}class q{constructor(a){this._hasEventListeners=
!1;this.__id=q.id++;this.stage=a;this.__core=new L(this);this.__ref=null;this.__active=this.__enabled=this.__attached=!1;this.__tagToComplex=this.__tagsCache=this.__treeTags=this.__tags=this.__displayedTexture=this.__texture=this.__parent=null;this.__tagRoot=!1;this.__childList=null}get id(){return this.__id}set ref(a){if(this.__ref!==a){const b=a.charCodeAt(0);l.isUcChar(b)||this._throwError("Ref must start with an upper case character: "+a);null!==this.__ref&&(this.removeTag(this.__ref),this.__parent&&
this.__parent.__childList.clearRef(this.__ref));if(this.__ref=a)this._addTag(this.__ref),this.__parent&&this.__parent.__childList.setRef(this.__ref,this)}}get ref(){return this.__ref}get core(){return this.__core}setAsRoot(){this.__core.setAsRoot();this._updateAttachedFlag();this._updateEnabledFlag()}get isRoot(){return this.__core.isRoot}_setParent(a){this.__parent!==a&&(this.__parent&&this._unsetTagsParent(),(this.__parent=a)&&this._setTagsParent(),this._updateAttachedFlag(),this._updateEnabledFlag(),
this.isRoot&&a&&this._throwError("Root should not be added as a child! Results are unspecified!"))}getDepth(){let a=0,b=this.__parent;for(;b;)a++,b=b.__parent;return a}getAncestor(a){let b=this;for(;0<a&&b.__parent;)b=b.__parent,a--;return b}getAncestorAtDepth(a){a=this.getDepth()-a;return 0>a?null:this.getAncestor(a)}isAncestorOf(a){for(;a=a.parent;)if(this===a)return!0;return!1}getSharedAncestor(a){let b=this,c=b.getDepth(),d=a.getDepth();c>d?b=b.getAncestor(c-d):d>c&&(a=a.getAncestor(d-c));do{if(b===
a)return b;b=b.__parent;a=a.__parent}while(b&&a);return null}get attached(){return this.__attached}get enabled(){return this.__enabled}get active(){return this.__active}_isAttached(){return this.__parent?this.__parent.__attached:this.stage.root===this}_isEnabled(){return this.__core.visible&&0<this.__core.alpha&&(this.__parent?this.__parent.__enabled:this.stage.root===this)}_isActive(){return this._isEnabled()&&this.withinBoundsMargin}_updateAttachedFlag(){let a=this._isAttached();if(this.__attached!==
a){(this.__attached=a)&&this._onSetup();let b=this._children.get();if(b){let a=b.length;if(0<a)for(let c=0;c<a;c++)b[c]._updateAttachedFlag()}a?this._onAttach():this._onDetach()}}_updateEnabledFlag(){var a=this._isEnabled();if(this.__enabled!==a&&(a?(this._onEnabled(),this._setEnabledFlag()):(this._onDisabled(),this._unsetEnabledFlag()),a=this._children.get())){let b=a.length;if(0<b)for(let c=0;c<b;c++)a[c]._updateEnabledFlag()}}_setEnabledFlag(){this.__enabled=!0;this._updateDimensions();this._updateTextureCoords();
this.__texture&&this.__texture.addView(this);this.withinBoundsMargin&&this._setActiveFlag();this.__core.shader&&this.__core.shader.addView(this.__core)}_unsetEnabledFlag(){this.__active&&this._unsetActiveFlag();this.__texture&&this.__texture.removeView(this);this.__core.shader&&this.__core.shader.removeView(this.__core);this._texturizer&&this.texturizer.filters.forEach((a)=>a.removeView(this.__core));this.__enabled=!1}_setActiveFlag(){this.__active=!0;this.__texture&&this.__texture.incActiveCount();
this.__texture&&this._enableTexture();this._onActive()}_unsetActiveFlag(){this.__texture&&this.__texture.decActiveCount();this.__active=!1;this.__texture&&this._disableTexture();this._hasTexturizer()&&this.texturizer.deactivate();this._onInactive()}_onSetup(){}_onAttach(){}_onDetach(){}_onEnabled(){}_onDisabled(){}_onActive(){}_onInactive(){}_onResize(){}_getRenderWidth(){return this.__core.w?this.__core.w:this.__displayedTexture?this.__displayedTexture.getRenderWidth():this.__texture?this.__texture.getRenderWidth():
0}_getRenderHeight(){return this.__core.h?this.__core.h:this.__displayedTexture?this.__displayedTexture.getRenderHeight():this.__texture?this.__texture.getRenderHeight():0}get renderWidth(){return this.__enabled?this.__core._rw:this._getRenderWidth()}get renderHeight(){return this.__enabled?this.__core._rh:this._getRenderHeight()}textureIsLoaded(){return this.__texture&&this.__texture.isLoaded()}loadTexture(){this.__texture&&(this.__texture.load(),this.__texture.isUsed()&&this._isEnabled()||this._updateDimensions())}_enableTextureError(){const a=
this.__texture.loadError;a&&this.emit("txError",a,this.__texture._source)}_enableTexture(){this.__texture.isLoaded()?this._setDisplayedTexture(this.__texture):(this._setDisplayedTexture(null),this._enableTextureError())}_disableTexture(){this._setDisplayedTexture(null)}get texture(){return this.__texture}set texture(a){let b;if(l.isObjectLiteral(a))(b=a.type?new a.type(this.stage):this.texture)&&this.stage.patchObject(b,a);else if(a)if(a.isTexture)b=a;else if(a.isTextureSource)b=new ja(this.stage),
b.textureSource=a;else{console.error("Please specify a texture type.");return}else b=null;a=this.__texture;b!==a&&((this.__texture=b)?this.__enabled&&(this.__texture.addView(this),this.withinBoundsMargin&&(this.__texture.isLoaded()?this._setDisplayedTexture(this.__texture):this._enableTextureError())):this._setDisplayedTexture(null),a&&a!==this.__displayedTexture&&a.removeView(this),this._updateDimensions())}get displayedTexture(){return this.__displayedTexture}_setDisplayedTexture(a){var b=this.__displayedTexture;
b&&a!==b&&this.__texture!==b&&b.removeView(this);b=(a?a._source:void 0)!==(this.__core.displayedTextureSource?this.__core.displayedTextureSource._source:void 0);this.__displayedTexture=a;this._updateDimensions();this.__displayedTexture?b&&(this._updateTextureCoords(),this.__core.setDisplayedTextureSource(this.__displayedTexture._source)):this.__core.setDisplayedTextureSource(null);b&&(this.__displayedTexture?this.emit("txLoaded",this.__displayedTexture):this.emit("txUnloaded",this.__displayedTexture))}onTextureSourceLoaded(){this.active&&
this._setDisplayedTexture(this.__texture)}onTextureSourceLoadError(a){this.emit("txError",a,this.__texture._source)}forceRenderUpdate(){this.__core.setHasRenderUpdates(3)}onDisplayedTextureClippingChanged(){this._updateDimensions();this._updateTextureCoords()}onPrecisionChanged(){this._updateDimensions()}_updateDimensions(){let a=this._getRenderWidth(),b=this._getRenderHeight(),c=!1;a&&b||this.__displayedTexture||!this.__texture||(c=!0,a=a||this.__texture.mw,b=b||this.__texture.mh);this.__core.setDimensions(a,
b,c)&&this._onResize()}_updateTextureCoords(){if(this.displayedTexture&&this.displayedTexture._source){let d=this.displayedTexture;var a=this.displayedTexture._source,b=0,c=0;let e=1,f=1;if(d.clipping){b=a.getRenderWidth();c=a.getRenderHeight();let g,h,k;a=1/b;g=1/c;h=d.pw?d.pw*a:(b-d.px)*a;k=d.ph?d.ph*g:(c-d.py)*g;a*=d.px;g*=d.py;b=a;c=g;e=e*h+a;f=f*k+g;b=Math.max(0,b);c=Math.max(0,c);e=Math.min(1,e);f=Math.min(1,f)}this.__core.setTextureCoords(b,c,e,f)}}getCornerPoints(){return this.__core.getCornerPoints()}_clearTagsCache(a){if(this.__tagsCache&&
(this.__tagsCache.delete(a),this.__tagToComplex)){let b=this.__tagToComplex.get(a);if(b){for(let a=0,d=b.length;a<d;a++)this.__tagsCache.delete(b[a]);this.__tagToComplex.delete(a)}}}_unsetTagsParent(){let a=null,b=0;if(this.__treeTags)if(this.__tagRoot)this.__tags&&this.__tags.forEach((a)=>{let b=this;for(;(b=b.__parent)&&(b.__treeTags.get(a).delete(this),b._clearTagsCache(a),!b.__tagRoot););});else if(a=l.iteratorToArray(this.__treeTags.keys()),b=a.length,0<b)for(let c=0;c<b;c++){let b=this.__treeTags.get(a[c]),
e=this;for(;e=e.__parent;){let d=e.__treeTags.get(a[c]);b.forEach(function(a){d.delete(a)});e._clearTagsCache(a[c]);if(e.__tagRoot)break}}}_setTagsParent(){this.__treeTags&&this.__treeTags.size&&(this.__tagRoot?this.__tags&&this.__tags.forEach((a)=>{let b=this;for(;b=b.__parent;){b.__treeTags||(b.__treeTags=new Map);let c=b.__treeTags.get(a);c||(c=new Set,b.__treeTags.set(a,c));c.add(this);b._clearTagsCache(a);if(b.__tagRoot)break}}):this.__treeTags.forEach((a,b)=>{let c=this;for(;!c.__tagRoot&&(c=
c.__parent);){c.__treeTags||(c.__treeTags=new Map);let d=c.__treeTags.get(b);d||(d=new Set,c.__treeTags.set(b,d));a.forEach(function(a){d.add(a)});c._clearTagsCache(b)}}))}_getByTag(a){return this.__treeTags?(a=this.__treeTags.get(a))?l.setToArray(a):[]:[]}getTags(){return this.__tags?this.__tags:[]}setTags(a){a=a.reduce((a,b)=>a.concat(b.split(" ")),[]);this.__ref&&a.push(this.__ref);let b,c=a.length,d=[],e=[];for(b=0;b<c;b++)this.hasTag(a[b])||e.push(a[b]);let f=this.tags||[];c=f.length;for(b=0;b<
c;b++)-1==a.indexOf(f[b])&&d.push(f[b]);for(b=0;b<d.length;b++)this.removeTag(d[b]);for(b=0;b<e.length;b++)this.addTag(e[b])}addTag(a){if(-1===a.indexOf(" "))l.isUcChar(a.charCodeAt(0))&&this._throwError("Tag may not start with an upper case character."),this._addTag(a);else{a=a.split(" ");for(let b=0,c=a.length;b<c;b++){const c=a[b];l.isUcChar(c.charCodeAt(0))&&this._throwError("Tag may not start with an upper case character.");this._addTag(c)}}}_addTag(a){this.__tags||(this.__tags=[]);if(-1===this.__tags.indexOf(a)){this.__tags.push(a);
let b=this;do{b.__treeTags||(b.__treeTags=new Map);let c=b.__treeTags.get(a);c||(c=new Set,b.__treeTags.set(a,c));c.add(this);b._clearTagsCache(a)}while(!b.__tagRoot&&(b=b.__parent))}}removeTag(a){var b=this.__tags.indexOf(a);if(-1!==b){this.__tags.splice(b,1);b=this;do{let c=b.__treeTags.get(a);c&&(c.delete(this),b._clearTagsCache(a))}while(!b.__tagRoot&&(b=b.__parent))}}hasTag(a){return this.__tags&&-1!==this.__tags.indexOf(a)}_tag(a){return this.mtag(a)[0]}get tag(){return this._tag}set tag(a){this.tags=
a}mtag(a){let b=null;this.__tagsCache&&(b=this.__tagsCache.get(a));if(!b){if(0<=a.indexOf(".")){let c=a.split(".");b=this._getByTag(c[0]);let d=1,e=c.length;for(;b.length&&d<e;){let a=[];for(let e=0,f=b.length;e<f;e++)a=a.concat(b[e]._getByTag(c[d]));b=a;d++}}else b=this._getByTag(a);this.__tagsCache||(this.__tagsCache=new Map);this.__tagsCache.set(a,b)}return b}stag(a,b){a=this.mtag(a);let c=a.length;for(let d=0;d<c;d++)this.stage.patchObject(a[d],b)}get tagRoot(){return this.__tagRoot}set tagRoot(a){this.__tagRoot!==
a&&(a?this._unsetTagsParent():this._setTagsParent(),this.__tagRoot=a)}sel(a){a=this.select(a);if(a.length)return a[0]}select(a){if(-1!==a.indexOf(",")){a=a.split(",");let b=[];for(let c=0;c<a.length;c++)b=b.concat(this._select(a[c]));return b}return this._select(a)}_select(a){if(""===a)return[this];var b=a.indexOf(".");let c=a.indexOf(">");if(-1===b&&-1===c)return l.isUcChar(a.charCodeAt(0))?(a=this.getByRef(a))?[a]:[]:this.mtag(a);0===c?(b=!0,a=a.substr(1)):0===b?(b=!1,a=a.substr(1)):(b=a.charCodeAt(0),
b=l.isUcChar(b));return this._selectChilds(a,b)}_selectChilds(a,b){var c=a.indexOf("."),d=a.indexOf(">");if(-1===c&&-1===d)return b?(a=this.getByRef(a))?[a]:[]:this.mtag(a);if(-1===d||-1!==c&&c<d){d=a.substr(0,c);d=b?(d=this.getByRef(d))?[d]:[]:this.mtag(d);b=[];a=a.substr(c+1);for(let c=0,f=d.length;c<f;c++)b=b.concat(d[c]._selectChilds(a,!1));return b}c=a.substr(0,d);c=b?(c=this.getByRef(c))?[c]:[]:this.mtag(c);b=[];a=a.substr(d+1);for(let d=0,f=c.length;d<f;d++)b=b.concat(c[d]._selectChilds(a,
!0));return b}getByRef(a){return this.childList.getByRef(a)}getLocationString(){let a;a=this.__parent?this.__parent._children.getIndex(this):"R";let b=this.getTags(),c=this.__parent?this.__parent.getLocationString():"";return c=this.ref?c+(":["+a+"]"+this.ref):b.length?c+(":["+a+"]"+b.join(",")):c+(":["+a+"]#"+this.id)}toString(){let a=this.getSettings();return q.getPrettyString(a,"")}static getPrettyString(a,b){var c=a.children;delete a.children;let d=["color","colorUl","colorUr","colorBl","colorBr"];
a=JSON.stringify(a,function(a,b){return-1!==d.indexOf(a)?"COLOR["+b.toString(16)+"]":b});a=a.replace(/"COLOR\[([a-f0-9]{1,8})\]"/g,"0x$1");if(c){let d="";if(l.isObjectLiteral(c)){var e=Object.keys(c);d="";for(let a=0,f=e.length;a<f;a++)d+=`\n${b}  "${e[a]}":`,delete c[e[a]].ref,d+=q.getPrettyString(c[e[a]],b+"  ")+(a<f-1?",":"");c="{}"===a;a=a.substr(0,a.length-1)+(c?"":",")+d+"\n"+b+"}"}else{e=c.length;d="[";for(let a=0;a<e;a++)d+=q.getPrettyString(c[a],b+"  ")+(a<e-1?",":"")+"\n";d+=b+"]}";c="{}"===
a;a=a.substr(0,a.length-1)+(c?"":",")+'"children":\n'+b+d+"}"}}return a}getSettings(){let a=this.getNonDefaults(),b=this._children.get();if(b){let c=b.length;if(c){const d=[];let e=!1;for(let a=0;a<c;a++)d.push(b[a].getSettings()),e=e||!b[a].ref;e?a.children=d:(a.children={},d.forEach((b)=>{a.children[b.ref]=b}))}}a.id=this.id;return a}getNonDefaults(){let a={};this.constructor!==q&&(a.type=this.constructor.name);this.__ref&&(a.ref=this.__ref);this.__tags&&this.__tags.length&&(a.tags=this.__tags);
0!==this.x&&(a.x=this.x);0!==this.y&&(a.y=this.y);0!==this.w&&(a.w=this.w);0!==this.h&&(a.h=this.h);this.scaleX===this.scaleY?1!==this.scaleX&&(a.scale=this.scaleX):(1!==this.scaleX&&(a.scaleX=this.scaleX),1!==this.scaleY&&(a.scaleY=this.scaleY));this.pivotX===this.pivotY?.5!==this.pivotX&&(a.pivot=this.pivotX):(.5!==this.pivotX&&(a.pivotX=this.pivotX),.5!==this.pivotY&&(a.pivotY=this.pivotY));this.mountX===this.mountY?0!==this.mountX&&(a.mount=this.mountX):(0!==this.mountX&&(a.mountX=this.mountX),
0!==this.mountY&&(a.mountY=this.mountY));1!==this.alpha&&(a.alpha=this.alpha);this.visible||(a.visible=!1);0!==this.rotation&&(a.rotation=this.rotation);this.colorUl===this.colorUr&&this.colorBl===this.colorBr&&this.colorUl===this.colorBl?4294967295!==this.colorUl&&(a.color=this.colorUl.toString(16)):(4294967295!==this.colorUl&&(a.colorUl=this.colorUl.toString(16)),4294967295!==this.colorUr&&(a.colorUr=this.colorUr.toString(16)),4294967295!==this.colorBl&&(a.colorBl=this.colorBl.toString(16)),4294967295!==
this.colorBr&&(a.colorBr=this.colorBr.toString(16)));this.zIndex&&(a.zIndex=this.zIndex);this.forceZIndexContext&&(a.forceZIndexContext=!0);this.clipping&&(a.clipping=this.clipping);this.clipbox&&(a.clipbox=this.clipbox);if(this.__texture){let b=this.__texture.getNonDefaults();Object.keys(b).length&&(a.texture=b)}this._texturizer&&(this.texturizer.enabled&&(a.renderToTexture=this.texturizer.enabled),this.texturizer.lazy&&(a.renderToTextureLazy=this._texturizer.lazy),this._texturizer.colorize&&(a.colorizeResultTexture=
this._texturizer.colorize),this._texturizer.renderOffscreen&&(a.renderOffscreen=this._texturizer.renderOffscreen));return a}static getGetter(a){let b=q.PROP_GETTERS.get(a);b||(b=new Function("obj","return obj."+a),q.PROP_GETTERS.set(a,b));return b}static getSetter(a){let b=q.PROP_SETTERS.get(a);b||(b=new Function("obj","v","obj."+a+" = v"),q.PROP_SETTERS.set(a,b));return b}get withinBoundsMargin(){return this.__core._withinBoundsMargin}_enableWithinBoundsMargin(){this.__enabled&&this._setActiveFlag()}_disableWithinBoundsMargin(){this.__active&&
this._unsetActiveFlag()}set boundsMargin(a){if(!Array.isArray(a)&&null!==a&&void 0!==a)throw Error("boundsMargin should be an array of left-top-right-bottom values, null (no margin) or undefined (inherit margin)");this.__core.boundsMargin=a}get boundsMargin(){return this.__core.boundsMargin}get x(){return this.__core.x}set x(a){this.__core.x=a}get y(){return this.__core.y}set y(a){this.__core.y=a}get w(){return this.__core.w}set w(a){this.__core.w=a}get h(){return this.__core.h}set h(a){this.__core.h=
a}get scaleX(){return this.__core.scaleX}set scaleX(a){this.__core.scaleX=a}get scaleY(){return this.__core.scaleY}set scaleY(a){this.__core.scaleY=a}get scale(){return this.__core.scale}set scale(a){this.__core.scale=a}get pivotX(){return this.__core.pivotX}set pivotX(a){this.__core.pivotX=a}get pivotY(){return this.__core.pivotY}set pivotY(a){this.__core.pivotY=a}get pivot(){return this.__core.pivot}set pivot(a){this.__core.pivot=a}get mountX(){return this.__core.mountX}set mountX(a){this.__core.mountX=
a}get mountY(){return this.__core.mountY}set mountY(a){this.__core.mountY=a}get mount(){return this.__core.mount}set mount(a){this.__core.mount=a}get rotation(){return this.__core.rotation}set rotation(a){this.__core.rotation=a}get alpha(){return this.__core.alpha}set alpha(a){this.__core.alpha=a}get visible(){return this.__core.visible}set visible(a){this.__core.visible=a}get colorUl(){return this.__core.colorUl}set colorUl(a){this.__core.colorUl=a}get colorUr(){return this.__core.colorUr}set colorUr(a){this.__core.colorUr=
a}get colorBl(){return this.__core.colorBl}set colorBl(a){this.__core.colorBl=a}get colorBr(){return this.__core.colorBr}set colorBr(a){this.__core.colorBr=a}get color(){return this.__core.colorUl}set color(a){if(this.colorUl!==a||this.colorUr!==a||this.colorBl!==a||this.colorBr!==a)this.colorBr=this.colorBl=this.colorUr=this.colorUl=a}get colorTop(){return this.colorUl}set colorTop(a){if(this.colorUl!==a||this.colorUr!==a)this.colorUr=this.colorUl=a}get colorBottom(){return this.colorBl}set colorBottom(a){if(this.colorBl!==
a||this.colorBr!==a)this.colorBr=this.colorBl=a}get colorLeft(){return this.colorUl}set colorLeft(a){if(this.colorUl!==a||this.colorBl!==a)this.colorBl=this.colorUl=a}get colorRight(){return this.colorUr}set colorRight(a){if(this.colorUr!==a||this.colorBr!==a)this.colorBr=this.colorUr=a}get zIndex(){return this.__core.zIndex}set zIndex(a){this.__core.zIndex=a}get forceZIndexContext(){return this.__core.forceZIndexContext}set forceZIndexContext(a){this.__core.forceZIndexContext=a}get clipping(){return this.__core.clipping}set clipping(a){this.__core.clipping=
a}get clipbox(){return this.__core.clipbox}set clipbox(a){this.__core.clipbox=a}get tags(){return this.getTags()}set tags(a){Array.isArray(a)||(a=[a]);this.setTags(a)}set t(a){this.tags=a}get _children(){this.__childList||(this.__childList=new Fa(this,!1));return this.__childList}get childList(){this._allowChildrenAccess()||this._throwError("Direct access to children is not allowed in "+this.getLocationString());return this._children}hasChildren(){return this._allowChildrenAccess()&&this.__childList&&
0<this.__childList.length}_allowChildrenAccess(){return!0}get children(){return this.childList.get()}set children(a){this.childList.patch(a)}add(a){return this.childList.a(a)}get parent(){return this.__parent}get src(){if(this.texture&&this.texture instanceof Q)return this.texture._src}set src(a){this.texture=new Q(this.stage);this.texture.src=a}set mw(a){this.texture?this.texture.mw=a:this._throwError("Please set mw after setting a texture.")}set mh(a){this.texture?this.texture.mh=a:this._throwError("Please set mh after setting a texture.")}get rect(){return this.texture===
this.stage.rectangleTexture}set rect(a){this.texture=a?this.stage.rectangleTexture:null}enableTextTexture(){this.texture&&this.texture instanceof J||(this.texture=new J(this.stage),this.texture.w||this.texture.h||(this.texture.w=this.w,this.texture.h=this.h));return this.texture}get text(){if(this.texture&&this.texture instanceof J)return this.texture}set text(a){this.texture&&this.texture instanceof J||this.enableTextTexture();l.isString(a)?this.texture.text=a:this.texture.patch(a)}set onUpdate(a){this.__core.onUpdate=
a}set onAfterCalcs(a){this.__core.onAfterCalcs=a}set onAfterUpdate(a){this.__core.onAfterUpdate=a}forceUpdate(){this.__core._setHasUpdates()}get shader(){return this.__core.shader}set shader(a){if(a=M.create(this.stage,a))this.__enabled&&this.__core.shader&&this.__core.shader.removeView(this),this.__core.shader=a,this.__enabled&&this.__core.shader&&this.__core.shader.addView(this)}_hasTexturizer(){return!!this.__core._texturizer}get renderToTexture(){return this.rtt}set renderToTexture(a){this.rtt=
a}get rtt(){return this._hasTexturizer()&&this.texturizer.enabled}set rtt(a){this.texturizer.enabled=a}get rttLazy(){return this._hasTexturizer()&&this.texturizer.lazy}set rttLazy(a){this.texturizer.lazy=a}get renderOffscreen(){return this._hasTexturizer()&&this.texturizer.renderOffscreen}set renderOffscreen(a){this.texturizer.renderOffscreen=a}get colorizeResultTexture(){return this._hasTexturizer()&&this.texturizer.colorize}set colorizeResultTexture(a){this.texturizer.colorize=a}getTexture(){return this.texturizer._getTextureSource()}get texturizer(){return this.__core.texturizer}patch(a,
b=!1){E.preparePatchSettings(a,this.stage.getPatchId());let c=Object.keys(a);a.hasOwnProperty("__create")&&(b=a.__create);for(let e=0,f=c.length;e<f;e++){let f=c[e];const h=a[f];var d=f.indexOf(".");if(-1===f.indexOf(">")&&-1===d)if(d=f.charCodeAt(0),l.isUcChar(d))if(d=this.getByRef(f))void 0===h?d.parent&&d.parent.childList.remove(d):l.isObjectLiteral(h)?d.patch(h,b):h.isView?(h.ref=f,this.childList.replace(h,d)):this._throwError("Unexpected value for path: "+f);else{if(void 0!==h&&(d=b,l.isObjectLiteral(h)&&
h.hasOwnProperty("__create")&&(d=h.__create),null!==d))if(!0===d){let a;l.isObjectLiteral(h)?(a=this.childList.createItem(h),a.patch(h,d)):l.isObject(h)&&(a=h);a.isView&&(a.ref=f);this.childList.a(a)}else this._throwError("Can't find path: "+f)}else E.patchObjectProperty(this,f,h);else if(d=this.select(f),void 0===h)for(let a=0,b=d.length;a<b;a++)d[a].parent&&d[a].parent.childList.remove(d[a]);else if(l.isObjectLiteral(h))for(let a=0,c=d.length;a<c;a++)d[a].patch(h,b);else this._throwError("Unexpected value for path: "+
f)}}_throwError(a){throw Error(this.constructor.name+" ("+this.getLocationString()+"): "+a);}animation(a){return this.stage.animations.createAnimation(this,a)}transition(a,b){if(void 0===b)return this._getTransition(a);this._setTransition(a,b);return null}set transitions(a){Object.keys(a).forEach((b)=>{this.transition(b,a[b])})}set smooth(a){Object.keys(a).forEach((b)=>{let c=a[b];Array.isArray(c)?this.setSmooth(b,c[0],c[1]):this.setSmooth(b,c)})}fastForward(a){this._transitions&&(a=this._transitions[a])&&
a.isTransition&&a.finish()}_getTransition(a){this._transitions||(this._transitions={});let b=this._transitions[a];b?b.isTransitionSettings&&(b=new R(this.stage.transitions,b,this,a)):b=new R(this.stage.transitions,this.stage.transitions.defaultTransitionSettings,this,a);return this._transitions[a]=b}_setTransition(a,b){if(b){l.isObjectLiteral(b)&&(b=this.stage.transitions.createSettings(b));this._transitions||(this._transitions={});let c=this._transitions[a];if(c&&c.isTransition)return c.settings=
b,c;this._transitions[a]=b}else this._removeTransition(a)}_removeTransition(a){this._transitions&&delete this._transitions[a]}getSmooth(a,b){return(a=this._getTransition(a))&&a.isAttached()?a.targetValue:b}setSmooth(a,b,c){c&&this._setTransition(a,c);a=this._getTransition(a);a.start(b);return a}static isColorProperty(a){return 0<=a.indexOf("color")}static getMerger(a){return q.isColorProperty(a)?t.mergeColors:t.mergeNumbers}}v.addAsMixin(q);q.prototype.isView=1;q.id=1;q.PROP_GETTERS=new Map;q.PROP_SETTERS=
new Map;class x extends q{constructor(a,b){super(a);this.tagRoot=!0;l.isObjectLiteral(b)&&Object.assign(this,b);this.__state="";this.__firstEnable=this.__firstActive=this.__initialized=!1;this.__passSignals=this.__signals=void 0;this.__construct();a=this.constructor.getTemplateFunc(a);a.f(this,a.a)}static getTemplateFunc(a){a=a.getPatchId();const b="_templateFunc_"+a;this[b]||(this[b]=this.parseTemplate(a?"_$"+a:a,this._template()));return this[b]}static parseTemplate(a,b){const c={patchId:a,loc:[],
store:[],rid:0};b=E._preparePatchSettings(b,a);this.parseTemplateRec(b,c,"view");a=c.loc.join(";\n");return{f:new Function("view","store",a),a:c.store}}static parseTemplateRec(a,b,c){const d=b.store,e=b.loc;Object.keys(a).forEach((f)=>{let g=a[f];if(l.isUcChar(f.charCodeAt(0)))if(l.isObjectLiteral(g)){g=E._preparePatchSettings(g,b.patchId);var h=`r${f.replace(/[^a-z0-9]/gi,"")+b.rid}`,k=g.type?g.type:q;"View"===k?e.push(`const ${h} = view.stage.createView()`):(d.push(k),e.push(`const ${h} = new store[${d.length-
1}](${c}.stage)`));e.push(`${h}.ref = "${f}"`);b.rid++;this.parseTemplateRec(g,b,h);e.push(`${c}.childList.add(${h})`)}else l.isObject(g)&&(d.push(g),e.push(`${c}.childList.add(store[${d.length-1}])`));else"text"===f?(f=c+"__text",e.push(`${f} = ${c}.enableTextTexture()`),this.parseTemplatePropRec(g,b,f)):"texture"===f&&l.isObjectLiteral(g)?(h=c+"__texture",(k=g.type)?(d.push(k),e.push(`${h} = new store[${d.length-1}](${c}.stage)`),this.parseTemplatePropRec(g,b,h),e.push(`${c}["${f}"] = ${h}`)):(e.push(`${h} = ${c}.texture`),
this.parseTemplatePropRec(g,b,h))):l.isNumber(g)?e.push(`${c}["${f}"] = ${g}`):l.isBoolean(g)?e.push(`${c}["${f}"] = ${g?"true":"false"}`):l.isObject(g)||Array.isArray(g)?(d.push(g),e.push(`${c}["${f}"] = store[${d.length-1}]`)):e.push(`${c}["${f}"] = ${JSON.stringify(g)}`)})}static parseTemplatePropRec(a,b,c){const d=b.store,e=b.loc;Object.keys(a).forEach((b)=>{if("type"!==b){const f=a[b];l.isNumber(f)?e.push(`${c}["${b}"] = ${f}`):l.isBoolean(f)?e.push(`${c}["${b}"] = ${f?"true":"false"}`):l.isObject(f)||
Array.isArray(f)?(d.push(f),e.push(`${c}["${b}"] = store[${d.length-1}]`)):e.push(`${c}["${b}"] = ${JSON.stringify(f)}`)}})}_onSetup(){this.__initialized||this.fire("_setup")}_onAttach(){this.__initialized||(this.__init(),this.__initialized=!0);this.fire("_attach")}_onDetach(){this.fire("_detach")}_onEnabled(){this.__firstEnable||(this.fire("_firstEnable"),this.__firstEnable=!0);this.fire("_enable")}_onDisabled(){this.fire("_disable")}_onActive(){this.__firstActive||(this.fire("_firstActive"),this.__firstActive=
!0);this.fire("_active")}_onInactive(){this.fire("_inactive")}get application(){return this.stage.application}get state(){return this.__state}__construct(){this.fire("_construct")}__init(){this.fire("_init")}__focus(a,b){this.fire("_focus",{newTarget:a,prevTarget:b})}__unfocus(a){this.fire("_unfocus",{newTarget:a})}__focusBranch(a){this.fire("_focusBranch",{target:a})}__unfocusBranch(a,b){this.fire("_unfocusBranch",{target:a,newTarget:b})}__focusChange(a,b){this.fire("_focusChange",{target:a,newTarget:b})}_getFocused(){return this}_setFocusSettings(a){}_getStates(){this.constructor.__hasStates!==
this.constructor&&(this.constructor.__hasStates=this.constructor,this.constructor.__states=this.constructor._states(),l.isObjectLiteral(this.constructor.__states)||this._throwError("States object empty"));return this.constructor.__states}static _states(){return{}}_getTemplate(){this.constructor.__hasTemplate!==this.constructor&&(this.constructor.__hasTemplate=this.constructor,this.constructor.__template=this.constructor._template(),l.isObjectLiteral(this.constructor.__template)||this._throwError("Template object empty"));
return this.constructor.__template}static _template(){return{}}hasFinalFocus(){let a=this.application._focusPath;return a&&a.length&&a[a.length-1]===this}hasFocus(){let a=this.application._focusPath;return a&&0<=a.indexOf(this)}get cparent(){return x.getParent(this)}seekAncestorByType(a){let b=this.cparent;for(;b;){if(b.constructor===a)return b;b=b.cparent}}getSharedAncestorComponent(a){for(a=this.getSharedAncestor(a);a&&!a.isComponent;)a=a.parent;return a}fire(a,b={}){l.isObjectLiteral(b)||this._throwError("Fire: args must be object");
return this.application.stateManager.fire(this,a,b)}signal(a,b={},c=!1){l.isObjectLiteral(b)||this._throwError("Signal: args must be object");b._source||(b=Object.assign({_source:this},b));if(this.__signals&&this.cparent){var d=this.__signals[a];if(!1===d||d&&(!0===d&&(d=a),this.cparent.fire(d,b)))return}d=this.__passSignals&&this.__passSignals[a];const e=this.cparent;e&&(e._passSignals||d||c)&&(d&&!0!==d&&(a=d),this.cparent.signal(a,b,c))}get signals(){return this.__signals}set signals(a){l.isObjectLiteral(a)||
this._throwError("Signals: specify an object with signal-to-fire mappings");this.__signals=Object.assign(this.__signals||{},a)}get passSignals(){return this.__passSignals||{}}set passSignals(a){this.__passSignals=Object.assign(this.__passSignals||{},a)}get _passSignals(){return!1}broadcast(a,b={}){l.isObjectLiteral(b)||this._throwError("Broadcast: args must be object");b._source||(b=Object.assign({_source:this},b));if(this.__broadcasts){var c=this.__broadcasts[a];if(!1===c||c&&(!0===c&&(c=a),this.fire(c,
b)))return}c=[];x.collectSubComponents(c,this);for(let d=0,e=c.length;d<e;d++)c[d].broadcast(a,b)}static collectSubComponents(a,b){if(b.hasChildren()){b=b.__childList;for(let c=0,d=b.length;c<d;c++){const d=b.getAt(c);d.isComponent?a.push(d):x.collectSubComponents(a,d)}}}get broadcasts(){return this.__broadcasts}set broadcasts(a){l.isObjectLiteral(a)||this._throwError("Broadcasts: specify an object with broadcast-to-fire mappings");this.__broadcasts=Object.assign(this.__broadcasts||{},a)}static getComponent(a){for(;a&&
!a.isComponent;)a=a.parent;return a}static getParent(a){return x.getComponent(a.parent)}}x.prototype.isComponent=!0;class la{constructor(a){this.ctx=a;this.quadTextures=[];this.quadViews=[]}get length(){return this.quadTextures.length}reset(){this.quadTextures=[];this.quadViews=[];this.dataLength=0}getView(a){return this.quadViews[a]._view}getViewCore(a){return this.quadViews[a]}getTexture(a){return this.quadTextures[a]}getTextureWidth(a){let b=this.quadTextures[a];return b.w?b.w:this.quadViews[a]._displayedTextureSource.w}getTextureHeight(a){let b=
this.quadTextures[a];return b.h?b.h:this.quadViews[a]._displayedTextureSource.h}}class Ga extends la{constructor(a){super(a);a=a.stage.getOption("bufferMemory");this.dataLength=0;this.data=new ArrayBuffer(a);this.floats=new Float32Array(this.data);this.uints=new Uint32Array(this.data);a=this.floats;let b=this.uints;a[0]=-1;a[1]=-1;a[2]=0;a[3]=0;b[4]=4294967295;a[5]=1;a[6]=-1;a[7]=1;a[8]=0;b[9]=4294967295;a[10]=1;a[11]=1;a[12]=1;a[13]=1;b[14]=4294967295;a[15]=-1;a[16]=1;a[17]=0;a[18]=1;b[19]=4294967295}getAttribsDataByteOffset(a){return 80*
a+80}getQuadContents(){let a=this.floats,b=this.uints,c=[];for(let d=1;d<=this.length;d++){let e="entry "+d+": ";for(let c=0;4>c;c++){let f=20*d+4*c;e+=a[f]+","+a[f+1]+":"+a[f+2]+","+a[f+3]+"["+b[f+4].toString(16)+"] "}c.push(e)}return c}}class ma{constructor(a,b,c,d,e,f){this.ctx=a;this.shader=b;this.shaderOwner=c;this.renderTextureInfo=d;this.scissor=e;this.index=f;this.length=0}get quads(){return this.ctx.renderState.quads}getTexture(a){return this.quads.getTexture(this.index+a)}getViewCore(a){return this.quads.getViewCore(this.index+
a)}getView(a){return this.quads.getView(this.index+a)}getViewWidth(a){return this.getView(a).renderWidth}getViewHeight(a){return this.getView(a).renderHeight}getTextureWidth(a){return this.quads.getTextureWidth(this.index+a)}getTextureHeight(a){return this.quads.getTextureHeight(this.index+a)}getRenderWidth(){return this.renderTextureInfo?this.renderTextureInfo.w:this.ctx.stage.w}getRenderHeight(){return this.renderTextureInfo?this.renderTextureInfo.h:this.ctx.stage.h}}class Ha extends ma{constructor(a,
b,c,d,e,f){super(a,b,c,d,e,f);this.extraAttribsDataByteOffset=0}getAttribsDataByteOffset(a){return this.quads.getAttribsDataByteOffset(this.index+a)}getNormalRenderTextureCoords(a,b){a=this.shaderOwner.getRenderTextureCoords(a,b);a[0]/=this.getRenderWidth();a[1]/=this.getRenderHeight();a[0]=2*a[0]-1;a[1]=1-2*a[1];return a}getProjection(){return null===this.renderTextureInfo?this.ctx.renderExec._projection:this.renderTextureInfo.nativeTexture.projection}}class na{constructor(a){this.ctx=a;this.renderState=
a.renderState;this.gl=this.ctx.stage.gl}destroy(){}_reset(){this._bindRenderTexture(null);this._setScissor(null);this._clearRenderTexture()}execute(){this._reset();let a=this.renderState.quadOperations,b=0,c=a.length;for(;b<c;)this._processQuadOperation(a[b]),b++}_processQuadOperation(a){a.renderTextureInfo&&a.renderTextureInfo.ignore||(this._setupQuadOperation(a),this._execQuadOperation(a))}_setupQuadOperation(a){}_execQuadOperation(a){let b=a.renderTextureInfo?a.renderTextureInfo.nativeTexture:
null;this._renderTexture!==b&&this._bindRenderTexture(b);a.renderTextureInfo&&!a.renderTextureInfo.cleared&&(this._setScissor(null),this._clearRenderTexture(),a.renderTextureInfo.cleared=!0);this._setScissor(a.scissor);this._renderQuadOperation(a)}_renderQuadOperation(a){}_bindRenderTexture(a){this._renderTexture=a}_clearRenderTexture(a){}_setScissor(a){}}class Ia extends na{constructor(a){super(a);this.gl=this.ctx.stage.gl;this.init()}init(){let a=this.gl;this._attribsBuffer=a.createBuffer();let b=
Math.floor(this.renderState.quads.data.byteLength/80),c=new Uint16Array(6*b);for(let a=0,e=0;a<b;a+=6,e+=4)c[a]=e,c[a+1]=e+1,c[a+2]=e+2,c[a+3]=e,c[a+4]=e+2,c[a+5]=e+3;this._quadsBuffer=a.createBuffer();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this._quadsBuffer);a.bufferData(a.ELEMENT_ARRAY_BUFFER,c,a.STATIC_DRAW);this._projection=new Float32Array([2/this.ctx.stage.rw,-2/this.ctx.stage.rh])}destroy(){super.destroy();this.gl.deleteBuffer(this._attribsBuffer);this.gl.deleteBuffer(this._quadsBuffer)}_reset(){super._reset();
let a=this.gl;a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA);a.enable(a.BLEND);a.disable(a.DEPTH_TEST);this._stopShaderProgram();this._setupBuffers()}_setupBuffers(){let a=this.gl;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this._quadsBuffer);let b=new DataView(this.renderState.quads.data,0,this.renderState.quads.dataLength);a.bindBuffer(a.ARRAY_BUFFER,this._attribsBuffer);a.bufferData(a.ARRAY_BUFFER,b,a.DYNAMIC_DRAW)}_setupQuadOperation(a){super._setupQuadOperation(a);this._useShaderProgram(a.shader,a)}_renderQuadOperation(a){let b=
a.shader;if(a.length||a.shader.addEmpty())b.beforeDraw(a),b.draw(a),b.afterDraw(a)}_useShaderProgram(a,b){a.hasSameProgram(this._currentShaderProgram)||(this._currentShaderProgram&&this._currentShaderProgram.stopProgram(),a.useProgram(),this._currentShaderProgram=a);a.setupUniforms(b)}_stopShaderProgram(){this._currentShaderProgram&&(this._currentShaderProgram.stopProgram(),this._currentShaderProgram=null)}_bindRenderTexture(a){super._bindRenderTexture(a);a=this.gl;this._renderTexture?(a.bindFramebuffer(a.FRAMEBUFFER,
this._renderTexture.framebuffer),a.viewport(0,0,this._renderTexture.w,this._renderTexture.h)):(a.bindFramebuffer(a.FRAMEBUFFER,null),a.viewport(0,0,this.ctx.stage.w,this.ctx.stage.h))}_clearRenderTexture(){super._clearRenderTexture();let a=this.gl;if(this._renderTexture)a.clearColor(0,0,0,0),a.clear(a.COLOR_BUFFER_BIT);else{let b=this.ctx.stage.getClearColor();b&&(a.clearColor(b[0]*b[3],b[1]*b[3],b[2]*b[3],b[3]),a.clear(a.COLOR_BUFFER_BIT))}}_setScissor(a){super._setScissor(a);if(this._scissor!==
a){this._scissor=a;var b=this.gl;if(a){b.enable(b.SCISSOR_TEST);let c=this.ctx.stage.getRenderPrecision(),d=a[1];null===this._renderTexture&&(d=this.ctx.stage.h/c-(a[1]+a[3]));b.scissor(Math.round(a[0]*c),Math.round(d*c),Math.round(a[2]*c),Math.round(a[3]*c))}else b.disable(b.SCISSOR_TEST)}}}class oa{constructor(a){this.ctx=a;this.stage=a.stage;this.defaultShader=this.stage.renderer.getDefaultShader(a);this.renderer=a.stage.renderer;this.quads=this.renderer.createCoreQuadList(a)}reset(){this._realShader=
this._shaderOwner=this._shader=this._scissor=this._renderTextureInfo=null;this._check=!1;this.quadOperations=[];this._texturizer=null;this._texturizerTemporary=!1;this._quadOperation=null;this.quads.reset();this._temporaryTexturizers=[];this._isCachingTexturizer=!1}get length(){return this.quads.quadTextures.length}setShader(a,b){if(this._shaderOwner!==b||this._realShader!==a)if(this._realShader=a,a.useDefault()&&(a=this.defaultShader),this._shader!==a||this._shaderOwner!==b)this._shader=a,this._shaderOwner=
b,this._check=!0}get renderTextureInfo(){return this._renderTextureInfo}setScissor(a){this._scissor!==a&&(this._scissor=a?a:null,this._check=!0)}getScissor(){return this._scissor}setRenderTextureInfo(a){this._renderTextureInfo!==a&&(this._renderTextureInfo=a,this._scissor=null,this._check=!0)}setTexturizer(a,b=!1){this._texturizer=a;this._cacheTexturizer=b}set isCachingTexturizer(a){this._isCachingTexturizer=a}get isCachingTexturizer(){return this._isCachingTexturizer}addQuad(a){this._quadOperation?
this._check&&this._hasChanges()&&(this._finishQuadOperation(),this._check=!1):this._createQuadOperation();let b=null;this._texturizer&&(b=this._texturizer.getResultTexture(),this._cacheTexturizer||this._temporaryTexturizers.push(this._texturizer));b||(b=a._displayedTextureSource.nativeTexture);this._renderTextureInfo&&(this._shader===this.defaultShader&&this._renderTextureInfo.empty?(this._renderTextureInfo.nativeTexture=b,this._renderTextureInfo.offset=this.length):this._renderTextureInfo.nativeTexture=
null,this._renderTextureInfo.empty=!1);this.quads.quadTextures.push(b);this.quads.quadViews.push(a);this._quadOperation.length++;this.renderer.addQuad(this,this.quads,this.length-1)}finishedRenderTexture(){this._renderTextureInfo.nativeTexture&&!this._isRenderTextureReusable()&&(this._renderTextureInfo.nativeTexture=null)}_isRenderTextureReusable(){const a=this._renderTextureInfo.offset;return this.quads.quadTextures[a].w===this._renderTextureInfo.w&&this.quads.quadTextures[a].h===this._renderTextureInfo.h&&
this.renderer.isRenderTextureReusable(this,this._renderTextureInfo)}_hasChanges(){let a=this._quadOperation;return this._shader!==a.shader||this._shaderOwner!==a.shaderOwner||this._renderTextureInfo!==a.renderTextureInfo||this._scissor!==a.scissor&&(this._scissor[0]!==a.scissor[0]||this._scissor[1]!==a.scissor[1]||this._scissor[2]!==a.scissor[2]||this._scissor[3]!==a.scissor[3])?!0:!1}_finishQuadOperation(a=!0){if(this._quadOperation){(this._quadOperation.length||this._shader.addEmpty())&&(!this._quadOperation.scissor||
0<this._quadOperation.scissor[2]&&0<this._quadOperation.scissor[3])&&this.quadOperations.push(this._quadOperation);if(this._temporaryTexturizers.length){for(let a=0,c=this._temporaryTexturizers.length;a<c;a++)this._temporaryTexturizers[a].releaseRenderTexture();this._temporaryTexturizers=[]}this._quadOperation=null}a&&this._createQuadOperation()}_createQuadOperation(){this._quadOperation=this.renderer.createCoreQuadOperation(this.ctx,this._shader,this._shaderOwner,this._renderTextureInfo,this._scissor,
this.length);this._check=!1}finish(){this._quadOperation&&this._finishQuadOperation(!1);this.renderer.finishRenderState(this)}}class Ja{constructor(a,b){this.vertexShaderSource=a;this.fragmentShaderSource=b;this._program=null;this._uniformLocations=new Map;this._attributeLocations=new Map;this._currentUniformValues={}}compile(a){if(!this._program){this.gl=a;this._program=a.createProgram();var b=this._glCompile(a.VERTEX_SHADER,this.vertexShaderSource),c=this._glCompile(a.FRAGMENT_SHADER,this.fragmentShaderSource);
a.attachShader(this._program,b);a.attachShader(this._program,c);a.linkProgram(this._program);a.getProgramParameter(this._program,a.LINK_STATUS)||(console.error("Error: Could not initialize shader."),console.error("gl.VALIDATE_STATUS",a.getProgramParameter(this._program,a.VALIDATE_STATUS)),console.error("gl.getError()",a.getError()),""!==a.getProgramInfoLog(this._program)&&console.warn("Warning: gl.getProgramInfoLog()",a.getProgramInfoLog(this._program)),a.deleteProgram(this._program),this._program=
null);a.deleteShader(b);a.deleteShader(c)}}_glCompile(a,b){let c=this.gl.createShader(a);this.gl.shaderSource(c,b);this.gl.compileShader(c);if(!this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS)){console.log(this.constructor.name,"Type: "+(a===this.gl.VERTEX_SHADER?"vertex shader":"fragment shader"));console.log(this.gl.getShaderInfoLog(c));let d=0;console.log("========== source ==========\n"+b.split("\n").map((a)=>""+ ++d+": "+a).join("\n"));return null}return c}getUniformLocation(a){let b=this._uniformLocations.get(a);
void 0===b&&(b=this.gl.getUniformLocation(this._program,a),this._uniformLocations.set(a,b));return b}getAttribLocation(a){let b=this._attributeLocations.get(a);void 0===b&&(b=this.gl.getAttribLocation(this._program,a),this._attributeLocations.set(a,b));return b}destroy(){this._program&&(this.gl.deleteProgram(this._program),this._program=null)}get glProgram(){return this._program}get compiled(){return!!this._program}_valueEquals(a,b){if(a.length&&b.length){for(let c=0,d=a.length;c<d;c++)if(a[c]!==
b[c])return!1;return!0}return a===b}_valueClone(a){return a.length?a.slice(0):a}setUniformValue(a,b,c){let d=this._currentUniformValues[a];void 0!==d&&this._valueEquals(d,b)||(b=this._valueClone(b),this._currentUniformValues[a]=b,(a=this.getUniformLocation(a))&&(c===this.gl.uniformMatrix2fv||c===this.gl.uniformMatrix3fv||c===this.gl.uniformMatrix4fv?c.call(this.gl,a,!1,b):c.call(this.gl,a,b)))}}class S extends M{constructor(a){super(a);a=a.stage;this._program=a.renderer.shaderPrograms.get(this.constructor);
this._program||(this._program=new Ja(this.constructor.vertexShaderSource,this.constructor.fragmentShaderSource),a.renderer.shaderPrograms.set(this.constructor,this._program));this.gl=a.gl}get glProgram(){return this._program.glProgram}_init(){this._initialized||(this.initialize(),this._initialized=!0)}initialize(){this._program.compile(this.gl)}get initialized(){return this._initialized}_uniform(a){return this._program.getUniformLocation(a)}_attrib(a){return this._program.getAttribLocation(a)}_setUniform(a,
b,c){this._program.setUniformValue(a,b,c)}useProgram(){this._init();this.gl.useProgram(this.glProgram);this.beforeUsage();this.enableAttribs()}stopProgram(){this.afterUsage();this.disableAttribs()}hasSameProgram(a){return a&&(a===this||a._program===this._program)}beforeUsage(){}afterUsage(){}enableAttribs(){}disableAttribs(){}getExtraAttribBytesPerVertex(){return 0}getVertexAttribPointerOffset(a){return a.extraAttribsDataByteOffset-4*(a.index+1)*this.getExtraAttribBytesPerVertex()}setExtraAttribsInBuffer(a){}setupUniforms(a){}_getProjection(a){return a.getProjection()}getFlipY(a){return 0>
this._getProjection(a)[1]}beforeDraw(a){}draw(a){}afterDraw(a){}cleanup(){this._initialized=!1}}class w extends S{enableAttribs(){let a=this.gl;a.vertexAttribPointer(this._attrib("aVertexPosition"),2,a.FLOAT,!1,20,0);a.enableVertexAttribArray(this._attrib("aVertexPosition"));-1!==this._attrib("aTextureCoord")&&(a.vertexAttribPointer(this._attrib("aTextureCoord"),2,a.FLOAT,!1,20,8),a.enableVertexAttribArray(this._attrib("aTextureCoord")));-1!==this._attrib("aColor")&&(a.vertexAttribPointer(this._attrib("aColor"),
4,a.UNSIGNED_BYTE,!0,20,16),a.enableVertexAttribArray(this._attrib("aColor")))}disableAttribs(){let a=this.gl;a.disableVertexAttribArray(this._attrib("aVertexPosition"));-1!==this._attrib("aTextureCoord")&&a.disableVertexAttribArray(this._attrib("aTextureCoord"));-1!==this._attrib("aColor")&&a.disableVertexAttribArray(this._attrib("aColor"))}setupUniforms(a){this._setUniform("projection",this._getProjection(a),this.gl.uniform2fv,!1)}draw(a){let b=this.gl,c=a.length;if(c){let d=a.getTexture(0),e=0;
for(let f=0;f<c;f++){let c=a.getTexture(f);d!==c&&(b.bindTexture(b.TEXTURE_2D,d),b.drawElements(b.TRIANGLES,6*(f-e),b.UNSIGNED_SHORT,12*(e+a.index+1)),d=c,e=f)}e<c&&(b.bindTexture(b.TEXTURE_2D,d),b.drawElements(b.TRIANGLES,6*(c-e),b.UNSIGNED_SHORT,12*(e+a.index+1)))}}}w.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n";
w.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    void main(void){\n        gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;\n    }\n";class pa{constructor(a){this.stage=a;this._defaultShader=void 0}getDefaultShader(a=this.stage.ctx){this._defaultShader||(this._defaultShader=this._createDefaultShader(a));return this._defaultShader}_createDefaultShader(a){}isValidShaderType(a){return a.prototype instanceof
this._getShaderBaseType()}createShader(a,b){const c=b.type||DefaultShader;if(this.isValidShaderType(c))return a=new c(a),this.stage.patchObject(this,b),a;b=this._getShaderAlternative(c);return b?new b(a):(console.warn("Shader has no implementation for render target: "+c.name),this._createDefaultShader(a))}_getShaderBaseType(){}_getShaderAlternative(a){return this.getDefaultShader()}getPatchId(){}copyRenderTexture(a,b,c){console.warn("copyRenderTexture not supported by renderer")}}class Ka extends pa{constructor(a){super(a);
this.shaderPrograms=new Map}destroy(){this.shaderPrograms.forEach((a)=>a.destroy())}_createDefaultShader(a){return new w(a)}_getShaderBaseType(){return S}_getShaderAlternative(a){return a.getWebGL&&a.getWebGL()}createCoreQuadList(a){return new Ga(a)}createCoreQuadOperation(a,b,c,d,e,f){return new Ha(a,b,c,d,e,f)}createCoreRenderExecutor(a){return new Ia(a)}createCoreRenderState(a){return new oa(a)}createRenderTexture(a,b,c,d){const e=this.stage.gl,f=e.createTexture();e.bindTexture(e.TEXTURE_2D,f);
e.texImage2D(e.TEXTURE_2D,0,e.RGBA,c,d,0,e.RGBA,e.UNSIGNED_BYTE,null);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);f.params={};f.params[e.TEXTURE_MAG_FILTER]=e.LINEAR;f.params[e.TEXTURE_MIN_FILTER]=e.LINEAR;f.params[e.TEXTURE_WRAP_S]=e.CLAMP_TO_EDGE;f.params[e.TEXTURE_WRAP_T]=e.CLAMP_TO_EDGE;f.options=
{format:e.RGBA,internalFormat:e.RGBA,type:e.UNSIGNED_BYTE};f.framebuffer=e.createFramebuffer();f.projection=new Float32Array([2/a,2/b]);e.bindFramebuffer(e.FRAMEBUFFER,f.framebuffer);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,f,0);return f}freeRenderTexture(a){let b=this.stage.gl;b.deleteFramebuffer(a.framebuffer);b.deleteTexture(a)}uploadTextureSource(a,b){const c=this.stage.gl,d=b.source;var e=!0,f=!0;b&&b.hasOwnProperty("premultiplyAlpha")&&(e=b.premultiplyAlpha);if(b&&
b.hasOwnProperty("flipBlueRed"))var g=b.flipBlueRed;b&&b.hasOwnProperty("hasAlpha")&&(f=b.hasAlpha);f||(e=!1);var h=b.texParams||{};b=b.texOptions||{};let k=c.createTexture();c.bindTexture(c.TEXTURE_2D,k);c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e);l.isNode&&c.pixelStorei(c.UNPACK_FLIP_BLUE_RED,!!g);h[c.TEXTURE_MAG_FILTER]||(h[c.TEXTURE_MAG_FILTER]=c.LINEAR);h[c.TEXTURE_MIN_FILTER]||(h[c.TEXTURE_MIN_FILTER]=c.LINEAR);h[c.TEXTURE_WRAP_S]||(h[c.TEXTURE_WRAP_S]=c.CLAMP_TO_EDGE);h[c.TEXTURE_WRAP_T]||
(h[c.TEXTURE_WRAP_T]=c.CLAMP_TO_EDGE);Object.keys(h).forEach((a)=>{const b=h[a];c.texParameteri(c.TEXTURE_2D,parseInt(a),b)});b.format=b.format||(f?c.RGBA:c.RGB);b.type=b.type||c.UNSIGNED_BYTE;b.internalFormat=b.internalFormat||b.format;this.stage.platform.uploadGlTexture(c,a,d,b);k.params=l.cloneObjShallow(h);k.options=l.cloneObjShallow(b);return k}freeTextureSource(a){this.stage.gl.deleteTexture(a.nativeTexture)}addQuad(a,b,c){let d=20*c+20;b=b.quadViews[c];c=b._renderContext;let e=a.quads.floats;
a=a.quads.uints;const f=t.mergeColorAlpha;if(0!==c.tb||0!==c.tc)e[d++]=c.px,e[d++]=c.py,e[d++]=b._ulx,e[d++]=b._uly,a[d++]=f(b._colorUl,c.alpha),e[d++]=c.px+b._rw*c.ta,e[d++]=c.py+b._rw*c.tc,e[d++]=b._brx,e[d++]=b._uly,a[d++]=f(b._colorUr,c.alpha),e[d++]=c.px+b._rw*c.ta+b._rh*c.tb,e[d++]=c.py+b._rw*c.tc+b._rh*c.td,e[d++]=b._brx,e[d++]=b._bry,a[d++]=f(b._colorBr,c.alpha),e[d++]=c.px+b._rh*c.tb,e[d++]=c.py+b._rh*c.td;else{let g=c.px+b._rw*c.ta,h=c.py+b._rh*c.td;e[d++]=c.px;e[d++]=c.py;e[d++]=b._ulx;
e[d++]=b._uly;a[d++]=f(b._colorUl,c.alpha);e[d++]=g;e[d++]=c.py;e[d++]=b._brx;e[d++]=b._uly;a[d++]=f(b._colorUr,c.alpha);e[d++]=g;e[d++]=h;e[d++]=b._brx;e[d++]=b._bry;a[d++]=f(b._colorBr,c.alpha);e[d++]=c.px;e[d++]=h}e[d++]=b._ulx;e[d++]=b._bry;a[d]=f(b._colorBl,c.alpha)}isRenderTextureReusable(a,b){let c=(80*a._renderTextureInfo.offset+80)/4,d=a.quads.floats;a=a.quads.uints;return 0===d[c]&&0===d[c+1]&&0===d[c+2]&&0===d[c+3]&&4294967295===a[c+4]&&d[c+5]===b.w&&0===d[c+6]&&1===d[c+7]&&0===d[c+8]&&
4294967295===a[c+9]&&d[c+10]===b.w&&d[c+11]===b.h&&1===d[c+12]&&1===d[c+13]&&4294967295===a[c+14]&&0===d[c+15]&&d[c+16]===b.h&&0===d[c+17]&&1===d[c+18]&&4294967295===a[c+19]}finishRenderState(a){let b=80*a.length+80;for(let c=0,d=a.quadOperations.length;c<d;c++){a.quadOperations[c].extraAttribsDataByteOffset=b;let d=4*a.quadOperations[c].shader.getExtraAttribBytesPerVertex()*a.quadOperations[c].length;b+=d;d&&a.quadOperations[c].shader.setExtraAttribsInBuffer(a.quadOperations[c],a.quads)}a.quads.dataLength=
b}getPatchId(){return"webgl"}copyRenderTexture(a,b,c){const d=this.stage.gl;d.bindTexture(d.TEXTURE_2D,b);d.bindFramebuffer(d.FRAMEBUFFER,a.framebuffer);b=a.precision;d.copyTexSubImage2D(d.TEXTURE_2D,0,b*(c.sx||0),b*(c.sy||0),b*(c.x||0),b*(c.y||0),b*(c.w||a.ow),b*(c.h||a.oh))}}class La extends la{constructor(a){super(a);this.renderContexts=[];this.modes=[]}setRenderContext(a,b){this.renderContexts[a]=b}setSimpleTc(a,b){this.modes[a]=b?this.modes[a]|1:this.modes[a]-(this.modes[a]&1)}setWhite(a,b){this.modes[a]=
b?this.modes[a]|2:this.modes[a]-(this.modes[a]&2)}getRenderContext(a){return this.renderContexts[a]}getSimpleTc(a){return this.modes[a]&1}getWhite(a){return this.modes[a]&2}}class Ma extends ma{getRenderContext(a){return this.quads.getRenderContext(this.index+a)}getSimpleTc(a){return this.quads.getSimpleTc(this.index+a)}getWhite(a){return this.quads.getWhite(this.index+a)}}class qa extends na{init(){this._mainRenderTexture=this.ctx.stage.getCanvas()}_renderQuadOperation(a){let b=a.shader;if(a.length||
a.shader.addEmpty()){const c=this._renderTexture||this._mainRenderTexture;b.beforeDraw(a,c);b.draw(a,c);b.afterDraw(a,c)}}_clearRenderTexture(){const a=this._getContext();let b=[0,0,0,0];this._mainRenderTexture.ctx===a&&(b=this.ctx.stage.getClearColor());const c=a.canvas;a.setTransform(1,0,0,1,0,0);b[0]||b[1]||b[2]||b[3]?(a.fillStyle=t.getRgbaStringFromArray(b),a.globalCompositeOperation="copy",a.beginPath(),a.rect(0,0,c.width,c.height),a.closePath(),a.fill(),a.globalCompositeOperation="source-over"):
a.clearRect(0,0,c.width,c.height)}_getContext(){return this._renderTexture?this._renderTexture.ctx:this._mainRenderTexture.ctx}_restoreContext(){const a=this._getContext();a.restore();a.save();a._scissor=null}_setScissor(a){const b=this._getContext();if(!qa._equalScissorAreas(b.canvas,b._scissor,a)){this._restoreContext();let c=this.ctx.stage.getRenderPrecision();a&&(b.beginPath(),b.rect(Math.round(a[0]*c),Math.round(a[1]*c),Math.round(a[2]*c),Math.round(a[3]*c)),b.closePath(),b.clip());b._scissor=
a}}static _equalScissorAreas(a,b,c){b||(b=[0,0,a.width,a.height]);c||(c=[0,0,a.width,a.height]);return l.equalValues(b,c)}}class T extends M{beforeDraw(a){}draw(a){}afterDraw(a){}}class N extends T{constructor(a){super(a);this._rectangleTexture=a.stage.rectangleTexture.source.nativeTexture}draw(a,b){const c=b.ctx;let d=a.length;for(let m=0;m<d;m++){const d=a.getTexture(m),l=a.getViewCore(m);var e=a.getRenderContext(m),f=a.getWhite(m),g=a.getSimpleTc(m),h=this.ctx.stage.getRenderPrecision();c.setTransform(e.ta*
h,e.tc*h,e.tb*h,e.td*h,e.px*h,e.py*h);var k=d===this._rectangleTexture;h={operation:a,target:b,index:m,rect:k};if(k)f?c.fillStyle="white":this._setColorGradient(c,l),c.globalAlpha=e.alpha,this._beforeDrawEl(h),c.fillRect(0,0,l.rw,l.rh);else{c.globalAlpha=e.alpha;this._beforeDrawEl(h);e=g?0:l._ulx*d.w;k=g?0:l._uly*d.h;const a=(g?1:l._brx-l._ulx)*d.w;g=(g?1:l._bry-l._uly)*d.h;f?c.drawImage(d,e,k,a,g,0,0,l.rw,l.rh):(f=document.createElement("canvas"),f.width=Math.ceil(a),f.height=Math.ceil(g),f.ctx=
f.getContext("2d"),4278190080>l._colorUl||4278190080>l._colorUr||4278190080>l._colorBl||4278190080>l._colorBr?(f.ctx.globalCompositeOperation="copy",f.ctx.drawImage(d,e,k,a,g,0,0,a,g),f.ctx.globalCompositeOperation="multiply",this._setColorGradient(f.ctx,l,a,g,!1),f.ctx.fillRect(0,0,a,g),this._setColorGradient(f.ctx,l,a,g,!0),f.ctx.globalCompositeOperation="destination-in",f.ctx.fillRect(0,0,a,g)):(this._setColorGradient(f.ctx,l,a,g,!1),f.ctx.globalCompositeOperation="copy",f.ctx.fillRect(0,0,a,g),
f.ctx.globalCompositeOperation="multiply",f.ctx.drawImage(d,e,k,a,g,0,0,a,g),f.ctx.globalCompositeOperation="destination-in",f.ctx.drawImage(d,e,k,a,g,0,0,a,g)),f.ctx.globalCompositeOperation="source-over",c.fillStyle="white",c.drawImage(f,0,0,a,g,0,0,l.rw,l.rh))}this._afterDrawEl(h);c.globalAlpha=1}}_setColorGradient(a,b,c=b.rw,d=b.rh,e=!0){let f=b._colorUl,g;b._colorUl===b._colorUr?b._colorBl===b._colorBr&&b._colorUl!==b.colorBl&&(g=a.createLinearGradient(0,0,0,d),e?(g.addColorStop(0,t.getRgbaString(b._colorUl)),
g.addColorStop(1,t.getRgbaString(b._colorBl))):(g.addColorStop(0,t.getRgbString(b._colorUl)),g.addColorStop(1,t.getRgbString(b._colorBl)))):b._colorUl===b._colorBl&&b._colorUr===b._colorBr&&(g=a.createLinearGradient(0,0,c,0),e?(g.addColorStop(0,t.getRgbaString(b._colorUl)),g.addColorStop(1,t.getRgbaString(b._colorBr))):(g.addColorStop(0,t.getRgbString(b._colorUl)),g.addColorStop(1,t.getRgbString(b._colorBr))));a.fillStyle=g||t.getRgbaString(f)}_beforeDrawEl(a){}_afterDrawEl(a){}}class Na extends pa{constructor(a){super(a);
this.setupC2d(this.stage.c2d.canvas)}_createDefaultShader(a){return new N(a)}_getShaderBaseType(){return T}_getShaderAlternative(a){return a.getC2d&&a.getC2d()}createCoreQuadList(a){return new La(a)}createCoreQuadOperation(a,b,c,d,e,f){return new Ma(a,b,c,d,e,f)}createCoreRenderExecutor(a){return new qa(a)}createCoreRenderState(a){return new oa(a)}createRenderTexture(a,b,c,d){a=document.createElement("canvas");a.width=c;a.height=d;this.setupC2d(a);return a}freeRenderTexture(a){}uploadTextureSource(a,
b){return b.source.buffer?(a=document.createElement("canvas"),a.width=b.w,a.height=b.h,b=new ImageData(new Uint8ClampedArray(b.source.buffer),b.w,b.h),a.getContext("2d").putImageData(b,0,0),a):b.source}freeTextureSource(a){}addQuad(a,b,c){a=b.quadViews[c];b.setRenderContext(c,a._renderContext);b.setWhite(c,a.isWhite());b.setSimpleTc(c,a.hasSimpleTexCoords())}isRenderTextureReusable(a,b){return!1}finishRenderState(a){}setupC2d(a){const b=a.getContext("2d");a.ctx=b;b._scissor=null;a.ctx.save()}getPatchId(){return"c2d"}}
class Oa{constructor(a){this._items=new Map;this._id=0;this._initWorker()}_initWorker(){var a=new Blob([`(${Pa.toString()})()`.replace('"use strict";',"")]);a=(window.URL?URL:webkitURL).createObjectURL(a,{type:"application/javascript; charset=utf-8"});this._worker=new Worker(a);this._worker.postMessage({type:"config",config:{path:window.location.href}});this._worker.onmessage=(a)=>{if(a.data&&a.data.id){const b=this._items.get(a.data.id);b&&("data"==a.data.type?this.finish(b,a.data.info):this.error(b,
a.data.info))}}}create(a){const b=++this._id,c=new Qa(this,b,a);this._items.set(b,c);this._worker.postMessage({type:"add",id:b,src:a});return c}cancel(a){this._worker.postMessage({type:"cancel",id:a.id});this._items.delete(a.id)}error(a,b){a.error(b);this._items.delete(a.id)}finish(a,b){a.load(b);this._items.delete(a.id)}}class Qa{constructor(a,b,c){this._manager=a;this._id=b;this._src=c;this._onLoad=this._onError=null}get id(){return this._id}get src(){return this._src}set onError(a){this._onError=
a}set onLoad(a){this._onLoad=a}cancel(){this._manager.cancel(this)}load(a){this._onLoad&&this._onLoad(a)}error(a){this._onError&&this._onError(a)}}const Pa=function(){class a{constructor(){this.items=new Map;onmessage=(a)=>{"config"==a.data.type?(this.config=a.data.config,a=this.config.path.split("/"),a.pop(),this._relativeBase=a.join("/")+"/"):"add"==a.data.type?this.add(a.data.id,a.data.src):"cancel"==a.data.type&&this.cancel(a.data.id)}}static isPathAbsolute(a){return/^(?:\/|[a-z]+:\/\/)/.test(a)}add(c,
d){a.isPathAbsolute(d)||(d=this._relativeBase+d,console.log("convert to relative: "+d));"//"===d.substr(0,2)&&(d="http:"+d);const e=new b(c,d);e.onFinish=(a)=>{this.finish(e,a)};e.onError=(a)=>{this.error(e,a)};this.items.set(c,e);e.start()}cancel(a){const b=this.items.get(a);b&&(b.cancel(),this.items.delete(a))}finish(a,{imageBitmap:b,hasAlphaChannel:e}){postMessage({type:"data",id:a.id,info:{imageBitmap:b,hasAlphaChannel:e}},[b]);this.items.delete(a.id)}error(a,{type:b,message:e}){postMessage({type:"error",
id:a.id,info:{type:b,message:e}});this.items.delete(a.id)}}class b{constructor(a,b){this._onFinish=this._onError=void 0;this._id=a;this._src=b;this._mimeType=this._xhr=void 0;this._canceled=!1}get id(){return this._id}set onFinish(a){this._onFinish=a}set onError(a){this._onError=a}start(){this._xhr=new XMLHttpRequest;this._xhr.open("GET",this._src,!0);this._xhr.responseType="blob";this._xhr.onerror=(a)=>{this.error({type:"connection",message:"Connection error"})};this._xhr.onload=(a)=>{a=this._xhr.response;
this._mimeType=a.type;this._createImageBitmap(a)};this._xhr.send()}_createImageBitmap(a){createImageBitmap(a,{premultiplyAlpha:"premultiply",colorSpaceConversion:"none",imageOrientation:"none"}).then((a)=>{this.finish({imageBitmap:a,hasAlphaChannel:this._hasAlphaChannel()})}).catch((a)=>{this.error({type:"parse",message:"Error parsing image data"})})}_hasAlphaChannel(){return!0}cancel(){this._canceled||(this._xhr&&this._xhr.abort(),this._canceled=!0)}error(a,b){!this._canceled&&this._onError&&this._onError({type:a,
message:b})}finish(a){!this._canceled&&this._onFinish&&this._onFinish(a)}}new a};class Ra{init(a){this.stage=a;this._awaitingLoop=this._looping=!1;this.stage.getOption("useImageWorker")&&(window.createImageBitmap&&window.Worker?this._imageWorker=new Oa:console.warn("Can't use image worker because browser does not have createImageBitmap and Web Worker support"))}startLoop(){this._looping=!0;this._awaitingLoop||this.loop()}stopLoop(){this._looping=!1}loop(){let a=this,b=function(){a._awaitingLoop=!1;
a._looping&&(a.stage.drawFrame(),requestAnimationFrame(b),a._awaitingLoop=!0)};requestAnimationFrame(b)}uploadGlTexture(a,b,c,d){c instanceof ImageData||c instanceof HTMLImageElement||c instanceof HTMLCanvasElement||c instanceof HTMLVideoElement||window.ImageBitmap&&c instanceof ImageBitmap?a.texImage2D(a.TEXTURE_2D,0,d.internalFormat,d.format,d.type,c):a.texImage2D(a.TEXTURE_2D,0,d.internalFormat,b.w,b.h,0,d.format,d.type,c)}loadSrcTexture({src:a,hasAlpha:b},c){let d=void 0,e=0<=a.indexOf(".png");
if(this._imageWorker){const b=this._imageWorker.create(a);b.onError=function(a){return c("Image load error")};b.onLoad=function({imageBitmap:b,hasAlphaChannel:d}){c(null,{source:b,renderInfo:{src:a},hasAlpha:d,premultiplyAlpha:!0})};d=function(){b.cancel()}}else{let f=new Image;"data:"!=a.substr(0,5)&&(f.crossOrigin="Anonymous");f.onerror=function(a){if(f.src)return c("Image load error")};f.onload=function(){c(null,{source:f,renderInfo:{src:a},hasAlpha:e||b})};f.src=a;d=function(){f.removeAttribute("src")}}return d}createWebGLContext(a,
b){var c=this.stage.getOption("canvas")||document.createElement("canvas");a&&b&&(c.width=a,c.height=b);a={alpha:!0,antialias:!1,premultipliedAlpha:!0,stencil:!0,preserveDrawingBuffer:!1};c=c.getContext("webgl",a)||c.getContext("experimental-webgl",a);if(!c)throw Error("This browser does not support webGL.");return c}createCanvasContext(a,b){let c=this.stage.getOption("canvas")||document.createElement("canvas");a&&b&&(c.width=a,c.height=b);a=c.getContext("2d");if(!a)throw Error("This browser does not support 2d canvas.");
return a}getHrTime(){return window.performance?window.performance.now():(new Date).getTime()}getDrawingCanvas(){return document.createElement("canvas")}getTextureOptionsForDrawingCanvas(a){let b={};b.source=a;return b}nextFrame(a){}registerKeyHandler(a){window.addEventListener("keydown",(b)=>{a({keyCode:b.keyCode})})}}class Sa{static load(a){return Ra}}class C{static isFunction(a){return"function"===typeof a}static isNumber(a){return"number"===typeof a}static isInteger(a){return"number"===typeof a&&
0===a%1}static isBoolean(a){return!0===a||!1===a}static isString(a){return"string"==typeof a}static isObject(a){let b=typeof a;return!!a&&("object"==b||"function"==b)}static isPlainObject(a){return!!a&&"object"==typeof a}static isObjectLiteral(a){return"object"===typeof a&&a&&a.constructor===Object}static getArrayIndex(a,b){return C.getModuloIndex(a,b.length)}static equalValues(a,b){return typeof a!==typeof b?!1:C.isObjectLiteral(a)?C.isObjectLiteral(b)&&C.equalObjectLiterals(a,b):Array.isArray(a)?
Array.isArray(b)&&C.equalArrays(a,b):a===b}static equalObjectLiterals(a,b){let c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(let e=0,f=c.length;e<f;e++){const f=c[e],h=d[e];if(f!==h||!C.equalValues(a[f],b[h]))return!1}return!0}static equalArrays(a,b){if(a.length!==b.length)return!1;for(let c=0,d=a.length;c<d;c++)if(!this.equalValues(a[c],b[c]))return!1;return!0}}class F{constructor(a,b){this._id=a;this._gl=b;this._program=void 0;this._buffers=new Map;this._framebuffers=new Map;
this._renderbuffers=new Map;this._vertexAttribs=Array(16);this._nonDefaultFlags=new Set;this._settings=new Map;this._textures=Array(8);this._maxTexture=0;this._activeTexture=b.TEXTURE0;this._pixelStorei=Array(5)}_getDefaultFlag(a){return a===this._gl.DITHER}setFlag(a,b){const c=this._getDefaultFlag(a);if(b===c)return this._nonDefaultFlags.delete(a);if(this._nonDefaultFlags.has(a))return!1;this._nonDefaultFlags.add(a);return!0}setBuffer(a,b){const c=this._buffers.get(a)!==b;this._buffers.set(a,b);
c&&a===this._gl.ARRAY_BUFFER&&(this._vertexAttribs=[]);return c}setFramebuffer(a,b){const c=this._framebuffers.get(a)!==b;this._framebuffers.set(a,b);return c}setRenderbuffer(a,b){const c=this._renderbuffers.get(a)!==b;this._renderbuffers.set(a,b);return c}setProgram(a){const b=this._program!==a;this._program=a;return b}setSetting(a,b){var c=this._settings.get(a);c=!c||!C.equalValues(c,b);this._settings.set(a,b);return c}disableVertexAttribArray(a){return(a=this._vertexAttribs[a])&&a[5]?(a[5]=!1,
!0):!1}enableVertexAttribArray(a){const b=this._vertexAttribs[a];if(b){if(!b[0])return b[0]=!0}else return this._vertexAttribs[a]=[0,0,0,0,0,!0],!0;return!1}vertexAttribPointer(a,b){a=this._vertexAttribs[a];let c=!1;a&&(c=a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]&&a[4]===b[4]);if(c)return!1;b[5]=a?a[5]:!1;return!0}setActiveTexture(a){const b=this._activeTexture!==a;this._activeTexture=a;return b}bindTexture(a,b){const c=F._getTextureIndex(this._activeTexture);this._maxTexture=Math.max(this._maxTexture,
c+1);const d=this._textures[c];a=F._getTextureTargetIndex(a);if(d){if(d[a]===b)return!1;d[a]=b;return!0}return b?(this._textures[c]=[],this._textures[c][a]=b,!0):!1}setPixelStorei(a,b){a=F._getPixelStoreiIndex(a);const c=!C.equalValues(this._pixelStorei[a],b);this._pixelStorei[a]=b;return c}migrate(a){this._migrateFlags(this,a);a._program!==this._program&&this._gl._useProgram(a._program);this._migrateFramebuffers(this,a);this._migrateRenderbuffers(this,a);const b=this._migrateBuffers(this,a);this._migrateAttributes(this,
a,b);this._migrateFlags(this,a);this._migrateSettings(this,a);this._migratePixelStorei(this,a);this._migrateTextures(this,a)}_migratePixelStorei(a,b){for(let c=0,d=a._pixelStorei.length;c<d;c++)if(a._pixelStorei[c]!==b._pixelStorei[c]){const a=void 0!==b._pixelStorei[c]?b._pixelStorei[c]:F._getDefaultPixelStoreiByIndex(c);this._gl._pixelStorei(F._getPixelStoreiByIndex(c),a)}}_migrateTextures(a,b){const c=Math.max(a._maxTexture,b._maxTexture);let d=a._activeTexture;for(let f=0;f<c;f++){const c=b._textures[f];
var e=a._textures[f];const h=F._getTextureByIndex(f);e=Math.max(e?e.length:0,c?c.length:0);for(let a=0,b=e;a<b;a++)e=F._getTextureTargetByIndex(a),d!==h&&(this._gl._activeTexture(h),d=h),this._gl._bindTexture(e,c&&c[a]||null)}b._activeTexture!==d&&this._gl._activeTexture(b._activeTexture)}_migrateBuffers(a,b){b._buffers.forEach((b,d)=>{a._buffers.get(d)!==b&&this._gl._bindBuffer(d,b)});a._buffers.forEach((a,d)=>{void 0===b._buffers.get(d)&&this._gl._bindBuffer(d,null)});return b._buffers.get(this._gl.ARRAY_BUFFER)!==
a._buffers.get(this._gl.ARRAY_BUFFER)}_migrateFramebuffers(a,b){b._framebuffers.forEach((b,d)=>{a._framebuffers.get(d)!==b&&this._gl._bindFramebuffer(d,b)});a._framebuffers.forEach((a,d)=>{void 0===b._framebuffers.get(d)&&this._gl._bindFramebuffer(d,null)})}_migrateRenderbuffers(a,b){b._renderbuffers.forEach((b,d)=>{a._renderbuffers.get(d)!==b&&this._gl._bindRenderbuffer(d,b)});a._renderbuffers.forEach((a,d)=>{void 0===b._renderbuffers.get(d)&&this._gl._bindRenderbuffer(d,null)})}_migrateAttributes(a,
b,c){c?b._vertexAttribs.forEach((a,b)=>{a[0]&&this._gl._vertexAttribPointer(b,a[0],a[1],a[2],a[3],a[4]);a[5]&&this._gl._enableVertexAttribArray(b)}):(a._vertexAttribs.forEach((a,c)=>{b._vertexAttribs[c]||this._gl._disableVertexAttribArray(c)}),b._vertexAttribs.forEach((a,b)=>{this._gl._vertexAttribPointer(b,a[0],a[1],a[2],a[4]);a[5]?this._gl._enableVertexAttribArray(b):this._gl._disableVertexAttribArray(b)}))}_migrateSettings(a,b){const c=this.constructor.getDefaultSettings();a._settings.forEach((a,
e)=>{a=e.name||e.xname;b._settings.has(e)||(a=c.get(a),C.isFunction(a)&&(a=a(this._gl)),b._settings.set(e,a),e.apply(this._gl,a))});b._settings.forEach((b,c)=>{const d=a._settings.get(c);d&&C.equalValues(d,b)||c.apply(this._gl,b)})}_migrateFlags(a,b){a._nonDefaultFlags.forEach((a)=>{b._nonDefaultFlags.has(a)||(this._getDefaultFlag(a)?this._gl._enable(a):this._gl._disable(a))});b._nonDefaultFlags.forEach((b)=>{a._nonDefaultFlags.has(b)||(this._getDefaultFlag(b)?this._gl._disable(b):this._gl._enable(b))})}static getDefaultSettings(){if(!this._defaultSettings){const a=
this._defaultSettings=new Map,b=WebGLRenderingContext.prototype;a.set("viewport",function(a){return[0,0,a.canvas.width,a.canvas.height]});a.set("scissor",function(a){return[0,0,a.canvas.width,a.canvas.height]});a.set("blendColor",[0,0,0,0]);a.set("blendEquation",[b.FUNC_ADD]);a.set("blendEquationSeparate",[b.FUNC_ADD,b.FUNC_ADD]);a.set("blendFunc",[b.ONE,b.ZERO]);a.set("blendFuncSeparate",[b.ONE,b.ZERO,b.ONE,b.ZERO]);a.set("clearColor",[0,0,0,0]);a.set("clearDepth",[1]);a.set("clearStencil",[0]);
a.set("colorMask",[!0,!0,!0,!0]);a.set("cullFace",[b.BACK]);a.set("depthFunc",[b.LESS]);a.set("depthMask",[!0]);a.set("depthRange",[0,1]);a.set("frontFace",[b.CCW]);a.set("lineWidth",[1]);a.set("polygonOffset",[0,0]);a.set("sampleCoverage",[1,!1]);a.set("stencilFunc",[b.ALWAYS,0,1]);a.set("_stencilFuncSeparateFront",[b.ALWAYS,0,1]);a.set("_stencilFuncSeparateBack",[b.ALWAYS,0,1]);a.set("_stencilFuncSeparateFrontAndBack",[b.ALWAYS,0,1]);a.set("stencilMask",[1]);a.set("_stencilMaskSeparateFront",[1]);
a.set("_stencilMaskSeparateBack",[1]);a.set("_stencilMaskSeparateFrontAndBack",[1]);a.set("stencilOp",[b.KEEP,b.KEEP,b.KEEP]);a.set("_stencilOpSeparateFront",[b.KEEP,b.KEEP,b.KEEP]);a.set("_stencilOpSeparateBack",[b.KEEP,b.KEEP,b.KEEP]);a.set("_stencilOpSeparateFrontAndBack",[b.KEEP,b.KEEP,b.KEEP]);a.set("vertexAttrib1f",[]);a.set("vertexAttrib1fv",[]);a.set("vertexAttrib2f",[]);a.set("vertexAttrib2fv",[]);a.set("vertexAttrib3f",[]);a.set("vertexAttrib3fv",[]);a.set("vertexAttrib4f",[]);a.set("vertexAttrib4fv",
[])}return this._defaultSettings}static _getTextureTargetIndex(a){switch(a){case 3553:return 0;case 34067:return 1;default:throw Error("Unknown texture target: "+a);}}static _getTextureTargetByIndex(a){this._textureTargetIndices||(this._textureTargetIndices=[3553,34067]);return this._textureTargetIndices[a]}static _getTextureIndex(a){return a-33984}static _getTextureByIndex(a){return a+33984}static _getPixelStoreiIndex(a){switch(a){case 3333:return 0;case 3317:return 1;case 37440:return 2;case 37441:return 3;
case 37443:return 4;case 37445:return 5;default:throw Error("Unknown pixelstorei: "+a);}}static _getPixelStoreiByIndex(a){this._pixelStoreiIndices||(this._pixelStoreiIndices=[3333,3317,37440,37441,37443]);return this._pixelStoreiIndices[a]}static _getDefaultPixelStoreiByIndex(a){this._pixelStoreiDefaults||(this._pixelStoreiDefaults=[4,4,!1,!1,WebGLRenderingContext.prototype.BROWSER_DEFAULT_WEBGL]);return this._pixelStoreiDefaults[a]}}class O{_initStateManager(a="default"){this._states={};this._state=
this._getState(a)}_getState(a){this._states[a]||(this._states[a]=new F(a,this));return this._states[a]}switchState(a="default"){this._state._id!==a&&(a=this._getState(a),this._state.migrate(a),this._state=a)}$useProgram(a){this._state.setProgram(a)&&this._useProgram(a)}$bindBuffer(a,b){this._state.setBuffer(a,b)&&this._bindBuffer(a,b)}$bindFramebuffer(a,b){this._state.setFramebuffer(a,b)&&this._bindFramebuffer(a,b)}$bindRenderbuffer(a,b){this._state.setRenderbuffer(a,b)&&this._bindRenderbuffer(a,
b)}$enable(a){this._state.setFlag(a,!0)&&this._enable(a)}$disable(a){this._state.setFlag(a,!1)&&this._disable(a)}$viewport(a,b,c,d){this._state.setSetting(this._viewport,[a,b,c,d])&&this._viewport(a,b,c,d)}$scissor(a,b,c,d){this._state.setSetting(this._scissor,[a,b,c,d])&&this._scissor(a,b,c,d)}$disableVertexAttribArray(a){this._state.disableVertexAttribArray(a)&&this._disableVertexAttribArray(a)}$enableVertexAttribArray(a){this._state.enableVertexAttribArray(a)&&this._enableVertexAttribArray(a)}$vertexAttribPointer(a,
b,c,d,e,f){this._state.vertexAttribPointer(a,[b,c,d,e,f])&&this._vertexAttribPointer(a,b,c,d,e,f)}$activeTexture(a){this._state.setActiveTexture(a)&&this._activeTexture(a)}$bindTexture(a,b){this._state.bindTexture(a,b)&&this._bindTexture(a,b)}$pixelStorei(a,b){this._state.setPixelStorei(a,b)&&this._pixelStorei(a,b)}$stencilFuncSeparate(a,b,c,d){let e;switch(a){case this.FRONT:e=this._stencilFuncSeparateFront;break;case this.BACK:e=this._stencilFuncSeparateBack;break;case this.FRONT_AND_BACK:e=this._stencilFuncSeparateFrontAndBack}this._state.setSetting(e,
[b,c,d])&&e.apply(this,[b,c,d])}_stencilFuncSeparateFront(a,b,c){this._stencilFuncSeparate(this.FRONT,a,b,c)}_stencilFuncSeparateBack(a,b,c){this._stencilFuncSeparate(this.BACK,a,b,c)}_stencilFuncSeparateFrontAndBack(a,b,c){this._stencilFuncSeparate(this.FRONT_AND_BACK,a,b,c)}$stencilMaskSeparate(a,b){let c;switch(a){case this.FRONT:c=this._stencilMaskSeparateFront;break;case this.BACK:c=this._stencilMaskSeparateBack;break;case this.FRONT_AND_BACK:c=this._stencilMaskSeparateFrontAndBack}this._state.setSetting(c,
[b])&&c.apply(this,[b])}_stencilMaskSeparateFront(a){this._stencilMaskSeparate(this.FRONT,a)}_stencilMaskSeparateBack(a){this._stencilMaskSeparate(this.BACK,a)}_stencilMaskSeparateFrontAndBack(a){this._stencilMaskSeparate(this.FRONT_AND_BACK,a)}$stencilOpSeparate(a,b,c,d){let e;switch(a){case this.FRONT:e=this._stencilOpSeparateFront;break;case this.BACK:e=this._stencilOpSeparateBack;break;case this.FRONT_AND_BACK:e=this._stencilOpSeparateFrontAndBack}this._state.setSetting(e,[b,c,d])&&e.apply(this,
[b,c,d])}_stencilOpSeparateFront(a,b,c){this._stencilOpSeparate(this.FRONT,a,b,c)}_stencilOpSeparateBack(a,b,c){this._stencilOpSeparate(this.BACK,a,b,c)}_stencilOpSeparateFrontAndBack(a,b,c){this._stencilOpSeparate(this.FRONT_AND_BACK,a,b,c)}$blendColor(a,b,c,d){this._state.setSetting(this._blendColor,[a,b,c,d])&&this._blendColor(a,b,c,d)}$blendEquation(a){this._state.setSetting(this._blendEquation,[a])&&this._blendEquation(a)}$blendEquationSeparate(a,b){this._state.setSetting(this._blendEquationSeparate,
[a,b])&&this._blendEquationSeparate(a,b)}$blendFunc(a,b){this._state.setSetting(this._blendFunc,[a,b])&&this._blendFunc(a,b)}$blendFuncSeparate(a,b,c,d){this._state.setSetting(this._blendFuncSeparate,[a,b,c,d])&&this._blendFuncSeparate(a,b,c,d)}$clearColor(a,b,c,d){this._state.setSetting(this._clearColor,[a,b,c,d])&&this._clearColor(a,b,c,d)}$clearDepth(a){this._state.setSetting(this._clearDepth,[a])&&this._clearDepth(a)}$clearStencil(a){this._state.setSetting(this._clearStencil,[a])&&this._clearStencil(a)}$colorMask(a,
b,c,d){this._state.setSetting(this._colorMask,[a,b,c,d])&&this._colorMask(a,b,c,d)}$cullFace(a){this._state.setSetting(this._cullFace,[a])&&this._cullFace(a)}$depthFunc(a){this._state.setSetting(this._depthFunc,[a])&&this._depthFunc(a)}$depthMask(a){this._state.setSetting(this._depthMask,[a])&&this._depthMask(a)}$depthRange(a,b){this._state.setSetting(this._depthRange,[a,b])&&this._depthRange(a,b)}$frontFace(a){this._state.setSetting(this._frontFace,[a])&&this._frontFace(a)}$lineWidth(a){this._state.setSetting(this._lineWidth,
[a])&&this._lineWidth(a)}$polygonOffset(a,b){this._state.setSetting(this._polygonOffset,[a,b])&&this._polygonOffset(a,b)}$sampleCoverage(a,b){this._state.setSetting(this._sampleCoverage,[a,b])&&this._sampleCoverage(a,b)}$stencilFunc(a,b,c){this._state.setSetting(this._stencilFunc,[a,b,c])&&this._stencilFunc(a,b,c)}$stencilMask(a){this._state.setSetting(this._stencilMask,[a])&&this._stencilMask(a)}$stencilOp(a,b,c){this._state.setSetting(this._stencilOp,[a,b,c])&&this._stencilOp(a,b,c)}$vertexAttrib1f(a,
b){this._state.setSetting(this._vertexAttrib1f,[a,b])&&this._vertexAttrib1f(a,b)}$vertexAttrib1fv(a,b){this._state.setSetting(this._vertexAttrib1fv,[a,b])&&this._vertexAttrib1fv(a,b)}$vertexAttrib2f(a,b,c){this._state.setSetting(this._vertexAttrib2f,[a,b,c])&&this._vertexAttrib2f(a,b,c)}$vertexAttrib2fv(a,b){this._state.setSetting(this._vertexAttrib2fv,[a,b])&&this._vertexAttrib2fv(a,b)}$vertexAttrib3f(a,b,c,d){this._state.setSetting(this._vertexAttrib3f,[a,b,c,d])&&this._vertexAttrib3f(a,b,c,d)}$vertexAttrib3fv(a,
b){this._state.setSetting(this._vertexAttrib3fv,[a,b])&&this._vertexAttrib3fv(a,b)}$vertexAttrib4f(a,b,c,d,e){this._state.setSetting(this._vertexAttrib4f,[a,b,c,d,e])&&this._vertexAttrib4f(a,b,c,d,e)}$vertexAttrib4fv(a,b){this._state.setSetting(this._vertexAttrib4fv,[a,b])&&this._vertexAttrib4fv(a,b)}static enable(a,b="default"){Object.getOwnPropertyNames(O.prototype).forEach((b)=>{if("constructor"!==b){const c=O.prototype[b];"$"===b.charAt(0)&&(b=b.substr(1));a[b]&&(a[b].name||(a[b].xname=b),a["_"+
b]=a[b]);a[b]=c}});O.prototype._initStateManager.call(a,b);return a}}class Ta{constructor(a){this.stage=a;this._usedTextureMemory=0;this._uploadedTextureSources=[];this.textureSourceHashmap=new Map}destroy(){for(let a=0,b=this._uploadedTextureSources.length;a<b;a++)this._nativeFreeTextureSource(this._uploadedTextureSources[a]);this.textureSourceHashmap.clear()}getReusableTextureSource(a){return this.textureSourceHashmap.get(a)}getTextureSource(a,b){let c=b?this.textureSourceHashmap.get(b):null;c||
(c=new K(this,a),b&&(c.lookupId=b,this.textureSourceHashmap.set(b,c)));return c}uploadTextureSource(a,b){a.isLoaded()||(b=this._nativeUploadTextureSource(a,b),a._nativeTexture=b,b.w=a.w,b.h=a.h,b.update=this.stage.frameCounter,this._usedTextureMemory+=a.w*a.h,this._uploadedTextureSources.push(a),this.addToLookupMap(a))}addToLookupMap(a){const b=a.lookupId;b&&(this.textureSourceHashmap.has(b)||this.textureSourceHashmap.set(b,a))}removeFromLookupMap(a){this.textureSourceHashmap.delete(a.lookupId)}isFull(){return this._usedTextureMemory>=
this.stage.getOption("textureMemory")}freeUnusedTextureSources(){let a=[],b=this._usedTextureMemory;for(let b=0,d=this._uploadedTextureSources.length;b<d;b++){let c=this._uploadedTextureSources[b];c.allowCleanup()?this._freeManagedTextureSource(c):a.push(c)}this._uploadedTextureSources=a;console.log("freed "+((b-this._usedTextureMemory)/1E6).toFixed(2)+"M texture pixels from GPU memory. Remaining: "+this._usedTextureMemory)}_freeManagedTextureSource(a){a.isLoaded()&&(this._usedTextureMemory-=a.w*
a.h,this._nativeFreeTextureSource(a));a.loadingSince=null;this.removeFromLookupMap(a)}freeTextureSource(a){const b=this._uploadedTextureSources.indexOf(a),c=-1!==b;a.isLoaded()&&(c&&(this._usedTextureMemory-=a.w*a.h,this._uploadedTextureSources.splice(b,1)),this._nativeFreeTextureSource(a));a.loadingSince=null;this.removeFromLookupMap(a)}_nativeUploadTextureSource(a,b){return this.stage.renderer.uploadTextureSource(a,b)}_nativeFreeTextureSource(a){this.stage.renderer.freeTextureSource(a);a.clearNativeTexture()}}
class Ua{constructor(a){this.stage=a;this.root=null;this.updateTreeOrder=0;this.renderState=this.stage.renderer.createCoreRenderState(this);this.renderExec=this.stage.renderer.createCoreRenderExecutor(this);this.renderExec.init();this._renderTexturePixels=0;this._renderTexturePool=[];this._renderTextureId=1;this._zSorts=[]}destroy(){this._renderTexturePool.forEach((a)=>this._freeRenderTexture(a))}hasRenderUpdates(){return!!this.root._parent._hasRenderUpdates}frame(){this.update();this.root._hasUpdates&&
this.update();if(this._zSorts.length){for(let a=0,b=this._zSorts.length;a<b;a++)this._zSorts[a].zSort&&this._zSorts[a].sortZIndexedChildren();this._zSorts=[]}this.root._parent._hasRenderUpdates=!1;this.render();return!0}update(){this.updateTreeOrder=0;this.root.update()}render(){this.renderState.reset();this.root.render();this.renderState.finish();this.renderExec.execute()}allocateRenderTexture(a,b,c=this.stage.getRenderPrecision()){let d=Math.max(1,Math.round(a*c)),e=Math.max(1,Math.round(b*c));
var f=this._renderTexturePool.length;for(--f;0<=f;f--){const a=this._renderTexturePool[f];if(a.w===d&&a.h===e)return a.f=this.stage.frameCounter,this._renderTexturePool.splice(f,1),a}a=this._createRenderTexture(a,b,d,e);a.precision=c;return a}releaseRenderTexture(a){this._renderTexturePool.push(a)}freeUnusedRenderTextures(a=60){const b=this._renderTexturePixels;let c=this.stage.frameCounter-a;this._renderTexturePool=this._renderTexturePool.filter((a)=>a.f<=c?(this._freeRenderTexture(a),!1):!0);console.warn("GC render texture memory"+
(a?"":" (aggressive)")+": "+b+"px > "+this._renderTexturePixels+"px")}_createRenderTexture(a,b,c,d){const e=this.stage.renderer.createRenderTexture(a,b,c,d);e.id=this._renderTextureId++;e.f=this.stage.frameCounter;e.ow=a;e.oh=b;e.w=c;e.h=d;this._renderTexturePixels+=c*d;this._renderTexturePixels>this.stage.getOption("renderTextureMemory")&&(this.freeUnusedRenderTextures(),this._renderTexturePixels>this.stage.getOption("renderTextureMemory")&&this.freeUnusedRenderTextures(0));return e}_freeRenderTexture(a){this.stage.renderer.freeRenderTexture(a);
this._renderTexturePixels-=a.w*a.h}copyRenderTexture(a,b,c){this.stage.renderer.copyRenderTexture(a,b,c)}forceZSort(a){this._zSorts.push(a)}}class U{constructor(a){this.stage=a;this._timingFunction="ease";this._timingFunctionImpl=t.getTimingFunction(this._timingFunction);this.delay=0;this.duration=.2;this.merger=null}get timingFunction(){return this._timingFunction}set timingFunction(a){this._timingFunction=a;this._timingFunctionImpl=t.getTimingFunction(a)}get timingFunctionImpl(){return this._timingFunctionImpl}patch(a){this.stage.patchObject(this,
a)}}U.prototype.isTransitionSettings=!0;class Va{constructor(a){this.stage=a;this.stage.on("frameStart",()=>this.progress());this.active=new Set;this.defaultTransitionSettings=new U(this.stage)}progress(){if(this.active.size){let a=this.stage.dt,b=!1;this.active.forEach(function(c){c.progress(a);c.isRunning()||(b=!0)});b&&(this.active=new Set([...this.active].filter((a)=>a.isRunning())))}}createSettings(a){let b=new U(this.stage);b.patch(a);return b}addActive(a){this.active.add(a)}removeActive(a){this.active.delete(a)}}
class u{constructor(){this._clear()}_clear(){this._p=[];this._pe=[];this._idp=[];this._f=[];this._v=[];this._lv=[];this._sm=[];this._s=[];this._ve=[];this._sme=[];this._se=[];this._length=0}parse(a,b){l.isObjectLiteral(b)||(b={0:b});let c=.5,d=[];for(g in b)if(b.hasOwnProperty(g)){var e=b[g];l.isObjectLiteral(e)||(e={v:e});var f=parseFloat(g);"sm"===g?c=e.v:!isNaN(f)&&0<=f&&2>=f&&(e.p=f,e.f=l.isFunction(e.v),e.lv=e.f?e.v(0,0):e.v,d.push(e))}d=d.sort(function(a,b){return a.p-b.p});var g=d.length;for(b=
0;b<g;b++)e=b===g-1,d[b].hasOwnProperty("pe")?(e=b<g-1?d[b+1].p:1,d[b].pe>e&&(d[b].pe=e)):d[b].pe=e?1>=d[b].p?1:2:d[b+1].p,d[b].idp=d[b].pe===d[b].p?0:1/(d[b].pe-d[b].p);for(b=0;b<g;b++)if(d[b].hasOwnProperty("sm")||(d[b].sm=c),!d[b].hasOwnProperty("s"))if(0===b||b===g-1||1===d[b].p)d[b].s=a?[0,0,0,0]:0;else{var h=d[b-1];const c=d[b+1];h.p===c.p?d[b].s=a?[0,0,0,0]:0:a?(e=u.getRgbaComponents(c.lv),f=u.getRgbaComponents(h.lv),h=1/(c.p-h.p),d[b].s=[h*(e[0]-f[0]),h*(e[1]-f[1]),h*(e[2]-f[2]),h*(e[3]-f[3])]):
d[b].s=(c.lv-h.lv)/(c.p-h.p)}for(b=0;b<g-1;b++)d[b].f||(e=b===g-1,d[b].hasOwnProperty("ve")||(d[b].ve=e?d[b].lv:d[b+1].lv),l.isNumber(d[b].v)&&l.isNumber(d[b].lv)&&(d[b].hasOwnProperty("sme")||(d[b].sme=e?c:d[b+1].sm),d[b].hasOwnProperty("se")||(d[b].se=e?a?[0,0,0,0]:0:d[b+1].s),d[b].v=a?u.getSplineRgbaValueFunction(d[b].v,d[b].ve,d[b].p,d[b].pe,d[b].sm,d[b].sme,d[b].s,d[b].se):u.getSplineValueFunction(d[b].v,d[b].ve,d[b].p,d[b].pe,d[b].sm,d[b].sme,d[b].s,d[b].se),d[b].f=!0));this.length&&this._clear();
b=0;for(g=d.length;b<g;b++)this._add(d[b])}_add(a){this._p.push(a.p||0);this._pe.push(a.pe||0);this._idp.push(a.idp||0);this._f.push(a.f||!1);this._v.push(a.hasOwnProperty("v")?a.v:0);this._lv.push(a.lv||0);this._sm.push(a.sm||0);this._s.push(a.s||0);this._ve.push(a.ve||0);this._sme.push(a.sme||0);this._se.push(a.se||0);this._length++}_getItem(a){const b=this._length;if(!b)return-1;if(a<this._p[0])return 0;for(let c=0;c<b;c++)if(this._p[c]<=a&&a<this._pe[c])return c;return b-1}getValue(a){const b=
this._getItem(a);if(-1!==b)return this._f[b]?this._v[b](Math.min(1,Math.max(0,(a-this._p[b])*this._idp[b]))):this._v[b]}get length(){return this._length}static getRgbaComponents(a){return[(a/65536|0)%256,(a/256|0)%256,a%256,a/16777216|0]}static getSplineValueFunction(a,b,c,d,e,f,g,h){c=d-c;let k=u.getSplineHelpers(a,b,e,f,g*c,h*c);return k?function(c){return 0===c?a:1===c?b:u.calculateSpline(k,c)}:function(c){return 0===c?a:1===c?b:b*c+a*(1-c)}}static getSplineRgbaValueFunction(a,b,c,d,e,f,g,h){c=
d-c;g[0]*=c;g[1]*=c;g[2]*=c;g[3]*=c;h[0]*=c;h[1]*=c;h[2]*=c;h[3]*=c;c=u.getRgbaComponents(a);d=u.getRgbaComponents(b);let k=[u.getSplineHelpers(c[0],d[0],e,f,g[0],h[0]),u.getSplineHelpers(c[1],d[1],e,f,g[1],h[1]),u.getSplineHelpers(c[2],d[2],e,f,g[2],h[2]),u.getSplineHelpers(c[3],d[3],e,f,g[3],h[3])];return k[0]?function(c){return 0===c?a:1===c?b:u.getArgbNumber([Math.min(255,u.calculateSpline(k[0],c)),Math.min(255,u.calculateSpline(k[1],c)),Math.min(255,u.calculateSpline(k[2],c)),Math.min(255,u.calculateSpline(k[3],
c))])}:function(c){return 0===c?a:1===c?b:u.mergeColors(b,a,c)}}static getSplineHelpers(a,b,c,d,e,f){if(!c&&!d)return null;e=a+e*c;let g=1-d;d=b-f*d;return[3*c-3*g+1,-6*c+3*g,3*c,3*e-3*d+b-a,3*(d+a)-6*e,3*(e-a),a]}static calculateSpline(a,b){let c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5];a=a[6];if(-2===c&&-2===f&&0===e&&0===h)return b;let k=.5;for(var l=0;20>l;l++){var r=k*(k*(k*c+d)+e);r=b-r;if(-1E-8<r&&1E-8>r)return k*(k*(k*f+g)+h)+a;var n=k*(3*k*c+2*d)+e;if(1E-10<n&&1E-10>n)break;k+=r/n}l=0;n=1;
for(let m=0;20>m;m++){k=.5*(l+n);r=k*(k*(k*c+d)+e);r=b-r;if(-1E-8<r&&1E-8>r)return k*(k*(k*f+g)+h)+a;0>r?n=k:l=k}return k}static mergeColors(a,b,c){return 16777216*Math.round((a/16777216|0)*c+(b/16777216|0)*(1-c)|0)+65536*Math.round((a/65536|0)%256*c+(b/65536|0)%256*(1-c)|0)+256*Math.round((a/256|0)%256*c+(b/256|0)%256*(1-c)|0)+Math.round(a%256*c+b%256*(1-c)|0)}static getArgbNumber(a){a[0]=Math.max(0,Math.min(255,a[0]));a[1]=Math.max(0,Math.min(255,a[1]));a[2]=Math.max(0,Math.min(255,a[2]));a[3]=
Math.max(0,Math.min(255,a[3]));a=((a[3]|0)<<24)+((a[0]|0)<<16)+((a[1]|0)<<8)+(a[2]|0);0>a&&(a=4294967295+a+1);return a}}class ra{constructor(a){this.animationSettings=a;this._selector="";this._items=new u;this._props=[];this._propSetters=[];this._resetValue=void 0;this._hasResetValue=!1;this._hasColorProperty=void 0}getResetValue(){return this._hasResetValue?this._resetValue:this._items.getValue(0)}apply(a,b,c){a=this.getAnimatedViews(a);b=this._items.getValue(b);if(void 0!==b&&a.length){if(1!==c){var d=
this.getResetValue();l.isNumber(b)&&l.isNumber(d)&&(b=this.hasColorProperty()?t.mergeColors(b,d,c):t.mergeNumbers(b,d,c))}c=this._propSetters.length;d=a.length;for(let e=0;e<d;e++)for(let d=0;d<c;d++)this._propSetters[d](a[e],b)}}getAnimatedViews(a){return a.select(this._selector)}reset(a){a=this.getAnimatedViews(a);let b=this.getResetValue();if(void 0!==b&&a.length){var c=this._propSetters.length,d=a.length;for(let e=0;e<d;e++)for(let d=0;d<c;d++)this._propSetters[d](a[e],b)}}set selector(a){this._selector=
a}set t(a){this.selector=a}get resetValue(){return this._resetValue}set resetValue(a){this._resetValue=a;this._hasResetValue=void 0!==a}set rv(a){this.resetValue=a}set value(a){this._items.parse(this.hasColorProperty(),a)}set v(a){this.value=a}set properties(a){Array.isArray(a)||(a=[a]);this._props=[];a.forEach((a)=>{this._props.push(a);this._propSetters.push(q.getSetter(a))})}set property(a){this._hasColorProperty=void 0;this.properties=a}set p(a){this.properties=a}patch(a){this.animationSettings.stage.patchObject(this,
a)}hasColorProperty(){void 0===this._hasColorProperty&&(this._hasColorProperty=this._props.length?q.isColorProperty(this._props[0]):!1);return this._hasColorProperty}}ra.prototype.isAnimationActionSettings=!0;class z{constructor(a){this.stage=a;this._actions=[];this.delay=0;this.duration=1;this.repeatDelay=this.repeatOffset=this.repeat=0;this.autostop=!1;this.stopMethod=z.STOP_METHODS.FADE;this._stopTimingFunction="ease";this._stopTimingFunctionImpl=t.getTimingFunction(this._stopTimingFunction);this.stopDelay=
this.stopDuration=0}get actions(){return this._actions}set actions(a){this._actions=[];for(let b=0,c=a.length;b<c;b++){const c=a[b];if(c.isAnimationActionSettings)this._actions.push(c);else{const a=new ra(this);a.patch(c);this._actions.push(a)}}}apply(a,b,c=1){this._actions.forEach(function(d){d.apply(a,b,c)})}reset(a){this._actions.forEach(function(b){b.reset(a)})}get stopTimingFunction(){return this._stopTimingFunction}set stopTimingFunction(a){this._stopTimingFunction=a;this._stopTimingFunctionImpl=
t.getTimingFunction(a)}get stopTimingFunctionImpl(){return this._stopTimingFunctionImpl}patch(a){this.stage.patchObject(this,a)}}z.STOP_METHODS={FADE:"fade",REVERSE:"reverse",FORWARD:"forward",IMMEDIATE:"immediate",ONETOTWO:"onetotwo"};class n extends v{constructor(a,b,c){super();this.manager=a;this._settings=b;this._view=c;this._state=n.STATES.IDLE;this._stopP=this._stopDelayLeft=this._repeatsLeft=this._delayLeft=this._p=0}start(){this._view&&this._view.attached?(this._p=0,this._delayLeft=this.settings.delay,
this._repeatsLeft=this.settings.repeat,this._state=n.STATES.PLAYING,this.emit("start"),this.checkActive()):console.warn("View must be attached before starting animation")}play(){this._state===n.STATES.PAUSED?(this._state=n.STATES.PLAYING,this.checkActive(),this.emit("resume")):this._state==n.STATES.STOPPING&&this.settings.stopMethod==z.STOP_METHODS.REVERSE?(this._state=n.STATES.PLAYING,this.emit("stopContinue")):this._state!=n.STATES.PLAYING&&this._state!=n.STATES.FINISHED&&this.start()}pause(){this._state===
n.STATES.PLAYING&&(this._state=n.STATES.PAUSED,this.emit("pause"))}replay(){this._state==n.STATES.FINISHED?this.start():this.play()}skipDelay(){this._stopDelayLeft=this._delayLeft=0}finish(){this._state===n.STATES.PLAYING?(this._delayLeft=0,this._p=1):this._state===n.STATES.STOPPING&&(this._p=this._stopDelayLeft=0)}stop(){this._state!==n.STATES.STOPPED&&this._state!==n.STATES.IDLE&&(this._stopDelayLeft=this.settings.stopDelay||0,this.settings.stopMethod===z.STOP_METHODS.IMMEDIATE&&!this._stopDelayLeft||
0<this._delayLeft||this.settings.stopMethod!==z.STOP_METHODS.FADE||(this._stopP=0),this._state=n.STATES.STOPPING,this.emit("stop"),this.checkActive())}stopNow(){if(this._state!==n.STATES.STOPPED||this._state!==n.STATES.IDLE)this._state=n.STATES.STOPPING,this._p=0,this.emit("stop"),this.reset(),this._state=n.STATES.STOPPED,this.emit("stopFinish")}isPaused(){return this._state===n.STATES.PAUSED}isPlaying(){return this._state===n.STATES.PLAYING}isStopping(){return this._state===n.STATES.STOPPING}checkActive(){this.isActive()&&
this.manager.addActive(this)}isActive(){return(this._state==n.STATES.PLAYING||this._state==n.STATES.STOPPING)&&this._view&&this._view.attached}progress(a){this._view&&(this._progress(a),this.apply())}_progress(a){if(this._state==n.STATES.STOPPING)this._stopProgress(a);else if(this._state==n.STATES.PLAYING){if(0<this._delayLeft)if(this._delayLeft-=a,0>this._delayLeft)a=-this._delayLeft,this._delayLeft=0,this.emit("delayEnd");else return;0===this.settings.duration?this._p=1:0<this.settings.duration&&
(this._p+=a/this.settings.duration);1<=this._p?-1==this.settings.repeat||0<this._repeatsLeft?(0<this._repeatsLeft&&this._repeatsLeft--,this._p=this.settings.repeatOffset,this.settings.repeatDelay&&(this._delayLeft=this.settings.repeatDelay),this.emit("repeat",this._repeatsLeft)):(this._p=1,this._state=n.STATES.FINISHED,this.emit("finish"),this.settings.autostop&&this.stop()):this.emit("progress",this._p)}}_stopProgress(a){let b=this._getStopDuration();if(0<this._stopDelayLeft)if(this._stopDelayLeft-=
a,0>this._stopDelayLeft)a=-this._stopDelayLeft,this._stopDelayLeft=0,this.emit("stopDelayEnd");else return;this.settings.stopMethod==z.STOP_METHODS.IMMEDIATE?(this._state=n.STATES.STOPPED,this.emit("stopFinish")):this.settings.stopMethod==z.STOP_METHODS.REVERSE?(0===b?this._p=0:0<b&&(this._p-=a/b),0>=this._p&&(this._p=0,this._state=n.STATES.STOPPED,this.emit("stopFinish"))):this.settings.stopMethod==z.STOP_METHODS.FADE?(this._progressStopTransition(a),1<=this._stopP&&(this._p=0,this._state=n.STATES.STOPPED,
this.emit("stopFinish"))):this.settings.stopMethod==z.STOP_METHODS.ONETOTWO?2>this._p&&(0===b?this._p=2:0<b&&(this._p=1>this._p?this._p+a/this.settings.duration:this._p+a/b),2<=this._p?(this._p=2,this._state=n.STATES.STOPPED,this.emit("stopFinish")):this.emit("progress",this._p)):this.settings.stopMethod==z.STOP_METHODS.FORWARD&&1>this._p&&(this._p=0==this.settings.duration?1:this._p+a/this.settings.duration,1<=this._p?this.settings.stopMethod==z.STOP_METHODS.FORWARD?(this._p=1,this._state=n.STATES.STOPPED,
this.emit("stopFinish")):0<this._repeatsLeft?(this._repeatsLeft--,this._p=0,this.emit("repeat",this._repeatsLeft)):(this._p=1,this._state=n.STATES.STOPPED,this.emit("stopFinish")):this.emit("progress",this._p))}_progressStopTransition(a){if(1>this._stopP){if(0<this._stopDelayLeft)if(this._stopDelayLeft-=a,0>this._stopDelayLeft)a=-this._stopDelayLeft,this._stopDelayLeft=0,this.emit("delayEnd");else return;const b=this._getStopDuration();this._stopP=0==b?1:this._stopP+a/b;1<=this._stopP&&(this._stopP=
1)}}_getStopDuration(){return this.settings.stopDuration||this.settings.duration}apply(){if(this._state===n.STATES.STOPPED)this.reset();else{let a=1;this._state===n.STATES.STOPPING&&this.settings.stopMethod===z.STOP_METHODS.FADE&&(a=1-this.settings.stopTimingFunctionImpl(this._stopP));this._settings.apply(this._view,this._p,a)}}reset(){this._settings.reset(this._view)}get state(){return this._state}get p(){return this._p}get delayLeft(){return this._delayLeft}get view(){return this._view}get frame(){return Math.round(this._p*
this._settings.duration*60)}get settings(){return this._settings}}n.STATES={IDLE:0,PLAYING:1,STOPPING:2,STOPPED:3,FINISHED:4,PAUSED:5};class Wa{constructor(a){this.stage=a;this.stage.on("frameStart",()=>this.progress());this.active=new Set}progress(){if(this.active.size){let a=this.stage.dt,b=!1;this.active.forEach(function(c){c.isActive()?c.progress(a):b=!0});b&&(this.active=new Set([...this.active].filter((a)=>a.isActive())))}}createAnimation(a,b){l.isObjectLiteral(b)&&(b=this.createSettings(b));
return new n(this,b,a)}createSettings(a){const b=new z(this.stage);b.patch(a);return b}addActive(a){this.active.add(a)}}class sa extends A{_getLookupId(){return"__whitepix"}_getSourceLoader(){return function(a){var b=new Uint8Array([255,255,255,255]);a(null,{source:b,w:1,h:1,permanent:!0})}}}class V extends v{constructor(a={}){super();this._setOptions(a);this.platform=new (Sa.load(a));this.platform.init&&this.platform.init(this);this.c2d=this.gl=void 0;(a=this.getOption("context"))?a.useProgram?this.gl=
a:this.c2d=a:!l.isWeb||V.isWebglSupported()&&!this.getOption("canvas2d")?this.gl=this.platform.createWebGLContext(this.getOption("w"),this.getOption("h")):this.c2d=this.platform.createCanvasContext(this.getOption("w"),this.getOption("h"));this.gl&&O.enable(this.gl,"lightning");this._mode=this.gl?0:1;this.getCanvas()&&(this._options.w=this.getCanvas().width,this._options.h=this.getCanvas().height);this._renderer=0===this._mode?new Ka(this):new Na(this);this.setClearColor(this.getOption("clearColor"));
this.frameCounter=0;this.transitions=new Va(this);this.animations=new Wa(this);this.textureManager=new Ta(this);this._destroyed=!1;this.dt=this.currentTime=this.startTime=0;this.rectangleTexture=new sa(this);this.rectangleTexture.load();this.rectangleTexture.source.permanent=!0;this.ctx=new Ua(this);this._updateSourceTextures=new Set}get renderer(){return this._renderer}static isWebglSupported(){if(l.isNode)return!0;try{return!!window.WebGLRenderingContext}catch(a){return!1}}get mode(){return this._mode}getOption(a){return this._options[a]}_setOptions(a){this._options=
{};let b=(b,d)=>{let c=a[b];this._options[b]=void 0===c?d:c};b("canvas",void 0);b("context",void 0);b("w",1280);b("h",720);b("srcBasePath",null);b("textureMemory",18E6);b("renderTextureMemory",12E6);b("bufferMemory",2E6);b("textRenderIssueMargin",0);b("clearColor",[0,0,0,0]);b("defaultFontFace","Sans-Serif");b("fixedDt",0);b("useTextureAtlas",!1);b("debugTextureAtlas",!1);b("useImageWorker",!1);b("autostart",!0);b("precision",1);b("canvas2d",!1);b("platform",void 0)}setApplication(a){this.application=
a}init(){this.application.setAsRoot();this.getOption("autostart")&&this.platform.startLoop()}destroy(){this._destroyed||(this.application.destroy(),this.platform.stopLoop(),this.ctx.destroy(),this.textureManager.destroy(),this._renderer.destroy(),this._destroyed=!0)}stop(){this.platform.stopLoop()}resume(){if(this._destroyed)throw Error("Already destroyed");this.platform.startLoop()}get root(){return this.application}getCanvas(){return this._mode?this.c2d.canvas:this.gl.canvas}getRenderPrecision(){return this._options.precision}addUpdateSourceTexture(a){this._updatingFrame?
a._performUpdateSource():this._updateSourceTextures.add(a)}removeUpdateSourceTexture(a){this._updateSourceTextures&&this._updateSourceTextures.delete(a)}drawFrame(){this.startTime=this.currentTime;this.currentTime=this.platform.getHrTime();this.dt=this._options.fixedDt?this._options.fixedDt:this.startTime?.001*(this.currentTime-this.startTime):.02;this.emit("frameStart");this.textureManager.isFull()&&this.textureManager.freeUnusedTextureSources();this._updateSourceTextures.size&&(this._updateSourceTextures.forEach((a)=>
{a._performUpdateSource()}),this._updateSourceTextures=new Set);this.emit("update");const a=this.ctx.hasRenderUpdates();a&&(this._updatingFrame=!0,this.ctx.frame(),this._updatingFrame=!1);this.platform.nextFrame(a);this.emit("frameEnd");this.frameCounter++}renderFrame(){this.ctx.frame()}forceRenderUpdate(){this.root&&this.root.core._parent.setHasRenderUpdates(1)}setClearColor(a){this.forceRenderUpdate();null===a||void 0===a?this._clearColor=void 0:Array.isArray(a)?this._clearColor=a:this._clearColor=
t.getRgbaComponentsNormalized(a)}getClearColor(){return this._clearColor}createView(){return new q(this)}view(a){if(a.isView)return a;let b;b=a.type?new a.type(this):new q(this);b.patch(a,!0);return b}c(a){return this.view(a)}get w(){return this._options.w}get h(){return this._options.h}get rw(){return this.w/this._options.precision}get rh(){return this.h/this._options.precision}gcTextureMemory(a=!1){console.log("GC texture memory"+(a?" (aggressive)":""));a&&this.ctx.root.visible?(this.ctx.root.visible=
!1,this.textureManager.freeUnusedTextureSources(),this.ctx.root.visible=!0):this.textureManager.freeUnusedTextureSources()}gcRenderTextureMemory(a=!1){console.log("GC texture render memory"+(a?" (aggressive)":""));a&&this.root.visible?(this.root.visible=!1,this.ctx.freeUnusedRenderTextures(0),this.root.visible=!0):this.ctx.freeUnusedRenderTextures(0)}getDrawingCanvas(){return this.platform.getDrawingCanvas()}patchObject(a,b){b=E.preparePatchSettings(b,this.getPatchId());E.patchObject(a,b)}getPatchId(){return this.renderer.getPatchId()}}
class B{constructor(){this._fireLevel=0;this._logPrefix="";this._debug=!1}get debug(){return this._debug}set debug(a){this._debug=a}fire(a,b,c){const d=0===this._fireLevel;this._fireLevel++;this.debug&&(this._logPrefix=d?"":this._logPrefix+" ");let e;try{(e=Array.isArray(b)?this._mfire(a,b,c):this._fire(a,b,c))&&d&&a.application.__updateFocus()}catch(f){console.error(`${a.constructor.name} "${a.state}".${b} ${a.getLocationString()}`),console.error(f.stack)}this._fireLevel--;this.debug&&(this._logPrefix=
this._logPrefix.substr(0,this._logPrefix.length-1));return!!e}_fire(a,b,c){l.isUcChar(b.charCodeAt(0))&&a._throwError("Event may not start with an upper case character: "+b);const d=this._getStatePaths(a,a.state);for(let e=0,f=d.length;e<f;e++){const f=this._attemptFirePathEvent(a,d[e],b,c);if(f)return f}}_mfire(a,b){const c=this._getStatePaths(a,a.state);for(let d=0,e=c.length;d<e;d++)for(let e=0,g=b.length;e<g;e++){const f=this._attemptFirePathEvent(a,c[d],b[e].event,b[e].args);if(f)return f}}_attemptFirePathEvent(a,
b,c,d){const e=B._getStateAction(b,c);if(e){let f=void 0!==e.s,g=e.s;e.a&&(this.debug&&console.log(`${this._logPrefix}${a.constructor.name} "${a.state}".${c} ${a.getLocationString()}`),g=e.a.call(a,d),(f=!1!==g)||this.debug&&console.log(`${this._logPrefix}[PASS THROUGH]`));if(f)return e.event=c,e.args=d,e.s=g,e.p=b,b=a.state,l.isString(g)&&this._setState(a,B._ucfirst(g),{event:c,args:d,prevState:b,newState:g}),e}}static _ucfirst(a){return a.charAt(0).toUpperCase()+a.substr(1)}_getStatePaths(a,b){var c=
a._getStates();if(""==b)return[c];const d=b.split("."),e=[c];for(let f=0,g=d.length;f<g;f++){const g=B._ucfirst(d[f]);c.hasOwnProperty(g)||a._throwError("State path not found: '"+b+"'");c=c[g];e.push(c)}return e.reverse()}static _getStateAction(a,b){if(!a.hasOwnProperty(b))return null;a=a[b];return l.isFunction(a)?{a,s:void 0}:l.isString(a)?{a:void 0,s:a}:null}_setState(a,b,c){this.debug&&console.log(`${this._logPrefix}\u255a>"${b!==a.state?b:""}"`);if(b!==a.state){this._fireLevel++;this.debug&&(this._logPrefix+=
" ");var d=this._getStatePaths(a,a.state),e=this._getStatePaths(a,b);d=B._compareStatePaths(d,e);e=d.exit.reverse();d=d.enter;const g=a.state;for(let b=0,d=e.length;b<d;b++){a.__state=B._getSuperState(g,b);var f=B._getStateAction(e[b],"_exit");if(f)if(this.debug&&console.log(`${this._logPrefix}${a.constructor.name} "${a.state}"._exit ${a.getLocationString()}`),f=B._executeAction(f,a,c),!1===f)this.debug&&console.log(`${this._logPrefix}[CANCELED]`);else if(f)return a=this._setState(a,f,c),this._fireLevel--,
this.debug&&(this._logPrefix=this._logPrefix.substr(0,this._logPrefix.length-1)),a}a.__state=B._getSuperState(g,e.length);for(let f=0,g=d.length;f<g;f++)if(a.__state=B._getSuperState(b,g-(f+1)),e=B._getStateAction(d[f],"_enter"))if(this.debug&&console.log(`${this._logPrefix}${a.constructor.name} "${b}"._enter ${a.getLocationString()}`),e=B._executeAction(e,a,c),!1===e)this.debug&&console.log(`${this._logPrefix}[CANCELED]`);else if(e)return a=this._setState(a,e,c),this._fireLevel--,this.debug&&(this._logPrefix=
this._logPrefix.substr(0,this._logPrefix.length-1)),a;this._fireLevel--;this.debug&&(this._logPrefix=this._logPrefix.substr(0,this._logPrefix.length-1))}}static _executeAction(a,b,c){let d;a.a&&(d=a.a.call(b,c));void 0===d&&(d=a.s);return d}static _getSuperState(a,b){return 0===b?a:a.split(".").slice(0,-b).join(".")}static _compareStatePaths(a,b){a=a.reverse();b=b.reverse();const c=Math.min(a.length,b.length);let d;for(d=0;d<c&&a[d]===b[d];d++);return{exit:a.slice(d),enter:b.slice(d)}}}class G extends x{constructor(a=
{},b){G._temp_options=a;G.booting=!0;super(new V(a.stage),b);G.booting=!1;this.stage.init();this.updateFocusSettings();(this.__keymap=this.getOption("keys"))&&this.stage.platform.registerKeyHandler((a)=>{this._receiveKeydown(a)})}getOption(a){return this.__options[a]}_setOptions(a){this.__options={};let b=(b,d)=>{let c=a[b];this.__options[b]=void 0===c?d:c};b("debug",!1);b("keys",{})}__construct(){this.stage.setApplication(this);this._setOptions(G._temp_options);delete G._temp_options;this.stateManager=
new B;this.stateManager.debug=this.__options.debug;super.__construct()}__init(){super.__init();this.__updateFocus()}updateFocusPath(){this.__updateFocus()}__updateFocus(){this.__updateFocusRec()&&this._handleFocusSettings!==G.prototype._handleFocusSettings&&(G.booting||this.updateFocusSettings())}__updateFocusRec(a=100){var b=this.__getFocusPath();const c=b[b.length-1],d=this._focusPath?this._focusPath[this._focusPath.length-1]:void 0;if(d){var e=Math.min(this._focusPath.length,b.length);let f;for(f=
0;f<e&&this._focusPath[f]===b[f];f++);if(this._focusPath.length!==b.length||f!==b.length){this.__options.debug&&console.log(this.stateManager._logPrefix+"* FOCUS "+c.getLocationString());for(e=this._focusPath.length-1;e>=f;e--)this._focusPath[e].__unfocus(c,d);this._focusPath=b;for(let a=f,b=this._focusPath.length;a<b;a++)this._focusPath[a].__focus(c,d);for(b=0;b<f;b++)this._focusPath[b].__focusChange(c,d);if(0===a--)throw Error("Max recursion count reached in focus update");this.__updateFocus(a);
return!0}return!1}this._focusPath=b;for(let a=0,b=this._focusPath.length;a<b;a++)this._focusPath[a].__focus(c,void 0);return!0}updateFocusSettings(){var a=this.__getFocusPath();a=a[a.length-1];const b={};for(let a=0,d=this._focusPath.length;a<d;a++)this._focusPath[a]._setFocusSettings(b);this._handleFocusSettings(b,this.__prevFocusSettings,a);this.__prevFocusSettings=b}_handleFocusSettings(a,b,c,d){}__getFocusPath(){const a=[this];let b=this;do{const c=b._getFocused();if(!c||c===b)break;let d=c.cparent;
if(d===b)a.push(c);else{const e=[c];do d||b._throwError("Return value for _getFocused must be an attached descendant component but its '"+c.getLocationString()+"'"),e.push(d),d=d.cparent;while(d!==b);for(let b=0,c=e.length;b<c;b++)a.push(e[c-b-1])}b=c}while(1);return a}get focusPath(){return this._focusPath}focusTopDownEvent(a,b){const c=this.focusPath,d=c.length;if(Array.isArray(a))for(b=0;b<d;b++){if(c[b].fire(a))return!0}else for(let e=0;e<d;e++)if(c[e].fire(a,b))return!0;return!1}focusBottomUpEvent(a,
b){const c=this.focusPath;var d=c.length;if(Array.isArray(a))for(b=d-1;0<=b;b--){if(c[b].fire(a))return!0}else for(--d;0<=d;d--)if(c[d].fire(a,b))return!0;return!1}_receiveKeydown(a){const b={keyCode:a.keyCode};this.__keymap[a.keyCode]?this.stage.application.focusTopDownEvent([{event:"_capture"+this.__keymap[a.keyCode],args:b},{event:"_captureKey",args:b}])||this.stage.application.focusBottomUpEvent([{event:"_handle"+this.__keymap[a.keyCode],args:b},{event:"_handleKey",args:b}]):this.stage.application.focusTopDownEvent("_captureKey",
b)||this.stage.application.focusBottomUpEvent("_handleKey",b)}destroy(){this.stage.root=void 0;this._updateAttachedFlag();this._updateEnabledFlag()}}class ta extends A{constructor(a){super(a);this._lookupId=this._factory=void 0}set content({factory:a,lookupId:b=void 0}){this._factory=a;this._lookupId=b;this._changed()}_getIsValid(){return!!this._factory}_getLookupId(){return this._lookupId}_getSourceLoader(){const a=this._factory;return(b)=>a((a,d)=>{if(a)return b(a);b(null,this.stage.platform.getTextureOptionsForDrawingCanvas(d))},
this.stage)}}class P{static getCanvasTexture(a,b){return{type:ta,content:{factory:a,lookupId:b}}}static getRoundRect(a,b,c,d,e,f,g){Array.isArray(c)||(c=[c,c,c,c]);let h="rect"+[a,b,d,e,f?1:0,g].concat(c).join(",");return P.getCanvasTexture((h,l)=>{h(null,this.createRoundRect(l,a,b,c,d,e,f,g))},h)}static createRoundRect(a,b,c,d,e,f,g,h){void 0===g&&(g=!0);void 0===e&&(e=0);a=a.platform.getDrawingCanvas();let k=a.getContext("2d");k.imageSmoothingEnabled=!0;a.width=b+e+2;a.height=c+e+2;k.beginPath();
let m=.5*e+1,r=.5*e+1;k.moveTo(m+d[0],r);k.lineTo(m+b-d[1],r);k.arcTo(m+b,r,m+b,r+d[1],d[1]);k.lineTo(m+b,r+c-d[2]);k.arcTo(m+b,r+c,m+b-d[2],r+c,d[2]);k.lineTo(m+d[3],r+c);k.arcTo(m,r+c,m,r+c-d[3],d[3]);k.lineTo(m,r+d[0]);k.arcTo(m,r,m+d[0],r,d[0]);g&&(l.isNumber(h)?k.fillStyle=t.getRgbaString(h):k.fillStyle="white",k.fill());e&&(l.isNumber(f)?k.strokeStyle=t.getRgbaString(f):k.strokeStyle="white",k.lineWidth=e,k.stroke());return a}static getShadowRect(a,b,c=0,d=5,e=2*d){Array.isArray(c)||(c=[c,c,
c,c]);let f="shadow"+[a,b,d,e].concat(c).join(",");return P.getCanvasTexture((f,h)=>{f(null,this.createShadowRect(h,a,b,c,d,e))},f)}static createShadowRect(a,b,c,d,e,f){a=a.platform.getDrawingCanvas();let g=a.getContext("2d");g.imageSmoothingEnabled=!0;a.width=b+2*f;a.height=c+2*f;g.globalAlpha=.01;g.fillRect(0,0,.01,.01);g.globalAlpha=1;g.shadowColor=t.getRgbaString(4294967295);g.fillStyle=t.getRgbaString(4294967295);g.shadowBlur=e;g.shadowOffsetX=b+10+f;g.shadowOffsetY=f;g.beginPath();e=-(b+10);
g.moveTo(e+d[0],0);g.lineTo(e+b-d[1],0);g.arcTo(e+b,0,e+b,0+d[1],d[1]);g.lineTo(e+b,0+c-d[2]);g.arcTo(e+b,0+c,e+b-d[2],0+c,d[2]);g.lineTo(e+d[3],0+c);g.arcTo(e,0+c,e,0+c-d[3],d[3]);g.lineTo(e,0+d[0]);g.arcTo(e,0,e+d[0],0,d[0]);g.fill();return a}static getSvgTexture(a,b,c){let d="svg"+[b,c,a].join();return P.getCanvasTexture((d,f)=>{this.createSvg(d,f,a,b,c)},d)}static createSvg(a,b,c,d,e){let f=b.platform.getDrawingCanvas(),g=f.getContext("2d");g.imageSmoothingEnabled=!0;let h=new Image;h.onload=
()=>{f.width=d;f.height=e;g.drawImage(h,0,0,f.width,f.height);a(null,f)};h.onError=(b)=>{a(b)};h.src=c}}class ua{static isMf(a){return l.isFunction(a)&&a.__mf}static mf(a){a.__mf=!0;return a}static merge(a,b){const c=Object.keys(a),d=Object.keys(b);if(!d.length)return a;const e={};var f={};for(let a=0,b=d.length;a<b;a++){var g=d[a];e[g]=-1;f[g]=a}for(let a=0,b=c.length;a<b;a++)g=c[a],e[g]=a,void 0===f[g]&&(f[g]=-1);g=c.length;const h={};for(let g=0,n=d.length;g<n;g++){const n=d[g];for(var k=e[n],
m=k;0<=--m&&-1===f[c[m]];);for(;++m<k;){const b=c[m];h[b]=a[b]}k=b[n];m=a[n];k=this.isMf(k)?k(m):l.isObjectLiteral(m)&&l.isObjectLiteral(k)?ua.merge(m,k):k;void 0!==k&&(h[n]=k)}for(b=g;0<=--b&&-1===f[c[b]];);for(;++b<g;)f=c[b],h[f]=a[f];return h}}class va extends ka{constructor(a){super();this._target=a}onAdd(a,b){this._target.addAt(a,b)}onRemove(a,b){this._target.removeAt(b)}onSync(a,b,c){this._target._setByArray(c)}onSet(a,b){this._target.setAt(a,b)}onMove(a,b,c){this._target.setAt(a,c)}createItem(a){return this._target.createItem(a)}isItem(a){return this._target.isItem(a)}}
class wa extends va{constructor(a,b){super(a);this._wrap=b}wrap(a){let b=this._wrap(a);return a._wrapper=b}onAdd(a,b){a=this.wrap(a);super.onAdd(a,b)}onRemove(a,b){super.onRemove(a,b)}onSync(a,b,c){b.forEach((a)=>this.wrap(a));c=c.map((a)=>a._wrapper);super.onSync(a,b,c)}onSet(a,b){a=this.wrap(a);super.onSet(a,b)}onMove(a,b,c){super.onMove(a,b,c)}}class xa extends A{_getLookupId(){return"__noise"}_getSourceLoader(){const a=this.stage.gl;return function(b){const c=new Uint8Array(65536);for(var d=0;65536>
d;d+=4){const a=Math.floor(256*Math.random());c[d]=a;c[d+1]=a;c[d+2]=a;c[d+3]=255}d={};a&&(d[a.TEXTURE_WRAP_S]=a.REPEAT,d[a.TEXTURE_WRAP_T]=a.REPEAT,d[a.TEXTURE_MIN_FILTER]=a.NEAREST,d[a.TEXTURE_MAG_FILTER]=a.NEAREST);b(null,{source:c,w:128,h:128,texParams:d})}}}class ya extends A{constructor(a){super(a);this._htmlElement=void 0;this._scale=1}set htmlElement(a){this._htmlElement=a;this._changed()}get htmlElement(){return this._htmlElement}set scale(a){this._scale=a;this._changed()}get scale(){return this._scale}set html(a){if(a){const b=
document.createElement("div");b.innerHTML="<div>"+a+"</div>";this.htmlElement=b.firstElementChild}else this.htmlElement=void 0}get html(){return this._htmlElement.innerHTML}_getIsValid(){return this.htmlElement}_getLookupId(){return this._scale+":"+this._htmlElement.innerHTML}_getSourceLoader(){const a=this._htmlElement,b=this._scale;return function(c){if(!window.html2canvas)return c(Error("Please include html2canvas (https://html2canvas.hertzen.com/)"));const d=ya.getPreloadArea();d.appendChild(a);
html2canvas(a,{backgroundColor:null,scale:b}).then(function(b){d.removeChild(a);if(0===b.height)return c(Error("Canvas height is 0"));c(null,{source:b,width:b.width,height:b.height})}).catch((a)=>{console.error(a)})}}static getPreloadArea(){this._preloadArea||(this._preloadArea=document.createElement("div"),this._preloadArea.attachShadow&&this._preloadArea.attachShadow({mode:"closed"}),this._preloadArea.style.opacity=0,this._preloadArea.style.pointerEvents="none",this._preloadArea.style.position=
"fixed",this._preloadArea.style.display="block",this._preloadArea.style.top="100vh",this._preloadArea.style.overflow="hidden",document.body.appendChild(this._preloadArea));return this._preloadArea}}class Xa extends A{constructor(a,b){super(a);this._options=b}set options(a){this._options!==a&&(this._options=a,this._changed())}get options(){return this._options}_getIsValid(){return!!this._options}_getSourceLoader(){return(a)=>{a(null,this._options)}}}class Ya extends x{constructor(a){super(a);this._wrapper=
super._children.a({});this._reloadVisibleElements=!1;this._visibleItems=new Set;this._index=0;this._started=!1;this._scrollTransitionSettings=this.stage.transitions.createSettings({});this._itemSize=100;this._itemScrollOffset=this._viewportScrollOffset=0;this._roll=!1;this._rollMax=this._rollMin=0;this._progressAnimation=null;this._invertDirection=!1;this._horizontal=!0;this.itemList=new Za(this)}_allowChildrenAccess(){return!1}get items(){return this.itemList.get()}set items(a){this.itemList.patch(a)}start(){this._wrapper.transition(this.property,
this._scrollTransitionSettings);this._scrollTransition=this._wrapper.transition(this.property);this._scrollTransition.on("progress",(a)=>this.update());this.setIndex(0,!0,!0);this._started=!0;this.update()}setIndex(a,b=!1,c=!1){var d=this.length;if(d){this.emit("unfocus",this.getElement(this.realIndex),this._index,this.realIndex);c?(a=l.getModuloIndex(a,d),c=l.getModuloIndex(this.index,d),a-=c,a>.5*d?a-=d:a<-.5*d&&(a+=d),this._index+=a):this._index=a;if(this._roll||this.viewportSize>this._itemSize*
d)this._index=l.getModuloIndex(this._index,d);c=this._horizontal^this._invertDirection?-1:1;a=c*this._index*this._itemSize;this._roll&&(1==c?(d=(d-1)*this._itemSize,c=this._viewportScrollOffset*this.viewportSize-this._itemScrollOffset*this._itemSize,d-=c,c=this.viewportSize-(this._itemSize+c),this._rollMin&&(c-=this._rollMin),this._rollMax&&(d+=this._rollMax),a=Math.max(Math.min(a,d),c)):(d=d*this._itemSize-this.viewportSize,c=this._viewportScrollOffset*this.viewportSize-this._itemScrollOffset*this._itemSize,
d+=c,this._rollMin&&(c-=this._rollMin),this._rollMax&&(d+=this._rollMax),a=Math.min(Math.max(-d,a),-c)));this._scrollTransition.start(a);b&&this._scrollTransition.finish();this.emit("focus",this.getElement(this.realIndex),this._index,this.realIndex)}}getAxisPosition(){return this._viewportScrollOffset*this.viewportSize+(-(this._horizontal^this._invertDirection?-1:1)*this._index*this._itemSize- -this._scrollTransition._targetValue)}update(){if(this._started){var a=this.length;if(a){var b=this._horizontal^
this._invertDirection?-1:1,c=this._horizontal?this._wrapper.x:this._wrapper.y,d=this.viewportSize,e=this._viewportScrollOffset*d-this._itemScrollOffset*this._itemSize;c+=e;if(-1==b){var f=Math.floor(-c/this._itemSize);var g=1-(-c/this._itemSize-f);var h=Math.floor((d-c)/this._itemSize);c=(d-c)/this._itemSize-h}else f=Math.ceil(c/this._itemSize),g=1+c/this._itemSize-f,h=Math.ceil((c-d)/this._itemSize),c=h-(c-d)/this._itemSize;if(this._roll||d>this._itemSize*a)h>=a&&(h=a-1,c=1),f>=a&&(f=a-1,g=1),-1>=
h&&(h=0,c=1),-1>=f&&(f=0,g=1);d=-b*f*this._itemSize;for(let m=f;-1==b?m<=h:m>=h;-1==b?m++:m--){let b=l.getModuloIndex(m,a),n=this.getElement(b);var k=n.parent;this._visibleItems.delete(k);this._horizontal?k.x=d+e:k.y=d+e;let p=k.visible;k.visible=!0;p&&!this._reloadVisibleElements||this.emit("visible",m,b);this._progressAnimation&&(k=1,m==f?k=g:m==h&&(k=c),this._progressAnimation.apply(n,k));d+=this._itemSize}var m=this;this._visibleItems.forEach(function(a){a.visible=!1;m._visibleItems.delete(a)});
for(e=f;-1==b?e<=h:e>=h;-1==b?e++:e--)f=l.getModuloIndex(e,a),this._visibleItems.add(this.getWrapper(f));this._reloadVisibleElements=!1}}}setPrevious(){this.setIndex(this._index-1)}setNext(){this.setIndex(this._index+1)}getWrapper(a){return this._wrapper.children[a]}getElement(a){return(a=this._wrapper.children[a])?a.children[0]:null}reload(){this._reloadVisibleElements=!0;this.update()}get element(){let a=this._wrapper.children[this.realIndex];return a?a.children[0]:null}get length(){return this._wrapper.children.length}get property(){return this._horizontal?
"x":"y"}get viewportSize(){return this._horizontal?this.w:this.h}get index(){return this._index}get realIndex(){return l.getModuloIndex(this._index,this.length)}get itemSize(){return this._itemSize}set itemSize(a){this._itemSize=a;this.update()}get viewportScrollOffset(){return this._viewportScrollOffset}set viewportScrollOffset(a){this._viewportScrollOffset=a;this.update()}get itemScrollOffset(){return this._itemScrollOffset}set itemScrollOffset(a){this._itemScrollOffset=a;this.update()}get scrollTransitionSettings(){return this._scrollTransitionSettings}set scrollTransitionSettings(a){this._scrollTransitionSettings.patch(a)}set scrollTransition(a){this._scrollTransitionSettings.patch(a)}get scrollTransition(){return this._scrollTransition}get progressAnimation(){return this._progressAnimation}set progressAnimation(a){l.isObjectLiteral(a)?
this._progressAnimation=this.stage.animations.createSettings(a):this._progressAnimation=a;this.update()}get roll(){return this._roll}set roll(a){this._roll=a;this.update()}get rollMin(){return this._rollMin}set rollMin(a){this._rollMin=a;this.update()}get rollMax(){return this._rollMax}set rollMax(a){this._rollMax=a;this.update()}get invertDirection(){return this._invertDirection}set invertDirection(a){this._started||(this._invertDirection=a)}get horizontal(){return this._horizontal}set horizontal(a){a===
this._horizontal||this._started||(this._horizontal=a)}}class Za extends wa{constructor(a){super(a._wrapper._children,(a)=>{let b=a.stage.createView();b.add(a);b.visible=!1;return b});this.list=a}onAdd(a,b){super.onAdd(a,b);this.checkStarted(b)}checkStarted(a){this.list._reloadVisibleElements=!0;this.list._started?(1===this.list.length?this.list.setIndex(0,!0,!0):this.list._index>=this.list.length&&this.list.setIndex(0),this.list.update()):this.list.start()}onRemove(a,b){super.onRemove(a,b);a=this.list.realIndex;
a===b?(a===this.list.length&&a--,0<=a&&this.list.setIndex(a)):a>b&&this.list.setIndex(a-1);this.list._reloadVisibleElements=!0}onSet(a,b){super.onSet(a,b);this.checkStarted(b)}onSync(a,b,c){super.onSync(a,b,c);this.checkStarted(0)}get _passSignals(){return!0}}class W extends w{constructor(a){super(a);this._direction=new Float32Array([1,0]);this._kernelRadius=1}get x(){return this._direction[0]}set x(a){this._direction[0]=a;this.redraw()}get y(){return this._direction[1]}set y(a){this._direction[1]=
a;this.redraw()}get kernelRadius(){return this._kernelRadius}set kernelRadius(a){this._kernelRadius=a;this.redraw()}useDefault(){return 0===this._kernelRadius}setupUniforms(a){super.setupUniforms(a);this._setUniform("direction",this._direction,this.gl.uniform2fv);this._setUniform("kernelRadius",this._kernelRadius,this.gl.uniform1i);const b=a.getRenderWidth();a=a.getRenderHeight();this._setUniform("resolution",new Float32Array([b,a]),this.gl.uniform2fv)}}W.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    uniform vec2 resolution;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform vec2 direction;\n    uniform int kernelRadius;\n    \n    vec4 blur1(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n        vec4 color = vec4(0.0);\n        vec2 off1 = vec2(1.3333333333333333) * direction;\n        color += texture2D(image, uv) * 0.29411764705882354;\n        color += texture2D(image, uv + (off1 / resolution)) * 0.35294117647058826;\n        color += texture2D(image, uv - (off1 / resolution)) * 0.35294117647058826;\n        return color; \n    }\n    \n    vec4 blur2(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n        vec4 color = vec4(0.0);\n        vec2 off1 = vec2(1.3846153846) * direction;\n        vec2 off2 = vec2(3.2307692308) * direction;\n        color += texture2D(image, uv) * 0.2270270270;\n        color += texture2D(image, uv + (off1 / resolution)) * 0.3162162162;\n        color += texture2D(image, uv - (off1 / resolution)) * 0.3162162162;\n        color += texture2D(image, uv + (off2 / resolution)) * 0.0702702703;\n        color += texture2D(image, uv - (off2 / resolution)) * 0.0702702703;\n        return color;\n    }\n    \n    vec4 blur3(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n        vec4 color = vec4(0.0);\n        vec2 off1 = vec2(1.411764705882353) * direction;\n        vec2 off2 = vec2(3.2941176470588234) * direction;\n        vec2 off3 = vec2(5.176470588235294) * direction;\n        color += texture2D(image, uv) * 0.1964825501511404;\n        color += texture2D(image, uv + (off1 / resolution)) * 0.2969069646728344;\n        color += texture2D(image, uv - (off1 / resolution)) * 0.2969069646728344;\n        color += texture2D(image, uv + (off2 / resolution)) * 0.09447039785044732;\n        color += texture2D(image, uv - (off2 / resolution)) * 0.09447039785044732;\n        color += texture2D(image, uv + (off3 / resolution)) * 0.010381362401148057;\n        color += texture2D(image, uv - (off3 / resolution)) * 0.010381362401148057;\n        return color;\n    }    \n\n    void main(void){\n        if (kernelRadius == 1) {\n            gl_FragColor = blur1(uSampler, vTextureCoord, resolution, direction) * vColor;\n        } else if (kernelRadius == 2) {\n            gl_FragColor = blur2(uSampler, vTextureCoord, resolution, direction) * vColor;\n        } else {\n            gl_FragColor = blur3(uSampler, vTextureCoord, resolution, direction) * vColor;\n        }\n    }\n";
class I extends w{setupUniforms(a){super.setupUniforms(a);const b=1/a.getTextureWidth(0);a=1/a.getTextureHeight(0);this._setUniform("stepTextureCoord",new Float32Array([b,a]),this.gl.uniform2fv)}}I.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    uniform vec2 stepTextureCoord;\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec4 vColor;\n    varying vec2 vTextureCoordUl;\n    varying vec2 vTextureCoordUr;\n    varying vec2 vTextureCoordBl;\n    varying vec2 vTextureCoordBr;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoordUl = aTextureCoord - stepTextureCoord;\n        vTextureCoordBr = aTextureCoord + stepTextureCoord;\n        vTextureCoordUr = vec2(vTextureCoordBr.x, vTextureCoordUl.y);\n        vTextureCoordBl = vec2(vTextureCoordUl.x, vTextureCoordBr.y);\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n";
I.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoordUl;\n    varying vec2 vTextureCoordUr;\n    varying vec2 vTextureCoordBl;\n    varying vec2 vTextureCoordBr;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    void main(void){\n        vec4 color = 0.25 * (texture2D(uSampler, vTextureCoordUl) + texture2D(uSampler, vTextureCoordUr) + texture2D(uSampler, vTextureCoordBl) + texture2D(uSampler, vTextureCoordBr));\n        gl_FragColor = color * vColor;\n    }\n";
class za extends N{constructor(a){super(a);this._kernelRadius=1}get kernelRadius(){return this._kernelRadius}set kernelRadius(a){this._kernelRadius=a;this.redraw()}useDefault(){return 0===this._amount}_beforeDrawEl({target:a}){a.ctx.filter="blur("+this._kernelRadius+"px)"}_afterDrawEl({target:a}){a.ctx.filter="none"}}class $a extends x{static _template(){return{passSignals:!0,Wrap:{type:Aa,_$c2d:{type:X}}}}get wrap(){return this.tag("Wrap")}set content(a){return this.wrap.content=a}get content(){return this.wrap.content}set padding(a){this.wrap._paddingX=
a;this.wrap._paddingY=a;this.wrap._updateBlurSize()}set paddingX(a){this.wrap._paddingX=a;this.wrap._updateBlurSize()}set paddingY(a){this.wrap._paddingY=a;this.wrap._updateBlurSize()}set amount(a){return this.wrap.amount=a}get amount(){return this.wrap.amount}set shader(a){this.wrap.shader=a}_onResize(){this.wrap.w=this.renderWidth;this.wrap.h=this.renderHeight}get _passSignals(){return!0}}class X extends x{static _template(){return{forceZIndexContext:!0,rtt:!0,Textwrap:{shader:{type:za},Content:{}}}}constructor(a){super(a);
this._textwrap=this.sel("Textwrap");this._wrapper=this.sel("Textwrap>Content");this._paddingY=this._paddingX=this._amount=0}static getSpline(){this._multiSpline||(this._multiSpline=new u,this._multiSpline.parse(!1,{0:0,"0.25":1.5,"0.5":5.5,"0.75":18,1:39}));return this._multiSpline}get content(){return this.sel("Textwrap>Content")}set content(a){this.sel("Textwrap>Content").patch(a,!0)}set padding(a){this._paddingY=this._paddingX=a;this._updateBlurSize()}set paddingX(a){this._paddingX=a;this._updateBlurSize()}set paddingY(a){this._paddingY=
a;this._updateBlurSize()}_updateBlurSize(){let a=this.renderWidth,b=this.renderHeight,c=this._paddingX,d=this._paddingY;this._wrapper.x=c;this._textwrap.x=-c;this._wrapper.y=d;this._textwrap.y=-d;this._textwrap.w=a+2*c;this._textwrap.h=b+2*d}get amount(){return this._amount}set amount(a){this._amount=a;this._textwrap.shader.kernelRadius=X._amountToKernelRadius(a)}static _amountToKernelRadius(a){return X.getSpline().getValue(Math.min(1,.25*a))}get _passSignals(){return!0}}class Aa extends x{static _template(){const a=
function(a,c){if(c._recalc&130){a=c.rw;const b=c.rh;do c=c._children[0],c._view.w=a,c._view.h=b;while(c._children)}};return{Textwrap:{rtt:!0,forceZIndexContext:!0,renderOffscreen:!0,Content:{}},Layers:{L0:{rtt:!0,onUpdate:a,renderOffscreen:!0,visible:!1,Content:{shader:{type:I}}},L1:{rtt:!0,onUpdate:a,renderOffscreen:!0,visible:!1,Content:{shader:{type:I}}},L2:{rtt:!0,onUpdate:a,renderOffscreen:!0,visible:!1,Content:{shader:{type:I}}},L3:{rtt:!0,onUpdate:a,renderOffscreen:!0,visible:!1,Content:{shader:{type:I}}}},
Result:{shader:{type:Ba},visible:!1}}}constructor(a){super(a);this._textwrap=this.sel("Textwrap");this._wrapper=this.sel("Textwrap>Content");this._layers=this.sel("Layers");this._output=this.sel("Result");this._paddingY=this._paddingX=this._amount=0}_build(){const a=[{x:1,y:0,kernelRadius:1},{x:0,y:1,kernelRadius:1},{x:1.5,y:0,kernelRadius:1},{x:0,y:1.5,kernelRadius:1}].map((a)=>M.create(this.stage,Object.assign({type:W},a)));this._setLayerTexture(this.getLayerContents(0),this._textwrap.getTexture(),
[]);this._setLayerTexture(this.getLayerContents(1),this.getLayer(0).getTexture(),[a[0],a[1]]);this._setLayerTexture(this.getLayerContents(2),this.getLayer(1).getTexture(),[a[0],a[1],a[2],a[3]]);this._setLayerTexture(this.getLayerContents(3),this.getLayer(2).getTexture(),[a[0],a[1],a[2],a[3]])}_setLayerTexture(a,b,c){if(c.length){var d=c.pop();d=a.stage.c({rtt:!0,shader:d});this._setLayerTexture(d,b,c);a.childList.add(d)}else a.texture=b;return a}get content(){return this.sel("Textwrap>Content")}set content(a){this.sel("Textwrap>Content").patch(a,
!0)}set padding(a){this._paddingY=this._paddingX=a;this._updateBlurSize()}set paddingX(a){this._paddingX=a;this._updateBlurSize()}set paddingY(a){this._paddingY=a;this._updateBlurSize()}getLayer(a){return this._layers.sel("L"+a)}getLayerContents(a){return this.getLayer(a).sel("Content")}_onResize(){this._updateBlurSize()}_updateBlurSize(){let a=this.renderWidth,b=this.renderHeight,c=this._paddingX,d=this._paddingY,e=a+2*c,f=b+2*d;this._textwrap.w=e;this._wrapper.x=c;this.getLayer(0).w=this.getLayerContents(0).w=
e/2;this.getLayer(1).w=this.getLayerContents(1).w=e/4;this.getLayer(2).w=this.getLayerContents(2).w=e/8;this.getLayer(3).w=this.getLayerContents(3).w=e/16;this._output.x=-c;this._textwrap.x=-c;this._output.w=e;this._textwrap.h=f;this._wrapper.y=d;this.getLayer(0).h=this.getLayerContents(0).h=f/2;this.getLayer(1).h=this.getLayerContents(1).h=f/4;this.getLayer(2).h=this.getLayerContents(2).h=f/8;this.getLayer(3).h=this.getLayerContents(3).h=f/16;this._output.y=-d;this._textwrap.y=-d;this._output.h=
f;this.w=a;this.h=b}set amount(a){this._amount=a;this._update()}get amount(){return this._amount}_update(){let a=Math.min(4,Math.max(0,this._amount));0===a?(this._textwrap.renderToTexture=!1,this._output.shader.otherTextureSource=null,this._output.visible=!1):(this._textwrap.renderToTexture=!0,this._output.visible=!0,this.getLayer(0).visible=0<a,this.getLayer(1).visible=1<a,this.getLayer(2).visible=2<a,this.getLayer(3).visible=3<a,1>=a?(this._output.texture=this._textwrap.getTexture(),this._output.shader.otherTextureSource=
this.getLayer(0).getTexture(),this._output.shader.a=a):2>=a?(this._output.texture=this.getLayer(0).getTexture(),this._output.shader.otherTextureSource=this.getLayer(1).getTexture(),this._output.shader.a=a-1):3>=a?(this._output.texture=this.getLayer(1).getTexture(),this._output.shader.otherTextureSource=this.getLayer(2).getTexture(),this._output.shader.a=a-2):4>=a&&(this._output.texture=this.getLayer(2).getTexture(),this._output.shader.otherTextureSource=this.getLayer(3).getTexture(),this._output.shader.a=
a-3))}set shader(a){super.shader=a;this.renderToTexture||console.warn("FastBlurView: please enable renderToTexture to use with a shader.")}static _states(){return{_firstActive:Aa.prototype._build}}get _passSignals(){return!0}}class Ba extends w{constructor(a){super(a);this._a=0;this._otherTextureSource=null}get a(){return this._a}set a(a){this._a=a;this.redraw()}set otherTextureSource(a){this._otherTextureSource=a;this.redraw()}setupUniforms(a){super.setupUniforms(a);this._setUniform("a",this._a,
this.gl.uniform1f);this._setUniform("uSampler2",1,this.gl.uniform1i)}beforeDraw(a){a=this._otherTextureSource?this._otherTextureSource.nativeTexture:null;let b=this.gl;b.activeTexture(b.TEXTURE1);b.bindTexture(b.TEXTURE_2D,a);b.activeTexture(b.TEXTURE0)}}Ba.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform sampler2D uSampler2;\n    uniform float a;\n    void main(void){\n        if (a == 1.0) {\n            gl_FragColor = texture2D(uSampler2, vTextureCoord) * vColor;\n        } else {\n            gl_FragColor = ((1.0 - a) * texture2D(uSampler, vTextureCoord) + (a * texture2D(uSampler2, vTextureCoord))) * vColor;\n        }\n    }\n";
class Y extends x{static _template(){return{ContentWrap:{renderOffscreen:!0,forceZIndexContext:!0,onAfterUpdate:Y._updateDimensions,Content:{}},Scale:{visible:!1}}}constructor(a){super(a);this._smoothScale=1;this._iterations=0}get content(){return this.tag("Content")}set content(a){this.tag("Content").patch(a,!0)}get smoothScale(){return this._smoothScale}set smoothScale(a){if(this._smoothScale!==a){let b=0;for(;.5>a&&12>b;)b++,a*=2;this.scale=a;this._setIterations(b);this._smoothScale=a}}_setIterations(a){if(this._iterations!==
a){const c=this.sel("Scale").childList;for(var b=this.sel("ContentWrap");c.length<a;){const a=0===c.length?b.getTexture():c.last.getTexture();c.a({rtt:!0,renderOffscreen:!0,texture:a})}Y._updateDimensions(this.tag("ContentWrap"),!0);b=0<a;this.patch({ContentWrap:{renderToTexture:b},Scale:{visible:b}});for(let b=0,e=c.length;b<e;b++)c.getAt(b).patch({visible:b<a,renderOffscreen:b!==a-1});this._iterations=a}}static _updateDimensions(a,b){var c=a.children[0];let d=c.renderWidth;c=c.renderHeight;if(d!==
a.w||c!==a.h||b){a.w=d;a.h=c;a=a.parent.tag("Scale").children;for(let b=0,f=a.length;b<f;b++)d*=.5,c*=.5,a[b].w=d,a[b].h=c}}get _passSignals(){return!0}}class ab extends x{static _template(){return{Content:{},Borders:{Top:{rect:!0,visible:!1,mountY:1},Right:{rect:!0,visible:!1},Bottom:{rect:!0,visible:!1},Left:{rect:!0,visible:!1,mountX:1}}}}constructor(a){super(a);this._borderTop=this.tag("Top");this._borderRight=this.tag("Right");this._borderBottom=this.tag("Bottom");this._borderLeft=this.tag("Left");
this.onAfterUpdate=function(a){var b=a.childList.first;let d=a.core.rw||b.renderWidth;b=a.core.rh||b.renderHeight;a._borderTop.w=d;a._borderBottom.y=b;a._borderBottom.w=d;a._borderLeft.h=b+a._borderTop.h+a._borderBottom.h;a._borderLeft.y=-a._borderTop.h;a._borderRight.x=d;a._borderRight.h=b+a._borderTop.h+a._borderBottom.h;a._borderRight.y=-a._borderTop.h};this.borderWidth=1}get content(){return this.sel("Content")}set content(a){this.sel("Content").patch(a,!0)}get borderWidth(){return this.borderWidthTop}get borderWidthTop(){return this._borderTop.h}get borderWidthRight(){return this._borderRight.w}get borderWidthBottom(){return this._borderBottom.h}get borderWidthLeft(){return this._borderLeft.w}set borderWidth(a){this.borderWidthLeft=
this.borderWidthBottom=this.borderWidthRight=this.borderWidthTop=a}set borderWidthTop(a){this._borderTop.h=a;this._borderTop.visible=0<a}set borderWidthRight(a){this._borderRight.w=a;this._borderRight.visible=0<a}set borderWidthBottom(a){this._borderBottom.h=a;this._borderBottom.visible=0<a}set borderWidthLeft(a){this._borderLeft.w=a;this._borderLeft.visible=0<a}get colorBorder(){return this.colorBorderTop}get colorBorderTop(){return this._borderTop.color}get colorBorderRight(){return this._borderRight.color}get colorBorderBottom(){return this._borderBottom.color}get colorBorderLeft(){return this._borderLeft.color}set colorBorder(a){this.colorBorderLeft=
this.colorBorderBottom=this.colorBorderRight=this.colorBorderTop=a}set colorBorderTop(a){this._borderTop.color=a}set colorBorderRight(a){this._borderRight.color=a}set colorBorderBottom(a){this._borderBottom.color=a}set colorBorderLeft(a){this._borderLeft.color=a}get borderTop(){return this._borderTop}set borderTop(a){this.borderTop.patch(a)}get borderRight(){return this._borderRight}set borderRight(a){this.borderRight.patch(a)}get borderBottom(){return this._borderBottom}set borderBottom(a){this.borderBottom.patch(a)}get borderLeft(){return this._borderLeft}set borderLeft(a){this.borderLeft.patch(a)}set borders(a){this.borderRight=
this.borderBottom=this.borderLeft=this.borderTop=a}get _passSignals(){return!0}}class Ca extends N{constructor(a){super(a);this._amount=1}static getWebGL(){return Z}set amount(a){this._amount=a;this.redraw()}get amount(){return this._amount}useDefault(){return 0===this._amount}_beforeDrawEl({target:a}){a.ctx.filter="grayscale("+this._amount+")"}_afterDrawEl({target:a}){a.ctx.filter="none"}}class Z extends w{constructor(a){super(a);this._amount=1}static getC2d(){return Ca}set amount(a){this._amount=
a;this.redraw()}get amount(){return this._amount}useDefault(){return 0===this._amount}setupUniforms(a){super.setupUniforms(a);this._setUniform("amount",this._amount,this.gl.uniform1f)}}Z.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform float amount;\n    void main(void){\n        vec4 color = texture2D(uSampler, vTextureCoord) * vColor;\n        float grayness = 0.2 * color.r + 0.6 * color.g + 0.2 * color.b;\n        gl_FragColor = vec4(amount * vec3(grayness, grayness, grayness) + (1.0 - amount) * color.rgb, color.a);\n    }\n";
class aa extends w{constructor(a){super(a);this._noiseTexture=new xa(a.stage);this._graining=1/256;this._random=!1}set graining(a){this._graining=a;this.redraw()}set random(a){this._random=a;this.redraw()}setExtraAttribsInBuffer(a){this._noiseTexture.load();let b=a.extraAttribsDataByteOffset/4,c=a.quads.floats,d=a.length;for(let f=0;f<d;f++){let d=a.getViewWidth(f)/this._noiseTexture.getRenderWidth(),h=a.getViewHeight(f)/this._noiseTexture.getRenderHeight(),k=0,l=0;if(this._random){k=Math.random();
l=Math.random();d+=k;h+=l;if(.5>Math.random()){var e=k;k=d;d=e}.5>Math.random()&&(e=l,l=h,h=e)}c[b]=k;c[b+1]=l;c[b+2]=d;c[b+3]=l;c[b+4]=d;c[b+5]=h;c[b+6]=k;c[b+7]=h;b+=8}}beforeDraw(a){let b=this.gl;b.vertexAttribPointer(this._attrib("aNoiseTextureCoord"),2,b.FLOAT,!1,8,this.getVertexAttribPointerOffset(a));a=this._noiseTexture.source.nativeTexture;b.activeTexture(b.TEXTURE1);b.bindTexture(b.TEXTURE_2D,a);b.activeTexture(b.TEXTURE0)}getExtraAttribBytesPerVertex(){return 8}setupUniforms(a){super.setupUniforms(a);
this._setUniform("uNoiseSampler",1,this.gl.uniform1i);this._setUniform("graining",2*this._graining,this.gl.uniform1f)}enableAttribs(){super.enableAttribs();this.gl.enableVertexAttribArray(this._attrib("aNoiseTextureCoord"))}disableAttribs(){super.disableAttribs();this.gl.disableVertexAttribArray(this._attrib("aNoiseTextureCoord"))}useDefault(){return 0===this._graining}afterDraw(a){this._random&&this.redraw()}}aa.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec2 aNoiseTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec2 vNoiseTextureCoord;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vNoiseTextureCoord = aNoiseTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n";
aa.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec2 vNoiseTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform sampler2D uNoiseSampler;\n    uniform float graining;\n    void main(void){\n        vec4 noise = texture2D(uNoiseSampler, vNoiseTextureCoord);\n        vec4 color = texture2D(uSampler, vTextureCoord);\n        gl_FragColor = (color * vColor) + graining * (noise.r - 0.5);\n    }\n";
class ba extends w{constructor(a){super(a);this._inputValue=0;this._maxDerivative=.01;this._offset=this._normalizedValue=0;this._amount=.1;this._aspectRatio=1;this._offsetY=this._offsetX=0;this.buckets=100}get aspectRatio(){return this._aspectRatio}set aspectRatio(a){this._aspectRatio=a;this.redraw()}get offsetX(){return this._offsetX}set offsetX(a){this._offsetX=a;this.redraw()}get offsetY(){return this._offsetY}set offsetY(a){this._offsetY=a;this.redraw()}set amount(a){this._amount=a;this.redraw()}get amount(){return this._amount}set inputValue(a){this._inputValue=
a}get inputValue(){return this._inputValue}set maxDerivative(a){this._maxDerivative=a}get maxDerivative(){return this._maxDerivative}set buckets(a){100<a&&(console.warn("CircularPushShader: supports max 100 buckets"),a=100);this._buckets=a;this._values=new Uint8Array(this._getValues(a));this.redraw()}get buckets(){return this._buckets}_getValues(a){const b=[];for(let c=0;c<a;c++)b.push(this._inputValue);return b}progress(a){this._offset+=a*this._buckets;a=Math.floor(this._offset);this._offset-=a;
this._shiftBuckets(a);this.redraw()}_shiftBuckets(a){for(let b=this._buckets-1;0<=b;b--){const c=b-a;0>c?(this._normalizedValue=Math.min(this._normalizedValue+this._maxDerivative,Math.max(this._normalizedValue-this._maxDerivative,this._inputValue)),this._values[b]=255*this._normalizedValue):this._values[b]=this._values[c]}}set offset(a){this._offset=a;this.redraw()}setupUniforms(a){super.setupUniforms(a);this._setUniform("aspectRatio",this._aspectRatio,this.gl.uniform1f);this._setUniform("offsetX",
this._offsetX,this.gl.uniform1f);this._setUniform("offsetY",this._offsetY,this.gl.uniform1f);this._setUniform("amount",this._amount,this.gl.uniform1f);this._setUniform("offset",this._offset,this.gl.uniform1f);this._setUniform("buckets",this._buckets,this.gl.uniform1f);this._setUniform("uValueSampler",1,this.gl.uniform1i)}useDefault(){return 0===this._amount}beforeDraw(a){a=this.gl;a.activeTexture(a.TEXTURE1);this._valuesTexture?a.bindTexture(a.TEXTURE_2D,this._valuesTexture):(this._valuesTexture=
a.createTexture(),a.bindTexture(a.TEXTURE_2D,this._valuesTexture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),l.isNode&&a.pixelStorei(a.UNPACK_FLIP_BLUE_RED,!1),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1));a.texImage2D(a.TEXTURE_2D,0,a.ALPHA,this._buckets,1,0,a.ALPHA,a.UNSIGNED_BYTE,this._values);
a.activeTexture(a.TEXTURE0)}cleanup(){this._valuesTexture&&this.gl.deleteTexture(this._valuesTexture)}}ba.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    uniform float offsetX;\n    uniform float offsetY;\n    uniform float aspectRatio;\n    varying vec2 vTextureCoord;\n    varying vec2 vPos;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vPos = vTextureCoord * 2.0 - 1.0;\n        vPos.y = vPos.y * aspectRatio;\n        vPos.y = vPos.y + offsetY;\n        vPos.x = vPos.x + offsetX;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n";
ba.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 vPos;\n    uniform float amount;\n    uniform float offset;\n    uniform float values[100];\n    uniform float buckets;\n    uniform sampler2D uSampler;\n    uniform sampler2D uValueSampler;\n    void main(void){\n        float l = length(vPos);\n        float m = (l * buckets * 0.678 - offset) / buckets;\n        float f = texture2D(uValueSampler, vec2(m, 0.0)).a * amount;\n        vec2 unit = vPos / l;\n        gl_FragColor = texture2D(uSampler, vTextureCoord - f * unit) * vColor;\n    }\n";
class Da extends w{}Da.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    void main(void){\n        vec4 color = texture2D(uSampler, vTextureCoord);\n        color.rgb = 1.0 - color.rgb; \n        gl_FragColor = color * vColor;\n    }\n";class ca extends w{constructor(a){super(a);this._width=5;this._col=4294967295;this._color=[1,1,1,1]}set width(a){this._width=a;this.redraw()}get color(){return this._col}set color(a){if(this._col!==
a){const b=t.getRgbaComponentsNormalized(a);b[0]*=b[3];b[1]*=b[3];b[2]*=b[3];this._color=b;this.redraw();this._col=a}}useDefault(){return 0===this._width||0===this._col[3]}setupUniforms(a){super.setupUniforms(a);a=this.gl;this._setUniform("color",new Float32Array(this._color),a.uniform4fv)}enableAttribs(){super.enableAttribs();this.gl.enableVertexAttribArray(this._attrib("aCorner"))}disableAttribs(){super.disableAttribs();this.gl.disableVertexAttribArray(this._attrib("aCorner"))}setExtraAttribsInBuffer(a){let b=
a.extraAttribsDataByteOffset/4,c=a.quads.floats,d=a.length;for(let g=0;g<d;g++){var e=a.getViewCore(g),f=this._width/e.rw;f/=1-2*f;e=this._width/e.rh;e/=1-2*e;c[b]=-f;c[b+1]=-e;c[b+2]=1+f;c[b+3]=-e;c[b+4]=1+f;c[b+5]=1+e;c[b+6]=-f;c[b+7]=1+e;b+=8}}beforeDraw(a){let b=this.gl;b.vertexAttribPointer(this._attrib("aCorner"),2,b.FLOAT,!1,8,this.getVertexAttribPointerOffset(a))}getExtraAttribBytesPerVertex(){return 8}}ca.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    attribute vec2 aCorner;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec2 vCorner;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vCorner = aCorner;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n";
ca.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 vCorner;\n    uniform vec4 color;\n    uniform sampler2D uSampler;\n    void main(void){\n        vec2 m = min(vCorner, 1.0 - vCorner);\n        float value = step(0.0, min(m.x, m.y));\n        gl_FragColor = mix(color, texture2D(uSampler, vTextureCoord) * vColor, value);\n    }\n";class da extends w{constructor(a){super(a);this._size=new Float32Array([4,
4])}get x(){return this._size[0]}set x(a){this._size[0]=a;this.redraw()}get y(){return this._size[1]}set y(a){this._size[1]=a;this.redraw()}get size(){return this._size[0]}set size(a){this._size[0]=a;this._size[1]=a;this.redraw()}useDefault(){return 0===this._size[0]&&0===this._size[1]}static getWebGLImpl(){return WebGLPixelateShaderImpl}setupUniforms(a){super.setupUniforms(a);a=this.gl;this._setUniform("size",new Float32Array(this._size),a.uniform2fv)}getExtraAttribBytesPerVertex(){return 8}enableAttribs(){super.enableAttribs();
this.gl.enableVertexAttribArray(this._attrib("aTextureRes"))}disableAttribs(){super.disableAttribs();this.gl.disableVertexAttribArray(this._attrib("aTextureRes"))}setExtraAttribsInBuffer(a){let b=a.extraAttribsDataByteOffset/4,c=a.quads.floats,d=a.length;for(let e=0;e<d;e++){let d=a.quads.getTextureWidth(a.index+e),g=a.quads.getTextureHeight(a.index+e);c[b]=d;c[b+1]=g;c[b+2]=d;c[b+3]=g;c[b+4]=d;c[b+5]=g;c[b+6]=d;c[b+7]=g;b+=8}}beforeDraw(a){let b=this.gl;b.vertexAttribPointer(this._attrib("aTextureRes"),
2,b.FLOAT,!1,this.getExtraAttribBytesPerVertex(),this.getVertexAttribPointerOffset(a))}}da.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    attribute vec2 aTextureRes;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 vTextureRes;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        vTextureRes = aTextureRes;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n";
da.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 vTextureRes;\n\n    uniform vec2 size;\n    uniform sampler2D uSampler;\n    \n    vec2 mapCoord( vec2 coord )\n    {\n        coord *= vTextureRes.xy;\n        return coord;\n    }\n    \n    vec2 unmapCoord( vec2 coord )\n    {\n        coord /= vTextureRes.xy;\n        return coord;\n    }\n    \n    vec2 pixelate(vec2 coord, vec2 size)\n    {\n        return floor( coord / size ) * size;\n    }\n    \n    void main(void)\n    {\n        vec2 coord = mapCoord(vTextureCoord);\n        coord = pixelate(coord, size);\n        coord = unmapCoord(coord);\n        gl_FragColor = texture2D(uSampler, coord) * vColor;\n    }\n";
class ea extends w{constructor(a){super(a);this._radius=0;this._cutoff=1}set radius(a){this._radius=a;this.redraw()}get radius(){return this._radius}set cutoff(a){this._cutoff=a;this.redraw()}get cutoff(){return this._cutoff}useDefault(){return 0===this._radius}setupUniforms(a){super.setupUniforms(a);this._setUniform("radius",2*(this._radius-.5)/a.getRenderWidth(),this.gl.uniform1f);this._setUniform("cutoff",.5*a.getRenderWidth()/this._cutoff,this.gl.uniform1f)}}ea.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 pos;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n        pos = gl_Position.xy;\n    }\n";
ea.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec2 pos;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform float radius;\n    uniform float cutoff;\n    void main(void){\n        vec4 color = texture2D(uSampler, vTextureCoord);\n        float f = max(0.0, min(1.0, 1.0 - (length(pos) - radius) * cutoff));\n        gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor * f;\n    }\n";class fa extends w{constructor(a){super(a);
this._y=this._x=0;this.color=4294901760;this._radiusY=this._radiusX=100}set x(a){this._x=a;this.redraw()}set y(a){this._y=a;this.redraw()}set radiusX(a){this._radiusX=a;this.redraw()}get radiusX(){return this._radiusX}set radiusY(a){this._radiusY=a;this.redraw()}get radiusY(){return this._radiusY}set radius(a){this.radiusY=this.radiusX=a}get color(){return this._color}set color(a){if(this._color!==a){const b=t.getRgbaComponentsNormalized(a);b[0]*=b[3];b[1]*=b[3];b[2]*=b[3];this._rawColor=new Float32Array(b);
this.redraw();this._color=a}}setupUniforms(a){super.setupUniforms(a);const b=a.getNormalRenderTextureCoords(this._x,this._y);this._setUniform("center",new Float32Array(b),this.gl.uniform2fv);this._setUniform("radius",2*this._radiusX/a.getRenderWidth(),this.gl.uniform1f);this._setUniform("alpha",a.getViewCore(0).renderContext.alpha,this.gl.uniform1f);this._setUniform("color",this._rawColor,this.gl.uniform4fv);this._setUniform("aspectRatio",this._radiusX/this._radiusY*a.getRenderHeight()/a.getRenderWidth(),
this.gl.uniform1f)}}fa.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    uniform vec2 center;\n    uniform float aspectRatio;\n    varying vec2 pos;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n        pos = gl_Position.xy - center;\n        pos.y = pos.y * aspectRatio;\n    }\n";
fa.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 pos;\n    uniform sampler2D uSampler;\n    uniform float radius;\n    uniform vec4 color;\n    uniform float alpha;\n    void main(void){\n        float dist = length(pos);\n        gl_FragColor = mix(color * alpha, texture2D(uSampler, vTextureCoord) * vColor, min(1.0, dist / radius));\n    }\n";class ha extends w{constructor(a){super(a);this._ambient=
this._strength=.5;this._fudge=.4;this._z=this._ry=this._rx=0;this._pivotY=this._pivotX=NaN;this._lightZ=this._lightY=this._pivotZ=0}setupUniforms(a){super.setupUniforms(a);a=a.shaderOwner;var b=a.view,c=isNaN(this._pivotX)?b.pivotX*a.rw:this._pivotX;b=isNaN(this._pivotY)?b.pivotY*a.rh:this._pivotY;c=a.getRenderTextureCoords(c,b);a=-Math.atan2(a._renderContext.tc,a._renderContext.ta);b=this.gl;this._setUniform("pivot",new Float32Array([c[0],c[1],this._pivotZ]),b.uniform3fv);this._setUniform("rot",
new Float32Array([this._rx,this._ry,a]),b.uniform3fv);this._setUniform("z",this._z,b.uniform1f);this._setUniform("lightY",this.lightY,b.uniform1f);this._setUniform("lightZ",this.lightZ,b.uniform1f);this._setUniform("strength",this._strength,b.uniform1f);this._setUniform("ambient",this._ambient,b.uniform1f);this._setUniform("fudge",this._fudge,b.uniform1f)}set strength(a){this._strength=a;this.redraw()}get strength(){return this._strength}set ambient(a){this._ambient=a;this.redraw()}get ambient(){return this._ambient}set fudge(a){this._fudge=
a;this.redraw()}get fudge(){return this._fudge}get rx(){return this._rx}set rx(a){this._rx=a;this.redraw()}get ry(){return this._ry}set ry(a){this._ry=a;this.redraw()}get z(){return this._z}set z(a){this._z=a;this.redraw()}get pivotX(){return this._pivotX}set pivotX(a){this._pivotX=a+1;this.redraw()}get pivotY(){return this._pivotY}set pivotY(a){this._pivotY=a+1;this.redraw()}get lightY(){return this._lightY}set lightY(a){this._lightY=a;this.redraw()}get pivotZ(){return this._pivotZ}set pivotZ(a){this._pivotZ=
a;this.redraw()}get lightZ(){return this._lightZ}set lightZ(a){this._lightZ=a;this.redraw()}useDefault(){return 0===this._rx&&0===this._ry&&0===this._z&&0===this._strength&&1===this._ambient}}ha.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n\n    uniform float fudge;\n    uniform float strength;\n    uniform float ambient;\n    uniform float z;\n    uniform float lightY;\n    uniform float lightZ;\n    uniform vec3 pivot;\n    uniform vec3 rot;\n    varying vec3 pos;\n\n    void main(void) {\n        pos = vec3(aVertexPosition.xy, z);\n        \n        pos -= pivot;\n        \n        // Undo XY rotation\n        mat2 iRotXy = mat2( cos(rot.z), sin(rot.z), \n                           -sin(rot.z), cos(rot.z));\n        pos.xy = iRotXy * pos.xy;\n        \n        // Perform 3d rotations\n        gl_Position.x = cos(rot.x) * pos.x - sin(rot.x) * pos.z;\n        gl_Position.y = pos.y;\n        gl_Position.z = sin(rot.x) * pos.x + cos(rot.x) * pos.z;\n        \n        pos.x = gl_Position.x;\n        pos.y = cos(rot.y) * gl_Position.y - sin(rot.y) * gl_Position.z;\n        pos.z = sin(rot.y) * gl_Position.y + cos(rot.y) * gl_Position.z;\n        \n        // Redo XY rotation\n        iRotXy[0][1] = -iRotXy[0][1];\n        iRotXy[1][0] = -iRotXy[1][0];\n        pos.xy = iRotXy * pos.xy; \n\n        // Undo translate to pivot position\n        pos.xyz += pivot;\n\n        pos = vec3(pos.x * projection.x - 1.0, pos.y * -abs(projection.y) + 1.0, pos.z * projection.x);\n        \n        // Set depth perspective\n        float perspective = 1.0 + fudge * pos.z;\n\n        pos.z += lightZ * projection.x;\n\n        // Map coords to gl coordinate space.\n        // Set z to 0 because we don't want to perform z-clipping\n        gl_Position = vec4(pos.xy, 0.0, perspective);\n\n        // Correct light source position.\n        pos.y += lightY * abs(projection.y);\n\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        \n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n";
ha.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec3 pos;\n    uniform sampler2D uSampler;\n    uniform float ambient;\n    uniform float strength;\n    void main(void){\n        vec4 rgba = texture2D(uSampler, vTextureCoord);\n        float d = length(pos);\n        float n = 1.0 / max(0.1, d);\n        rgba.rgb = rgba.rgb * (strength * n + ambient);\n        gl_FragColor = rgba * vColor;\n    }\n";
return{Application:G,Component:x,Base:E,Utils:l,StageUtils:t,View:q,Tools:P,Stage:V,ViewCore:L,ViewTexturizer:ia,Texture:A,EventEmitter:v,shaders:{Grayscale:Z,BoxBlur:I,Dithering:aa,CircularPush:ba,Inversion:Da,LinearBlur:W,Outline:ca,Pixelate:da,RadialFilter:ea,RadialGradient:fa,Light3d:ha,WebGLShader:S,WebGLDefaultShader:w,C2dShader:T,C2dDefaultShader:N,c2d:{Grayscale:Ca,Blur:za}},textures:{RectangleTexture:sa,NoiseTexture:xa,TextTexture:J,ImageTexture:Q,HtmlTexture:ya,StaticTexture:Xa,StaticCanvasTexture:ta,
SourceTexture:ja},components:{FastBlurComponent:$a,SmoothScaleComponent:Y,BorderComponent:ab,ListComponent:Ya},tools:{ObjMerger:ua,ObjectListProxy:va,ObjectListWrapper:wa}}}();
