'use strict';var _get=function e(o,s,n){null===o&&(o=Function.prototype);var l=Object.getOwnPropertyDescriptor(o,s);if(l===void 0){var d=Object.getPrototypeOf(o);return null===d?void 0:e(d,s,n)}if('value'in l)return l.value;var _=l.get;return void 0===_?void 0:_.call(n)},_typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&'function'==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?'symbol':typeof e},_createClass=function(){function e(e,o){for(var s,n=0;n<o.length;n++)s=o[n],s.enumerable=s.enumerable||!1,s.configurable=!0,'value'in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}return function(o,s,n){return s&&e(o.prototype,s),n&&e(o,n),o}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var o=0,s=Array(e.length);o<e.length;o++)s[o]=e[o];return s}return Array.from(e)}function _possibleConstructorReturn(e,o){if(!e)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return o&&('object'==typeof o||'function'==typeof o)?o:e}function _inherits(e,o){if('function'!=typeof o&&null!==o)throw new TypeError('Super expression must either be null or a function, not '+typeof o);e.prototype=Object.create(o&&o.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),o&&(Object.setPrototypeOf?Object.setPrototypeOf(e,o):e.__proto__=o)}function _classCallCheck(e,o){if(!(e instanceof o))throw new TypeError('Cannot call a class as a function')}var has=Object.prototype.hasOwnProperty,prefix='~';function Events(){}Object.create&&(Events.prototype=Object.create(null),!new Events().__proto__&&(prefix=!1));function EE(e,o,s){this.fn=e,this.context=o,this.once=s||!1}function EventEmitter(){this._events=new Events,this._eventsCount=0}EventEmitter.prototype.eventNames=function(){var e,o,s=[];if(0===this._eventsCount)return s;for(o in e=this._events)has.call(e,o)&&s.push(prefix?o.slice(1):o);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},EventEmitter.prototype.listeners=function(e,o){var s=prefix?prefix+e:e,n=this._events[s];if(o)return!!n;if(!n)return[];if(n.fn)return[n.fn];for(var d=0,_=n.length,l=Array(_);d<_;d++)l[d]=n[d].fn;return l},EventEmitter.prototype.emit=function(e,o,s,n,l,d){var _=prefix?prefix+e:e;if(!this._events[_])return!1;var u,c,x=this._events[_],h=arguments.length;if(x.fn){switch(x.once&&this.removeListener(e,x.fn,void 0,!0),h){case 1:return x.fn.call(x.context),!0;case 2:return x.fn.call(x.context,o),!0;case 3:return x.fn.call(x.context,o,s),!0;case 4:return x.fn.call(x.context,o,s,n),!0;case 5:return x.fn.call(x.context,o,s,n,l),!0;case 6:return x.fn.call(x.context,o,s,n,l,d),!0;}for(c=1,u=Array(h-1);c<h;c++)u[c-1]=arguments[c];x.fn.apply(x.context,u)}else{var y,f=x.length;for(c=0;c<f;c++)switch(x[c].once&&this.removeListener(e,x[c].fn,void 0,!0),h){case 1:x[c].fn.call(x[c].context);break;case 2:x[c].fn.call(x[c].context,o);break;case 3:x[c].fn.call(x[c].context,o,s);break;case 4:x[c].fn.call(x[c].context,o,s,n);break;default:if(!u)for(y=1,u=Array(h-1);y<h;y++)u[y-1]=arguments[y];x[c].fn.apply(x[c].context,u);}}return!0},EventEmitter.prototype.on=function(e,o,s){var n=new EE(o,s||this),l=prefix?prefix+e:e;return this._events[l]?this._events[l].fn?this._events[l]=[this._events[l],n]:this._events[l].push(n):(this._events[l]=n,this._eventsCount++),this},EventEmitter.prototype.once=function(e,o,s){var n=new EE(o,s||this,!0),l=prefix?prefix+e:e;return this._events[l]?this._events[l].fn?this._events[l]=[this._events[l],n]:this._events[l].push(n):(this._events[l]=n,this._eventsCount++),this},EventEmitter.prototype.removeListener=function(e,o,s,n){var l=prefix?prefix+e:e;if(!this._events[l])return this;if(!o)return 0==--this._eventsCount?this._events=new Events:delete this._events[l],this;var d=this._events[l];if(d.fn)d.fn!==o||n&&!d.once||s&&d.context!==s||(0==--this._eventsCount?this._events=new Events:delete this._events[l]);else{for(var _=0,u=[],c=d.length;_<c;_++)(d[_].fn!==o||n&&!d[_].once||s&&d[_].context!==s)&&u.push(d[_]);u.length?this._events[l]=1===u.length?u[0]:u:0==--this._eventsCount?this._events=new Events:delete this._events[l]}return this},EventEmitter.prototype.removeAllListeners=function(e){var o;return e?(o=prefix?prefix+e:e,this._events[o]&&(0==--this._eventsCount?this._events=new Events:delete this._events[o])):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prototype.setMaxListeners=function(){return this},EventEmitter.prefixed=prefix,EventEmitter.EventEmitter=EventEmitter,'undefined'!=typeof module;var WebAdapter=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:'init',value:function init(e){this.stage=e,this.canvas=null,this._looping=!1,this._awaitingLoop=!1}},{key:'startLoop',value:function startLoop(){this._looping=!0,this._awaitingLoop||this.loop()}},{key:'stopLoop',value:function stopLoop(){this._looping=!1}},{key:'loop',value:function loop(){var e=this,o=function(){e._awaitingLoop=!1,e._looping&&(e.stage.drawFrame(),requestAnimationFrame(o),e._awaitingLoop=!0)};o()}},{key:'uploadGlTexture',value:function uploadGlTexture(e,o,s,n){var l=n?e.RGBA:e.RGB;s instanceof ImageData||s instanceof HTMLImageElement||s instanceof HTMLCanvasElement||s instanceof HTMLVideoElement||window.ImageBitmap&&s instanceof ImageBitmap?e.texImage2D(e.TEXTURE_2D,0,l,l,e.UNSIGNED_BYTE,s):e.texImage2D(e.TEXTURE_2D,0,l,o.w,o.h,0,l,e.UNSIGNED_BYTE,s)}},{key:'loadSrcTexture',value:function loadSrcTexture(e,o,s,n){var l=0<=e.indexOf('.png');if(window.OffthreadImage&&OffthreadImage.available){var d=document.createElement('DIV');d.setAttribute('alt','.');var _=new OffthreadImage(d);d.addEventListener('painted',function(){var o=d.childNodes[0];n(null,o,{renderInfo:{src:e},hasAlpha:!0,premultiplyAlpha:!0})}),_.src=e}else{var u=new Image;'data:'==e.substr(0,5)||(u.crossOrigin='Anonymous'),u.onerror=function(){return n('Image load error')},u.onload=function(){n(null,u,{renderInfo:{src:e},hasAlpha:l})},u.src=e}}},{key:'loadTextTexture',value:function loadTextTexture(e,o,s,n){var l=new TextRenderer(this.getDrawingCanvas(),e),d=l.draw(),_=d.renderInfo,u={renderInfo:_,precision:d.renderInfo.precision},c=d.canvas;n(null,c,u)}},{key:'createWebGLContext',value:function createWebGLContext(e,o){var s=this.stage.options.canvas||document.createElement('canvas');s.width=e,s.height=o;var n={alpha:!0,antialias:!1,premultipliedAlpha:!0,stencil:!0,preserveDrawingBuffer:!1},l=s.getContext('webgl',n)||s.getContext('experimental-webgl',n);if(!l)throw new Error('This browser does not support webGL.');return this.canvas=s,l}},{key:'getWebGLCanvas',value:function getWebGLCanvas(){return this.canvas}},{key:'getHrTime',value:function getHrTime(){return window.performance?window.performance.now():new Date().getTime()}},{key:'getDrawingCanvas',value:function getDrawingCanvas(){return document.createElement('canvas')}},{key:'nextFrame',value:function nextFrame(){}}]),e}(),Base=function(){function e(){_classCallCheck(this,e);var o=Object.getPrototypeOf(this);e.protoReady.has(o)||e.initPrototype(o)}return _createClass(e,[{key:'_properties',value:function _properties(){}},{key:'setSettings',value:function setSettings(o){e.setObjectSettings(this,o)}}],[{key:'initPrototype',value:function initPrototype(o){if(!e.protoReady.has(o)){for(var s=[];o;)e.protoReady.has(o)||s.push(o),e.protoReady.add(o),o=Object.getPrototypeOf(o);for(var n=stack.length-1;0<=n;n--)o=stack[n],o.hasOwnProperty('_properties')&&o._properties()}}},{key:'mixinEs5',value:function mixinEs5(e,o){for(var s=o.prototype,n=Object.getOwnPropertyNames(s),l=0;l<n.length;l++){var d=n[l],_=Object.getOwnPropertyDescriptor(s,d);'constructor'!==d&&_.configurable&&(e.prototype[d]?console.warn('Mixin overwrites '+d):Object.defineProperty(e.prototype,d,_))}return e}},{key:'setObjectSettings',value:function setObjectSettings(o,s){for(var l in s)if(s.hasOwnProperty(l)&&'type'!=l){var d=s[l];if(Utils.isObjectLiteral(d)&&Utils.isObject(o[l])){var n=o[l];n.setSettings?n.setSettings(d):e.setObjectSettings(n,d)}else o[l]=d}}}]),e}();Base.protoReady=new WeakSet;var Utils=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:'isFunction',value:function isFunction(e){return'function'==typeof e}},{key:'isNumber',value:function isNumber(e){return'number'==typeof e}},{key:'isInteger',value:function isInteger(e){return'number'==typeof e&&0==e%1}},{key:'isBoolean',value:function isBoolean(e){return!0===e||!1===e}},{key:'isString',value:function isString(e){return'string'==typeof e}},{key:'cloneObj',value:function cloneObj(e){for(var o=Object.keys(e),s={},n=0;n<o.length;n++)s[o[n]]=e[o[n]];return clone}},{key:'merge',value:function merge(e,o){for(var s=Object.keys(o),n=0;n<s.length;n++)e[s[n]]=o[s[n]];return e}},{key:'isObject',value:function isObject(e){var o='undefined'==typeof e?'undefined':_typeof(e);return!!e&&('object'==o||'function'==o)}},{key:'isPlainObject',value:function isPlainObject(e){var o='undefined'==typeof e?'undefined':_typeof(e);return!!e&&'object'==o}},{key:'isObjectLiteral',value:function isObjectLiteral(e){return'object'===('undefined'==typeof e?'undefined':_typeof(e))&&e&&e.constructor===Object}},{key:'getArrayIndex',value:function getArrayIndex(o,s){return e.getModuloIndex(o,s.length)}},{key:'getModuloIndex',value:function getModuloIndex(e,o){if(0==o)return e;for(;0>e;)e+=Math.ceil(-e/o)*o;return e%=o,e}},{key:'getDeepClone',value:function getDeepClone(o){var s,n;if(e.isFunction(o))return o;if(e.isArray(o)){n=[];var l=Object.keys(o);for(s=0;s<l.length;s++)n[l[s]]=e.getDeepClone(o[l[s]]);return n}if(e.isObject(o)){n={};var d=Object.keys(o);for(s=0;s<d.length;s++)n[d[s]]=e.getDeepClone(o[d[s]]);return n}return o}},{key:'setToArray',value:function setToArray(e){var o=[];return e.forEach(function(e){o.push(e)}),o}},{key:'iteratorToArray',value:function iteratorToArray(e){for(var o=[],s=e.next();!s.done;)o.push(s.value),s=e.next();return result}}]),e}();Utils.isNode='undefined'==typeof window;var StageUtils=function(){function e(){_classCallCheck(this,e)}var o=Math.max,s=Math.min;return _createClass(e,null,[{key:'mergeNumbers',value:function mergeNumbers(e,o,s){return e*s+o*(1-s)}},{key:'rgb',value:function rgb(e,o,s){return(e<<16)+(o<<8)+s+4278190080}},{key:'rgba',value:function rgba(e,o,s,n){return(e<<16)+(o<<8)+s+16777216*(0|255*n)}},{key:'getRgbaString',value:function getRgbaString(e){return'rgba('+(0|e/65536)%256+','+(0|e/256)%256+','+e%256+','+((0|e/16777216)/255).toFixed(4)+')'}},{key:'getRgbaComponentsNormalized',value:function getRgbaComponentsNormalized(e){return[(0|e/65536)%256/255,(0|e/256)%256/255,e%256/255,(0|e/16777216)/255]}},{key:'getRgbaComponents',value:function getRgbaComponents(e){return[(0|e/65536)%256,(0|e/256)%256,e%256,0|e/16777216]}},{key:'getArgbNumber',value:function getArgbNumber(e){e[0]=o(0,s(255,e[0])),e[1]=o(0,s(255,e[1])),e[2]=o(0,s(255,e[2])),e[3]=o(0,s(255,e[3]));var n=((0|e[3])<<24)+((0|e[0])<<16)+((0|e[1])<<8)+(0|e[2]);return 0>n&&(n=4294967295+n+1),n}},{key:'mergeColors',value:function mergeColors(e,o,s){return 16777216*(0|(0|e/16777216)*s+(0|o/16777216)*(1-s))+65536*(0|(0|e/65536)%256*s+(0|o/65536)%256*(1-s))+256*(0|(0|e/256)%256*s+(0|o/256)%256*(1-s))+(0|e%256*s+o%256*(1-s))}},{key:'mergeMultiColors',value:function mergeMultiColors(e,o){for(var s=0,l=0,d=0,_=0,u=0,c=e.length,n=0;n<c;n++){var x=(0|e[n]/65536)%256,h=(0|e[n]/256)%256,y=e[n]%256,f=0|e[n]/16777216;s+=x*o[n],l+=h*o[n],d+=y*o[n],_+=f*o[n],u+=o[n]}return t=1/t,16777216*(0|a*t)+65536*(0|r*t)+256*(0|g*t)+(0|b*t)}},{key:'mergeMultiColorsEqual',value:function mergeMultiColorsEqual(e){for(var o=0,s=0,l=0,d=0,_=0,u=e.length,n=0;n<u;n++){var c=(0|e[n]/65536)%256,x=(0|e[n]/256)%256,h=e[n]%256,y=0|e[n]/16777216;o+=c,s+=x,l+=h,d+=y,_+=1}return t=1/t,16777216*(0|a*t)+65536*(0|r*t)+256*(0|g*t)+(0|b*t)}},{key:'rad',value:function rad(e){return e*(Math.PI/180)}},{key:'getTimingBezier',value:function getTimingBezier(e,o,s,n){var l=3*e,d=3*(s-e)-l,_=1-l-d,u=3*o,c=3*(n-o)-u,x=1-u-c;return function(e){if(1<=e)return 1;if(0>=e)return 0;for(var n=0.5,h=void 0,y=void 0,f=void 0,T=0;20>T;T++){if(h=n*(n*(n*_+d)+l),f=e-h,-1e-8<f&&1e-8>f)return n*(n*(n*x+c)+u);if(y=n*(n*(3*_)+2*d)+l,1e-10<y&&1e-10>y)break;n+=f/y}var o=0,s=1;for(it=0;20>it;it++){if(t=0.5*(o+s),cbx=t*(t*(t*_+d)+l),dx=e-cbx,-1e-8<dx&&1e-8>dx)return t*(t*(t*x+c)+u);0>dx?s=t:o=t}}}},{key:'getTimingFunction',value:function getTimingFunction(o){switch(o){case'linear':return function(e){return e};case'ease':return e.getTimingBezier(0.25,0.1,0.25,1);case'ease-in':return e.getTimingBezier(0.42,0,1,1);case'ease-out':return e.getTimingBezier(0,0,0.58,1);case'ease-in-out':return e.getTimingBezier(0.42,0,0.58,1);case'step-start':return function(){return 1};case'step-end':return function(e){return 1===e?1:0};default:var n='cubic-bezier(';if(o&&0===o.indexOf(n)){var s=o.substr(n.length,o.length-n.length-1).split(',');if(4!==s.length)return console.warn('Unknown timing function: '+o),function(e){return e};var l=parseFloat(s[0]),_=parseFloat(s[1]),u=parseFloat(s[2]),c=parseFloat(s[3]);return isNaN(l)||isNaN(_)||isNaN(u)||isNaN(c)?(console.warn('Unknown timing function: '+o),function(e){return e}):e.getTimingBezier(l,_,u,c)}return console.warn('Unknown timing function: '+o),function(e){return e};}}},{key:'getSplineValueFunction',value:function getSplineValueFunction(o,s,n,l,d,_,u,c){var x=l-n;u*=x,c*=x;var h=e.getSplineHelpers(o,s,d,_,u,c);return h?function(n){return 0==n?o:1==n?s:e.calculateSpline(h,n)}:function(e){return 0==e?o:1==e?s:s*e+o*(1-e)}}},{key:'getSplineRgbaValueFunction',value:function getSplineRgbaValueFunction(o,n,l,d,_,u,c,x){var h=d-l;c[0]*=h,c[1]*=h,c[2]*=h,c[3]*=h,x[0]*=h,x[1]*=h,x[2]*=h,x[3]*=h;var y=e.getRgbaComponents(o),f=e.getRgbaComponents(n),T=[e.getSplineHelpers(y[0],f[0],_,u,c[0],x[0]),e.getSplineHelpers(y[1],f[1],_,u,c[1],x[1]),e.getSplineHelpers(y[2],f[2],_,u,c[2],x[2]),e.getSplineHelpers(y[3],f[3],_,u,c[3],x[3])];return T[0]?function(l){return 0==l?o:1==l?n:e.getArgbNumber([s(255,e.calculateSpline(T[0],l)),s(255,e.calculateSpline(T[1],l)),s(255,e.calculateSpline(T[2],l)),s(255,e.calculateSpline(T[3],l))])}:function(s){return 0==s?o:1==s?n:e.mergeColors(n,o,s)}}},{key:'getSplineHelpers',value:function getSplineHelpers(e,o,s,n,l,d){if(!s&&!n)return null;var _=s,u=e+l*s,c=1-n,x=o-d*n;return[3*_-3*c+1,-6*_+3*c,3*_,3*u-3*x+o-e,3*(x+e)-6*u,3*(u-e),e]}},{key:'calculateSpline',value:function calculateSpline(e,o){var s=e[0],n=e[1],l=e[2],d=e[3],_=e[4],u=e[5],c=e[6];if(-2==s&&-2==d&&0==l&&0==u)return o;for(var y=0.5,f=void 0,T=void 0,S=0;20>S;S++){if(f=y*(y*(y*s+n)+l),T=o-f,-1e-8<T&&1e-8>T)return y*(y*(y*d+_)+u)+c;var C=y*(y*(3*s)+2*n)+l;if(1e-10<C&&1e-10>C)break;y+=T/C}var x=0,h=1;for(it=0;20>it;it++){if(t=0.5*(x+h),cbx=t*(t*(t*s+n)+l),dx=o-cbx,-1e-8<dx&&1e-8>dx)return t*(t*(t*d+_)+u)+c;0>dx?h=t:x=t}return t}}]),e}(),Stage=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return EventEmitter.call(s),s.setOptions(e),s.init(),s}return _inherits(o,e),_createClass(o,[{key:'setOptions',value:function setOptions(e){var o=this;this.options=e;var s=function(s,n){var l=e[s];o.options[s]=void 0===l?n:l};s('w',1280),s('h',720),s('canvas',this.options.canvas),s('renderWidth',this.options.w),s('renderHeight',this.options.h),s('srcBasePath',null),s('textureMemory',12e6),s('renderTexturePoolPixels',12e6),s('glClearColor',[0,0,0,0]),s('defaultFontFace','Sans-Serif'),s('defaultPrecision',this.options.h/this.options.renderHeight),s('fixedDt',0),s('useTextureAtlas',!1),s('debugTextureAtlas',!1)}},{key:'init',value:function init(){this.adapter=new WebAdapter,this.adapter.init&&this.adapter.init(this),this.gl=this.adapter.createWebGLContext(this.options.w,this.options.h),this.setGlClearColor(this.options.glClearColor),this.frameCounter=0,this.transitions=new TransitionManager(this),this.animations=new AnimationManager(this),this.textureManager=new TextureManager(this),this.options.useTextureAtlas&&(this.textureAtlas=new TextureAtlas(this)),this.ctx=new CoreContext(this),this.root=new View(this),this.root.w=this.options.w,this.root.h=this.options.h,this.root.setAsRoot(),this.startTime=0,this.currentTime=0,this.dt=0,this._destroyed=!1;var e=this;this.rectangleTexture=this.texture(function(e){var o=new Uint8Array([255,255,255,255]);return e(null,o,{w:1,h:1})},{id:'__whitepix'});var o=this.rectangleTexture.source;this.rectangleTexture.source.load(!0),o.permanent=!0,e.textureAtlas&&e.textureAtlas.add(o),e.adapter.startLoop()}},{key:'destroy',value:function destroy(){this.adapter.stopLoop(),this.textureAtlas&&this.textureAtlas.destroy(),this.ctx.destroy(),this.textureManager.destroy(),this._destroyed=!0}},{key:'stop',value:function stop(){this.adapter.stopLoop()}},{key:'resume',value:function resume(){if(this._destroyed)throw new Error('Already destroyed');this.adapter.startLoop()}},{key:'getCanvas',value:function getCanvas(){return this.adapter.getWebGLCanvas()}},{key:'drawFrame',value:function drawFrame(){this.dt=this.options.fixedDt?this.options.fixedDt:this.startTime?.001*(this.currentTime-this.startTime):.02,this.startTime=this.currentTime,this.currentTime=new Date().getTime(),this.emit('frameStart'),this.textureManager.isFull()&&(console.log('clean up'),this.textureManager.freeUnusedTextureSources()),this.emit('update'),this.textureAtlas&&this.textureAtlas.flush();var e=this.ctx.frame();this.adapter.nextFrame(e),this.frameCounter++}},{key:'setGlClearColor',value:function setGlClearColor(e){this.options.glClearColor=Array.isArray(e)?e:StageUtils.getRgbaComponentsNormalized(e)}},{key:'createView',value:function createView(){return new View(this)}},{key:'view',value:function(e){if(e.isView)return e;var o;return o=e.type?new e.type(this):new View(this),o.setSettings(e),o}},{key:'c',value:function c(e){return this.view(e)}},{key:'texture',value:function texture(e,o){return this.textureManager.getTexture(e,o)}},{key:'w',get:function get(){return this.options.w}},{key:'h',get:function get(){return this.options.h}},{key:'rw',get:function get(){return this.options.renderWidth}},{key:'rh',get:function get(){return this.options.renderHeight}}]),o}(Base);Base.mixinEs5(Stage,EventEmitter);var ShaderProgram=function(){function e(o,s){_classCallCheck(this,e),this.vertexShaderSource=o,this.fragmentShaderSource=s,this._program=null,this._uniformLocations=new Map,this._attributeLocations=new Map,this._currentUniformValues={},this._pendingUniformValues={},this._pendingUniformFunctions={},this._pendingUniformCount=0}return _createClass(e,[{key:'compile',value:function compile(e){if(!this._program){this.gl=e,this._program=e.createProgram();var o=this._glCompile(e.VERTEX_SHADER,this.vertexShaderSource),s=this._glCompile(e.FRAGMENT_SHADER,this.fragmentShaderSource);e.attachShader(this._program,o),e.attachShader(this._program,s),e.linkProgram(this._program),e.getProgramParameter(this._program,e.LINK_STATUS)||(console.error('Error: Could not initialize shader.'),console.error('gl.VALIDATE_STATUS',e.getProgramParameter(this._program,e.VALIDATE_STATUS)),console.error('gl.getError()',e.getError()),''!==e.getProgramInfoLog(this._program)&&console.warn('Warning: gl.getProgramInfoLog()',e.getProgramInfoLog(this._program)),e.deleteProgram(this._program),this._program=null),e.deleteShader(o),e.deleteShader(s)}}},{key:'_glCompile',value:function _glCompile(e,o){var s=this.gl.createShader(e);if(this.gl.shaderSource(s,o),this.gl.compileShader(s),!this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)){console.log(this.constructor.name,'Type: '+(e===this.gl.VERTEX_SHADER?'vertex shader':'fragment shader')),console.log(this.gl.getShaderInfoLog(s));var n=0;return console.log('========== source ==========\n'+o.split('\n').map(function(e){return''+ ++n+': '+e}).join('\n')),null}return s}},{key:'getUniformLocation',value:function getUniformLocation(e){var o=this._uniformLocations.get(e);return void 0===o&&(o=this.gl.getUniformLocation(this._program,e),this._uniformLocations.set(e,o)),o}},{key:'getAttribLocation',value:function getAttribLocation(e){var o=this._attributeLocations.get(e);return void 0===o&&(o=this.gl.getAttribLocation(this._program,e),this._attributeLocations.set(e,o)),o}},{key:'destroy',value:function destroy(){this._program&&(this.gl.deleteProgram(this._program),this._program=null)}},{key:'_valueEquals',value:function _valueEquals(e,o){if(e.length&&o.length){for(var s=0,l=e.length;s<l;s++)if(e[s]!==o[s])return!1;return!0}return e===o}},{key:'_valueClone',value:function _valueClone(e){return e.length?e.slice(0):e}},{key:'setUniformValue',value:function setUniformValue(e,o,s){var n=this._currentUniformValues[e];void 0!==n&&this._valueEquals(n,o)?void 0!==n&&this._pendingUniformValues[e]&&(delete this._pendingUniformValues[e],delete this._pendingUniformFunctions[e],this._pendingUniformCount--):(this._pendingUniformValues[e]=this._valueClone(o),this._pendingUniformFunctions[e]=s,this._pendingUniformCount++)}},{key:'hasUniformUpdates',value:function hasUniformUpdates(){return 0<this._pendingUniformCount}},{key:'commitUniformUpdates',value:function commitUniformUpdates(){var e=this,o=Object.keys(this._pendingUniformValues);o.forEach(function(o){e._currentUniformValues[o]=e._pendingUniformValues[o];var s=e.getUniformLocation(o);if(s){var n=e._pendingUniformFunctions[o]===e.gl.uniformMatrix2fv||e._pendingUniformFunctions[o]===e.gl.uniformMatrix3fv||e._pendingUniformFunctions[o]===e.gl.uniformMatrix4fv;n?e._pendingUniformFunctions[o].call(e.gl,s,!1,e._pendingUniformValues[o]):e._pendingUniformFunctions[o].call(e.gl,s,e._pendingUniformValues[o])}}),this._pendingUniformValues={},this._pendingUniformFunctions={},this._pendingUniformCount=0}},{key:'glProgram',get:function get(){return this._program}},{key:'compiled',get:function get(){return!!this._program}}]),e}(),ShaderBase=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return s._program=e.shaderPrograms.get(s.constructor),s._program||(s._program=new ShaderProgram(s.getVertexShaderSource(),s.getFragmentShaderSource()),e.shaderPrograms.set(s.constructor,s._program)),s._initialized=!1,s.ctx=e,s.gl=s.ctx.gl,s._views=new Set,s}return _inherits(o,e),_createClass(o,[{key:'getVertexShaderSource',value:function getVertexShaderSource(){return''}},{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return''}},{key:'_init',value:function _init(){this._initialized||(this._program.compile(this.ctx.gl),this._initialized=!0)}},{key:'_uniform',value:function _uniform(e){return this._program.getUniformLocation(e)}},{key:'_attrib',value:function _attrib(e){return this._program.getAttribLocation(e)}},{key:'_setUniform',value:function _setUniform(e,o,s){this._program.setUniformValue(e,o,s)}},{key:'useProgram',value:function useProgram(){this._init(),this.ctx.gl.useProgram(this.glProgram),this.beforeUsage(),this.enableAttribs()}},{key:'stopProgram',value:function stopProgram(){this.afterUsage(),this.disableAttribs()}},{key:'hasSameProgram',value:function hasSameProgram(e){return e&&(e===this||e._program===this._program)}},{key:'beforeUsage',value:function beforeUsage(){}},{key:'afterUsage',value:function afterUsage(){}},{key:'hasUniformUpdates',value:function hasUniformUpdates(){return this._program.hasUniformUpdates()}},{key:'commitUniformUpdates',value:function commitUniformUpdates(){this._program.commitUniformUpdates()}},{key:'addView',value:function addView(e){this._views.add(e)}},{key:'removeView',value:function removeView(e){this._views.delete(e)}},{key:'redraw',value:function redraw(){this._views.forEach(function(e){e.setHasRenderUpdates(2)})}},{key:'initialized',get:function get(){return this._initialized}},{key:'glProgram',get:function get(){return this._program.glProgram}}]),o}(Base),Shader=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return s.isDefault=s.constructor===o,s}return _inherits(o,e),_createClass(o,[{key:'getVertexShaderSource',value:function getVertexShaderSource(){return o.vertexShaderSource}},{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return o.fragmentShaderSource}},{key:'supportsTextureAtlas',value:function supportsTextureAtlas(){return this.isDefault}},{key:'enableAttribs',value:function enableAttribs(){var e=this.ctx.gl;e.vertexAttribPointer(this._attrib('aVertexPosition'),2,e.FLOAT,!1,16,0),e.enableVertexAttribArray(this._attrib('aVertexPosition')),-1!==this._attrib('aTextureCoord')&&(e.vertexAttribPointer(this._attrib('aTextureCoord'),2,e.UNSIGNED_SHORT,!0,16,8),e.enableVertexAttribArray(this._attrib('aTextureCoord'))),-1!==this._attrib('aColor')&&(e.vertexAttribPointer(this._attrib('aColor'),4,e.UNSIGNED_BYTE,!0,16,12),e.enableVertexAttribArray(this._attrib('aColor')))}},{key:'disableAttribs',value:function disableAttribs(){var e=this.ctx.gl;e.disableVertexAttribArray(this._attrib('aVertexPosition')),-1!==this._attrib('aTextureCoord')&&e.disableVertexAttribArray(this._attrib('aTextureCoord')),-1!==this._attrib('aColor')&&e.disableVertexAttribArray(this._attrib('aColor'))}},{key:'getExtraAttribBytesPerVertex',value:function getExtraAttribBytesPerVertex(){return 0}},{key:'getVertexAttribPointerOffset',value:function getVertexAttribPointerOffset(e){return e.extraAttribsDataByteOffset-4*(e.index+1)*this.getExtraAttribBytesPerVertex()}},{key:'useDefault',value:function useDefault(){return!1}},{key:'supportsMerging',value:function supportsMerging(){return!0}},{key:'addEmpty',value:function addEmpty(){return!1}},{key:'setExtraAttribsInBuffer',value:function setExtraAttribsInBuffer(){}},{key:'setupUniforms',value:function setupUniforms(e){this._setUniform('projection',this._getProjection(e),this.ctx.gl.uniform2fv,!1)}},{key:'isMergable',value:function isMergable(){return this.hasUniformUpdates()}},{key:'_getProjection',value:function _getProjection(e){return e.getProjection()}},{key:'getFlipY',value:function getFlipY(){return 0>this._getProjection()[1]}},{key:'beforeDraw',value:function beforeDraw(){}},{key:'draw',value:function draw(e){var o=this.ctx.gl,s=e.length;if(s){for(var n,l=e.getTexture(0),d=0,_=0;_<s;_++)n=e.getTexture(_),l!==n&&(o.bindTexture(o.TEXTURE_2D,l),o.drawElements(o.TRIANGLES,6*(_-d),o.UNSIGNED_SHORT,2*(6*(d+e.index+1))),l=n,d=_);pos<s&&(o.bindTexture(o.TEXTURE_2D,glTexture),o.drawElements(o.TRIANGLES,6*(s-pos),o.UNSIGNED_SHORT,2*(6*(pos+e.index+1))))}}},{key:'afterDraw',value:function afterDraw(){}}]),o}(ShaderBase);Shader.vertexShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n',Shader.fragmentShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    void main(void){\n        gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;\n    }\n',Shader.prototype.isShader=!0;var Filter=function(e){function o(e){return _classCallCheck(this,o),_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e))}return _inherits(o,e),_createClass(o,[{key:'getVertexShaderSource',value:function getVertexShaderSource(){return o.vertexShaderSource}},{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return o.fragmentShaderSource}},{key:'useDefault',value:function useDefault(){return!1}},{key:'enableAttribs',value:function enableAttribs(){var e=this.ctx.gl;e.vertexAttribPointer(this._attrib('aVertexPosition'),2,e.FLOAT,!1,16,0),e.enableVertexAttribArray(this._attrib('aVertexPosition')),-1!==this._attrib('aTextureCoord')&&(e.vertexAttribPointer(this._attrib('aTextureCoord'),2,e.UNSIGNED_SHORT,!0,16,8),e.enableVertexAttribArray(this._attrib('aTextureCoord')))}},{key:'disableAttribs',value:function disableAttribs(){var e=this.ctx.gl;e.disableVertexAttribArray(this._attrib('aVertexPosition')),-1!==this._attrib('aTextureCoord')&&e.disableVertexAttribArray(this._attrib('aTextureCoord'))}},{key:'setupUniforms',value:function setupUniforms(e){this._setUniform('resolution',new Float32Array([e.getRenderWidth(),e.getRenderHeight()]),this.gl.uniform2fv)}},{key:'beforeDraw',value:function beforeDraw(){}},{key:'afterDraw',value:function afterDraw(){}},{key:'draw',value:function draw(e){var o=this.gl;o.bindTexture(o.TEXTURE_2D,e.source),o.drawElements(o.TRIANGLES,6,o.UNSIGNED_SHORT,0)}},{key:'redraw',value:function redraw(){this._views.forEach(function(e){e.setHasRenderUpdates(2),e._setRecalc(15)})}}]),o}(ShaderBase);Filter.prototype.isFilter=!0,Filter.vertexShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    varying vec2 vTextureCoord;\n    void main(void){\n        gl_Position = vec4(aVertexPosition, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n    }\n',Filter.fragmentShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    uniform sampler2D uSampler;\n    void main(void){\n        gl_FragColor = texture2D(uSampler, vTextureCoord);\n    }\n',Filter.prototype.isFilter=!0;var TextureManager=function(){function e(o){_classCallCheck(this,e),this.stage=o,this.gl=this.stage.gl,this._usedTextureMemory=0,this._uploadedTextureSources=[],this.textureSourceHashmap=new Map}return _createClass(e,[{key:'destroy',value:function destroy(){for(var e,o=0,s=this._uploadedTextureSources.length;o<s;o++)e=this._uploadedTextureSources[o],this.gl.deleteTexture(e.glTexture)}},{key:'loadSrcTexture',value:function loadSrcTexture(e,o,s,n){if(this.stage.options.srcBasePath){var l=e.charCodeAt(0);-1===e.indexOf('//')&&(65<=l&&90>=l||97<=l&&122>=l||46==l)&&(e=this.stage.options.srcBasePath+e)}this.stage.adapter.loadSrcTexture(e,o,s,n)}},{key:'loadTextTexture',value:function loadTextTexture(e,o,s,n){if(this.stage.options.text2pngEndpoint&&!s){var l=this.stage.options.text2pngEndpoint+'?q='+encodeURIComponent(JSON.stringify(e.getNonDefaults()));this.loadSrcTexture(l,o,s,n)}else this.stage.adapter.loadTextTexture(e,o,s,n)}},{key:'getTexture',value:function getTexture(e,o){var s,n,l=o&&o.id||null;if(!Utils.isString(e))n=e instanceof TextureSource?e:this.getTextureSource(e,l);else if(l=l||e,n=this.textureSourceHashmap.get(l),!n){var d=this;n=this.getTextureSource(function func(o,s,n){d.loadSrcTexture(e,s,n,o)},l),n.renderInfo||(n.renderInfo={src:e})}return s=new Texture(this,n),s.x=o&&o.x||0,s.y=o&&o.y||0,s.w=o&&o.w||0,s.h=o&&o.h||0,s.clipping=!!(s.x||s.y||s.w||s.h),s.precision=o&&o.precision||1,s}},{key:'getTextureSource',value:function getTextureSource(e,o){var s=o?this.textureSourceHashmap.get(o):null;return s||(s=new TextureSource(this,e),o&&(s.lookupId=o,this.textureSourceHashmap.set(o,s))),s}},{key:'uploadTextureSource',value:function uploadTextureSource(e,o,s){if(!e.glTexture){var n=this.gl,l=n.createTexture();n.bindTexture(n.TEXTURE_2D,l),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.premultiplyAlpha),Utils.isNode&&n.pixelStorei(n.UNPACK_FLIP_BLUE_RED,!!s.flipBlueRed),this.stage.adapter.uploadGlTexture(n,e,o,s.hasAlpha),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),e.glTexture=l,l.w=e.w,l.h=e.h,this._usedTextureMemory+=e.w*e.h,this._uploadedTextureSources.push(e)}}},{key:'isFull',value:function isFull(){return this._usedTextureMemory>=this.stage.options.textureMemory}},{key:'freeUnusedTextureSources',value:function freeUnusedTextureSources(){for(var o,s=[],l=this._usedTextureMemory,d=0,_=this._uploadedTextureSources.length;d<_;d++)o=this._uploadedTextureSources[d],o.permanent||0!==o.views.size?s.push(o):this.freeTextureSource(o);var e=this;this.textureSourceHashmap.forEach(function(o){0===o.views.size&&e.freeTextureSource(o)}),this._uploadedTextureSources=remainingTextureSources,console.log('freed '+((usedTextureMemoryBefore-this._usedTextureMemory)/1e6).toFixed(2)+'M texture pixels from GPU memory. Remaining: '+this._usedTextureMemory)}},{key:'freeTextureSource',value:function freeTextureSource(e){e.isLoadedByCore()||(e.glTexture&&(this._usedTextureMemory-=e.w*e.h,this.gl.deleteTexture(e.glTexture),e.glTexture=null),e.loadingSince=null,e.lookupId&&this.textureSourceHashmap.delete(e.lookupId))}}]),e}(),Texture=function(){function e(o,s){_classCallCheck(this,e),this.manager=o,this.id=e.id++,this.source=s}return _createClass(e,[{key:'_properties',value:function _properties(){this._x=0,this._y=0,this._w=0,this._h=0,this._precision=1,this.clipping=!1}},{key:'enableClipping',value:function enableClipping(e,o,s,n){(this._x!==e||this._y!==o||this._w!==s||this._h!==n)&&(this._x=e,this._y=o,this._w=s,this._h=n,this.updateClipping(!0))}},{key:'disableClipping',value:function disableClipping(){(this._x||this._y||this._w||this._h)&&(this._x=0,this._y=0,this._w=0,this._h=0,this.updateClipping(!1))}},{key:'updateClipping',value:function updateClipping(e){this.clipping=!0===e||!1===e?e:!!(this._x||this._y||this._w||this._h);var o=this;this.source.views.forEach(function(e){e.displayedTexture===o&&e.onDisplayedTextureClippingChanged()})}},{key:'updatePrecision',value:function updatePrecision(){var e=this;this.source.views.forEach(function(o){o.displayedTexture===e&&o.onPrecisionChanged()})}},{key:'replaceTextureSource',value:function replaceTextureSource(e){var o=this,s=this.source;this.source=e,s.views.forEach(function(n){if(n.texture===o||n.displayedTexture===o){var l=n.displayedTexture&&n.displayedTexture!==o&&n.displayedTexture.source===s;l=l||n.texture&&n.texture!==o&&n.texture.source===s,l||s.removeView(n),e.addView(n),e.glTexture&&(n.displayedTexture=o)}})}},{key:'getNonDefaults',value:function getNonDefaults(){var e={};return 0!==this.x&&(e.x=this.x),0!==this.y&&(e.y=this.y),0!==this.w&&(e.w=this.w),0!==this.h&&(e.h=this.h),1!==this.precision&&(e.precision=this.precision),e}},{key:'x',get:function get(){return this._x},set:function set(e){this._x!==e&&(this._x=e,this.updateClipping())}},{key:'y',get:function get(){return this._y},set:function set(e){this._y!==e&&(this._y=e,this.updateClipping())}},{key:'w',get:function get(){return this._w},set:function set(e){this._w!==e&&(this._w=e,this.updateClipping())}},{key:'h',get:function get(){return this._h},set:function set(e){this._h!==e&&(this._h=e,this.updateClipping())}},{key:'precision',get:function get(){return this._precision},set:function set(e){this._precision!==e&&(this._precision=e,this.updatePrecision())}}]),e}();Texture.id=0;var TextureSource=function(e){function o(e,s){_classCallCheck(this,o);var n=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return n.id=o.id++,n.manager=e,n.stage=e.stage,n.id=o.id++,n.loadCb=s,n.views=new Set,n}return _inherits(o,e),_createClass(o,[{key:'_properties',value:function _properties(){this.lookupId=null,this.cancelCb=null,this.loadingSince=0,this.inTextureAtlas=!1,this.textureAtlasX=0,this.textureAtlasY=0,this.w=0,this.h=0,this.glTexture=null,this.permanent=!1,this.noTextureAtlas=!1,this.renderInfo=null}},{key:'getRenderWidth',value:function getRenderWidth(){return this.w}},{key:'getRenderHeight',value:function getRenderHeight(){return this.h}},{key:'isLoadedByCore',value:function isLoadedByCore(){return!this.loadCb}},{key:'addView',value:function addView(e){this.views.has(e)||(this.views.add(e),this.glTexture&&this.stage.textureAtlas&&!this.noTextureAtlas&&this.stage.textureAtlas.addActiveTextureSource(this),1===this.views.size&&(this.lookupId&&!this.manager.textureSourceHashmap.has(this.lookupId)&&this.manager.textureSourceHashmap.set(this.lookupId,this),this.becomesVisible()))}},{key:'removeView',value:function removeView(e){this.views.delete(e)&&!this.views.size&&(this.stage.textureAtlas&&this.stage.textureAtlas.removeActiveTextureSource(this),this.becomesInvisible())}},{key:'becomesVisible',value:function becomesVisible(){this.load(!1)}},{key:'becomesInvisible',value:function becomesInvisible(){this.isLoading()&&this.cancelCb&&this.cancelCb(this)}},{key:'load',value:function load(e){if(!this.isLoadedByCore()&&(this.isLoading()&&e&&(this.cancelCb&&this.cancelCb(this),this.loadingSince=0),!this.glTexture&&!this.isLoading())){var o=this;this.loadingSince=new Date().getTime(),this.loadCb(function(e,s,n){o.manager.stage.destroyed||(o.loadingSince=0,e?o.onError(e):s&&o.setSource(s,n))},this,!!e)}}},{key:'isLoading',value:function isLoading(){return 0<this.loadingSince}},{key:'setSource',value:function setSource(e,o){if(this.w=e.width||o&&o.w||0,this.h=e.height||o&&o.h||0,2048<this.w||2048<this.h)return void console.error('Texture size too large: '+e.width+'x'+e.height+' (max allowed is 2048x2048)');o&&o.renderInfo&&(this.renderInfo=o.renderInfo);var s={premultiplyAlpha:!0,hasAlpha:!0};o&&o.hasOwnProperty('premultiplyAlpha')&&(s.premultiplyAlpha=o.premultiplyAlpha),o&&o.hasOwnProperty('flipBlueRed')&&(s.flipBlueRed=o.flipBlueRed),o&&o.hasOwnProperty('hasAlpha')&&(s.hasAlpha=o.hasAlpha),s.hasAlpha||(s.premultiplyAlpha=!1),this.manager.uploadTextureSource(this,e,s),this.onLoad()}},{key:'isVisible',value:function isVisible(){return 0<this.views.size}},{key:'onLoad',value:function onLoad(){this.isVisible()&&this.stage.textureAtlas&&!this.noTextureAtlas&&this.stage.textureAtlas.addActiveTextureSource(this),this.views.forEach(function(e){e.onTextureSourceLoaded()})}},{key:'_changeGlTexture',value:function _changeGlTexture(e,o,s){var n=this.glTexture;this.glTexture=e,this.w=o,this.h=s,!n&&this.glTexture&&this.views.forEach(function(e){return e.onTextureSourceLoaded()}),this.glTexture||this.views.forEach(function(e){e.displayedTexture=null}),this.views.forEach(function(e){return e._updateDimensions()})}},{key:'onError',value:function onError(o){console.error('texture load error',o,this.id),this.views.forEach(function(e){e.onTextureSourceLoadError(o)})}},{key:'onAddedToTextureAtlas',value:function onAddedToTextureAtlas(e,o){this.inTextureAtlas=!0,this.textureAtlasX=e,this.textureAtlasY=o,this.views.forEach(function(e){e.onTextureSourceAddedToTextureAtlas()})}},{key:'onRemovedFromTextureAtlas',value:function onRemovedFromTextureAtlas(){this.inTextureAtlas=!1,this.views.forEach(function(e){e.onTextureSourceRemovedFromTextureAtlas()})}},{key:'free',value:function free(){this.manager.freeTextureSource(this)}}]),o}(Base);TextureSource.id=1;var TextureAtlas=function(){function e(o){_classCallCheck(this,e);this._program=new ShaderProgram('\n            #ifdef GL_ES\n            precision lowp float;\n            #endif\n            attribute vec2 aVertexPosition;\n            attribute vec2 aTextureCoord;\n            uniform mat4 projectionMatrix;\n            varying vec2 vTextureCoord;\n            void main(void){\n                gl_Position = projectionMatrix * vec4(aVertexPosition, 0.0, 1.0);\n                vTextureCoord = aTextureCoord;\n            }\n        ','\n            #ifdef GL_ES\n            precision lowp float;\n            #endif\n            varying vec2 vTextureCoord;\n            uniform sampler2D uSampler;\n            void main(void){\n                gl_FragColor = texture2D(uSampler, vTextureCoord);\n            }\n        '),this._program.compile(o.gl),this.stage=o,this.w=2048,this.h=2048,this._activeTree=new TextureAtlasTree(this.w,this.h),this._activeTextureSources=new Set,this._addedTextureSources=new Set,this._wastedPixels=0,this._lastDefragFrame=0,this._pixelsLimit=this.w*this.h/16,this._minWastedPixels=this.w*this.h/8,this._defragNeeded=!1,this._uploads=[],this._init()}return _createClass(e,[{key:'_init',value:function _init(){var e=this.gl;e.useProgram(this.glProgram),this._vertexPositionAttribute=e.getAttribLocation(this.glProgram,'aVertexPosition'),this._textureCoordAttribute=e.getAttribLocation(this.glProgram,'aTextureCoord'),this._paramsBuffer=new ArrayBuffer(576000),this._allCoords=new Float32Array(this._paramsBuffer),this._allTexCoords=new Float32Array(this._paramsBuffer),this._allIndices=new Uint16Array(54000);for(var s=0,n=0;54000>s;s+=6,n+=4)this._allIndices[s]=n,this._allIndices[s+1]=n+1,this._allIndices[s+2]=n+2,this._allIndices[s+3]=n,this._allIndices[s+4]=n+2,this._allIndices[s+5]=n+3;this._indicesGlBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._indicesGlBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this._allIndices,e.STATIC_DRAW),this._projectionMatrix=new Float32Array([2/this.w,0,0,0,0,2/this.h,0,0,0,0,1,0,-1,-1,0,1]);var o=e.getUniformLocation(this.glProgram,'projectionMatrix');if(e.uniformMatrix4fv(o,!1,this._projectionMatrix),this.texture=this.gl.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),this.texture.w=this.w,this.texture.h=this.h,e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.w,this.h,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),this.framebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0),e.getError()!=e.NO_ERROR)throw'Some WebGL error occurred while trying to create framebuffer.';e.bindFramebuffer(e.FRAMEBUFFER,null)}},{key:'destroy',value:function destroy(){this.gl.deleteTexture(this.texture),this.gl.deleteFramebuffer(this.framebuffer),this.gl.deleteBuffer(this.paramsGlBuffer),this.gl.deleteBuffer(this._indicesGlBuffer),this._program.destroy()}},{key:'uploadTextureSources',value:function uploadTextureSources(e){var o,s=e.length;for(1e3<s&&(s=1e3),o=0;o<s;o++){var d=e[o].w,_=e[o].h,u=e[o].textureAtlasX,c=e[o].textureAtlasY,x=1/d,h=1/_,y=9*(16*o);this._allCoords[y+0]=u,this._allCoords[y+1]=c,this._allCoords[y+4]=u+d,this._allCoords[y+5]=c,this._allCoords[y+8]=u+d,this._allCoords[y+9]=c+_,this._allCoords[y+12]=u,this._allCoords[y+13]=c+_,this._allCoords[y+16]=u,this._allCoords[y+17]=c-1,this._allCoords[y+20]=u+d,this._allCoords[y+21]=c-1,this._allCoords[y+24]=u+d,this._allCoords[y+25]=c,this._allCoords[y+28]=u,this._allCoords[y+29]=c,this._allCoords[y+32]=u,this._allCoords[y+33]=c+_,this._allCoords[y+36]=u+d,this._allCoords[y+37]=c+_,this._allCoords[y+40]=u+d,this._allCoords[y+41]=c+_+1,this._allCoords[y+44]=u,this._allCoords[y+45]=c+_+1,this._allCoords[y+48]=u-1,this._allCoords[y+49]=c,this._allCoords[y+52]=u,this._allCoords[y+53]=c,this._allCoords[y+56]=u,this._allCoords[y+57]=c+_,this._allCoords[y+60]=u-1,this._allCoords[y+61]=c+_,this._allCoords[y+64]=u+d,this._allCoords[y+65]=c,this._allCoords[y+68]=u+d+1,this._allCoords[y+69]=c,this._allCoords[y+72]=u+d+1,this._allCoords[y+73]=c+_,this._allCoords[y+76]=u+d,this._allCoords[y+77]=c+_,this._allCoords[y+80]=u-1,this._allCoords[y+81]=c-1,this._allCoords[y+84]=u,this._allCoords[y+85]=c-1,this._allCoords[y+88]=u,this._allCoords[y+89]=c,this._allCoords[y+92]=u-1,this._allCoords[y+93]=c,this._allCoords[y+96]=u+d,this._allCoords[y+97]=c-1,this._allCoords[y+100]=u+d+1,this._allCoords[y+101]=c-1,this._allCoords[y+104]=u+d+1,this._allCoords[y+105]=c,this._allCoords[y+108]=u+d,this._allCoords[y+109]=c,this._allCoords[y+112]=u+d,this._allCoords[y+113]=c+_,this._allCoords[y+116]=u+d+1,this._allCoords[y+117]=c+_,this._allCoords[y+120]=u+d+1,this._allCoords[y+121]=c+_+1,this._allCoords[y+124]=u+d,this._allCoords[y+125]=c+_+1,this._allCoords[y+128]=u-1,this._allCoords[y+129]=c+_,this._allCoords[y+132]=u,this._allCoords[y+133]=c+_,this._allCoords[y+136]=u,this._allCoords[y+137]=c+_+1,this._allCoords[y+140]=u-1,this._allCoords[y+141]=c+_+1,this._allTexCoords[y+2]=0,this._allTexCoords[y+3]=0,this._allTexCoords[y+6]=1,this._allTexCoords[y+7]=0,this._allTexCoords[y+10]=1,this._allTexCoords[y+11]=1,this._allTexCoords[y+14]=0,this._allTexCoords[y+15]=1,this._allTexCoords[y+18]=0,this._allTexCoords[y+19]=0,this._allTexCoords[y+22]=1,this._allTexCoords[y+23]=0,this._allTexCoords[y+26]=1,this._allTexCoords[y+27]=h,this._allTexCoords[y+30]=0,this._allTexCoords[y+31]=h,this._allTexCoords[y+34]=0,this._allTexCoords[y+35]=1-h,this._allTexCoords[y+38]=1,this._allTexCoords[y+39]=1-h,this._allTexCoords[y+42]=1,this._allTexCoords[y+43]=1,this._allTexCoords[y+46]=0,this._allTexCoords[y+47]=1,this._allTexCoords[y+50]=0,this._allTexCoords[y+51]=0,this._allTexCoords[y+54]=x,this._allTexCoords[y+55]=0,this._allTexCoords[y+58]=x,this._allTexCoords[y+59]=1,this._allTexCoords[y+62]=0,this._allTexCoords[y+63]=1,this._allTexCoords[y+66]=1-x,this._allTexCoords[y+67]=0,this._allTexCoords[y+70]=1,this._allTexCoords[y+71]=0,this._allTexCoords[y+74]=1,this._allTexCoords[y+75]=1,this._allTexCoords[y+78]=1-x,this._allTexCoords[y+79]=1,this._allTexCoords[y+82]=0,this._allTexCoords[y+83]=0,this._allTexCoords[y+86]=x,this._allTexCoords[y+87]=0,this._allTexCoords[y+90]=x,this._allTexCoords[y+91]=h,this._allTexCoords[y+94]=0,this._allTexCoords[y+95]=h,this._allTexCoords[y+98]=1-x,this._allTexCoords[y+99]=0,this._allTexCoords[y+102]=1,this._allTexCoords[y+103]=0,this._allTexCoords[y+106]=1,this._allTexCoords[y+107]=h,this._allTexCoords[y+110]=1-x,this._allTexCoords[y+111]=h,this._allTexCoords[y+114]=1-x,this._allTexCoords[y+115]=1-h,this._allTexCoords[y+118]=1,this._allTexCoords[y+119]=1-h,this._allTexCoords[y+122]=1,this._allTexCoords[y+123]=1,this._allTexCoords[y+126]=1-x,this._allTexCoords[y+127]=1,this._allTexCoords[y+130]=0,this._allTexCoords[y+131]=1-h,this._allTexCoords[y+134]=x,this._allTexCoords[y+135]=1-h,this._allTexCoords[y+138]=x,this._allTexCoords[y+139]=1,this._allTexCoords[y+142]=0,this._allTexCoords[y+143]=1}var n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer),n.useProgram(this.glProgram),n.viewport(0,0,this.w,this.h),n.blendFunc(n.ONE,n.ZERO),n.enable(n.BLEND),n.disable(n.DEPTH_TEST),this.paramsGlBuffer=this.paramsGlBuffer||n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.paramsGlBuffer);var l=new DataView(this._paramsBuffer,0,576*s);for(n.bufferData(n.ARRAY_BUFFER,l,n.DYNAMIC_DRAW),n.vertexAttribPointer(this._vertexPositionAttribute,2,n.FLOAT,!1,16,0),n.vertexAttribPointer(this._textureCoordAttribute,2,n.FLOAT,!1,16,8),n.enableVertexAttribArray(this._vertexPositionAttribute),n.enableVertexAttribArray(this._textureCoordAttribute),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this._indicesGlBuffer),o=0;o<s;o++)n.bindTexture(n.TEXTURE_2D,e[o].glTexture),n.drawElements(n.TRIANGLES,54,n.UNSIGNED_SHORT,2*(9*(6*o)));n.disableVertexAttribArray(this._vertexPositionAttribute),n.disableVertexAttribArray(this._textureCoordAttribute)}},{key:'allocate',value:function allocate(e){return this._activeTree.add(e)}},{key:'addActiveTextureSource',value:function addActiveTextureSource(e){1===e.id||e.w*e.h<this._pixelsLimit&&!this._activeTextureSources.has(e)&&(this._activeTextureSources.add(e),!this._addedTextureSources.has(e)&&this.add(e))}},{key:'removeActiveTextureSource',value:function removeActiveTextureSource(e){if(this._activeTextureSources.has(e)){this._activeTextureSources.delete(e);var o=this._uploads.indexOf(e);0<=o&&(this._uploads.splice(o,1),e.onRemovedFromTextureAtlas(),this._addedTextureSources.delete(e)),this._addedTextureSources.has(e)&&(this._wastedPixels+=e.w*e.h)}}},{key:'add',value:function add(e){var o=this.allocate(e);if(o)this._addedTextureSources.add(e),e.onAddedToTextureAtlas(o.x+1,o.y+1),this._uploads.push(e);else return this._defragNeeded=!0,!1;return!0}},{key:'defragment',value:function defragment(){console.log('defragment texture atlas');var e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.viewport(0,0,this.w,this.h),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),this._activeTree.reset(),this._uploads=[],this._wastedPixels=0,this._lastDefragFrame=this.stage.frameCounter,this._defragNeeded=!1,this._addedTextureSources.forEach(function(e){e.onRemovedFromTextureAtlas()}),this._addedTextureSources.clear(),this.add(this.stage.rectangleTexture.source);var o=this;this._activeTextureSources.forEach(function(e){o.add(e)})}},{key:'flush',value:function flush(){this._defragNeeded&&this._wastedPixels>=this._minWastedPixels&&this._lastDefragFrame<this.stage.frameCounter-300&&this.defragment(),this._uploads.length&&(this.uploadTextureSources(this._uploads),this._uploads=[])}},{key:'glProgram',get:function get(){return this._program.glProgram}},{key:'gl',get:function get(){return this._program.gl}}]),e}(),TextureAtlasTree=function(){function e(o,s){_classCallCheck(this,e),this.w=o,this.h=s,this.reset()}return _createClass(e,[{key:'reset',value:function reset(){this.root={x:0,y:0,w:this.w,h:this.h},this.spaces=new Set([this.root]),this.maxH=this.h}},{key:'add',value:function add(e){var o=e.w+2,s=e.h+2;if(s>this.maxH)return!1;var l=0,d=null,_=0;return(this.spaces.forEach(function(e){e.h>_&&(_=e.h),e.w>=o&&e.h>=s&&(!l||l>o*s)&&(l=o*s,d=e)}),this.maxH=_,!!d)&&(this.useNode(d,e),d)}},{key:'findNode',value:function findNode(e,o,s){return e?e.o?this.findNode(e.r,o,s)||this.findNode(e.d,o,s):o<=e.w&&s<=e.h?e:null:null}},{key:'useNode',value:function useNode(e,o){var s=o.w+2,n=o.h+2;e.w>s&&(e.r={x:e.x+s,y:e.y,w:e.w-s,h:n},this.spaces.add(e.r)),e.h>n&&(e.d={x:e.x,y:e.y+n,w:e.w,h:e.h-n},this.spaces.add(e.d)),this.spaces.delete(e),e.o=o}},{key:'getTextures',value:function getTextures(){for(var e,o=[this.root],s=[],n=1;n;)e=o.pop(),n--,e.o&&(s.push(e.o),e.r&&(o.push(e.r),n++),e.d&&(o.push(e.d),n++));return textures}}]),e}(),View=function(){function e(o){_classCallCheck(this,e),EventEmitter.call(this),this.id=e.id++,this.stage=o,this._core=new ViewCore(this),this._texturizer=null,this._active=!1,this._attached=!1,this._parent=null,this._texture=null,this._displayedTexture=null,this._tags=null,this._treeTags=null,this._tagsCache=null,this._tagToComplex=null,this._tagRoot=!1,this._x=0,this._y=0,this._w=0,this._h=0,this._scaleX=1,this._scaleY=1,this._pivotX=0.5,this._pivotY=0.5,this._mountX=0,this._mountY=0,this._alpha=1,this._rotation=0,this._visible=!0,this._viewText=null,this._childList=null,this._exposedChildList=null}var o=Math.max,s=Math.min;return _createClass(e,[{key:'setAsRoot',value:function setAsRoot(){this._updateActiveFlag(),this._updateAttachedFlag(),this._core.setAsRoot()}},{key:'_setParent',value:function _setParent(e){this._parent===e||(this._parent&&this._unsetTagsParent(),this._parent=e,e&&this._setTagsParent(),this._updateActiveFlag(),this._updateAttachedFlag())}},{key:'getDepth',value:function getDepth(){var e=0,o=this;do e++,o=o._parent;while(o);return e}},{key:'getAncestor',value:function getAncestor(e){for(var o=this;0<e&&o._parent;)o=o._parent,e--;return p}},{key:'getAncestorAtDepth',value:function getAncestorAtDepth(e){var o=this.getDepth()-e;return 0>o?null:this.getAncestor(o)}},{key:'isAncestorOf',value:function isAncestorOf(e){for(var o=e;o=o.parent;)if(this===o)return!0;return!1}},{key:'getSharedAncestor',value:function getSharedAncestor(e){var o=this,s=e,n=o.getDepth(),l=s.getDepth();n>l?o=o.getAncestor(n-l):l>n&&(s=s.getAncestor(l-n));do{if(o===s)return o;o=o._parent,s=s._parent}while(o&&s);return null}},{key:'isActive',value:function isActive(){return this._visible&&0<this._alpha&&(this._parent?this._parent._active:this.stage.root===this)}},{key:'isAttached',value:function isAttached(){return this._parent?this._parent._attached:this.stage.root===this}},{key:'_updateActiveFlag',value:function _updateActiveFlag(){var e=this.isActive();if(this._active!==e){e?this._setActiveFlag():this._unsetActiveFlag();var o=this._children.get();if(o){var s=o.length;if(0<s)for(var n=0;n<s;n++)o[n]._updateActiveFlag()}this._eventsCount&&this.emit('active',e)}}},{key:'_setActiveFlag',value:function _setActiveFlag(){var e=null;this._texture&&this._texture.source.glTexture?(e=this._texture,this._texture.source.addView(this)):this._displayedTexture&&this._displayedTexture.source.glTexture&&(e=this._displayedTexture),this.displayedTexture=e,this._updateDimensions(),this._updateTextureCoords(),this._active=!0,this._texture&&this._texture.source.addView(this),this._displayedTexture&&this._displayedTexture!==this._texture&&this._displayedTexture.source.addView(this)}},{key:'_unsetActiveFlag',value:function _unsetActiveFlag(){this._texture&&this._texture.source.removeView(this),this._displayedTexture&&this._displayedTexture.source.removeView(this),this._texturizer&&this._texturizer.deactivate(),this._active=!1}},{key:'_updateAttachedFlag',value:function _updateAttachedFlag(){var e=this.isAttached();if(this._attached!==e){this._attached=e;var o=this._children.get();if(o){var s=o.length;if(0<s)for(var n=0;n<s;n++)o[n]._updateAttachedFlag()}}}},{key:'_getRenderWidth',value:function _getRenderWidth(){return this._w?this._w:this._texture&&this._texture.source.glTexture?this._texture.w||this._texture.source.w/this._texture.precision:this._displayedTexture?this._displayedTexture.w||this._displayedTexture.source.w/this._displayedTexture.precision:0}},{key:'_getRenderHeight',value:function _getRenderHeight(){return this._h?this._h:this._texture&&this._texture.source.glTexture?(this._texture.h||this._texture.source.h)/this._texture.precision:this._displayedTexture?(this._displayedTexture.h||this._displayedTexture.source.h)/this._displayedTexture.precision:0}},{key:'textureIsLoaded',value:function textureIsLoaded(){return!!this.texture&&!!this.texture.source.glTexture}},{key:'loadTexture',value:function loadTexture(e){this.texture&&this.texture.source.load(e)}},{key:'onTextureSourceLoaded',value:function onTextureSourceLoaded(){this.displayedTexture=this._texture}},{key:'onTextureSourceLoadError',value:function onTextureSourceLoadError(o){this._eventsCount&&this.emit('txError',o,this._texture.source)}},{key:'onTextureSourceAddedToTextureAtlas',value:function onTextureSourceAddedToTextureAtlas(){this._updateTextureCoords()}},{key:'onTextureSourceRemovedFromTextureAtlas',value:function onTextureSourceRemovedFromTextureAtlas(){this._updateTextureCoords()}},{key:'onDisplayedTextureClippingChanged',value:function onDisplayedTextureClippingChanged(){this._updateDimensions(),this._updateTextureCoords()}},{key:'onPrecisionChanged',value:function onPrecisionChanged(){this._updateDimensions()}},{key:'_updateDimensions',value:function _updateDimensions(){var e=this._core.rw,o=this._core.rh,s=this._getRenderWidth(),n=this._getRenderHeight();return(e!==s||o!==n)&&(this._core.setDimensions(this._getRenderWidth(),this._getRenderHeight()),this._updateLocalTranslate(),!0)}},{key:'_updateLocalTransform',value:function _updateLocalTransform(){if(0!==this._rotation&&this._rotation%(2*Math.PI)){var e=Math.sin(this._rotation),o=Math.cos(this._rotation);this._core.setLocalTransform(o*this._scaleX,-e*this._scaleY,e*this._scaleX,o*this._scaleY)}else this._core.setLocalTransform(this._scaleX,0,0,this._scaleY);this._updateLocalTranslate()}},{key:'_updateLocalTranslate',value:function _updateLocalTranslate(){var e=this._pivotX*this._core.rw,o=this._pivotY*this._core.rh,s=this._x-(e*this._core.localTa+o*this._core.localTb)+e,n=this._y-(e*this._core.localTc+o*this._core.localTd)+o;s-=this._mountX*this.renderWidth,n-=this._mountY*this.renderHeight,this._core.setLocalTranslate(s,n)}},{key:'_updateLocalTranslateDelta',value:function _updateLocalTranslateDelta(e,o){this._core.addLocalTranslate(e,o)}},{key:'_updateLocalAlpha',value:function _updateLocalAlpha(){this._core.setLocalAlpha(this._visible?this._alpha:0)}},{key:'_updateTextureCoords',value:function _updateTextureCoords(){if(this.displayedTexture&&this.displayedTexture.source){var e=this.displayedTexture,n=this.displayedTexture.source,l=0,d=0,_=1,u=1;if(e.clipping){var c,x,y,f,T=n.getRenderWidth(),S=n.getRenderHeight();c=1/T,x=1/S,y=e.w?e.w*c:(T-e.x)*c,f=e.h?e.h*x:(S-e.y)*x,c*=e.x,x*=e.y,l=s(1,o(0,c)),d=s(1,o(x)),_=s(1,o(_*y+c)),u=s(1,o(u*f+x))}var h=this._core.allowTextureAtlas()&&n.inTextureAtlas;if(h){var C=4.88281e-4,k=n.textureAtlasX*C,w=n.textureAtlasY*C,R=n.w*C,E=n.h*C;l=l*R+k,d=d*R+w,_=_*R+k,u=u*E+w}this._core.setTextureCoords(l,d,_,u),this._core.setInTextureAtlas(h)}}},{key:'getCornerPoints',value:function getCornerPoints(){return this._core.getCornerPoints()}},{key:'_clearTagsCache',value:function _clearTagsCache(e){if(this._tagsCache&&(this._tagsCache.delete(e),this._tagToComplex)){var o=this._tagToComplex.get(e);if(o){for(var s=0,l=o.length;s<l;s++)this._tagsCache.delete(o[s]);this._tagToComplex.delete(e)}}}},{key:'_unsetTagsParent',value:function _unsetTagsParent(){var e=null,o=0;if(!this._tagRoot&&this._treeTags&&(e=Utils.iteratorToArray(this._treeTags.keys()),o=e.length,0<o))for(var s=0;s<o;s++)for(var n=this._treeTags.get(e[s]),l=this,d=function(){var o=l._treeTags.get(e[s]);n.forEach(function(e){o.delete(e)}),l._clearTagsCache(e[s])};(l=l._parent)&&!l._tagRoot;)d()}},{key:'_setTagsParent',value:function _setTagsParent(){if(!this._tagRoot&&this._treeTags&&this._treeTags.size){var e=this;this._treeTags.forEach(function(o,n){for(var l=e,s=function(){l._treeTags||(l._treeTags=new Map);var e=l._treeTags.get(n);e||(e=new Set,l._treeTags.set(n,e)),o.forEach(function(o){e.add(o)}),l._clearTagsCache(n)};(l=l._parent)&&!l._tagRoot;)s()})}}},{key:'_getByTag',value:function _getByTag(e){if(!this._treeTags)return[];var o=this._treeTags.get(e);return o?Utils.setToArray(o):[]}},{key:'getTags',value:function getTags(){return this._tags?this._tags:[]}},{key:'setTags',value:function setTags(e){var o,s=e.length,n=[],l=[];for(o=0;o<s;o++)this.hasTag(e[o])||l.push(e[o]);var d=this.tags||[];for(s=d.length,o=0;o<s;o++)-1==e.indexOf(d[o])&&n.push(d[o]);for(o=0;o<n.length;o++)this.removeTag(n[o]);for(o=0;o<l.length;o++)this.addTag(l[o])}},{key:'addTag',value:function addTag(e){if(this._tags||(this._tags=[]),-1===this._tags.indexOf(e)){this._tags.push(e);var o=this;do{o._treeTags||(o._treeTags=new Map);var s=o._treeTags.get(e);s||(s=new Set,o._treeTags.set(e,s)),s.add(this),o._clearTagsCache(e)}while(o=o._parent)}}},{key:'removeTag',value:function removeTag(e){var o=this._tags.indexOf(e);if(-1!==o){this._tags.splice(o,1);var s=this;do{var n=s._treeTags.get(e);n&&(n.delete(this),s._clearTagsCache(e))}while(s=s._parent)}}},{key:'hasTag',value:function hasTag(e){return this._tags&&-1!==this._tags.indexOf(e)}},{key:'_tag',value:function _tag(e){var o=this.mtag(e);return o[0]}},{key:'mtag',value:function mtag(e){var o=null;if(this._tagsCache&&(o=this._tagsCache.get(e)),!o){var s=e.indexOf('.');if(0<=s){var l=e.split('.');o=this._getByTag(l[0]);for(var d=1,_=l.length;o.length&&d<_;){for(var u=[],c=0,x=o.length;c<x;c++)u=u.concat(o[c]._getByTag(l[d]));o=resn,d++}}else o=this._getByTag(e);this._tagsCache||(this._tagsCache=new Map),this._tagsCache.set(e,o)}return o}},{key:'stag',value:function stag(e,o){for(var s=this.mtag(e),l=s.length,n=0;n<l;n++)s[n].setSettings(o)}},{key:'getLocationString',value:function getLocationString(){var e;if(this._parent&&(e=this._parent._children.getIndex(this),0<=e)){var o=this.getTags();return this._parent.getLocationString()+':'+e+'['+this.id+']'+(o.length?'('+o.join(',')+')':'')}return''}},{key:'toString',value:function toString(){var o=this.getSettings();return e.getPrettyString(o,'')}},{key:'getSettings',value:function getSettings(){var e=this.getNonDefaults(),o=this._children.get();if(o){var s=o.length;e.children=[];for(var n=0;n<s;n++)e.children.push(o[n].getSettings())}return e}},{key:'getNonDefaults',value:function getNonDefaults(){var e={};if(this._tags&&this._tags.length&&(e.tags=this._tags),0!==this._x&&(e.x=this._x),0!==this._y&&(e.y=this._y),0!==this._w&&(e.w=this._w),0!==this._h&&(e.h=this._h),this._scaleX===this._scaleY?1!==this._scaleX&&(e.scale=this._scaleX):(1!==this._scaleX&&(e.scaleX=this._scaleX),1!==this._scaleY&&(e.scaleY=this._scaleY)),this._pivotX===this._pivotY?0.5!==this._pivotX&&(e.pivot=this._pivotX):(0.5!==this._pivotX&&(e.pivotX=this._pivotX),0.5!==this._pivotY&&(e.pivotY=this._pivotY)),this._mountX===this._mountY?0!==this._mountX&&(e.mount=this._mountX):(0!==this._mountX&&(e.mountX=this._mountX),0!==this._mountY&&(e.mountY=this._mountY)),1!==this._alpha&&(e.alpha=this._alpha),0!==this._rotation&&(e.rotation=this._rotation),this._core.colorUl===this._core.colorUr&&this._core.colorBl===this._core.colorBr&&this._core.colorUl===this._core.colorBl?4294967295!==this._core.colorUl&&(e.color=4294967295):(4294967295!==this._core.colorUl&&(e.colorUl=4294967295),4294967295!==this._core.colorUr&&(e.colorUr=4294967295),4294967295!==this._core.colorBl&&(e.colorBl=4294967295),4294967295!==this._core.colorBr&&(e.colorBr=4294967295)),this._visible||(e.visible=!1),this._core.zIndex&&(e.zIndex=this._core.zIndex),this._core.forceZIndexContext&&(e.forceZIndexContext=!0),this._core.clipping&&(e.clipping=this._core.clipping),this.rect?e.rect=!0:this.src?e.src=this.src:this.texture&&this._viewText&&(e.text=this._viewText.settings.getNonDefaults()),this._texture){var o=this._texture.getNonDefaults();Object.keys(o).length&&(e.texture=o)}return this._texturizer&&(this._texturizer.enabled&&(e.renderToTexture=this._texturizer.enabled),this._texturizer.lazy&&(e.renderToTextureLazy=this._texturizer.lazy),this._texturizer.colorize&&(e.colorizeResultTexture=this._texturizer.colorize),this._texturizer.hideResult&&(e.hideResultTexture=this._texturizer.hideResult)),e}},{key:'setSettings',value:function setSettings(e){Base.setObjectSettings(this,e)}},{key:'_getExposedChildList',value:function _getExposedChildList(){return this._children}},{key:'getChildren',value:function getChildren(){return this.childList.get()}},{key:'addChild',value:function addChild(e){return this.childList.add(e)}},{key:'addChildAt',value:function addChildAt(e,o){return this.childList.addAt(e,o)}},{key:'getChildIndex',value:function getChildIndex(e){return this.childList.getIndex(e)}},{key:'removeChild',value:function removeChild(e){return this.childList.remove(e)}},{key:'removeChildAt',value:function removeChildAt(e){return this.childList.removeAt(e)}},{key:'removeChildren',value:function removeChildren(){return this.childList.clear()}},{key:'add',value:function add(e){return this.childList.a(e)}},{key:'getResultTextureSource',value:function getResultTextureSource(){return this.texturizer.getResultTextureSource()}},{key:'animation',value:function animation(e){return this.stage.animations.createAnimation(this,e)}},{key:'transition',value:function transition(e,o){return void 0===o?this._getTransition(e):(this._setTransition(e,o),null)}},{key:'fastForward',value:function fastForward(e){if(this._transitions){var o=this._transitions[e];o&&o.isTransition&&o.finish()}}},{key:'_getTransition',value:function _getTransition(e){this._transitions||(this._transitions={});var o=this._transitions[e];return o?o.isTransitionSettings&&(o=new Transition(this.stage.transitions,o,this,e)):o=new Transition(this.stage.transitions,this.stage.transitions.defaultTransitionSettings,this,e),this._transitions[e]=o,o}},{key:'_setTransition',value:function _setTransition(e,o){o||this._removeTransition(e),Utils.isObjectLiteral(o)&&(o=this.stage.transitions.createSettings(o)),this._transitions||(this._transitions={});var s=this._transitions[e];return s&&s.isTransition?(s.settings=o,s):void(this._transitions[e]=o)}},{key:'_removeTransition',value:function _removeTransition(e){this._transitions&&delete this._transitions[e]}},{key:'getSmooth',value:function getSmooth(e,o){var s=this._getTransition(e);return s&&s.isActive()?s.targetValue:o}},{key:'setSmooth',value:function setSmooth(e,o,s){s&&this._setTransition(e,s);var n=this._getTransition(e);return n.start(o),n}},{key:'isNumberProperty',value:function isNumberProperty(o){return e.isNumberProperty(o,this.constructor)}},{key:'isColorProperty',value:function isColorProperty(o){return e.isColorProperty(o,this.constructor)}},{key:'active',get:function get(){return this._active}},{key:'attached',get:function get(){return this._attached}},{key:'renderWidth',get:function get(){return this._active?this._core._rw:this._getRenderWidth()}},{key:'renderHeight',get:function get(){return this._active?this._core._rh:this._getRenderHeight()}},{key:'texture',get:function get(){return this._texture},set:function set(e){if(e&&Utils.isObjectLiteral(e))return void(this.texture?Base.setObjectSettings(this.texture,e):console.warn('Trying to set texture properties, but there is no texture.'));var o=this._texture;if(e!==o){if(null!==e)if(e instanceof TextureSource)e=this.stage.texture(e);else if(!e instanceof Texture)return void console.error('incorrect value for texture');this._texture=e,this._active&&o&&this.displayedTexture!==o&&(!e||o.source!==e.source)&&(!this.displayedTexture||this.displayedTexture.source!==o.source)&&o.source.removeView(this),e?(this._active&&e.source.addView(this),e.source.glTexture&&(this.displayedTexture=e)):this.displayedTexture=null}}},{key:'displayedTexture',get:function get(){return this._displayedTexture},set:function set(e){var o=this._displayedTexture;e!==o&&(this._active&&o&&o!==this._texture&&(!e||o.source!==e.source)&&o.source.removeView(this),this._displayedTexture=e,this._updateDimensions(),e?(this._eventsCount&&this.emit('txLoaded',e),this._updateTextureCoords(),this._core.setDisplayedTextureSource(e.source)):(this._eventsCount&&this.emit('txUnloaded',e),this._core.setDisplayedTextureSource(null)))}},{key:'tag',get:function get(){return this._tag},set:function set(e){this.tags=e}},{key:'tagRoot',get:function get(){return this._tagRoot},set:function set(e){this._tagRoot!==e&&(e?this._unsetTagsParent():this._setTagsParent(),this._tagRoot=e)}},{key:'x',get:function get(){return this._x},set:function set(e){this._x!==e&&(this._updateLocalTranslateDelta(e-this._x,0),this._x=e)}},{key:'y',get:function get(){return this._y},set:function set(e){this._y!==e&&(this._updateLocalTranslateDelta(0,e-this._y),this._y=e)}},{key:'w',get:function get(){return this._w},set:function set(e){this._w!==e&&(this._w=e,this._updateDimensions())}},{key:'h',get:function get(){return this._h},set:function set(e){this._h!==e&&(this._h=e,this._updateDimensions())}},{key:'scaleX',get:function get(){return this._scaleX},set:function set(e){this._scaleX!==e&&(this._scaleX=e,this._updateLocalTransform())}},{key:'scaleY',get:function get(){return this._scaleY},set:function set(e){this._scaleY!==e&&(this._scaleY=e,this._updateLocalTransform())}},{key:'scale',get:function get(){return this._scaleX},set:function set(e){(this._scaleX!==e||this._scaleY!==e)&&(this._scaleX=e,this._scaleY=e,this._updateLocalTransform())}},{key:'pivotX',get:function get(){return this._pivotX},set:function set(e){this._pivotX!==e&&(this._pivotX=e,this._updateLocalTranslate())}},{key:'pivotY',get:function get(){return this._pivotY},set:function set(e){this._pivotY!==e&&(this._pivotY=e,this._updateLocalTranslate())}},{key:'pivot',get:function get(){return this._pivotX},set:function set(e){(this._pivotX!==e||this._pivotY!==e)&&(this._pivotX=e,this._pivotY=e,this._updateLocalTranslate())}},{key:'mountX',get:function get(){return this._mountX},set:function set(e){this._mountX!==e&&(this._mountX=e,this._updateLocalTranslate())}},{key:'mountY',get:function get(){return this._mountY},set:function set(e){this._mountY!==e&&(this._mountY=e,this._updateLocalTranslate())}},{key:'mount',get:function get(){return this._mountX},set:function set(e){(this._mountX!==e||this._mountY!==e)&&(this._mountX=e,this._mountY=e,this._updateLocalTranslate())}},{key:'alpha',get:function get(){return this._alpha},set:function set(e){if(e=1<e?1:1e-14>e?0:e,this._alpha!==e){var o=this._alpha;this._alpha=e,this._updateLocalAlpha(),0===o!=(0===e)&&this._updateActiveFlag()}}},{key:'rotation',get:function get(){return this._rotation},set:function set(e){this._rotation!==e&&(this._rotation=e,this._updateLocalTransform())}},{key:'colorUl',get:function get(){return this._core.colorUl},set:function set(e){this._core.colorUl=e}},{key:'colorUr',get:function get(){return this._core.colorUr},set:function set(e){this._core.colorUr=e}},{key:'colorBl',get:function get(){return this._core.colorBl},set:function set(e){this._core.colorBl=e}},{key:'colorBr',get:function get(){return this._core.colorBr},set:function set(e){this._core.colorBr=e}},{key:'color',get:function get(){return this._core.colorUl},set:function set(e){(this.colorUl!==e||this.colorUr!==e||this.colorBl!==e||this.colorBr!==e)&&(this.colorUl=e,this.colorUr=e,this.colorBl=e,this.colorBr=e)}},{key:'colorTop',get:function get(){return this.colorUl},set:function set(e){(this.colorUl!==e||this.colorUr!==e)&&(this.colorUl=e,this.colorUr=e)}},{key:'colorBottom',get:function get(){return this.colorBl},set:function set(e){(this.colorBl!==e||this.colorBr!==e)&&(this.colorBl=e,this.colorBr=e)}},{key:'colorLeft',get:function get(){return this.colorUl},set:function set(e){(this.colorUl!==e||this.colorBl!==e)&&(this.colorUl=e,this.colorBl=e)}},{key:'colorRight',get:function get(){return this.colorUr},set:function set(e){(this.colorUr!==e||this.colorBr!==e)&&(this.colorUr=e,this.colorBr=e)}},{key:'visible',get:function get(){return this._visible},set:function set(e){this._visible!==e&&(this._visible=e,this._updateLocalAlpha(),this._updateActiveFlag())}},{key:'zIndex',get:function get(){return this._core.zIndex},set:function set(e){this._core.zIndex;this._core.zIndex=e}},{key:'forceZIndexContext',get:function get(){return this._core.forceZIndexContext},set:function set(e){this._core.forceZIndexContext=e}},{key:'clipping',get:function get(){return this._core.clipping},set:function set(e){this._core.clipping=e}},{key:'tags',get:function get(){return this.getTags()},set:function set(e){Array.isArray(e)||(e=[e]),this.setTags(e)}},{key:'t',set:function set(e){this.tags=e}},{key:'_children',get:function get(){return this._childList||(this._childList=new ViewChildList(this,!1)),this._childList}},{key:'_lchildren',get:function get(){return this._childList.get()}},{key:'childList',get:function get(){return this._exposedChildList||(this._exposedChildList=this._getExposedChildList()),this._exposedChildList}},{key:'children',get:function get(){return this.childList.get()},set:function set(e){this.childList.set(e)}},{key:'parent',get:function get(){return this._parent}},{key:'src',get:function get(){return this.texture&&this.texture.source&&this.texture.source.renderInfo&&this.texture.source.renderInfo.src?this.texture.source.renderInfo.src:null},set:function set(e){e?(!this.texture||!this.texture.source.renderInfo||this.texture.source.renderInfo.src!==e)&&(this.texture=this.stage.textureManager.getTexture(e)):this.texture=null}},{key:'rect',get:function get(){return this.texture===this.stage.rectangleTexture},set:function set(e){this.texture=e?this.stage.rectangleTexture:null}},{key:'text',get:function get(){return this._viewText||(this._viewText=new ViewText(this)),this._viewText.settings},set:function set(e){this._viewText||(this._viewText=new ViewText(this)),Utils.isString(e)?this._viewText.settings.text=e:this._viewText.settings.setSettings(e)}},{key:'visitEntry',set:function set(e){this._core.visitEntry=e}},{key:'visitExit',set:function set(e){this._core.visitExit=e}},{key:'shader',get:function get(){return this._core.shader},set:function set(e){var o;if(Utils.isObjectLiteral(e))o=e.type?new e.type(this.stage.ctx):this.shader,o&&o.setSettings(e);else if(null===e)o=this.stage.ctx.renderState.defaultShader;else if(e.isShader)o=e;else return void console.error('Please specify a shader type.');this._core.shader=o}},{key:'renderToTexture',get:function get(){return this._texturizer&&this.texturizer.enabled},set:function set(e){this.texturizer.enabled=e}},{key:'renderToTextureLazy',get:function get(){return this._texturizer&&this.texturizer.lazy},set:function set(e){this.texturizer.lazy=e}},{key:'hideResultTexture',get:function get(){return this._texturizer&&this.texturizer.hideResult},set:function set(e){this.texturizer.hideResult=e}},{key:'colorizeResultTexture',get:function get(){return this._texturizer&&this.texturizer.colorize},set:function set(e){this.texturizer.colorize=e}},{key:'filters',get:function get(){return this.texturizer.filters},set:function set(e){this.texturizer.filters=e}},{key:'texturizer',get:function get(){return this._core.texturizer}},{key:'transitions',set:function set(e){var o=this,s=Object.keys(e);s.forEach(function(s){o.transition(s,e[s])})}},{key:'X',get:function get(){return this.getSmooth('x',this.x)},set:function set(e){this.setSmooth('x',e)}},{key:'Y',get:function get(){return this.getSmooth('y',this.y)},set:function set(e){this.setSmooth('y',e)}},{key:'W',get:function get(){return this.getSmooth('w',this.w)},set:function set(e){return this.setSmooth('w',e)}},{key:'H',get:function get(){return this.getSmooth('h',this.h)},set:function set(e){this.setSmooth('h',e)}},{key:'SCALE',get:function get(){return this.getSmooth('scale',this.scale)},set:function set(e){this.setSmooth('scale',e)}},{key:'SCALEX',get:function get(){return this.getSmooth('scaleX',this.scaleX)},set:function set(e){this.setSmooth('scaleX',e)}},{key:'PIVOT',get:function get(){return this.getSmooth('pivot',this.pivot)},set:function set(e){this.setSmooth('pivot',e)}},{key:'PIVOTX',get:function get(){return this.getSmooth('pivotX',this.pivotX)},set:function set(e){this.setSmooth('pivotX',e)}},{key:'MOUNT',get:function get(){return this.getSmooth('mount',this.mount)},set:function set(e){this.setSmooth('mount',e)}},{key:'MOUNTX',get:function get(){return this.getSmooth('mountX',this.mountX)},set:function set(e){this.setSmooth('mountX',e)}},{key:'ALPHA',get:function get(){return this.getSmooth('alpha',this.alpha)},set:function set(e){this.setSmooth('alpha',e)}},{key:'ROTATION',get:function get(){return this.getSmooth('rotation',this.rotation)},set:function set(e){this.setSmooth('rotation',e)}},{key:'COLOR',get:function get(){return this.getSmooth('color',this.color)},set:function set(e){this.setSmooth('color',e)}},{key:'COLORTOP',set:function set(e){this.setSmooth('colorTop',e)}},{key:'COLORBOTTOM',set:function set(e){this.setSmooth('colorBottom',e)}},{key:'COLORLEFT',set:function set(e){this.setSmooth('colorLeft',e)}},{key:'COLORRIGHT',set:function set(e){this.setSmooth('colorRight',e)}},{key:'COLORUL',get:function get(){return this.getSmooth('colorUl',this.colorUl)},set:function set(e){this.setSmooth('colorUl',e)}},{key:'COLORUR',get:function get(){return this.getSmooth('colorUr',this.colorUr)},set:function set(e){this.setSmooth('colorUr',e)}},{key:'COLORBL',get:function get(){return this.getSmooth('colorBl',this.colorBl)},set:function set(e){this.setSmooth('colorBl',e)}},{key:'COLORBR',get:function get(){return this.getSmooth('colorBr',this.colorBr)},set:function set(e){this.setSmooth('colorBr',e)}}],[{key:'getPrettyString',value:function getPrettyString(o,s){var l=o.children;delete o.children;var d=['color','colorUl','colorUr','colorBl','colorBr'],_=JSON.stringify(o,function(e,o){return-1===d.indexOf(e)?o:'COLOR['+o.toString(16)+']'});if(_=_.replace(/"COLOR\[([a-f0-9]{1,8})\]"/g,'0x$1'),l&&l.length){var u='{}'===_;_=_.substr(0,_.length-1)+(u?'':',')+'"children":[\n';for(var c=l.length,n=0;n<c;n++)_+=e.getPrettyString(l[n],s+'  ')+(n<c-1?',':'')+'\n';_+=s+']}'}return s+_}},{key:'getGetter',value:function getGetter(o){var s=e.PROP_GETTERS.get(o);return s||(s=new Function('obj','return obj.'+o),e.PROP_GETTERS.set(o,s)),s}},{key:'getSetter',value:function getSetter(o){var s=e.PROP_SETTERS.get(o);return s||(s=new Function('obj','v','obj.'+o+' = v'),e.PROP_SETTERS.set(o,s)),s}}]),e}();View.isNumberProperty=function(e){var o=1<arguments.length&&arguments[1]!==void 0?arguments[1]:View;do if(o.NUMBER_PROPERTIES&&o.NUMBER_PROPERTIES.has(e))return!0;while(o!==View&&(o=Object.getPrototypeOf(o)));return!1},View.isColorProperty=function(e){var o=1<arguments.length&&arguments[1]!==void 0?arguments[1]:View;do if(o.COLOR_PROPERTIES&&o.COLOR_PROPERTIES.has(e))return!0;while(o!==View&&(o=Object.getPrototypeOf(o)));return!1},View.getMerger=function(e){var o=1<arguments.length&&arguments[1]!==void 0?arguments[1]:View;return View.isNumberProperty(e,o)?StageUtils.mergeNumbers:View.isColorProperty(e,o)?StageUtils.mergeColors:void 0},View.NUMBER_PROPERTIES=new Set(['x','y','w','h','scale','scaleX','scaleY','pivot','pivotX','pivotY','mount','mountX','mountY','alpha','rotation','texture.x','texture.y','texture.w','texture.h']),View.COLOR_PROPERTIES=new Set(['color','colorTop','colorBottom','colorLeft','colorRight','colorUl','colorUr','colorBl','colorBr']),View.prototype.isView=1,View.id=1,View.PROP_GETTERS=new Map,View.PROP_SETTERS=new Map,Base.mixinEs5(View,EventEmitter);var ViewChildList=function(){function e(o){var s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0;_classCallCheck(this,e),this._view=o,this._children=s?this._view._children._children:[]}return _createClass(e,[{key:'get',value:function get(){return this._children}},{key:'add',value:function add(e){return e._parent===this&&0<=this._children.indexOf(e)?e:void this.addAt(e,this._children.length)}},{key:'addAt',value:function addAt(e,o){if(e!==this._view){if(0<=o&&o<=this._children.length){if(e._parent===this._view&&this._children.indexOf(e)===o);else{if(e._parent){var s=e._parent;s._children.remove(e)}e._setParent(this._view),this._children.splice(o,0,e),this._view._core.addChildAt(o,e._core)}return}throw new Error(e+'addChildAt: The index '+o+' supplied is out of bounds '+this._children.length)}}},{key:'getIndex',value:function getIndex(e){return this._children.indexOf(e)}},{key:'remove',value:function remove(e){var o=this.getIndex(e);-1!==o&&this.removeAt(o)}},{key:'removeAt',value:function removeAt(e){var o=this._children[e];return o._setParent(null),this._children.splice(e,1),this._view._core.removeChildAt(e),o}},{key:'clear',value:function clear(){var e=this._children.length;if(e){for(var o,s=0;s<e;s++)o=this._children[s],o._setParent(null);this._children.splice(0,e),this._view._core.removeChildren()}}},{key:'a',value:function a(e){if(Utils.isObjectLiteral(e)){var o;return o=e.type?new e.type(this._view.stage):this._view.stage.createView(),this.add(o),o.setSettings(e),o}if(Array.isArray(e)){for(var s=0,l=e.length;s<l;s++)this.a(e[s]);return null}return e.isView?(this.add(e),e):void 0}},{key:'set',value:function set(e){this.clear();for(var s,o=0,l=e.length;o<l;o++)if(s=e[o],Utils.isObjectLiteral(s)){var n=void 0;n=s.type?new s.type(this._view.stage):this._view.stage.createView(),this.add(n),n.setSettings(s)}else s.isView&&this.add(s)}},{key:'length',get:function get(){return this._children.length}}]),e}(),ViewTexturizer=function(){function e(o){_classCallCheck(this,e),this._view=o.view,this._core=o,this.ctx=this._core.ctx,this._enabled=!1,this.lazy=!1,this._colorize=!1,this._filters=[],this._renderTexture=null,this._renderTextureReused=!1,this._resultTexture=null,this._resultTextureSource=null,this._renderToTextureEnabled=!1,this._hideResult=!1,this.filterResultCached=!1}var o=Math.min;return _createClass(e,[{key:'_clearFilters',value:function _clearFilters(){var e=this;this._filters.forEach(function(o){return o.removeView(e._core)}),this._filters=[],this.filterResultCached=!1}},{key:'_addFilter',value:function _addFilter(e){e.addView(this._core),this._filters.push(e)}},{key:'_hasFilters',value:function _hasFilters(){return 0<this._filters.length}},{key:'_hasActiveFilters',value:function _hasActiveFilters(){for(var e=0,o=this._filters.length;e<o;e++)if(!this._filters[e].useDefault())return!0;return!1}},{key:'getActiveFilters',value:function getActiveFilters(){var e=[];return this._filters.forEach(function(o){o.useDefault()||(o.getFilters?o.getFilters().forEach(function(o){return e.push(o)}):e.push(o))}),e}},{key:'getResultTextureSource',value:function getResultTextureSource(){return this._resultTextureSource||(this._resultTextureSource=new TextureSource(this._view.stage.textureManager,null),this.updateResultTexture()),this._resultTextureSource}},{key:'updateResultTexture',value:function updateResultTexture(){var e=this.getResultTexture();if(this._resultTextureSource){if(this._resultTextureSource.glTexture!==e){var o=e?e.w:0,s=e?e.h:0;this._resultTextureSource._changeGlTexture(e,o,s)}this._resultTextureSource.views.forEach(function(e){return e._core.setHasRenderUpdates(3)})}}},{key:'mustRenderToTexture',value:function mustRenderToTexture(){return this._enabled&&!this.lazy||this._enabled&&this.lazy&&3>this._hasRenderUpdates||!!this._hasActiveFilters()}},{key:'deactivate',value:function deactivate(){this.releaseRenderTexture(),this.releaseFilterTexture()}},{key:'releaseRenderTexture',value:function releaseRenderTexture(){this._renderTexture&&(!this._renderTextureReused&&this.ctx.releaseRenderTexture(this._renderTexture),this._renderTexture=null,this._renderTextureReused=!1,this.updateResultTexture())}},{key:'reuseTextureAsRenderTexture',value:function reuseTextureAsRenderTexture(e){this._renderTexture!==e&&(this.releaseRenderTexture(),this._renderTexture=e,this._renderTextureReused=!0)}},{key:'hasRenderTexture',value:function hasRenderTexture(){return!!this._renderTexture}},{key:'getRenderTexture',value:function getRenderTexture(){return this._renderTexture||(this._renderTexture=this.ctx.allocateRenderTexture(o(2048,this._core._rw),o(2048,this._core._rh)),this._renderTextureReused=!1),this._renderTexture}},{key:'getFilterTexture',value:function getFilterTexture(){return this._resultTexture||(this._resultTexture=this.ctx.allocateRenderTexture(o(2048,this._core._rw),o(2048,this._core._rh))),this._resultTexture}},{key:'releaseFilterTexture',value:function releaseFilterTexture(){this._resultTexture&&(this.ctx.releaseRenderTexture(this._resultTexture),this._resultTexture=null,this.filterResultCached=!1,this.updateResultTexture())}},{key:'getResultTexture',value:function getResultTexture(){return this._hasActiveFilters()?this._resultTexture:this._renderTexture}},{key:'enabled',get:function get(){return this._enabled},set:function set(e){this._enabled=e,this._core.updateRenderToTextureEnabled()}},{key:'hideResult',get:function get(){return this._hideResult},set:function set(e){this._hideResult=e,this._core.setHasRenderUpdates(1)}},{key:'colorize',get:function get(){return this._colorize},set:function set(e){this._colorize!==e&&(this._colorize=e,this._core.setHasRenderUpdates(1))}},{key:'filters',get:function get(){return this._filters},set:function set(e){var o=this;this._clearFilters(),e.forEach(function(e){if(Utils.isObjectLiteral(e)&&e.type){var s=new e.type(o.ctx);s.setSettings(e),e=s}e.isFilter?o._addFilter(e):console.error('Please specify a filter type.')}),this._core.updateRenderToTextureEnabled(),this._core.setHasRenderUpdates(2)}},{key:'renderTextureReused',get:function get(){return this._renderTextureReused}}]),e}(),ViewCore=function(){function e(o){_classCallCheck(this,e),this._view=o,this.ctx=o.stage.ctx,this.renderState=this.ctx.renderState,this._parent=null,this._hasUpdates=!1,this._hasRenderUpdates=0,this._visitEntry=null,this._visitExit=null,this._recalc=0,this._updateTreeOrder=0,this._worldContext=new ViewCoreContext,this._renderContext=this._worldContext,this._localPx=0,this._localPy=0,this._localTa=1,this._localTb=0,this._localTc=0,this._localTd=1,this._isComplex=!1,this._localAlpha=1,this._rw=0,this._rh=0,this._clipping=!1,this._displayedTextureSource=null,this.inTextureAtlas=!1,this._colorUl=this._colorUr=this._colorBl=this._colorBr=4294967295,this._txCoordsUl=0,this._txCoordsUr=65535,this._txCoordsBr=4294967295,this._txCoordsBl=4294901760,this._ulx=0,this._uly=0,this._brx=1,this._bry=1,this._zIndex=0,this._forceZIndexContext=!1,this._zContextUsage=0,this._zParent=null,this._zSort=!1,this._isRoot=!1,this._children=null,this._zIndexedChildren=null,this._shader=null,this._shaderOwner=null,this._renderToTextureEnabled=!1,this._texturizer=null,this._useRenderToTexture=!1,this._useViewportClipping=!1,this.render=this._renderSimple}var o=Math.round,s=Math.min;return _createClass(e,[{key:'setHasRenderUpdates',value:function setHasRenderUpdates(e){var o=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(this._worldContext.alpha||o){var s=this;for(s._hasRenderUpdates=Math.max(e,s._hasRenderUpdates);(s=s._parent)&&3!=s._hasRenderUpdates;)s._hasRenderUpdates=3}}},{key:'_setRecalc',value:function _setRecalc(e){if(this._recalc|=e,this._worldContext.alpha){var o=this;do o._hasUpdates=!0;while((o=o._parent)&&!o._hasUpdates);this._parent&&this._parent.setHasRenderUpdates(3)}else this._hasUpdates=!0}},{key:'_setRecalcForced',value:function _setRecalcForced(e){this._recalc|=e;var o=this;do o._hasUpdates=!0;while((o=o._parent)&&!o._hasUpdates);this._parent&&this._parent.setHasRenderUpdates(3)}},{key:'setParent',value:function setParent(e){if(e!==this._parent){var o=this.isZContext(),s=this._parent;if(this._parent=e,this._setRecalc(7),0===this._zIndex?this.setZParent(e):this.setZParent(e?e.findZContext():null),o!==this.isZContext()&&(this.isZContext()?this.enableZContext(s.findZContext()):this.disableZContext()),!this._shader){var n=e?e._shaderOwner:null;n!==this._shaderOwner&&(this.setHasRenderUpdates(1),this._setShaderOwnerRecursive(n))}}}},{key:'addChildAt',value:function addChildAt(e,o){this._children||(this._children=[]),this._children.splice(e,0,o),o.setParent(this)}},{key:'removeChildAt',value:function removeChildAt(e){var o=this._children[e];this._children.splice(e,1),o.setParent(null)}},{key:'removeChildren',value:function removeChildren(){if(this._children){for(var e=0,o=this._children.length;e<o;e++)this._children[e].setParent(null);this._children.splice(0),this._zIndexedChildren&&this._zIndexedChildren.splice(0)}}},{key:'setLocalTransform',value:function setLocalTransform(e,o,s,n){this._setRecalc(4),this._localTa=e,this._localTb=o,this._localTc=s,this._localTd=n,this._isComplex=0!=o||0!=s}},{key:'setLocalTranslate',value:function setLocalTranslate(e,o){this._setRecalc(2),this._localPx=e,this._localPy=o}},{key:'addLocalTranslate',value:function addLocalTranslate(e,o){this.setLocalTranslate(this._localPx+e,this._localPy+o)}},{key:'setLocalAlpha',value:function setLocalAlpha(e){!this._worldContext.alpha&&this._parent&&this._parent._worldContext.alpha&&e?(this._setRecalcForced(129),this.setHasRenderUpdates(3,!0)):this._setRecalc(1),1e-14>e&&(e=0),this._localAlpha=e}},{key:'setDimensions',value:function setDimensions(e,o){this._rw=e,this._rh=o,this._setRecalc(2),this._texturizer&&(this._texturizer.releaseRenderTexture(),this._texturizer.releaseFilterTexture(),this._texturizer.updateResultTexture())}},{key:'setTextureCoords',value:function setTextureCoords(e,o,s,n){this.setHasRenderUpdates(3),this._ulx=e,this._uly=o,this._brx=s,this._bry=n,this._txCoordsUl=(0|65535*e+0.5)+65536*(0|65535*o+0.5),this._txCoordsUr=(0|65535*s+0.5)+65536*(0|65535*o+0.5),this._txCoordsBl=(0|65535*e+0.5)+65536*(0|65535*n+0.5),this._txCoordsBr=(0|65535*s+0.5)+65536*(0|65535*n+0.5)}},{key:'setDisplayedTextureSource',value:function setDisplayedTextureSource(e){this.setHasRenderUpdates(3),this._displayedTextureSource=e}},{key:'allowTextureAtlas',value:function allowTextureAtlas(){return this.activeShader.supportsTextureAtlas()}},{key:'setInTextureAtlas',value:function setInTextureAtlas(e){this.inTextureAtlas=e}},{key:'setAsRoot',value:function setAsRoot(){this._parent=new e(this._view),this._isRoot=!0,this.ctx.root=this}},{key:'isAncestorOf',value:function isAncestorOf(e){for(var o=e;o=o._parent;)if(this===o)return!0;return!1}},{key:'isZContext',value:function isZContext(){return this._forceZIndexContext||this._renderToTextureEnabled||0!==this._zIndex||this._isRoot||!this._parent}},{key:'findZContext',value:function findZContext(){return this.isZContext()?this:this._parent.findZContext()}},{key:'setZParent',value:function setZParent(e){if(this._zParent!==e){if(null!==this._zParent&&(0!==this._zIndex&&this._zParent.decZContextUsage(),0<this._zParent._zContextUsage)){var o=this._zParent._zIndexedChildren.indexOf(this);this._zParent._zIndexedChildren.splice(o,1)}if(null!==e){var s=0<e._zContextUsage;0!==this._zIndex&&e.incZContextUsage(),0<e._zContextUsage&&(!s&&this._parent===e||e._zIndexedChildren.push(this),e._zSort=!0)}this._zParent=e}}},{key:'incZContextUsage',value:function incZContextUsage(){if(this._zContextUsage++,1===this._zContextUsage&&(this._zIndexedChildren||(this._zIndexedChildren=[]),this._children))for(var e=0,o=this._children.length;e<o;e++)this._zIndexedChildren.push(this._children[e])}},{key:'decZContextUsage',value:function decZContextUsage(){this._zContextUsage--,0===this._zContextUsage&&(this._zSort=!1,this._zIndexedChildren.splice(0))}},{key:'enableZContext',value:function enableZContext(e){if(e&&0<e._zContextUsage){var o=this;e._zIndexedChildren.slice().forEach(function(e){o.isAncestorOf(e)&&0!==e._zIndex&&e.setZParent(o)})}}},{key:'disableZContext',value:function disableZContext(){if(0<this._zContextUsage){var e=this._parent.findZContext();this._zIndexedChildren.slice().forEach(function(o){0!==o._zIndex&&o.setZParent(e)})}}},{key:'_setShaderOwnerRecursive',value:function _setShaderOwnerRecursive(e){var o=this.activeShader.supportsTextureAtlas();if(this._shaderOwner=e,o!==this.activeShader.supportsTextureAtlas()&&this._view._updateTextureCoords(),this._children&&!this._renderToTextureEnabled)for(var s,l=0,d=this._children.length;l<d;l++)s=this._children[l],s._shader||(s._setShaderOwnerRecursive(e),s._hasRenderUpdates=3)}},{key:'_setShaderOwnerChildrenRecursive',value:function _setShaderOwnerChildrenRecursive(e){if(this._children)for(var o,s=0,l=this._children.length;s<l;s++)o=this._children[s],o._shader||(o._setShaderOwnerRecursive(e),o._hasRenderUpdates=3)}},{key:'_hasRenderContext',value:function _hasRenderContext(){return this._renderContext!==this._worldContext}},{key:'updateRenderToTextureEnabled',value:function updateRenderToTextureEnabled(){var e=this.texturizer._hasFilters()||this.texturizer._enabled||this._clipping;e?this._enableRenderToTexture():(this._disableRenderToTexture(),this._texturizer.releaseRenderTexture())}},{key:'_enableRenderToTexture',value:function _enableRenderToTexture(){if(!this._renderToTextureEnabled){var e=this.isZContext();this._renderToTextureEnabled=!0,this._renderContext=new ViewCoreContext,this._setShaderOwnerChildrenRecursive(null),e||this.enableZContext(this._parent?this._parent.findZContext():null),this.setHasRenderUpdates(3),this._setRecalc(7),this.render=this._renderAdvanced}}},{key:'_disableRenderToTexture',value:function _disableRenderToTexture(){this._renderToTextureEnabled&&(this._renderToTextureEnabled=!1,this._setShaderOwnerChildrenRecursive(this._shaderOwner),this._renderContext=this._worldContext,!this.isZContext()&&this.disableZContext(),this._setRecalc(7),this.setHasRenderUpdates(3),this.render=this._renderSimple)}},{key:'_stashTexCoords',value:function _stashTexCoords(){this._stashedTexCoords=[this._txCoordsUl,this._txCoordsUr,this._txCoordsBr,this._txCoordsBl,this._ulx,this._uly,this._brx,this._bry],this._txCoordsUl=0,this._txCoordsUr=65535,this._txCoordsBr=4294967295,this._txCoordsBl=4294901760,this._ulx=0,this._uly=0,this._brx=1,this._bry=1}},{key:'_unstashTexCoords',value:function _unstashTexCoords(){this._txCoordsUl=this._stashedTexCoords[0],this._txCoordsUr=this._stashedTexCoords[1],this._txCoordsBr=this._stashedTexCoords[2],this._txCoordsBl=this._stashedTexCoords[3],this._ulx=this._stashedTexCoords[4],this._uly=this._stashedTexCoords[5],this._brx=this._stashedTexCoords[6],this._bry=this._stashedTexCoords[7],this._stashedTexCoords=null}},{key:'_stashColors',value:function _stashColors(){this._stashedColors=[this._colorUl,this._colorUr,this._colorBr,this._colorBl],this._colorUl=4294967295,this._colorUr=4294967295,this._colorBr=4294967295,this._colorBl=4294967295}},{key:'_unstashColors',value:function _unstashColors(){this._colorUl=this._stashedColors[0],this._colorUr=this._stashedColors[1],this._colorBr=this._stashedColors[2],this._colorBl=this._stashedColors[3],this._stashedColors=null}},{key:'isVisible',value:function isVisible(){return 1e-14<this._localAlpha}},{key:'visit',value:function visit(){if(this.isVisible()){var e=0<this._recalc||0<this._hasRenderUpdates||this._hasUpdates;if(e){if(this._visitEntry&&this._visitEntry(this._view),this._children){var o=this._recalc;this._recalc|=6&this._parent._recalc;for(var s=0,l=this._children.length;s<l;s++)this._children[s].visit();this._recalc=o}this._visitExit&&this._visitExit(this._view)}}}},{key:'update',value:function update(){this._recalc|=this._parent._recalc;var e=this._parent._worldContext,o=this._worldContext,s=e.alpha&&this._localAlpha,l=o.alpha&&!s;if(s||l){this._zSort&&this.ctx.updateTreeOrderForceUpdate++;var d=this._recalc;if(1&d&&(o.alpha=e.alpha*this._localAlpha,1e-14>o.alpha&&(o.alpha=0)),6&d&&(o.px=e.px+this._localPx*e.ta,o.py=e.py+this._localPy*e.td,0!==e.tb&&(o.px+=this._localPy*e.tb),0!==e.tc&&(o.py+=this._localPx*e.tc)),4&d&&(o.ta=this._localTa*e.ta,o.tb=this._localTd*e.tb,o.tc=this._localTa*e.tc,o.td=this._localTd*e.td,this._isComplex&&(o.ta+=this._localTc*e.tb,o.tb+=this._localTb*e.ta,o.tc+=this._localTc*e.td,o.td+=this._localTb*e.tc)),this._parent._hasRenderContext()){this._renderContext===this._worldContext&&(this._renderContext=new ViewCoreContext);var _=this._renderContext,u=this._parent._renderContext;1&d&&(_.alpha=u.alpha*this._localAlpha,1e-14>_.alpha&&(_.alpha=0)),6&d&&(_.px=u.px+this._localPx*u.ta,_.py=u.py+this._localPy*u.td,0!==u.tb&&(_.px+=this._localPy*u.tb),0!==u.tc&&(_.py+=this._localPx*u.tc)),4&d&&(_.ta=this._localTa*u.ta,_.tb=this._localTd*u.tb,_.tc=this._localTa*u.tc,_.td=this._localTd*u.td,this._isComplex&&(_.ta+=this._localTc*u.tb,_.tb+=this._localTb*u.ta,_.tc+=this._localTc*u.td,_.td+=this._localTb*u.tc))}else this._renderContext=this._worldContext;this._updateTreeOrder=this.ctx.updateTreeOrder++,this._recalc&=135,this._useRenderToTexture=this._renderToTextureEnabled&&this._texturizer.mustRenderToTexture(),this._useViewportClipping=!1,!this._useRenderToTexture&&this._clipping&&(this._renderContext.isSquare()?this._useViewportClipping=!0:this._useRenderToTexture=!0);var c;if(this._useRenderToTexture&&(c=this._renderContext,this._renderContext=this._worldContext.isIdentity()?this._worldContext:ViewCoreContext.IDENTITY),this._children)for(var x=0,h=this._children.length;x<h;x++)this._recalc||this._children[x]._hasUpdates?this._children[x].update():0<this.ctx.updateTreeOrderForceUpdate&&this._children[x].updateTreeOrder();this._useRenderToTexture&&(this._renderContext=c),this._recalc=0,this._hasUpdates=!1,this._zSort&&this.ctx.updateTreeOrderForceUpdate--}else 0<this.ctx.updateTreeOrderForceUpdate&&this.updateTreeOrder()}},{key:'updateTreeOrder',value:function updateTreeOrder(){if(this._zSort&&this.ctx.updateTreeOrderForceUpdate++,this._updateTreeOrder=this.ctx.updateTreeOrder++,this._children)for(var e,o=0,s=this._children.length;o<s;o++)e=this._children[o]._zSort,e&&this.ctx.updateTreeOrderForceUpdate--,this._children[o].updateTreeOrder(),e&&this.ctx.updateTreeOrderForceUpdate--;this._zSort&&this.ctx.updateTreeOrderForceUpdate--}},{key:'_renderSimple',value:function _renderSimple(){if(this._zSort&&(this.sortZIndexedChildren(),this._zSort=!1),this._renderContext.alpha){var e=this.renderState;if(e.setShader(this.activeShader,this._shaderOwner),this._displayedTextureSource&&this.addQuads(),this._children)if(this._zContextUsage)for(var o=0,s=this._zIndexedChildren.length;o<s;o++)this._zIndexedChildren[o].render();else for(var n=0,l=this._children.length;n<l;n++)0===this._children[n]._zIndex&&this._children[n].render();this._hasRenderUpdates=0}}},{key:'_renderAdvanced',value:function _renderAdvanced(){if(this._zSort&&(this.sortZIndexedChildren(),this._zSort=!1),this._renderContext.alpha){var e=this.renderState;e.setShader(this.activeShader,this._shaderOwner);var s,l,d,_=!0;if(this._useRenderToTexture){if(0===this._rw||0===this._rh)return void(this._hasRenderUpdates=0);if(this._texturizer.hasRenderTexture()&&!(3<=this._hasRenderUpdates))_=!1;else if(e.setShader(e.defaultShader,this),l=e.renderTextureInfo,s={glTexture:null,offset:0,w:this._rw,h:this._rh,empty:!0,cleared:!1,ignore:!1},e.setRenderTextureInfo(s),this._displayedTextureSource){var u=this._renderContext;this._renderContext=ViewCoreContext.IDENTITY,this.addQuads(),this._renderContext=u}}else{if(this._useViewportClipping){var c=o(this._renderContext.px),x=o(this._renderContext.py),y=o(this._renderContext.ta*this._rw),f=o(this._renderContext.td*this._rh);d=e.getScissor(),e.setScissor([c,x,y,f])}this._displayedTextureSource&&this.addQuads()}if(_&&this._children)if(this._zContextUsage)for(var h=0,T=this._zIndexedChildren.length;h<T;h++)this._zIndexedChildren[h].render();else for(var n=0,S=this._children.length;n<S;n++)0===this._children[n]._zIndex&&this._children[n].render();if(this._useRenderToTexture){var C=!1;if(_){if(s.glTexture){var k=e.quads.floats,w=e.quads.uints,R=s.offset/4,E=0===k[R]&&0===k[R+1]&&0===w[R+2]&&4294967295===w[R+3]&&k[R+4]===s.w&&0===k[R+5]&&65535===w[R+6]&&4294967295===w[R+7]&&k[R+8]===s.w&&k[R+9]===s.h&&4294967295===w[R+10]&&4294967295===w[R+11]&&0===k[R+12]&&k[R+13]===s.h&&4294901760===w[R+14]&&4294967295===w[R+15];E||(s.glTexture=null)}s.empty||(s.glTexture?(this._texturizer.reuseTextureAsRenderTexture(s.glTexture),s.ignore=!0):(this._texturizer.renderTextureReused&&this._texturizer.releaseRenderTexture(),s.glTexture=this._texturizer.getRenderTexture())),e.setRenderTextureInfo(l),C=!0}var P=this._texturizer._hasActiveFilters();P&&(2<=this._hasRenderUpdates||!this._texturizer.filterResultCached)&&(this.applyFilters(),C=!0);var A=this._texturizer.getResultTexture();C&&this._texturizer.updateResultTexture(),_&&s.empty||this._texturizer.hideResult||(e.setShader(this.activeShader,this._shaderOwner),e.setOverrideQuadTexture(A),this._stashTexCoords(),!this._texturizer.colorize&&this._stashColors(),this.addQuads(),!this._texturizer.colorize&&this._unstashColors(),this._unstashTexCoords(),e.setOverrideQuadTexture(null))}else this._useViewportClipping&&e.setScissor(d);this._hasRenderUpdates=0}}},{key:'applyFilters',value:function applyFilters(){var e=this._texturizer.getRenderTexture(),o=this.renderState,n=this._texturizer.getActiveFilters(),l=n.length;if(this._texturizer.filterResultCached=!1,0===l)return e;if(1===l){var d=this._texturizer.getFilterTexture();o.addFilter(n[0],this,e,d),this._texturizer.filterResultCached=!0}else{for(var _=this._texturizer.getFilterTexture(),u=this.ctx.allocateRenderTexture(s(2048,this._rw),s(2048,this._rh)),c=u,x=_,h=0;h<l;h++){if(0!==h||0==l%2){var y=c;c=x,x=y}o.addFilter(n[h],this,0===h?e:c,x)}this.ctx.releaseRenderTexture(intermediate),this._texturizer.filterResultCached=!0}}},{key:'sortZIndexedChildren',value:function sortZIndexedChildren(){for(var e=1,o=this._zIndexedChildren.length;e<o;e++){for(var s,n=this._zIndexedChildren[e],l=e-1;0<=l&&(s=this._zIndexedChildren[l],n._zIndex===s._zIndex?!!(n._updateTreeOrder<s._updateTreeOrder):!!(n._zIndex<s._zIndex));)this._zIndexedChildren[l+1]=this._zIndexedChildren[l],l--;this._zIndexedChildren[j+1]=a}}},{key:'addQuads',value:function addQuads(){var e=this._renderContext,o=this.renderState.quads.floats,s=this.renderState.quads.uints;if(0!==e.tb||0!==this.tb){var n=this.renderState.addQuad(this)/4;o[n++]=e.px,o[n++]=e.py,s[n++]=this._txCoordsUl,s[n++]=getColorInt(this._colorUl,e.alpha),o[n++]=e.px+this._rw*e.ta,o[n++]=e.py+this._rw*e.tc,s[n++]=this._txCoordsUr,s[n++]=getColorInt(this._colorUr,e.alpha),o[n++]=e.px+this._rw*e.ta+this._rh*e.tb,o[n++]=e.py+this._rw*e.tc+this._rh*e.td,s[n++]=this._txCoordsBr,s[n++]=getColorInt(this._colorBr,e.alpha),o[n++]=e.px+this._rh*e.tb,o[n++]=e.py+this._rh*e.td,s[n++]=this._txCoordsBl,s[n]=getColorInt(this._colorBl,e.alpha)}else{var l=e.px+this._rw*e.ta,d=e.py+this._rh*e.td,_=this.renderState.addQuad(this)/4;o[_++]=e.px,o[_++]=e.py,s[_++]=this._txCoordsUl,s[_++]=getColorInt(this._colorUl,e.alpha),o[_++]=l,o[_++]=e.py,s[_++]=this._txCoordsUr,s[_++]=getColorInt(this._colorUr,e.alpha),o[_++]=l,o[_++]=d,s[_++]=this._txCoordsBr,s[_++]=getColorInt(this._colorBr,e.alpha),o[_++]=e.px,o[_++]=d,s[_++]=this._txCoordsBl,s[_]=getColorInt(this._colorBl,e.alpha)}}},{key:'getCornerPoints',value:function getCornerPoints(){var e=this._worldContext;return[e.px,e.py,e.px+this._rw*e.ta,e.py+this._rw*e.tc,e.px+this._rw*e.ta+this._rh*this.tb,e.py+this._rw*e.tc+this._rh*this.td,e.px+this._rh*this.tb,e.py+this._rh*this.td]}},{key:'getRenderTextureCoords',value:function getRenderTextureCoords(e,o){var s=this._renderContext;return[s.px+s.ta*e+s.tb*o,s.py+s.tc*e+s.td*o]}},{key:'getAbsoluteCoords',value:function getAbsoluteCoords(e,o){var s=this._renderContext;return[s.px+s.ta*e+s.tb*o,s.py+s.tc*e+s.td*o]}},{key:'zIndex',get:function get(){return this._zIndex},set:function set(e){if(this._zIndex!==e){this.setHasRenderUpdates(1);var o=this._zParent,s=this.isZContext();0===e&&0!==this._zIndex?this._parent===this._zParent?this._zParent.decZContextUsage():o=this._parent:0!==e&&0===this._zIndex?(o=this._parent?this._parent.findZContext():null,o===this._zParent&&this._zParent&&(this._zParent.incZContextUsage(),this._zParent._zSort=!0)):e!==this._zIndex&&(this._zParent._zSort=!0),o!==this._zParent&&this.setZParent(null),this._zIndex=e,o!==this._zParent&&this.setZParent(o),s!==this.isZContext()&&(this.isZContext()?this.enableZContext(this._parent.findZContext()):this.disableZContext())}}},{key:'forceZIndexContext',get:function get(){return this._forceZIndexContext},set:function set(e){this.setHasRenderUpdates(1);var o=this.isZContext();this._forceZIndexContext=e,o!==this.isZContext()&&(this.isZContext()?this.enableZContext(this._parent.findZContext()):this.disableZContext())}},{key:'colorUl',get:function get(){return this._colorUl},set:function set(e){this._colorUl!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorUl=e)}},{key:'colorUr',get:function get(){return this._colorUr},set:function set(e){this._colorUr!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorUr=e)}},{key:'colorBl',get:function get(){return this._colorBl},set:function set(e){this._colorBl!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorBl=e)}},{key:'colorBr',get:function get(){return this._colorBr},set:function set(e){this._colorBr!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorBr=e)}},{key:'visitEntry',set:function set(e){this._visitEntry=e}},{key:'visitExit',set:function set(e){this._visitExit=e}},{key:'shader',get:function get(){return this._shader},set:function set(e){this.setHasRenderUpdates(1);var o=this._shader;if(this._shader=e,!e&&o){var s=this._parent&&!this._parent._renderToTextureEnabled?this._parent._shaderOwner:null;this._setShaderOwnerRecursive(s)}else this._setShaderOwnerRecursive(this);o&&o.removeView(this),this._shader&&this._shader.addView(this)}},{key:'activeShader',get:function get(){return this._shaderOwner?this._shaderOwner.shader:this.renderState.defaultShader}},{key:'activeShaderOwner',get:function get(){return this._shaderOwner}},{key:'clipping',get:function get(){return this._clipping},set:function set(e){this._clipping=e,this.updateRenderToTextureEnabled()}},{key:'localTa',get:function get(){return this._localTa}},{key:'localTb',get:function get(){return this._localTb}},{key:'localTc',get:function get(){return this._localTc}},{key:'localTd',get:function get(){return this._localTd}},{key:'rw',get:function get(){return this._rw}},{key:'rh',get:function get(){return this._rh}},{key:'view',get:function get(){return this._view}},{key:'renderUpdates',get:function get(){return this._hasRenderUpdates}},{key:'texturizer',get:function get(){return this._texturizer||(this._texturizer=new ViewTexturizer(this)),this._texturizer}}]),e}(),getColorInt=function(e,o){var s=0|(0|e/16777216)*o;return(255&(255&e>>16)*s/255)+(65280&(65280&e)*s/255)+(16711680&((255&e)<<16)*s/255)+(s<<24)},ViewCoreContext=function(){function e(){_classCallCheck(this,e),this.alpha=1,this.px=0,this.py=0,this.ta=1,this.tb=0,this.tc=0,this.td=1}return _createClass(e,[{key:'isIdentity',value:function isIdentity(){return 1===this.alpha&&0===this.px&&0===this.py&&1===this.ta&&0===this.tb&&0===this.tc&&1===this.td}},{key:'isSquare',value:function isSquare(){return 0===this.tb&&0===this.tc}}]),e}();ViewCoreContext.IDENTITY=new ViewCoreContext;var CoreContext=function(){function e(o){_classCallCheck(this,e),this.stage=o,this.gl=o.gl,this.root=null,this.updateTreeOrder=0,this.updateTreeOrderForceUpdate=0,this.shaderPrograms=new Map,this.renderState=new CoreRenderState(this),this.renderExec=new CoreRenderExecutor(this),this.renderExec.init(),this._renderTexturePool=[],this._renderTexturePoolPixels=0,this._renderTextureId=1}var o=Math.round;return _createClass(e,[{key:'destroy',value:function destroy(){var e=this;this.shaderPrograms.forEach(function(e){return e.destroy()}),this._renderTexturePool.forEach(function(o){return e._freeRenderTexture(o)})}},{key:'visit',value:function visit(){this.root.visit()}},{key:'frame',value:function frame(){return!!this.root._parent._hasRenderUpdates&&(this.visit(),this.update(),this.render(),this.root._parent._hasRenderUpdates=!1,this._freeUnusedRenderTextures(6e3),!0)}},{key:'update',value:function update(){this.updateTreeOrderForceUpdate=0,this.updateTreeOrder=0,this.root.update()}},{key:'render',value:function render(){this.renderState.reset(),this.root.render(),this.renderState.finish(),this.renderExec.execute()}},{key:'allocateRenderTexture',value:function allocateRenderTexture(e,s){e=o(e),s=o(s);for(var d,_=0,u=this._renderTexturePool.length;_<u;_++)if(d=this._renderTexturePool[_],d.w===e&&d.h===s)return d.f=this.stage.frameCounter,this._renderTexturePool.splice(_,1),d;var l=this._createRenderTexture(e,s);return l.f=this.stage.frameCounter,l}},{key:'releaseRenderTexture',value:function releaseRenderTexture(e){this._renderTexturePool.push(e)}},{key:'_freeUnusedRenderTextures',value:function _freeUnusedRenderTextures(){var e=this,o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:60,s=this.stage.frameCounter-o;this._renderTexturePool=this._renderTexturePool.filter(function(o){return!(o.f<s)||(e._freeRenderTexture(o),e._renderTexturePoolPixels-=o.w*o.h,!1)})}},{key:'_createRenderTexture',value:function _createRenderTexture(e,o){this._renderTexturePoolPixels>this.stage.options.renderTexturePoolPixels&&(this._freeUnusedRenderTextures(),this._renderTexturePoolPixels>this.stage.options.renderTexturePoolPixels&&console.warn('Render texture pool overflow: '+this._renderTexturePoolPixels+'px'));var s=this.gl,n=s.createTexture();return s.bindTexture(s.TEXTURE_2D,n),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,e,o,0,s.RGBA,s.UNSIGNED_BYTE,null),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),n.framebuffer=s.createFramebuffer(),n.w=e,n.h=o,n.id=this._renderTextureId++,n.projection=new Float32Array([2/e,2/o]),s.bindFramebuffer(s.FRAMEBUFFER,n.framebuffer),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,n,0),n}},{key:'_freeRenderTexture',value:function _freeRenderTexture(e){var o=this.stage.gl;this._renderTexturePoolPixels-=e.w*e.h,o.deleteFramebuffer(e.framebuffer),o.deleteTexture(e)}}]),e}(),CoreRenderState=function(){function e(o){_classCallCheck(this,e),this.ctx=o,this.stage=o.stage,this.textureAtlasGlTexture=this.stage.textureAtlas?this.stage.textureAtlas.texture:null,this.quads=new CoreQuadList(o,8e6),this.defaultShader=new Shader(this.ctx)}var o=Math.max,s=Math.min;return _createClass(e,[{key:'reset',value:function reset(){this._renderTextureInfo=null,this._scissor=null,this._shader=null,this._shaderOwner=null,this._realShader=null,this._check=!1,this.quadOperations=[],this.filterOperations=[],this._overrideQuadTexture=null,this._quadOperation=null,this.quads.reset()}},{key:'setShader',value:function setShader(e,o){(this._shaderOwner!==o||this._realShader!==e)&&(this._realShader=e,e.useDefault()&&(e=this.defaultShader),(this._shader!==e||this._shaderOwner!==o)&&(this._shader=e,this._shaderOwner=o,this._check=!0))}},{key:'setScissor',value:function setScissor(e){if(!e)this._scissor=null;else if(this._scissor){var n=o(e[0],this._scissor[0]),l=o(e[1],this._scissor[1]),d=s(e[0]+e[2],this._scissor[0]+this._scissor[2]),_=s(e[1]+e[3],this._scissor[1]+this._scissor[3]);this._scissor=[n,l,d-n,_-l]}else this._scissor=e;this._check=!0}},{key:'getScissor',value:function getScissor(){return this._scissor}},{key:'setRenderTextureInfo',value:function setRenderTextureInfo(e){this._renderTextureInfo!==e&&(this._renderTextureInfo=e,this._scissor=null,this._check=!0)}},{key:'setOverrideQuadTexture',value:function setOverrideQuadTexture(e){this._overrideQuadTexture=e}},{key:'addQuad',value:function addQuad(e){this._quadOperation?this._check&&this._hasChanges()&&(this._addQuadOperation(),this._check=!1):this._createQuadOperation();var o=this._overrideQuadTexture;o||(e.inTextureAtlas?o=this.textureAtlasGlTexture:o=e._displayedTextureSource.glTexture);var s=64*this.length+64;return this._renderTextureInfo&&(this._shader===this.defaultShader&&this._renderTextureInfo.empty&&this._renderTextureInfo.w===o.w&&this._renderTextureInfo.h===o.h?(this._renderTextureInfo.glTexture=o,this._renderTextureInfo.offset=s):this._renderTextureInfo.glTexture=null,this._renderTextureInfo.empty=!1),this.quads.quadTextures.push(o),this.quads.quadViews.push(e),this._quadOperation.length++,s}},{key:'_hasChanges',value:function _hasChanges(){var e=this._quadOperation;return this._shader!==e.shader||this._shaderOwner!==e.shaderOwner||this._renderTextureInfo!==e.renderTextureInfo||this._scissor!==e.scissor}},{key:'_addQuadOperation',value:function _addQuadOperation(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!0;this._quadOperation&&((this._quadOperation.length||this._shader.addEmpty())&&this.quadOperations.push(this._quadOperation),this._quadOperation=null),e&&this._createQuadOperation()}},{key:'_createQuadOperation',value:function _createQuadOperation(){this._quadOperation=new CoreQuadOperation(this.ctx,this._shader,this._shaderOwner,this._renderTextureInfo,this._scissor,this.length),this._check=!1}},{key:'addFilter',value:function addFilter(e,o,s,n){this._addQuadOperation(!1),this.filterOperations.push(new CoreFilterOperation(this.ctx,e,o,s,n,this.quadOperations.length))}},{key:'finish',value:function finish(){this.ctx.stage.textureAtlas&&this.ctx.stage.options.debugTextureAtlas&&this._renderDebugTextureAtlas(),this._quadOperation&&this._addQuadOperation(!1),this._setExtraShaderAttribs()}},{key:'_renderDebugTextureAtlas',value:function _renderDebugTextureAtlas(){this.setShader(this.defaultShader,this.ctx.root),this.setRenderTextureInfo(null),this.setOverrideQuadTexture(this.textureAtlasGlTexture);var e=s(this.ctx.stage.w,this.ctx.stage.h),o=this.addQuad(this.ctx.root)/4,n=this.quads.floats,l=this.quads.uints;n[o++]=0,n[o++]=0,l[o++]=0,l[o++]=4294967295,n[o++]=e,n[o++]=0,l[o++]=65535,l[o++]=4294967295,n[o++]=e,n[o++]=e,l[o++]=4294967295,l[o++]=4294967295,n[o++]=0,n[o++]=e,l[o++]=4294901760,l[o]=4294967295,this.setOverrideQuadTexture(null)}},{key:'_setExtraShaderAttribs',value:function _setExtraShaderAttribs(){for(var e=64*this.length+64,o=0,s=this.quadOperations.length;o<s;o++){this.quadOperations[o].extraAttribsDataByteOffset=e;var n=4*this.quadOperations[o].shader.getExtraAttribBytesPerVertex()*this.quadOperations[o].length;e+=n,n&&this.quadOperations[o].shader.setExtraAttribsInBuffer(this.quadOperations[o],this.quads)}this.quads.dataLength=offset}},{key:'length',get:function get(){return this.quads.quadTextures.length}},{key:'renderTextureInfo',get:function get(){return this._renderTextureInfo}}]),e}(),CoreQuadList=function(){function e(o,s){_classCallCheck(this,e),this.ctx=o,this.textureAtlasGlTexture=this.ctx.textureAtlas?this.ctx.textureAtlas.texture:null,this.dataLength=0,this.data=new ArrayBuffer(s),this.floats=new Float32Array(this.data),this.uints=new Uint32Array(this.data),this.quadTextures=[],this.quadViews=[];var n=this.floats,l=this.uints;n[0]=-1,n[1]=-1,l[2]=0,l[3]=4294967295,n[4]=1,n[5]=-1,l[6]=65535,l[7]=4294967295,n[8]=1,n[9]=1,l[10]=4294967295,l[11]=4294967295,n[12]=-1,n[13]=1,l[14]=4294901760,l[15]=4294967295}return _createClass(e,[{key:'reset',value:function reset(){this.quadTextures=[],this.quadViews=[],this.dataLength=0}},{key:'getView',value:function getView(e){return this.quadViews[e]._view}},{key:'getViewCore',value:function getViewCore(e){return this.quadViews[e]}},{key:'getTexture',value:function getTexture(e){return this.quadTextures[e]}},{key:'getTextureWidth',value:function getTextureWidth(e){var o=this.quadTextures[e];return o.w?o.w:o===this.textureAtlasGlTexture?2048:this.quadViews[e]._displayedTextureSource.w}},{key:'getTextureHeight',value:function getTextureHeight(e){var o=this.quadTextures[e];return o.h?o.h:o===this.textureAtlasGlTexture?2048:this.quadViews[e]._displayedTextureSource.h}},{key:'getQuadContents',value:function getQuadContents(){for(var e,o=this.floats,s=this.uints,n=[],l=1;l<=this.length;l++){e='entry '+l+': ';for(var d,_=0;4>_;_++)d=16*l+4*_,e+=o[d]+','+o[d+1]+':'+s[d+2].toString(16)+'['+s[d+3].toString(16)+'] ';n.push(e)}return lines}},{key:'length',get:function get(){return this.quadTextures.length}}]),e}(),CoreQuadOperation=function(){function e(o,s,n,l,d,_){_classCallCheck(this,e),this.ctx=o,this.shader=s,this.shaderOwner=n,this.renderTextureInfo=l,this.scissor=d,this.index=_,this.length=0,this.extraAttribsDataByteOffset=0}return _createClass(e,[{key:'getTexture',value:function getTexture(e){return this.quads.getTexture(this.index+e)}},{key:'getViewCore',value:function getViewCore(e){return this.quads.getViewCore(this.index+e)}},{key:'getView',value:function getView(e){return this.quads.getView(this.index+e)}},{key:'getTextureWidth',value:function getTextureWidth(e){return this.quads.getTextureWidth(this.index+e)}},{key:'getTextureHeight',value:function getTextureHeight(e){return this.quads.getTextureHeight(this.index+e)}},{key:'getNormalRenderTextureCoords',value:function getNormalRenderTextureCoords(e,o){var s=this.shaderOwner.getRenderTextureCoords(e,o);return s[0]/=this.getRenderWidth(),s[1]/=this.getRenderHeight(),s[0]=2*s[0]-1,s[1]=1-2*s[1],s}},{key:'getRenderWidth',value:function getRenderWidth(){return this.renderTexture?this.renderTexture.w:this.ctx.stage.w}},{key:'getRenderHeight',value:function getRenderHeight(){return this.renderTexture?this.renderTexture.h:this.ctx.stage.h}},{key:'getProjection',value:function getProjection(){return null===this.renderTextureInfo?this.ctx.renderExec._projection:this.renderTextureInfo.glTexture.projection}},{key:'quads',get:function get(){return this.ctx.renderState.quads}}]),e}(),CoreFilterOperation=function(){function e(o,s,n,l,d,_){_classCallCheck(this,e),this.ctx=o,this.filter=s,this.owner=n,this.source=l,this.renderTexture=d,this.beforeQuadOperation=_}return _createClass(e,[{key:'getRenderWidth',value:function getRenderWidth(){return this.renderTexture?this.renderTexture.w:this.ctx.stage.w}},{key:'getRenderHeight',value:function getRenderHeight(){return this.renderTexture?this.renderTexture.h:this.ctx.stage.h}}]),e}(),CoreRenderExecutor=function(){function e(o){_classCallCheck(this,e),this.ctx=o,this.renderState=o.renderState,this.gl=this.ctx.stage.gl,this.init()}return _createClass(e,[{key:'init',value:function init(){var e=this.gl;this._attribsBuffer=e.createBuffer();for(var o=Math.floor(this.renderState.quads.data.byteLength/64),s=new Uint16Array(6*o),n=0,l=0;n<o;n+=6,l+=4)s[n]=l,s[n+1]=l+1,s[n+2]=l+2,s[n+3]=l,s[n+4]=l+2,s[n+5]=l+3;this._quadsBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._quadsBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,allIndices,e.STATIC_DRAW),this._projection=new Float32Array([2/this.ctx.stage.rw,-2/this.ctx.stage.rh])}},{key:'destroy',value:function destroy(){this.gl.deleteBuffer(this._attribsBuffer),this.gl.deleteBuffer(this._quadsBuffer)}},{key:'_reset',value:function _reset(){this._bindRenderTexture(null),this._setScissor(null),this._clearRenderTexture();var e=this.gl;e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND),e.disable(e.DEPTH_TEST),this._quadOperation=null,this._currentShaderProgramOwner=null}},{key:'_setupBuffers',value:function _setupBuffers(){var e=this.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._quadsBuffer);var o=new DataView(this.renderState.quads.data,0,this.renderState.quads.dataLength);e.bindBuffer(e.ARRAY_BUFFER,this._attribsBuffer),e.bufferData(e.ARRAY_BUFFER,o,e.DYNAMIC_DRAW)}},{key:'execute',value:function execute(){this._reset(),this._setupBuffers();for(var e=this.renderState.quadOperations,o=this.renderState.filterOperations,s=0,l=0,d=e.length,n=o.length;s<d;){for(;l<n&&s===o[l].beforeQuadOperation;)this._quadOperation&&this._execQuadOperation(this._quadOperation),this._execFilterOperation(o[l]),l++;this._processQuadOperation(e[s]),s++}for(this._quadOperation&&this._execQuadOperation();j<m;)this._execFilterOperation(fops[j]),j++;this._stopShaderProgram()}},{key:'getQuadContents',value:function getQuadContents(){return this.renderState.quads.getQuadContents()}},{key:'_mergeQuadOperation',value:function _mergeQuadOperation(e){this._quadOperation&&(this._quadOperation.length+=e.length,this._quadOperation.shaderOwner=null)}},{key:'_processQuadOperation',value:function _processQuadOperation(e){if(!(e.renderTextureInfo&&e.renderTextureInfo.ignore)){var o=e.shader,s=!1;this._quadOperation&&this._quadOperation.renderTextureInfo===e.renderTextureInfo&&this._quadOperation.scissor===e.scissor&&this._quadOperation.shader.supportsMerging()&&e.shader.supportsMerging()&&(this._quadOperation.shader===o?(this._mergeQuadOperation(e),s=!0):o.hasSameProgram(this._quadOperation.shader)&&(o.setupUniforms(e),o.isMergable(this._quadOperation.shader)&&(this._mergeQuadOperation(e),s=!0))),s||(this._quadOperation&&this._execQuadOperation(),o.setupUniforms(e),this._quadOperation=e)}}},{key:'_execQuadOperation',value:function _execQuadOperation(){var e=this._quadOperation,o=e.shader;if(e.length||o.addEmpty()){var s=e.renderTextureInfo?e.renderTextureInfo.glTexture:null;this._renderTexture!==s&&this._bindRenderTexture(s),this._setScissor(e.scissor),e.renderTextureInfo&&!e.renderTextureInfo.cleared&&(this._clearRenderTexture(),e.renderTextureInfo.cleared=!0),this._useShaderProgram(o),o.commitUniformUpdates(),o.beforeDraw(e),o.draw(e),o.afterDraw(e)}this._quadOperation=null}},{key:'_execFilterOperation',value:function _execFilterOperation(e){var o=e.filter;this._useShaderProgram(o),o.setupUniforms(e),o.commitUniformUpdates(),o.beforeDraw(e),this._bindRenderTexture(e.renderTexture),this._clearRenderTexture(),this._setScissor(null),o.draw(e),o.afterDraw(e)}},{key:'_useShaderProgram',value:function _useShaderProgram(e){e.hasSameProgram(this._currentShaderProgramOwner)||(this._currentShaderProgramOwner&&this._currentShaderProgramOwner.stopProgram(),e.useProgram(),this._currentShaderProgramOwner=e)}},{key:'_stopShaderProgram',value:function _stopShaderProgram(){this._currentShaderProgramOwner&&(this._currentShaderProgramOwner.stopProgram(),this._currentShaderProgramOwner=null)}},{key:'_bindRenderTexture',value:function _bindRenderTexture(e){this._renderTexture=e;var o=this.gl;this._renderTexture?(o.bindFramebuffer(o.FRAMEBUFFER,this._renderTexture.framebuffer),o.viewport(0,0,this._renderTexture.w,this._renderTexture.h)):(o.bindFramebuffer(o.FRAMEBUFFER,null),o.viewport(0,0,this.ctx.stage.w,this.ctx.stage.h))}},{key:'_clearRenderTexture',value:function _clearRenderTexture(){var e=this.gl;if(!this._renderTexture){var o=this.ctx.stage.options.glClearColor;e.clearColor(o[0],o[1],o[2],o[3]),e.clear(e.COLOR_BUFFER_BIT)}else e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT)}},{key:'_setScissor',value:function _setScissor(e){if(this._scissor!==e){var o=this.gl;e?(o.enable(o.SCISSOR_TEST),null===this._renderTexture&&(e[1]=this.ctx.stage.h-(e[1]+e[3])),o.scissor(e[0],e[1],e[2],e[3])):o.disable(o.SCISSOR_TEST),this._scissor=e}}}]),e}(),ViewText=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return s.view=e,s.settings=new TextRendererSettings,s.settings.on('change',function(){s.updateTexture()}),s}return _inherits(o,e),_createClass(o,[{key:'_properties',value:function _properties(){this.updatingTexture=null}},{key:'updateTexture',value:function updateTexture(){var e=this;return''==this.settings.text?void(this.view.texture=null):void(this.updatingTexture||(this.updatingTexture=!0,this.view.texture=this.view.stage.texture(function(o,s,n){e.updatingTexture=!1,o(null,null);var l=e.getFinalizedSettings(),d=e.createTextureSource(l);e.view.texture.precision=l.precision,d.load(n||l.sync),e.view.texture.replaceTextureSource(d)})))}},{key:'getFinalizedSettings',value:function getFinalizedSettings(){var e=this.settings.clone();return e.finalize(this.view),e}},{key:'createTextureSource',value:function createTextureSource(e){var o=this.view.stage.textureManager;return this.view.stage.textureManager.getTextureSource(function loadCb(s,n,l){o.loadTextTexture(e,n,l,s)},e.getTextureId())}}]),o}(Base),TextRenderer=function(){function e(o,s){_classCallCheck(this,e),this._canvas=o,this._context=this._canvas.getContext('2d'),this._settings=s}var o=Math.max,s=Math.min,n=Math.ceil;return _createClass(e,[{key:'getPrecision',value:function getPrecision(){return this._settings.precision}},{key:'setFontProperties',value:function setFontProperties(e){var o=this._settings.fontFace,s='"'+(Array.isArray(o)?this._settings.fontFace.join('","'):o)+'"',n=e?this.getPrecision():1;this._context.font=this._settings.fontStyle+' '+this._settings.fontSize*n+'px '+s,this._context.textBaseline=this._settings.textBaseline}},{key:'draw',value:function draw(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],l={};this.setFontProperties(!1);var d=this._settings.w||2048/this.getPrecision(),_=d-(this._settings.paddingLeft+this._settings.paddingRight);10>_&&(d+=10-_,_+=10-_);var u,c=this._settings.wordWrapWidth||_;if(this._settings.wordWrap)u=this.wrapText(this._settings.text,c);else{u={l:this._settings.text.split(/(?:\r\n|\r|\n)/),n:[]};for(var C=u.l.length,k=0;k<C-1;k++)u.n.push(k)}var x=u.l;if(this._settings.maxLines&&x.length>this._settings.maxLines){var w=x.slice(0,this._settings.maxLines),R=null;if(this._settings.maxLinesSuffix){var E=this.wrapText(w[w.length-1]+this._settings.maxLinesSuffix,c);w[w.length-1]=E.l[0],R=[1<E.l.length?E.l[1]:'']}else R=[''];var P,A=x.length,O=0,L=u.n.length;for(P=this._settings.maxLines;P<A;P++)R[O]+=(R[O]?' ':'')+x[P],P+1<L&&u.n[P+1]&&O++;l.remainingText=R.join('\n'),l.moreTextLines=!0,x=w}else l.moreTextLines=!1,l.remainingText='';for(var U,z=0,I=[],F=0;F<x.length;F++)U=this._context.measureText(x[F]).width,I.push(U),z=o(z,U);l.lineWidths=lineWidths,this._settings.w||(d=maxLineWidth+this._settings.paddingLeft+this._settings.paddingRight,_=maxLineWidth);var h,y=this._settings.lineHeight||this._settings.fontSize;h=this._settings.h?this._settings.h:y*(x.length-1)+0.5*this._settings.fontSize+o(y,this._settings.fontSize)+this._settings.offsetY;var f=null===this._settings.offsetY?this._settings.fontSize:this._settings.offsetY,T=this.getPrecision();if(l.w=d*T,l.h=h*T,l.lines=x,l.precision=T,!e){d||(d=1),h||(h=1),(this._settings.cutSx||this._settings.cutEx)&&(d=s(d,this._settings.cutEx-this._settings.cutSx)),(this._settings.cutSy||this._settings.cutEy)&&(h=s(h,this._settings.cutEy-this._settings.cutSy)),this._canvas.width=n(d*T),this._canvas.height=n(h*T),this.setFontProperties(!0),(this._settings.cutSx||this._settings.cutSy)&&this._context.translate(-(this._settings.cutSx*T),-(this._settings.cutSy*T));for(var D=void 0,B=void 0,V=[],N=0,M=x.length;N<M;N++)D=0,B=N*y+f,'right'===this._settings.textAlign?D+=_-lineWidths[N]:'center'===this._settings.textAlign&&(D+=(_-lineWidths[N])/2),D+=this._settings.paddingLeft,V.push({text:x[N],x:D*T,y:B*T,w:lineWidths[N]*T});if(this._settings.highlight){var X=this._settings.highlightColor||0,W=this._settings.highlightHeight||1.5*this._settings.fontSize,H=null===this._settings.highlightOffset?-0.5*this._settings.fontSize:this._settings.highlightOffset,Y=null===this._settings.highlightPaddingLeft?this._settings.paddingLeft:this._settings.highlightPaddingLeft,G=null===this._settings.highlightPaddingRight?this._settings.paddingRight:this._settings.highlightPaddingRight;for(this._context.fillStyle=StageUtils.getRgbaString(X),i=0;i<drawLines.length;i++){var q=drawLines[i];this._context.fillRect((q.x-Y)*T,(q.y+H)*T,(q.w+G+Y)*T,W*T)}}var Z=null;this._settings.shadow&&(Z=[this._context.shadowColor,this._context.shadowOffsetX,this._context.shadowOffsetY,this._context.shadowBlur],this._context.shadowColor=StageUtils.getRgbaString(this._settings.shadowColor),this._context.shadowOffsetX=this._settings.shadowOffsetX*T,this._context.shadowOffsetY=this._settings.shadowOffsetY*T,this._context.shadowBlur=this._settings.shadowBlur*T),this._context.fillStyle=StageUtils.getRgbaString(this._settings.textColor);for(var Q,K=0,$=drawLines.length;K<$;K++)Q=drawLines[K],this._context.fillText(Q.text,Q.x,Q.y);Z&&(this._context.shadowColor=Z[0],this._context.shadowOffsetX=Z[1],this._context.shadowOffsetY=Z[2],this._context.shadowBlur=Z[3]),(this._settings.cutSx||this._settings.cutSy)&&this._context.translate(this._settings.cutSx,this._settings.cutSy)}var S=this._canvas;return{renderInfo:l,canvas:S}}},{key:'wrapText',value:function wrapText(e,o){for(var s=e.split(/\r?\n/g),n=[],l=[],d=0;d<s.length;d++){for(var _=[],u='',c=o,x=s[d].split(' '),h=0;h<x.length;h++){var y=this._context.measureText(x[h]).width,f=y+this._context.measureText(' ').width;0===h||f>c?(0<h&&(_.push(u),u=''),u+=x[h],c=o-y):(c-=f,u+=' '+x[h])}result&&(resultLines.push(result),result=''),n=n.concat(resultLines),d<s.length-1&&l.push(n.length)}return{l:allLines,n:realNewlines}}}]),e}(),TextRendererSettings=function(e){function o(){_classCallCheck(this,o);var e=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return EventEmitter.call(e),e}return _inherits(o,e),_createClass(o,[{key:'_properties',value:function _properties(){this._text='',this._w=0,this._h=0,this._fontStyle='normal',this._fontSize=40,this._fontFace=null,this._wordWrap=!0,this._wordWrapWidth=0,this._lineHeight=null,this._textBaseline='alphabetic',this._textAlign='left',this._offsetY=null,this._maxLines=0,this._maxLinesSuffix='..',this._precision=null,this._textColor=4294967295,this._paddingLeft=0,this._paddingRight=0,this._shadow=!1,this._shadowColor=4278190080,this._shadowOffsetX=0,this._shadowOffsetY=0,this._shadowBlur=5,this._highlight=!1,this._highlightHeight=0,this._highlightColor=4278190080,this._highlightOffset=0,this._highlightPaddingLeft=0,this._highlightPaddingRight=0,this._cutSx=0,this._cutEx=0,this._cutSy=0,this._cutEy=0,this.sync=!1}},{key:'finalize',value:function finalize(e){!this.w&&e.w&&(this.w=e.w),!this.h&&e.h&&(this.h=e.h),null===this.fontFace&&(this.fontFace=e.stage.options.defaultFontFace),null===this.precision&&(this.precision=e.stage.options.defaultPrecision)}},{key:'getTextureId',value:function getTextureId(){var e=[];0!==this.w&&e.push('w '+this.w),0!==this.h&&e.push('h '+this.h),'normal'!==this.fontStyle&&e.push('fS'+this.fontStyle),40!==this.fontSize&&e.push('fs'+this.fontSize),null!==this.fontFace&&e.push('ff'+(Array.isArray(this.fontFace)?this.fontFace.join(','):this.fontFace)),!0!==this.wordWrap&&e.push('wr'+(this.wordWrap?1:0)),0!==this.wordWrapWidth&&e.push('ww'+this.wordWrapWidth),null!==this.lineHeight&&e.push('lh'+this.lineHeight),'alphabetic'!==this.textBaseline&&e.push('tb'+this.textBaseline),'left'!==this.textAlign&&e.push('ta'+this.textAlign),null!==this.offsetY&&e.push('oy'+this.offsetY),0!==this.maxLines&&e.push('ml'+this.maxLines),'..'!==this.maxLinesSuffix&&e.push('ms'+this.maxLinesSuffix),null!==this.precision&&e.push('pc'+this.precision),4294967295!==this.textColor&&e.push('co'+this.textColor.toString(16)),0!==this.paddingLeft&&e.push('pl'+this.paddingLeft),0!==this.paddingRight&&e.push('pr'+this.paddingRight),!1!==this.shadow&&e.push('sh'+(this.shadow?1:0)),4278190080!==this.shadowColor&&e.push('sc'+this.shadowColor.toString(16)),0!==this.shadowOffsetX&&e.push('sx'+this.shadowOffsetX),0!==this.shadowOffsetY&&e.push('sy'+this.shadowOffsetY),5!==this.shadowBlur&&e.push('sb'+this.shadowBlur),!1!==this.highlight&&e.push('hL'+(this.highlight?1:0)),0!==this.highlightHeight&&e.push('hh'+this.highlightHeight),4278190080!==this.highlightColor&&e.push('hc'+this.highlightColor.toString(16)),null!==this.highlightOffset&&e.push('ho'+this.highlightOffset),null!==this.highlightPaddingLeft&&e.push('hl'+this.highlightPaddingLeft),null!==this.highlightPaddingRight&&e.push('hr'+this.highlightPaddingRight),this.cutSx&&e.push('csx'+this.cutSx),this.cutEx&&e.push('cex'+this.cutEx),this.cutSy&&e.push('csy'+this.cutSy),this.cutEy&&e.push('cey'+this.cutEy),this.sync&&e.push('sync');var o='TX$'+e.join('|')+':'+this.text;return o}},{key:'getNonDefaults',value:function getNonDefaults(){var e={};return''!==this.text&&(e.text=this.text),0!==this.w&&(e.w=this.w),0!==this.h&&(e.h=this.h),'normal'!==this.fontStyle&&(e.fontStyle=this.fontStyle),40!==this.fontSize&&(e.fontSize=this.fontSize),null!==this.fontFace&&(e.fontFace=this.fontFace),!0!==this.wordWrap&&(e.wordWrap=this.wordWrap),0!==this.wordWrapWidth&&(e.wordWrapWidth=this.wordWrapWidth),null!==this.lineHeight&&(e.lineHeight=this.lineHeight),'alphabetic'!==this.textBaseline&&(e.textBaseline=this.textBaseline),'left'!==this.textAlign&&(e.textAlign=this.textAlign),null!==this.offsetY&&(e.offsetY=this.offsetY),0!==this.maxLines&&(e.maxLines=this.maxLines),'..'!==this.maxLinesSuffix&&(e.maxLinesSuffix=this.maxLinesSuffix),null!==this.precision&&(e.precision=this.precision),4294967295!==this.textColor&&(e.textColor=this.textColor),0!==this.paddingLeft&&(e.paddingLeft=this.paddingLeft),0!==this.paddingRight&&(e.paddingRight=this.paddingRight),!1!==this.shadow&&(e.shadow=this.shadow),4278190080!==this.shadowColor&&(e.shadowColor=this.shadowColor),0!==this.shadowOffsetX&&(e.shadowOffsetX=this.shadowOffsetX),0!==this.shadowOffsetY&&(e.shadowOffsetY=this.shadowOffsetY),5!==this.shadowBlur&&(e.shadowBlur=this.shadowBlur),!1!==this.highlight&&(e.highlight=this.highlight),0!==this.highlightHeight&&(e.highlightHeight=this.highlightHeight),4278190080!==this.highlightColor&&(e.highlightColor=this.highlightColor),null!==this.highlightOffset&&(e.highlightOffset=this.highlightOffset),null!==this.highlightPaddingLeft&&(e.highlightPaddingLeft=this.highlightPaddingLeft),null!==this.highlightPaddingRight&&(e.highlightPaddingRight=this.highlightPaddingRight),this.cutSx&&(e.cutSx=this.cutSx),this.cutEx&&(e.cutEx=this.cutEx),this.cutSy&&(e.cutSy=this.cutSy),this.cutEy&&(e.cutEy=this.cutEy),this.sync&&(e.sync=this.sync),e}},{key:'clone',value:function clone(){var e=new o;return e._text=this._text,e._w=this._w,e._h=this._h,e._fontStyle=this._fontStyle,e._fontSize=this._fontSize,e._fontFace=this._fontFace,e._wordWrap=this._wordWrap,e._wordWrapWidth=this._wordWrapWidth,e._lineHeight=this._lineHeight,e._textBaseline=this._textBaseline,e._textAlign=this._textAlign,e._offsetY=this._offsetY,e._maxLines=this._maxLines,e._maxLinesSuffix=this._maxLinesSuffix,e._precision=this._precision,e._textColor=this._textColor,e._paddingLeft=this._paddingLeft,e._paddingRight=this._paddingRight,e._shadow=this._shadow,e._shadowColor=this._shadowColor,e._shadowOffsetX=this._shadowOffsetX,e._shadowOffsetY=this._shadowOffsetY,e._shadowBlur=this._shadowBlur,e._highlight=this._highlight,e._highlightHeight=this._highlightHeight,e._highlightColor=this._highlightColor,e._highlightOffset=this._highlightOffset,e._highlightPaddingLeft=this._highlightPaddingLeft,e._highlightPaddingRight=this._highlightPaddingRight,e._cutSx=this._cutSx,e._cutEx=this._cutEx,e._cutSy=this._cutSy,e._cutEy=this._cutEy,e.sync=this.sync,e}},{key:'text',get:function get(){return this._text},set:function set(e){this._text!==e&&(this._text=e,this.emit('change'))}},{key:'w',get:function get(){return this._w},set:function set(e){this._w!==e&&(this._w=e,this.emit('change'))}},{key:'h',get:function get(){return this._h},set:function set(e){this._h!==e&&(this._h=e,this.emit('change'))}},{key:'fontStyle',get:function get(){return this._fontStyle},set:function set(e){this._fontStyle!==e&&(this._fontStyle=e,this.emit('change'))}},{key:'fontSize',get:function get(){return this._fontSize},set:function set(e){this._fontSize!==e&&(this._fontSize=e,this.emit('change'))}},{key:'fontFace',get:function get(){return this._fontFace},set:function set(e){this._fontFace!==e&&(this._fontFace=e,this.emit('change'))}},{key:'wordWrap',get:function get(){return this._wordWrap},set:function set(e){this._wordWrap!==e&&(this._wordWrap=e,this.emit('change'))}},{key:'wordWrapWidth',get:function get(){return this._wordWrapWidth},set:function set(e){this._wordWrapWidth!==e&&(this._wordWrapWidth=e,this.emit('change'))}},{key:'lineHeight',get:function get(){return this._lineHeight},set:function set(e){this._lineHeight!==e&&(this._lineHeight=e,this.emit('change'))}},{key:'textBaseline',get:function get(){return this._textBaseline},set:function set(e){this._textBaseline!==e&&(this._textBaseline=e,this.emit('change'))}},{key:'textAlign',get:function get(){return this._textAlign},set:function set(e){this._textAlign!==e&&(this._textAlign=e,this.emit('change'))}},{key:'offsetY',get:function get(){return this._offsetY},set:function set(e){this._offsetY!==e&&(this._offsetY=e,this.emit('change'))}},{key:'maxLines',get:function get(){return this._maxLines},set:function set(e){this._maxLines!==e&&(this._maxLines=e,this.emit('change'))}},{key:'maxLinesSuffix',get:function get(){return this._maxLinesSuffix},set:function set(e){this._maxLinesSuffix!==e&&(this._maxLinesSuffix=e,this.emit('change'))}},{key:'precision',get:function get(){return this._precision},set:function set(e){this._precision!==e&&(this._precision=e,this.emit('change'))}},{key:'textColor',get:function get(){return this._textColor},set:function set(e){this._textColor!==e&&(this._textColor=e,this.emit('change'))}},{key:'paddingLeft',get:function get(){return this._paddingLeft},set:function set(e){this._paddingLeft!==e&&(this._paddingLeft=e,this.emit('change'))}},{key:'paddingRight',get:function get(){return this._paddingRight},set:function set(e){this._paddingRight!==e&&(this._paddingRight=e,this.emit('change'))}},{key:'shadow',get:function get(){return this._shadow},set:function set(e){this._shadow!==e&&(this._shadow=e,this.emit('change'))}},{key:'shadowColor',get:function get(){return this._shadowColor},set:function set(e){this._shadowColor!==e&&(this._shadowColor=e,this.emit('change'))}},{key:'shadowOffsetX',get:function get(){return this._shadowOffsetX},set:function set(e){this._shadowOffsetX!==e&&(this._shadowOffsetX=e,this.emit('change'))}},{key:'shadowOffsetY',get:function get(){return this._shadowOffsetY},set:function set(e){this._shadowOffsetY!==e&&(this._shadowOffsetY=e,this.emit('change'))}},{key:'shadowBlur',get:function get(){return this._shadowBlur},set:function set(e){this._shadowBlur!==e&&(this._shadowBlur=e,this.emit('change'))}},{key:'highlight',get:function get(){return this._highlight},set:function set(e){this._highlight!==e&&(this._highlight=e,this.emit('change'))}},{key:'highlightHeight',get:function get(){return this._highlightHeight},set:function set(e){this._highlightHeight!==e&&(this._highlightHeight=e,this.emit('change'))}},{key:'highlightColor',get:function get(){return this._highlightColor},set:function set(e){this._highlightColor!==e&&(this._highlightColor=e,this.emit('change'))}},{key:'highlightOffset',get:function get(){return this._highlightOffset},set:function set(e){this._highlightOffset!==e&&(this._highlightOffset=e,this.emit('change'))}},{key:'highlightPaddingLeft',get:function get(){return this._highlightPaddingLeft},set:function set(e){this._highlightPaddingLeft!==e&&(this._highlightPaddingLeft=e,this.emit('change'))}},{key:'highlightPaddingRight',get:function get(){return this._highlightPaddingRight},set:function set(e){this._highlightPaddingRight!==e&&(this._highlightPaddingRight=e,this.emit('change'))}},{key:'cutSx',get:function get(){return this._cutSx},set:function set(e){this._cutSx!==e&&(this._cutSx=e,this.emit('change'))}},{key:'cutEx',get:function get(){return this._cutEx},set:function set(e){this._cutEx!==e&&(this._cutEx=e,this.emit('change'))}},{key:'cutSy',get:function get(){return this._cutSy},set:function set(e){this._cutSy!==e&&(this._cutSy=e,this.emit('change'))}},{key:'cutEy',get:function get(){return this._cutEy},set:function set(e){this._cutEy!==e&&(this._cutEy=e,this.emit('change'))}}]),o}(Base);Base.mixinEs5(TextRendererSettings,EventEmitter);var TransitionManager=function(){function e(o){var s=this;_classCallCheck(this,e),this.stage=o,this.stage.on('frameStart',function(){return s.progress()}),this.active=new Set,this.defaultTransitionSettings=new TransitionSettings}return _createClass(e,[{key:'progress',value:function progress(){if(this.active.size){var e=this.stage.dt,o=!1;this.active.forEach(function(s){s.isActive()?s.progress(e):o=!0}),o&&(this.active=new Set([].concat(_toConsumableArray(this.active)).filter(function(e){return e.isActive()})))}}},{key:'createSettings',value:function createSettings(e){var o=new TransitionSettings;return Base.setObjectSettings(o,e),o}},{key:'addActive',value:function addActive(e){this.active.add(e)}}]),e}(),TransitionSettings=function(e){function o(){return _classCallCheck(this,o),_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this))}return _inherits(o,e),_createClass(o,[{key:'_properties',value:function _properties(){this._timingFunction='ease',this._timingFunctionImpl=StageUtils.getTimingFunction(this._timingFunction),this.delay=0,this.duration=0.2,this.isTransitionSettings=!0,this.merger=null}},{key:'timingFunction',get:function get(){return this._timingFunction},set:function set(e){this._timingFunction=e,this._timingFunctionImpl=StageUtils.getTimingFunction(e)}},{key:'timingFunctionImpl',get:function get(){return this._timingFunctionImpl}}]),o}(Base),Transition=function(e){function o(e,s,n,l){_classCallCheck(this,o);var d=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return EventEmitter.call(d),d.manager=e,d._settings=s,View||(View=require('../core/View')),d._view=n,d._getter=View.getGetter(l),d._setter=View.getSetter(l),d._merger=s.merger,d._merger||(n.isColorProperty(l)?d._merger=StageUtils.mergeColors:d._merger=StageUtils.mergeNumbers),d._startValue=d._getter(d._view),d._targetValue=d._startValue,d._p=1,d._delayLeft=0,d}return _inherits(o,e),_createClass(o,[{key:'_properties',value:function _properties(){this.isTransition=!0}},{key:'stop',value:function stop(){this.isActive()&&(this._setter(this.targetValue),this._p=1)}},{key:'reset',value:function reset(e,o){this._startValue=this._getter(this._view),this._targetValue=e,this._p=o,1>o?this.checkActive():1===o&&(this._setter(e),this.invokeListeners())}},{key:'start',value:function start(e){this._startValue=this._getter(this._view),e===this._startValue?this.reset(this._startValue,e,1):(this._targetValue=e,this._p=0,this._delayLeft=this._settings.delay,this._eventsCount&&this.emit('start'),this.checkActive(),!this._view.isAttached()&&this.finish())}},{key:'finish',value:function finish(){1>this._p&&(this._p=1,this._setter(this._view,this.targetValue),this._eventsCount&&this.invokeListeners())}},{key:'checkActive',value:function checkActive(){this.isActive()&&this.manager.addActive(this)}},{key:'isActive',value:function isActive(){return 1>this._p&&this._view.isAttached()}},{key:'progress',value:function progress(e){if(1>this.p){if(0<this.delayLeft)if(this._delayLeft-=e,0>this.delayLeft)e=-this.delayLeft,this._delayLeft=0,this._eventsCount&&this.emit('delayEnd');else return;0==this._settings.duration?this._p=1:this._p+=e/this._settings.duration,1<=this._p&&(this._p=1)}this._setter(this._view,this.getDrawValue()),this._eventsCount&&this.invokeListeners()}},{key:'invokeListeners',value:function invokeListeners(){this.emit('progress',this.p),1===this.p&&this.emit('finish')}},{key:'setValuesDynamic',value:function setValuesDynamic(e){var o=this._settings.timingFunctionImpl(this.p);1===o?this._targetValue=e:0===o?(this._startValue=this._targetValue,this._targetValue=e):(this._startValue=e-(e-this._targetValue)/(1-v),this._targetValue=e)}},{key:'getDrawValue',value:function getDrawValue(){if(1<=this.p)return this.targetValue;var e=this._settings._timingFunctionImpl(this.p);return this._merger(this.targetValue,this.startValue,e)}},{key:'skipDelay',value:function skipDelay(){this._delayLeft=0}},{key:'startValue',get:function get(){return this._startValue}},{key:'targetValue',get:function get(){return this._targetValue}},{key:'p',get:function get(){return this._p}},{key:'delayLeft',get:function get(){return this._delayLeft}},{key:'view',get:function get(){return this._view}},{key:'settings',get:function get(){return this._settings},set:function set(e){this._settings=e}}]),o}(Base);Base.mixinEs5(Transition,EventEmitter);var AnimationManager=function(){function e(o){var s=this;_classCallCheck(this,e),this.stage=o,this.stage.on('frameStart',function(){return s.progress()}),this.active=new Set}return _createClass(e,[{key:'progress',value:function progress(){if(this.active.size){var e=this.stage.dt,o=!1;this.active.forEach(function(s){s.isActive()?s.progress(e):o=!0}),o&&(this.active=new Set([].concat(_toConsumableArray(this.active)).filter(function(e){return e.isActive()})))}}},{key:'createAnimation',value:function createAnimation(e,o){return Utils.isObjectLiteral(o)&&(o=this.createSettings(o)),new Animation(this,o,e)}},{key:'createSettings',value:function createSettings(e){var o=new AnimationSettings;return Base.setObjectSettings(o,e),o}},{key:'addActive',value:function addActive(e){this.active.add(e)}}]),e}(),AnimationSettings=function(e){function o(){_classCallCheck(this,o);var e=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return e._actions=[],e}return _inherits(o,e),_createClass(o,[{key:'_properties',value:function _properties(){this.delay=0,this.duration=1,this.repeat=0,this.repeatOffset=0,this.repeatDelay=0,this.autostop=!1,this.stopMethod=o.STOP_METHODS.FADE,this._stopTimingFunction='ease',this._stopTimingFunctionImpl=StageUtils.getTimingFunction(this._stopTimingFunction),this.stopDuration=0,this.stopDelay=0}},{key:'apply',value:function apply(e,o){var s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1;this._actions.forEach(function(n){n.apply(e,o,s)})}},{key:'reset',value:function reset(e){this._actions.forEach(function(o){o.reset(e)})}},{key:'actions',get:function get(){return this._actions},set:function set(o){this._actions=[];for(var s,e=0,l=o.length;e<l;e++)if(s=o[e],!s.isAnimationActionSettings){var n=new AnimationActionSettings(this);n.setSettings(s),this._actions.push(n)}else this._actions.push(s)}},{key:'stopTimingFunction',get:function get(){return this._stopTimingFunction},set:function set(e){this._stopTimingFunction=e,this._stopTimingFunctionImpl=StageUtils.getTimingFunction(e)}},{key:'stopTimingFunctionImpl',get:function get(){return this._stopTimingFunctionImpl}}]),o}(Base);AnimationSettings.STOP_METHODS={FADE:'fade',REVERSE:'reverse',FORWARD:'forward',IMMEDIATE:'immediate',ONETOTWO:'onetotwo'};var AnimationActionSettings=function(e){function o(){_classCallCheck(this,o);var e=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return e._tags=null,e._items=new AnimationActionItems(e),e._props=[],e._propSetters=[],e._merger=void 0,e}return _inherits(o,e),_createClass(o,[{key:'_properties',value:function _properties(){this._resetValue=void 0,this._hasResetValue=!1,this.isAnimationActionSettings=!0}},{key:'getResetValue',value:function getResetValue(){return this._hasResetValue?this._resetValue:this._items.getValue(0)}},{key:'apply',value:function apply(e,o,s){var l=this.getAnimatedViews(e),d=this._items.getValue(o);if(void 0!==d&&l.length){if(1!==s){var _=this.getResetValue();this._merger&&(d=this._merger(d,_,s))}for(var u=this._propSetters.length,n=l.length,c=0;c<n;c++)for(var x=0;x<u;x++)this._propSetters[x](l[c],d)}}},{key:'getAnimatedViews',value:function getAnimatedViews(e){if(!this._tags)return[e];var o=this._tags.length;if(1===o)return''==this._tags[0]?[e]:e.mtag(this._tags[0]);for(var s=[],n=0;n<o;n++)if(''===this._tags[n])s.push(e);else{var l=e.mtag(this._tags[n]);s=s.concat(l)}return views}},{key:'reset',value:function reset(e){var o=this.getAnimatedViews(e),s=this.getResetValue();if(void 0!==s&&o.length)for(var l=this._propSetters.length,n=o.length,d=0;d<n;d++)for(var _=0;_<l;_++)this._propSetters[_](o[d],s)}},{key:'tags',get:function get(){return this._tags},set:function set(e){Array.isArray(e)||(e=[e]),this._tags=e}},{key:'t',set:function set(e){this.tags=e}},{key:'resetValue',get:function get(){return this._resetValue},set:function set(e){this._resetValue=e,this._hasResetValue=void 0!==e}},{key:'rv',set:function set(e){this.resetValue=e}},{key:'value',set:function set(e){this._items.parse(e)}},{key:'v',set:function set(e){this.value=e}},{key:'properties',set:function set(e){var o=this;Array.isArray(e)||(e=[e]),this._props=[];var s=void 0===this._merger,n=!0;e.forEach(function(l){if(o._props.push(l),o._propSetters.push(View.getSetter(l)),s){var d=View.getMerger(l);n?(o._merger=d,n=!1):o._merger!==d&&(console.warn('Merger conflicts for animation action properties: '+e.join(',')),o._merger=void 0)}})}},{key:'property',set:function set(e){this.properties=e}},{key:'p',set:function set(e){this.properties=e}},{key:'merger',set:function set(e){this._items.length&&console.trace('You should specify the merger before the values'),'numbers'===e?e=StageUtils.mergeNumbers:'colors'===e&&(e=StageUtils.mergeColors),this._merger=e}}]),o}(Base),AnimationActionItems=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return s._action=e,s._clear(),s}return _inherits(o,e),_createClass(o,[{key:'_clear',value:function _clear(){this._p=[],this._pe=[],this._idp=[],this._f=[],this._v=[],this._lv=[],this._sm=[],this._s=[],this._ve=[],this._sme=[],this._se=[],this._length=0}},{key:'parse',value:function parse(e){var o,s;Utils.isObjectLiteral(e)||(e={0:e});var n=[];for(var l in e)if(e.hasOwnProperty(l)){var _=e[l];Utils.isObjectLiteral(_)||(_={v:_});var u=parseFloat(l);!isNaN(u)&&0<=u&&2>=u&&(_.p=u,_.f=Utils.isFunction(_.v),_.lv=_.f?_.v(0,0):_.v,n.push(_))}for(n=n.sort(function(e,o){return e.p-o.p}),s=n.length,o=0;o<s;o++){var c=o==s-1;if(!n[o].hasOwnProperty('pe'))n[o].pe=c?1>=n[o].p?1:2:n[o+1].p;else{var x=o<s-1?n[o+1].p:1;n[o].pe>x&&(n[o].pe=x)}n[o].idp=n[o].pe===n[o].p?0:1/(n[o].pe-n[o].p)}if(this._action._merger){var h=this._action._merger===StageUtils.mergeColors;for(o=0;o<s;o++)if(n[o].hasOwnProperty('sm')||(n[o].sm=0.5),!n[o].hasOwnProperty('s'))if(0===o||o===s-1||1===n[o].p)n[o].s=h?[0,0,0,0]:0;else{var y=n[o-1],f=n[o+1];if(y.p===f.p)n[o].s=h?[0,0,0,0]:0;else if(h){var T=StageUtils.getRgbaComponents(f.lv),S=StageUtils.getRgbaComponents(y.lv),C=1/(f.p-y.p);n[o].s=[C*(T[0]-S[0]),C*(T[1]-S[1]),C*(T[2]-S[2]),C*(T[3]-S[3])]}else n[o].s=(f.lv-y.lv)/(f.p-y.p)}for(o=0;o<s-1;o++)if(!n[o].f){var d=o===s-1;n[o].hasOwnProperty('sme')||(n[o].sme=d?0.5:n[o+1].sm),n[o].hasOwnProperty('se')||(n[o].se=d?h?[0,0,0,0]:0:n[o+1].s),n[o].hasOwnProperty('ve')||(n[o].ve=d?n[o].lv:n[o+1].lv),n[o].v=h?StageUtils.getSplineRgbaValueFunction(n[o].v,n[o].ve,n[o].p,n[o].pe,n[o].sm,n[o].sme,n[o].s,n[o].se):StageUtils.getSplineValueFunction(n[o].v,n[o].ve,n[o].p,n[o].pe,n[o].sm,n[o].sme,n[o].s,n[o].se),n[o].f=!0}}for(this.length&&this._clear(),o=0,s=n.length;o<s;o++)this._add(n[o])}},{key:'_add',value:function _add(e){this._p.push(e.p||0),this._pe.push(e.pe||0),this._idp.push(e.idp||0),this._f.push(e.f||!1),this._v.push(e.hasOwnProperty('v')?e.v:0),this._lv.push(e.lv||0),this._sm.push(e.sm||0),this._s.push(e.s||0),this._ve.push(e.ve||0),this._sme.push(e.sme||0),this._se.push(e.se||0),this._length++}},{key:'_getItem',value:function _getItem(e){var o=this._length;if(!o)return-1;if(e<this._p[0])return-1;for(var s=0;s<o;s++)if(this._p[s]<=e&&e<this._pe[s])return s;return o-1}},{key:'getValue',value:function getValue(e){var s=this._getItem(e);if(-1!=s){if(this._f[s]){var n=(e-this._p[s])*this._idp[s];return this._v[s](n)}return this._v[s]}}},{key:'length',get:function get(){return this._length}}]),o}(Base),Animation=function(e){function o(e,s,n){_classCallCheck(this,o);var l=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return EventEmitter.call(l),l.manager=e,l._settings=s,l._view=n,l._state=o.STATES.IDLE,l}return _inherits(o,e),_createClass(o,[{key:'_properties',value:function _properties(){this._p=0,this._delayLeft=0,this._repeatsLeft=0,this._stopDelayLeft=0,this._stopP=0}},{key:'start',value:function start(){this._view&&this._view.isAttached()?(this._p=0,this._delayLeft=this.settings.delay,this._repeatsLeft=this.settings.repeat,this._state=o.STATES.PLAYING,this._eventsCount&&this.emit('start'),this.checkActive()):console.warn('View must be attached before starting animation')}},{key:'play',value:function play(){this._state==o.STATES.STOPPING&&this.settings.stopMethod==AnimationSettings.STOP_METHODS.REVERSE?(this._state=o.STATES.PLAYING,this._eventsCount&&this.emit('stopContinue')):this._state!=o.STATES.PLAYING&&this._state!=o.STATES.FINISHED&&this.start()}},{key:'replay',value:function replay(){this._state==o.STATES.FINISHED?this.start():this.play()}},{key:'skipDelay',value:function skipDelay(){this._delayLeft=0,this._stopDelayLeft=0}},{key:'finish',value:function finish(){this._state===o.STATES.PLAYING?(this._delayLeft=0,this._p=1):this._state===o.STATES.STOPPING&&(this._stopDelayLeft=0,this._p=0)}},{key:'stop',value:function stop(){this._state===o.STATES.STOPPED||this._state===o.STATES.IDLE||(this._stopDelayLeft=this.settings.stopDelay||0,this.settings.stopMethod===AnimationSettings.STOP_METHODS.IMMEDIATE&&!this._stopDelayLeft||0<this._delayLeft?(this._state=o.STATES.STOPPING,this._eventsCount&&this.emit('stop')):(this.settings.stopMethod===AnimationSettings.STOP_METHODS.FADE&&(this._stopP=0),this._state=o.STATES.STOPPING,this._eventsCount&&this.emit('stop')),this.checkActive())}},{key:'stopNow',value:function stopNow(){(this._state!==o.STATES.STOPPED||this._state!==o.STATES.IDLE)&&(this._state=o.STATES.STOPPING,this._p=0,this._eventsCount&&this.emit('stop'),this.reset(),this._state=o.STATES.STOPPED,this._eventsCount&&this.emit('stopFinish'))}},{key:'isPlaying',value:function isPlaying(){return this._state===o.STATES.PLAYING}},{key:'isStopping',value:function isStopping(){return this._state===o.STATES.STOPPING}},{key:'checkActive',value:function checkActive(){this.isActive()&&this.manager.addActive(this)}},{key:'isActive',value:function isActive(){return(this._state==o.STATES.PLAYING||this._state==o.STATES.STOPPING)&&this._view&&this._view.isAttached()}},{key:'progress',value:function progress(e){this._view&&(this._progress(e),this.apply())}},{key:'_progress',value:function _progress(e){if(this._state==o.STATES.STOPPING)return void this._stopProgress(e);if(this._state==o.STATES.PLAYING){if(0<this._delayLeft)if(this._delayLeft-=e,0>this._delayLeft)e=-this._delayLeft,this._delayLeft=0,this._eventsCount&&this.emit('delayEnd');else return;0===this.settings.duration?this._p=1:0<this.settings.duration&&(this._p+=e/this.settings.duration),1<=this._p?-1==this.settings.repeat||0<this._repeatsLeft?(0<this._repeatsLeft&&this._repeatsLeft--,this._p=this.settings.repeatOffset,this.settings.repeatDelay&&(this._delayLeft=this.settings.repeatDelay),this._eventsCount&&this.emit('repeat',this._repeatsLeft)):(this._p=1,this._state=o.STATES.FINISHED,this._eventsCount&&this.emit('finish'),this.settings.autostop&&this.stop()):this._eventsCount&&this.emit('progress',this._p)}}},{key:'_stopProgress',value:function _stopProgress(e){var s=this._getStopDuration();if(0<this._stopDelayLeft&&(this._state=o.STATES.STOPPED,this._eventsCount&&this.emit('stopFinish')),0<this._stopDelayLeft)if(this._stopDelayLeft-=e,0>this._stopDelayLeft)e=-this._stopDelayLeft,this._stopDelayLeft=0,this._eventsCount&&this.emit('stopDelayEnd');else return;this.settings.stopMethod==AnimationSettings.STOP_METHODS.IMMEDIATE?(this._state=o.STATES.STOPPED,this._eventsCount&&this.emit('stop'),this._eventsCount&&this.emit('stopFinish')):this.settings.stopMethod==AnimationSettings.STOP_METHODS.REVERSE?(0===s?this._p=0:0<s&&(this._p-=e/s),0>=this._p&&(this._p=0,this._state=o.STATES.STOPPED,this._eventsCount&&this.emit('stopFinish'))):this.settings.stopMethod==AnimationSettings.STOP_METHODS.FADE?(this._progressStopTransition(e),1<=this._stopP&&(this._p=0,this._state=o.STATES.STOPPED,this._eventsCount&&this.emit('stopFinish'))):this.settings.stopMethod==AnimationSettings.STOP_METHODS.ONETOTWO?2>this._p&&(0===s?this._p=2:0<s&&(1>this._p?this._p+=e/this.settings.duration:this._p+=e/s),2<=this._p?(this._p=2,this._state=o.STATES.STOPPED,this._eventsCount&&this.emit('stopFinish')):this._eventsCount&&this.emit('progress',this._p)):this.settings.stopMethod==AnimationSettings.STOP_METHODS.FORWARD&&1>this._p&&(0==this.settings.duration?this._p=1:this._p+=e/this.settings.duration,1<=this._p?this.settings.stopMethod==AnimationSettings.STOP_METHODS.FORWARD?(this._p=1,this._state=o.STATES.STOPPED,this._eventsCount&&this.emit('stopFinish')):0<this._repeatsLeft?(this._repeatsLeft--,this._p=0,this._eventsCount&&this.emit('repeat',this._repeatsLeft)):(this._p=1,this._state=o.STATES.STOPPED,this._eventsCount&&this.emit('stopFinish')):this._eventsCount&&this.emit('progress',this._p))}},{key:'_progressStopTransition',value:function _progressStopTransition(e){if(1>this._stopP){if(0<this._stopDelayLeft)if(this._stopDelayLeft-=e,0>this._stopDelayLeft)e=-this._stopDelayLeft,this._stopDelayLeft=0,this._eventsCount&&this.emit('delayEnd');else return;var o=this._getStopDuration();0==o?this._stopP=1:this._stopP+=e/o,1<=this._stopP&&(this._stopP=1)}}},{key:'_getStopDuration',value:function _getStopDuration(){return this.settings.stopDuration||this.settings.duration}},{key:'apply',value:function apply(){if(this._state==o.STATES.STOPPED)this.reset();else{var e=1;this._state===o.STATES.STOPPING&&this.settings.stopMethod===AnimationSettings.STOP_METHODS.FADE&&(e=1-this.settings.stopTimingFunctionImpl(this._stopP)),this._settings.apply(this._view,this._p,e)}}},{key:'reset',value:function reset(){this._settings.reset(this._view)}},{key:'state',get:function get(){return this._state}},{key:'p',get:function get(){return this._p}},{key:'delayLeft',get:function get(){return this._delayLeft}},{key:'view',get:function get(){return this._view}},{key:'frame',get:function get(){return Math.round(60*(p*this._settings.duration))}},{key:'settings',get:function get(){return this._settings}}]),o}(Base);Base.mixinEs5(Animation,EventEmitter),Animation.STATES={IDLE:0,PLAYING:1,STOPPING:2,STOPPED:3,FINISHED:4};var Tools=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:'getCanvasTexture',value:function getCanvasTexture(e,o){var s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};return e.texture(function(e){var s=o,n={};Utils.isNode&&(s=o.toBuffer('raw'),n.w=o.width,n.h=o.height,n.premultiplyAlpha=!1,n.flipBlueRed=!0),e(null,s,n)},s)}},{key:'getRoundRect',value:function getRoundRect(o,s,n,l,d,_,u,c){var x=this.createRoundRect(o,s,n,l,d,_,u,c),h='rect'+[s,n,l,d,_,u?1:0,c].join(',');return e.getCanvasTexture(o,x,{id:h})}},{key:'createRoundRect',value:function createRoundRect(e,o,s,n,l,d,_,u){void 0===_&&(_=!0),void 0===l&&(l=0);var c=e.adapter.getDrawingCanvas(),h=c.getContext('2d');h.imageSmoothingEnabled=!0;'rect'+[o,s,n,l,d,_?1:0,u].join(',');c.width=o+l+2,c.height=s+l+2,h.beginPath();var f=0.5*l+1,x=0.5*l+1;return h.moveTo(f+n,x),h.lineTo(f+o-n,x),h.arcTo(f+o,x,f+o,x+n,n),h.lineTo(f+o,x+s-n),h.arcTo(f+o,x+s,f+o-n,x+s,n),h.lineTo(f+n,x+s),h.arcTo(f,x+s,f,x+s-n,n),h.lineTo(f,x+n),h.arcTo(f,x,f+n,x,n),_&&(h.fillStyle=Utils.isNumber(u)?StageUtils.getRgbaString(u):'white',h.fill()),l&&(h.strokeStyle=Utils.isNumber(d)?StageUtils.getRgbaString(d):'white',h.lineWidth=l,h.stroke()),c}}]),e}(),ListView=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return s._wrapper=_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'_children',s).a({}),s._reloadVisibleElements=!1,s._visibleItems=new Set,s._index=0,s._started=!1,s._scrollTransitionSettings=s.stage.transitions.createSettings({}),s._itemSize=100,s._viewportScrollOffset=0,s._itemScrollOffset=0,s._roll=!1,s._rollMin=0,s._rollMax=0,s._progressAnimation=null,s._invertDirection=!1,s._horizontal=!0,s}var n=Math.floor,s=Math.max,l=Math.min,d=Math.ceil;return _inherits(o,e),_createClass(o,[{key:'_getExposedChildList',value:function _getExposedChildList(){return new(function(e){function o(e,s){_classCallCheck(this,o);var n=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return n.list=s,n}return _inherits(o,e),_createClass(o,[{key:'addAt',value:function addAt(e,s){var n=e.stage.createView();n.add(e),n.visible=!1,_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'addAt',this).call(this,n,s),this.list._reloadVisibleElements=!0,this.list._started?(1===this.list.length&&this.list.setIndex(0,!0,!0),this.list.update()):this.list.start()}},{key:'getIndex',value:function getIndex(e){return _get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'getIndex',this).call(this,e.parent)}},{key:'removeAt',value:function removeAt(e){var s=this.list.realIndex,n=_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'removeAt',this).call(this,e);return s===e?(s===this.list.length&&s--,0<=s&&this.list.setIndex(s)):s>e&&this.list.setIndex(s-1),this.list._reloadVisibleElements=!0,n._children.get()[0]}},{key:'get',value:function get(){return _get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'get',this).call(this).map(function(e){return e._children.get()[0]})}},{key:'clear',value:function clear(){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'clear',this).call(this),this.list._reloadVisibleElements=!0,this.list._index=0}}]),o}(ViewChildList))(this._wrapper,this)}},{key:'start',value:function start(){var e=this;this._wrapper.transition(this.property,this._scrollTransitionSettings),this._scrollTransition=this._wrapper.transition(this.property),this._scrollTransition.on('progress',function(){return e.update()}),this.setIndex(0,!0,!0),this.update(),this._started=!0}},{key:'setIndex',value:function setIndex(e){var n=1<arguments.length&&void 0!==arguments[1]&&arguments[1],d=2<arguments.length&&void 0!==arguments[2]&&arguments[2],_=this.length;if(_){if(this.emit('unfocus',this.getElement(this.realIndex),this._index,this.realIndex),d){var x=Utils.getModuloIndex(e,_),h=Utils.getModuloIndex(this.index,_),o=x-h;o>0.5*_?o-=_:o<-0.5*_&&(o+=_),this._index+=o}else this._index=e;(this._roll||this.viewportSize>this._itemSize*_)&&(this._index=Utils.getModuloIndex(this._index,_));var u=this._horizontal^this._invertDirection?-1:1,c=u*this._index*this._itemSize;if(this._roll){var y,f,T;if(1==u)f=(_-1)*this._itemSize,T=this._viewportScrollOffset*this.viewportSize-this._itemScrollOffset*this._itemSize,f-=T,y=this.viewportSize-(this._itemSize+T),this._rollMin&&(y-=this._rollMin),this._rollMax&&(f+=this._rollMax),c=s(l(c,f),y);else{f=_*this._itemSize-this.viewportSize,T=this._viewportScrollOffset*this.viewportSize-this._itemScrollOffset*this._itemSize,f+=T;var S=T;this._rollMin&&(S-=this._rollMin),this._rollMax&&(f+=this._rollMax),c=l(s(-f,c),-S)}}this._scrollTransition.start(c),n&&this._scrollTransition.finish(),this.emit('focus',this.getElement(this.realIndex),this._index,this.realIndex)}}},{key:'update',value:function update(){if(this._started){var o=this.length;if(o){var l=this._horizontal^this._invertDirection?-1:1,_=this._horizontal?this._wrapper.x:this._wrapper.y,u=this.viewportSize,c=this._viewportScrollOffset*u-this._itemScrollOffset*this._itemSize;_+=c;var x,s,e,h;-1==l?(x=n(-_/this._itemSize),e=1-(-_/this._itemSize-x),s=n((u-_)/this._itemSize),h=(u-_)/this._itemSize-s):(x=d(_/this._itemSize),e=1+_/this._itemSize-x,s=d((_-u)/this._itemSize),h=s-(_-u)/this._itemSize),(this._roll||u>this._itemSize*o)&&(s>=o&&(s=o-1,h=1),x>=o&&(x=o-1,e=1),-1>=s&&(s=0,h=1),-1>=x&&(x=0,e=1));for(var f=-l*x*this._itemSize,T=void 0,S=x;-1==l?S<=s:S>=s;-1==l?S++:S--){var C=Utils.getModuloIndex(S,o),k=this.getElement(C);T=k.parent,this._visibleItems.delete(T),this._horizontal?T.x=f+c:T.y=f+c;var w=T.visible;if(T.visible=!0,(!w||this._reloadVisibleElements)&&this.emit('visible',S,C),this._progressAnimation){var R=1;S==x?R=e:S==s&&(R=h),this._progressAnimation.apply(k,R)}f+=this._itemSize}var y=this;this._visibleItems.forEach(function(e){e.visible=!1,y._visibleItems.delete(e)});for(var E,P=x;-1==l?P<=s:P>=s;-1==l?P++:P--)E=Utils.getModuloIndex(P,o),this._visibleItems.add(this.getWrapper(E));this._reloadVisibleElements=!1}}}},{key:'setPrevious',value:function setPrevious(){this.setIndex(this._index-1)}},{key:'setNext',value:function setNext(){this.setIndex(this._index+1)}},{key:'getWrapper',value:function getWrapper(e){return this._wrapper.children[e]}},{key:'getElement',value:function getElement(o){var s=this._wrapper.children[o];return s?s.children[0]:null}},{key:'reload',value:function reload(){this._reloadVisibleElements=!0,this.update()}},{key:'element',get:function get(){var o=this._wrapper.children[this.realIndex];return o?o.children[0]:null}},{key:'length',get:function get(){return this._wrapper.children.length}},{key:'property',get:function get(){return this._horizontal?'x':'y'}},{key:'viewportSize',get:function get(){return this._horizontal?this.w:this.h}},{key:'index',get:function get(){return this._index}},{key:'realIndex',get:function get(){return Utils.getModuloIndex(this._index,this.length)}},{key:'itemSize',get:function get(){return this._itemSize},set:function set(e){this._itemSize=e,this.update()}},{key:'viewportScrollOffset',get:function get(){return this._viewportScrollOffset},set:function set(e){this._viewportScrollOffset=e,this.update()}},{key:'itemScrollOffset',get:function get(){return this._itemScrollOffset},set:function set(e){this._itemScrollOffset=e,this.update()}},{key:'scrollTransitionSettings',get:function get(){return this._scrollTransitionSettings},set:function set(e){this._scrollTransitionSettings.setSettings(e)}},{key:'scrollTransition',set:function set(e){this._scrollTransitionSettings.setSettings(e)},get:function get(){return this._scrollTransition}},{key:'progressAnimation',get:function get(){return this._progressAnimation},set:function set(e){this._progressAnimation=Utils.isObjectLiteral(e)?this.stage.animations.createSettings(e):e,this.update()}},{key:'roll',get:function get(){return this._roll},set:function set(e){this._roll=e,this.update()}},{key:'rollMin',get:function get(){return this._rollMin},set:function set(e){this._rollMin=e,this.update()}},{key:'rollMax',get:function get(){return this._rollMax},set:function set(e){this._rollMax=e,this.update()}},{key:'invertDirection',get:function get(){return this._invertDirection},set:function set(e){this._started||(this._invertDirection=e)}},{key:'horizontal',get:function get(){return this._horizontal},set:function set(e){e===this._horizontal||this._started||(this._horizontal=e)}}]),o}(View);ListView.NUMBER_PROPERTIES=new Set(['viewportScrollOffset','itemScrollOffset']);var BorderView=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return s._wrapper=_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'_children',s).a({}),s._borderTop=_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'_children',s).a({rect:!0,visible:!1,mountY:1}),s._borderRight=_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'_children',s).a({rect:!0,visible:!1}),s._borderBottom=_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'_children',s).a({rect:!0,visible:!1}),s._borderLeft=_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'_children',s).a({rect:!0,visible:!1,mountX:1}),s._updateLayout=!1,s.visitExit=function(e,o){var s=1===e.children.length,n=s&&2&e.children[0]._core._recalc||o||e._updateLayout;if(n){1===e.children.length&&(e.w=e.children[0].renderWidth,e.h=e.children[0].renderHeight);var l=e.renderWidth,d=e.renderHeight;e._borderTop.w=l,e._borderBottom.y=d,e._borderBottom.w=l,e._borderLeft.h=d+e._borderTop.h+e._borderBottom.h,e._borderLeft.y=-e._borderTop.h,e._borderRight.x=l,e._borderRight.h=d+e._borderTop.h+e._borderBottom.h,e._borderRight.y=-e._borderTop.h,e._wrapper.w=l,e._wrapper.h=d,e._updateLayout=!1}},s}return _inherits(o,e),_createClass(o,[{key:'_getExposedChildList',value:function _getExposedChildList(){return this._wrapper._children}},{key:'borderWidth',get:function get(){return this.borderWidthTop},set:function set(e){this.borderWidthTop=e,this.borderWidthRight=e,this.borderWidthBottom=e,this.borderWidthLeft=e}},{key:'borderWidthTop',get:function get(){return this._borderTop.h},set:function set(e){this._borderTop.h=e,this._borderTop.visible=0<e,this._updateLayout=!0}},{key:'borderWidthRight',get:function get(){return this._borderRight.w},set:function set(e){this._borderRight.w=e,this._borderRight.visible=0<e,this._updateLayout=!0}},{key:'borderWidthBottom',get:function get(){return this._borderBottom.h},set:function set(e){this._borderBottom.h=e,this._borderBottom.visible=0<e,this._updateLayout=!0}},{key:'borderWidthLeft',get:function get(){return this._borderLeft.w},set:function set(e){this._borderLeft.w=e,this._borderLeft.visible=0<e,this._updateLayout=!0}},{key:'borderColor',get:function get(){return this.borderColorTop},set:function set(e){this.borderColorTop=e,this.borderColorRight=e,this.borderColorBottom=e,this.borderColorLeft=e}},{key:'borderColorTop',get:function get(){return this._borderTop.color},set:function set(e){this._borderTop.color=e}},{key:'borderColorRight',get:function get(){return this._borderRight.color},set:function set(e){this._borderRight.color=e}},{key:'borderColorBottom',get:function get(){return this._borderBottom.color},set:function set(e){this._borderBottom.color=e}},{key:'borderColorLeft',get:function get(){return this._borderLeft.color},set:function set(e){this._borderLeft.color=e}},{key:'borderTop',get:function get(){return this._borderTop},set:function set(e){this.borderTop.setSettings(e)}},{key:'borderRight',get:function get(){return this._borderRight},set:function set(e){this.borderRight.setSettings(e)}},{key:'borderBottom',get:function get(){return this._borderBottom},set:function set(e){this.borderBottom.setSettings(e)}},{key:'borderLeft',get:function get(){return this._borderLeft},set:function set(e){this.borderLeft.setSettings(e)}},{key:'borders',set:function set(e){this.borderTop=e,this.borderLeft=e,this.borderBottom=e,this.borderRight=e}},{key:'clipping',get:function get(){return this._wrapper.clipping},set:function set(e){this._wrapper.clipping=e}}]),o}(View);BorderView.NUMBER_PROPERTIES=new Set(['borderWidth','borderWidthTop','borderWidthRight','borderWidthBottom','borderWidthLeft']),BorderView.COLOR_PROPERTIES=new Set(['borderColor','borderColorTop','borderColorRight','borderColorBottom','borderColorLeft']);var FastBlurView=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e)),n=o.getFastBoxBlurShader(e.ctx),l=s._children;l.a([{renderToTexture:!1,hideResultTexture:!0,children:[{}]},{children:[{renderToTexture:!0,hideResultTexture:!0,visible:!1,children:[{shader:n}]},{renderToTexture:!0,hideResultTexture:!0,visible:!1,children:[{shader:n}]},{renderToTexture:!0,hideResultTexture:!0,visible:!1,children:[{shader:n}]},{renderToTexture:!0,hideResultTexture:!0,visible:!1,children:[{shader:n}]}]},{shader:{type:FastBlurOutputShader},visible:!1}]),s._textwrap=l.get()[0],s._wrapper=s._textwrap.children[0],s._layers=l.get()[1].children,s._output=l.get()[2],s.getLayerContents(0).texture=s._textwrap.getResultTextureSource(),s.getLayerContents(1).texture=s.getLayer(0).getResultTextureSource(),s.getLayerContents(2).texture=s.getLayer(1).getResultTextureSource(),s.getLayerContents(3).texture=s.getLayer(2).getResultTextureSource();var d=o.getLinearBlurFilters(e.ctx);return s.getLayer(1).filters=[d[0],d[1]],s.getLayer(2).filters=[d[2],d[3],d[0],d[1]],s.getLayer(3).filters=[d[2],d[3],d[0],d[1]],s._amount=0,s._paddingX=0,s._paddingY=0,s}return _inherits(o,e),_createClass(o,[{key:'_getExposedChildList',value:function _getExposedChildList(){return this._wrapper._children}},{key:'getLayer',value:function getLayer(e){return this._layers[e]}},{key:'getLayerContents',value:function getLayerContents(e){return this.getLayer(e).children[0]}},{key:'_updateDimensions',value:function _updateDimensions(){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'_updateDimensions',this).call(this)&&this._updateBlurSize()}},{key:'_updateBlurSize',value:function _updateBlurSize(){var e=this.renderWidth,o=this.renderHeight,s=this._paddingX,n=this._paddingY,l=e+2*s,d=o+2*n;this._textwrap.w=l,this._wrapper.x=s,this.getLayer(0).w=this.getLayerContents(0).w=l/2,this.getLayer(1).w=this.getLayerContents(1).w=l/4,this.getLayer(2).w=this.getLayerContents(2).w=l/8,this.getLayer(3).w=this.getLayerContents(3).w=l/16,this._output.x=-s,this._textwrap.x=-s,this._output.w=l,this._textwrap.h=d,this._wrapper.y=n,this.getLayer(0).h=this.getLayerContents(0).h=d/2,this.getLayer(1).h=this.getLayerContents(1).h=d/4,this.getLayer(2).h=this.getLayerContents(2).h=d/8,this.getLayer(3).h=this.getLayerContents(3).h=d/16,this._output.y=-n,this._textwrap.y=-n,this._output.h=d,this.w=e,this.h=o}},{key:'_update',value:function _update(){var e=Math.min(4,Math.max(0,this._amount));0===e?(this._textwrap.renderToTexture=!1,this._output.shader.otherTextureSource=null,this._output.visible=!1):(this._textwrap.renderToTexture=!0,this._output.visible=!0,this.getLayer(0).visible=0<e,this.getLayer(1).visible=1<e,this.getLayer(2).visible=2<e,this.getLayer(3).visible=3<e,1>=e?(this._output.texture=this._textwrap.getResultTextureSource(),this._output.shader.otherTextureSource=this.getLayer(0).getResultTextureSource(),this._output.shader.a=e):2>=e?(this._output.texture=this.getLayer(0).getResultTextureSource(),this._output.shader.otherTextureSource=this.getLayer(1).getResultTextureSource(),this._output.shader.a=e-1):3>=e?(this._output.texture=this.getLayer(1).getResultTextureSource(),this._output.shader.otherTextureSource=this.getLayer(2).getResultTextureSource(),this._output.shader.a=e-2):4>=e&&(this._output.texture=this.getLayer(2).getResultTextureSource(),this._output.shader.otherTextureSource=this.getLayer(3).getResultTextureSource(),this._output.shader.a=e-3))}},{key:'padding',set:function set(e){this._paddingX=e,this._paddingY=e,this._updateBlurSize()}},{key:'paddingX',set:function set(e){this.paddingX=e,this._updateBlurSize()}},{key:'paddingY',set:function set(e){this.paddingY=e,this._updateBlurSize()}},{key:'amount',set:function set(e){this._amount=e,this._update()},get:function get(){return this._amount}}],[{key:'getFastBoxBlurShader',value:function getFastBoxBlurShader(e){return o.fastBoxBlurShader||(o.fastBoxBlurShader=new FastBoxBlurShader(e)),o.fastBoxBlurShader}},{key:'getLinearBlurFilters',value:function getLinearBlurFilters(e){if(!o.linearBlurFilters){o.linearBlurFilters=[];var s=new LinearBlurFilter(e);s.x=1,s.y=0,s.kernelRadius=1,o.linearBlurFilters.push(s),s=new LinearBlurFilter(e),s.x=0,s.y=1,s.kernelRadius=1,o.linearBlurFilters.push(s),s=new LinearBlurFilter(e),s.x=1.5,s.y=0,s.kernelRadius=1,o.linearBlurFilters.push(s),s=new LinearBlurFilter(e),s.x=0,s.y=1.5,s.kernelRadius=1,o.linearBlurFilters.push(s)}return o.linearBlurFilters}}]),o}(View);FastBlurView.NUMBER_PROPERTIES=new Set(['amount']);var FastBoxBlurShader=function(e){function o(e){return _classCallCheck(this,o),_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e))}return _inherits(o,e),_createClass(o,[{key:'getVertexShaderSource',value:function getVertexShaderSource(){return o.vertexShaderSource}},{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return o.fragmentShaderSource}},{key:'setupUniforms',value:function setupUniforms(e){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'setupUniforms',this).call(this,e);var s=1/e.getTextureWidth(0),n=1/e.getTextureHeight(0);this._setUniform('stepTextureCoord',new Float32Array([s,n]),this.gl.uniform2fv)}}]),o}(Shader);FastBoxBlurShader.vertexShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    uniform vec2 stepTextureCoord;\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec4 vColor;\n    varying vec2 vTextureCoordUl;\n    varying vec2 vTextureCoordUr;\n    varying vec2 vTextureCoordBl;\n    varying vec2 vTextureCoordBr;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoordUl = aTextureCoord - stepTextureCoord;\n        vTextureCoordBr = aTextureCoord + stepTextureCoord;\n        vTextureCoordUr = vec2(vTextureCoordBr.x, vTextureCoordUl.y);\n        vTextureCoordBl = vec2(vTextureCoordUl.x, vTextureCoordBr.y);\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n',FastBoxBlurShader.fragmentShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoordUl;\n    varying vec2 vTextureCoordUr;\n    varying vec2 vTextureCoordBl;\n    varying vec2 vTextureCoordBr;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    void main(void){\n        vec4 color = 0.25 * (texture2D(uSampler, vTextureCoordUl) + texture2D(uSampler, vTextureCoordUr) + texture2D(uSampler, vTextureCoordBl) + texture2D(uSampler, vTextureCoordBr));\n        gl_FragColor = color * vColor;\n    }\n';var FastBlurOutputShader=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return s._a=0,s._otherTextureSource=null,s}return _inherits(o,e),_createClass(o,[{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return o.fragmentShaderSource}},{key:'setupUniforms',value:function setupUniforms(e){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'setupUniforms',this).call(this,e),this._setUniform('a',this._a,this.gl.uniform1f),this._setUniform('uSampler2',1,this.gl.uniform1i)}},{key:'beforeDraw',value:function beforeDraw(){var e=this._otherTextureSource?this._otherTextureSource.glTexture:null,o=this.gl;o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,e),o.activeTexture(o.TEXTURE0)}},{key:'isMergable',value:function isMergable(e){return _get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'isMergable',this).call(this,e)&&e._otherTextureSource===this._otherTextureSource}},{key:'a',get:function get(){return this._a},set:function set(e){this._a=e,this.redraw()}},{key:'otherTextureSource',set:function set(e){this._otherTextureSource=e,this.redraw()}}]),o}(Shader);FastBlurOutputShader.fragmentShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform sampler2D uSampler2;\n    uniform float a;\n    void main(void){\n        if (a == 1.0) {\n            gl_FragColor = texture2D(uSampler2, vTextureCoord) * vColor;\n        } else {\n            gl_FragColor = ((1.0 - a) * texture2D(uSampler, vTextureCoord) + (a * texture2D(uSampler2, vTextureCoord))) * vColor;\n        }\n    }\n';var Light3dShader=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return s._strength=0.5,s._ambient=0.5,s._fudge=0.4,s._rx=0,s._ry=0,s._z=0,s}return _inherits(o,e),_createClass(o,[{key:'getVertexShaderSource',value:function getVertexShaderSource(){return o.vertexShaderSource}},{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return o.fragmentShaderSource}},{key:'supportsTextureAtlas',value:function supportsTextureAtlas(){return!0}},{key:'supportsMerging',value:function supportsMerging(){return!1}},{key:'setupUniforms',value:function setupUniforms(e){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'setupUniforms',this).call(this,e);var s=e.shaderOwner,n=s.view,l=s.getRenderTextureCoords(n.pivotX*s.rw,n.pivotY*s.rh),d=-Math.atan2(s._renderContext.tc,s._renderContext.ta),_=this.gl;this._setUniform('pivot',new Float32Array([l[0],l[1],this._z]),_.uniform3fv),this._setUniform('rot',new Float32Array([this._rx,this._ry,d]),_.uniform3fv),this._setUniform('strength',this._strength,_.uniform1f),this._setUniform('ambient',this._ambient,_.uniform1f),this._setUniform('fudge',this._fudge,_.uniform1f)}},{key:'strength',set:function set(e){this._strength=e,this.redraw()},get:function get(){return this._strength}},{key:'ambient',set:function set(e){this._ambient=e,this.redraw()},get:function get(){return this._ambient}},{key:'fudge',set:function set(e){this._fudge=e,this.redraw()},get:function get(){return this._fudge}},{key:'rx',get:function get(){return this._rx},set:function set(e){this._rx=e,this.redraw()}},{key:'ry',get:function get(){return this._ry},set:function set(e){this._ry=e,this.redraw()}},{key:'z',get:function get(){return this._z},set:function set(e){this._z=e,this.redraw()}}]),o}(Shader);Light3dShader.vertexShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n\n    uniform float fudge;\n    uniform float strength;\n    uniform float ambient;\n    uniform vec3 pivot;\n    uniform vec3 rot;\n    varying float light;\n\n    void main(void) {\n        vec3 pos = vec3(aVertexPosition.xy, pivot.z);\n        \n        pos -= pivot;\n\n        /* Undo XY rotation */\n        mat2 iRotXy = mat2( cos(rot.z), sin(rot.z), \n                           -sin(rot.z), cos(rot.z));\n        pos.xy = iRotXy * pos.xy;\n        \n        /* Perform 3d rotations */\n        gl_Position.x = cos(rot.x) * pos.x - sin(rot.x) * pos.z;\n        gl_Position.y = pos.y;\n        gl_Position.z = sin(rot.x) * pos.x + cos(rot.x) * pos.z;\n        \n        pos.y = cos(rot.y) * gl_Position.y - sin(rot.y) * gl_Position.z;\n        gl_Position.z = sin(rot.y) * gl_Position.y + cos(rot.y) * gl_Position.z;\n        gl_Position.y = pos.y;\n        \n        /* Redo XY rotation */\n        iRotXy[0][1] = -iRotXy[0][1];\n        iRotXy[1][0] = -iRotXy[1][0];\n        gl_Position.xy = iRotXy * gl_Position.xy; \n\n        /* Undo translate to pivot position */\n        gl_Position.xyz += pivot;\n        \n        /* Set depth perspective */\n        float perspective = 1.0 + fudge * gl_Position.z * projection.x;\n\n        /* Map coords to gl coordinate space. */\n        gl_Position = vec4(gl_Position.x * projection.x - 1.0, gl_Position.y * -abs(projection.y) + 1.0, 0.0, perspective);\n        \n        /* Set z to 0 because we don\'t want to perform z-clipping */\n        gl_Position.z = 0.0;\n\n        /* Use texture normal to calculate light strength */ \n        light = ambient + strength * abs(cos(rot.y) * cos(rot.x));\n        \n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        \n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n',Light3dShader.fragmentShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying float light;\n    uniform sampler2D uSampler;\n    void main(void){\n        vec4 rgba = texture2D(uSampler, vTextureCoord);\n        rgba.rgb = rgba.rgb * light;\n        gl_FragColor = rgba * vColor;\n    }\n';var PixelateShader=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return s._size=new Float32Array([4,4]),s}return _inherits(o,e),_createClass(o,[{key:'getVertexShaderSource',value:function getVertexShaderSource(){return o.vertexShaderSource}},{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return o.fragmentShaderSource}},{key:'setupUniforms',value:function setupUniforms(e){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'setupUniforms',this).call(this,e);var s=this.gl;this._setUniform('size',new Float32Array(this._size),s.uniform2fv)}},{key:'getExtraAttribBytesPerVertex',value:function getExtraAttribBytesPerVertex(){return 8}},{key:'enableAttribs',value:function enableAttribs(){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'enableAttribs',this).call(this),this.gl.enableVertexAttribArray(this._attrib('aTextureRes'))}},{key:'disableAttribs',value:function disableAttribs(){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'disableAttribs',this).call(this),this.gl.disableVertexAttribArray(this._attrib('aTextureRes'))}},{key:'setExtraAttribsInBuffer',value:function setExtraAttribsInBuffer(e){for(var o=e.extraAttribsDataByteOffset/4,s=e.quads.floats,n=e.length,l=0;l<n;l++){var d=e.quads.getTextureWidth(e.index+l),_=e.quads.getTextureHeight(e.index+l);s[o]=d,s[o+1]=_,s[o+2]=d,s[o+3]=_,s[o+4]=d,s[o+5]=_,s[o+6]=d,s[o+7]=_,o+=8}}},{key:'beforeDraw',value:function beforeDraw(e){var o=this.gl;o.vertexAttribPointer(this._attrib('aTextureRes'),2,o.FLOAT,!1,this.getExtraAttribBytesPerVertex(),this.getVertexAttribPointerOffset(e))}},{key:'useDefault',value:function useDefault(){return 0===this._size[0]&&0===this._size[1]}},{key:'x',get:function get(){return this._size[0]},set:function set(e){this._size[0]=e,this.redraw()}},{key:'y',get:function get(){return this._size[1]},set:function set(e){this._size[1]=e,this.redraw()}},{key:'size',get:function get(){return this._size[0]},set:function set(e){this._size[0]=e,this._size[1]=e,this.redraw()}}]),o}(Shader);PixelateShader.vertexShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    attribute vec2 aTextureRes;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 vTextureRes;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        vTextureRes = aTextureRes;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n',PixelateShader.fragmentShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 vTextureRes;\n\n    uniform vec2 size;\n    uniform sampler2D uSampler;\n    \n    vec2 mapCoord( vec2 coord )\n    {\n        coord *= vTextureRes.xy;\n        return coord;\n    }\n    \n    vec2 unmapCoord( vec2 coord )\n    {\n        coord /= vTextureRes.xy;\n        return coord;\n    }\n    \n    vec2 pixelate(vec2 coord, vec2 size)\n    {\n        return floor( coord / size ) * size;\n    }\n    \n    void main(void)\n    {\n        vec2 coord = mapCoord(vTextureCoord);\n        coord = pixelate(coord, size);\n        coord = unmapCoord(coord);\n        gl_FragColor = texture2D(uSampler, coord) * vColor;\n    }\n';var InversionShader=function(e){function o(){return _classCallCheck(this,o),_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).apply(this,arguments))}return _inherits(o,e),_createClass(o,[{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return o.fragmentShaderSource}}]),o}(Shader);InversionShader.fragmentShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    void main(void){\n        vec4 color = texture2D(uSampler, vTextureCoord);\n        color.rgb = 1.0 - color.rgb; \n        gl_FragColor = color * vColor;\n    }\n';var FxaaFilter=function(e){function o(e){return _classCallCheck(this,o),_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e))}return _inherits(o,e),_createClass(o,[{key:'getVertexShaderSource',value:function getVertexShaderSource(){return Filter.vertexShaderSource}},{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return o.fragmentShaderSource}}]),o}(Filter);FxaaFilter.fxaa='\n    #ifndef FXAA_REDUCE_MIN\n        #define FXAA_REDUCE_MIN   (1.0/ 128.0)\n    #endif\n    #ifndef FXAA_REDUCE_MUL\n        #define FXAA_REDUCE_MUL   (1.0 / 8.0)\n    #endif\n    #ifndef FXAA_SPAN_MAX\n        #define FXAA_SPAN_MAX     8.0\n    #endif\n    \n    //optimized version for mobile, where dependent \n    //texture reads can be a bottleneck\n    vec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\n            vec2 v_rgbNW, vec2 v_rgbNE, \n            vec2 v_rgbSW, vec2 v_rgbSE, \n            vec2 v_rgbM) {\n            \n        vec4 color;\n        vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\n        vec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\n        vec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\n        vec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\n        vec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\n        vec4 texColor = texture2D(tex, v_rgbM);\n        vec3 rgbM  = texColor.xyz;\n        vec3 luma = vec3(0.299, 0.587, 0.114);\n        float lumaNW = dot(rgbNW, luma);\n        float lumaNE = dot(rgbNE, luma);\n        float lumaSW = dot(rgbSW, luma);\n        float lumaSE = dot(rgbSE, luma);\n        float lumaM  = dot(rgbM,  luma);\n        float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n        float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n        \n        vec2 dir;\n        dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n        dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n        \n        float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n                              (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n        \n        float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n        dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n                  max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n                  dir * rcpDirMin)) * inverseVP;\n        \n        vec3 rgbA = 0.5 * (\n            texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\n            texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n        vec3 rgbB = rgbA * 0.5 + 0.25 * (\n            texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\n            texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n    \n        float lumaB = dot(rgbB, luma);\n        if ((lumaB < lumaMin) || (lumaB > lumaMax))\n            color = vec4(rgbA, texColor.a);\n        else\n            color = vec4(rgbB, texColor.a);\n        return color;\n    }\n    \n    void texcoords(vec2 fragCoord, vec2 resolution,\n            out vec2 v_rgbNW, out vec2 v_rgbNE,\n            out vec2 v_rgbSW, out vec2 v_rgbSE,\n            out vec2 v_rgbM) {\n        \n        vec2 inverseVP = 1.0 / resolution.xy;\n        v_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\n        v_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\n        v_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\n        v_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\n        v_rgbM = vec2(fragCoord * inverseVP);\n    }\n    vec4 apply(sampler2D tex, vec2 fragCoord, vec2 resolution) {\n        vec2 v_rgbNW;\n        vec2 v_rgbNE;\n        vec2 v_rgbSW;\n        vec2 v_rgbSE;\n        vec2 v_rgbM;\n    \n        //compute the texture coords\n        texcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n        \n        //compute FXAA\n        return fxaa(tex, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n    }    \n',FxaaFilter.fragmentShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    \n    '+FxaaFilter.fxaa+'\n    \n    uniform vec2 resolution;\n    uniform sampler2D uSampler;\n    void main(void){\n        gl_FragColor = apply(uSampler, gl_FragCoord.xy, resolution);\n    }\n    \n';var InversionFilter=function(e){function o(e){return _classCallCheck(this,o),_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e))}return _inherits(o,e),_createClass(o,[{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return o.fragmentShaderSource}}]),o}(Filter);InversionFilter.fragmentShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    uniform sampler2D uSampler;\n    void main(void){\n        vec4 color = texture2D(uSampler, vTextureCoord);\n        color.rgb = 1.0 - color.rgb; \n        gl_FragColor = color;\n    }\n';var BlurFilter=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return s.ctx=e,s._kernelRadius=1,s._steps=[],s.steps=1,s}return _inherits(o,e),_createClass(o,[{key:'useDefault',value:function useDefault(){return 0===this._size||0===this._kernelRadius}},{key:'getFilters',value:function getFilters(){return this._steps}},{key:'kernelRadius',get:function get(){return this._kernelRadius},set:function set(e){this._kernelRadius=e,this._steps.forEach(function(o){return o._kernelRadius=e}),this.redraw()}},{key:'steps',get:function get(){return this._size},set:function set(e){this._size=Math.round(e);var o=this._steps.length/2;if(o<this._size){for(var s,n=[],l=o+1;l<=this._size;l++)s=new LinearBlurFilter(this.ctx),s._direction[0]=l,s._kernelRadius=this._kernelRadius,n.push(s),s=new LinearBlurFilter(this.ctx),s._kernelRadius=this._kernelRadius,s._direction[1]=l,n.push(s);this._steps=this._steps.concat(add),this.redraw()}else if(o>this._size){var d=o-this._size;this._steps.splice(2*-d),this.redraw()}}}]),o}(Filter),LinearBlurFilter=function(e){function o(e){_classCallCheck(this,o);var s=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,e));return s._direction=new Float32Array([0,0]),s._kernelRadius=1,s}return _inherits(o,e),_createClass(o,[{key:'getFragmentShaderSource',value:function getFragmentShaderSource(){return o.fragmentShaderSource}},{key:'setupUniforms',value:function setupUniforms(e){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),'setupUniforms',this).call(this,e),this._setUniform('direction',this._direction,this.gl.uniform2fv),this._setUniform('kernelRadius',this._kernelRadius,this.gl.uniform1i)}},{key:'x',get:function get(){return this._direction[0]},set:function set(e){this._direction[0]=e,this.redraw()}},{key:'y',get:function get(){return this._direction[1]},set:function set(e){this._direction[1]=e,this.redraw()}},{key:'kernelRadius',get:function get(){return this._kernelRadius},set:function set(e){this._kernelRadius=e,this.redraw()}}]),o}(Filter);LinearBlurFilter.fragmentShaderSource='\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    uniform vec2 resolution;\n    varying vec2 vTextureCoord;\n    uniform sampler2D uSampler;\n    uniform vec2 direction;\n    uniform int kernelRadius;\n    \n    vec4 blur1(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n        vec4 color = vec4(0.0);\n        vec2 off1 = vec2(1.3333333333333333) * direction;\n        color += texture2D(image, uv) * 0.29411764705882354;\n        color += texture2D(image, uv + (off1 / resolution)) * 0.35294117647058826;\n        color += texture2D(image, uv - (off1 / resolution)) * 0.35294117647058826;\n        return color; \n    }\n    \n    vec4 blur2(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n        vec4 color = vec4(0.0);\n        vec2 off1 = vec2(1.3846153846) * direction;\n        vec2 off2 = vec2(3.2307692308) * direction;\n        color += texture2D(image, uv) * 0.2270270270;\n        color += texture2D(image, uv + (off1 / resolution)) * 0.3162162162;\n        color += texture2D(image, uv - (off1 / resolution)) * 0.3162162162;\n        color += texture2D(image, uv + (off2 / resolution)) * 0.0702702703;\n        color += texture2D(image, uv - (off2 / resolution)) * 0.0702702703;\n        return color;\n    }\n    \n    vec4 blur3(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n        vec4 color = vec4(0.0);\n        vec2 off1 = vec2(1.411764705882353) * direction;\n        vec2 off2 = vec2(3.2941176470588234) * direction;\n        vec2 off3 = vec2(5.176470588235294) * direction;\n        color += texture2D(image, uv) * 0.1964825501511404;\n        color += texture2D(image, uv + (off1 / resolution)) * 0.2969069646728344;\n        color += texture2D(image, uv - (off1 / resolution)) * 0.2969069646728344;\n        color += texture2D(image, uv + (off2 / resolution)) * 0.09447039785044732;\n        color += texture2D(image, uv - (off2 / resolution)) * 0.09447039785044732;\n        color += texture2D(image, uv + (off3 / resolution)) * 0.010381362401148057;\n        color += texture2D(image, uv - (off3 / resolution)) * 0.010381362401148057;\n        return color;\n    }    \n\n    void main(void){\n        if (kernelRadius == 0) {\n            gl_FragColor = texture2D(uSampler, vTextureCoord);\n        } else if (kernelRadius == 1) {\n            gl_FragColor = blur1(uSampler, vTextureCoord, resolution, direction);\n        } else if (kernelRadius == 2) {\n            gl_FragColor = blur2(uSampler, vTextureCoord, resolution, direction);\n        } else {\n            gl_FragColor = blur3(uSampler, vTextureCoord, resolution, direction);\n        }\n    }\n';
