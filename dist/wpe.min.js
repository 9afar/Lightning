function Events(){}function EE(t,e,i){this.fn=t,this.context=e,this.once=i||!1}function EventEmitter(){this._events=new Events,this._eventsCount=0}function Stage(t,e){EventEmitter.call(this),this.adapter=t.adapter,this.adapter||isNode||(this.adapter=new WebAdapter),this.adapter.stage=this;var i=t&&t.w,o=t&&t.h;i&&o||(i=1280,o=720),this.w=i,this.h=o,this.reuseCanvas=t&&t.reuseCanvas||null,this.renderWidth=t&&t.rw||this.w,this.renderHeight=t&&t.rh||this.h,this.textureMemory=t&&t.textureMemory||12e6,t&&t.hasOwnProperty("glClearColor")?this.setGlClearColor(t.glClearColor):this.setGlClearColor(this.adapter.glClearColor||[0,0,0,0]),this.defaultFontFace=t&&t.defaultFontFace||"Arial",this.defaultPrecision=t&&t.defaultPrecision||this.h/this.renderHeight,this.fixedDt=t&&t.fixedDt||0,this.frameCounter=0,this.useTextureAtlas=!(!t||!t.hasOwnProperty("useTextureAtlas"))&&t.useTextureAtlas,this.useTextureAtlas&&console.log("Using texture atlas."),this.debugTextureAtlas=!!(this.useTextureAtlas&&t&&t.hasOwnProperty("debugTextureAtlas"))&&t.debugTextureAtlas,this.debugTextureAtlas&&console.log("Showing texture atlas for debug."),this.renderer=new Renderer(this,i,o),this.textureManager=new TextureManager(this,this.renderer.gl),this.textureAtlas=this.useTextureAtlas?new TextureAtlas(this,this.renderer.gl):null,this.state=Stage.STATES.IDLE,this.root=this.c(),this.root.active=!0,this.root.setAsRoot(),this.dt=0,this.activeTransitions=new Set,this.activeAnimations=new Set,this.measure=!!t.measure,this.measureDetails=!!t.measureDetails,this.measureFrameDistribution=!!t.measureFrameDistribution,this.measureInnerFrameDistribution=!!t.measureInnerFrameDistribution,this.measureLongFrames=!!t.measureLongFrames,this.textureProcessOptions=t.textureProcessOptions||{},this.useTextureProcessImageFetching=!1!==t.useTextureProcessImageFetching,this.useTextureProcessTextGeneration=!1!==t.useTextureProcessTextGeneration,this.useTextureProcess=!!t.useTextureProcess&&!!this.adapter.getTextureProcess,this.useTextureProcess&&(this.textureProcess=this.adapter.getTextureProcess(),this.textureProcess||console.warn("Texture process not supported")),this.measureStart={},this.measureTotalMs={},this.measureMs={},this.measureLastFrameCounter={},this.measureCount={},this.rectangleTexture=this.texture(Stage.rectangleSource.src,Stage.rectangleSource),this.adapter.setStage&&this.adapter.setStage(this),this.uComponentContext=this.adapter.getUComponentContext(),this.zIndexUsage=0,this.profile=new Array(60),this.innerProfile=new Array(10),this.profileLast=0,this.longFrameComponents={lastFrameStart:0,lastFrameEnd:0,text:0,uploadRaw:0,uploadImage:0};var r=this;this.drawingCanvasFactory=function(){return r.adapter.getDrawingCanvas()},this.destroyed=!1,this.init(e)}function TextureManager(t,e){this.stage=t,this.gl=e,this.textureMemory=t.textureMemory,this.usedTextureMemory=0,this.uploadedTextureSources=[],this.textureSourceHashmap=new Map,this.textureSourceIdHashmap=new Map}function Texture(t,e){this.manager=t,this.id=++Texture.id,this.source=e,this.components=new Set}function TextureAtlas(t,e){this.stage=t,this.w=2048,this.h=2048,this.activeTree=new TextureAtlasTree(this.w,this.h),this.activeTextureSources=new Set,this.addedTextureSources=new Set,this.wastedPixels=0,this.lastImportFrame=0,this.gl=e,this.vertexShaderSrc=["#ifdef GL_ES","precision lowp float;","#endif","attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","uniform mat4 projectionMatrix;","varying vec2 vTextureCoord;","void main(void){","    gl_Position = projectionMatrix * vec4(aVertexPosition, 0.0, 1.0);","    vTextureCoord = aTextureCoord;","}"].join("\n"),this.fragmentShaderSrc=["#ifdef GL_ES","precision lowp float;","#endif","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","void main(void){","    gl_FragColor = texture2D(uSampler, vTextureCoord);","}"].join("\n"),this.program=null,this.lastDefragFrame=0,this.pixelsLimit=this.w*this.h/32,this.minWastedPixels=this.w*this.h/8,this.defragNeeded=!1,this.uploads=[],this.projectionMatrix=new Float32Array([2/this.w,0,0,0,0,2/this.h,0,0,0,0,1,0,-1,-1,0,1]),this.initShaderProgram();var e=this.gl;if(this.texture=this.gl.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.w,this.h,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array(this.w*this.h*4)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),this.framebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0),e.getError()!=e.NO_ERROR)throw"Some WebGL error occurred while trying to create framebuffer.";e.bindFramebuffer(e.FRAMEBUFFER,null);var i=e.getUniformLocation(this.program,"projectionMatrix");e.uniformMatrix4fv(i,!1,this.projectionMatrix)}function TextureAtlasTree(t,e){this.w=t,this.h=e,this.root={x:0,y:0,w:t,h:e},this.spaces=new Set([this.root]),this.maxH=e}function ComponentText(t){this.stage=t.stage,this.component=t,this.settings=new TextRendererSettings,this.updateTexture()}function TextRenderer(t,e){this.drawingCanvasFactory=t,this.settings=e,this.canvas=null,this.context=null}function GenericTransition(t){EventEmitter.call(this),this.startValue=t,this.targetValue=this.startValue,this.timingFunction="ease"}function Transition(t,e){this.component=t,this.property=e,this.setting=Component.SETTINGS[e],GenericTransition.call(this,this.setting.g(this.component)),this.mergeFunction=this.setting.m,this.valueSetterFunction=this.setting.sf}function GenericAnimation(t){this.stage=t,this.actions=[]}function AnimationAction(t){this.animation=t,this._tags=[],this._items=new AnimationActionItems(this),this._properties=[]}function Renderer(t,e,i){this.stage=t,this.w=e,this.h=i,this.gl=t.adapter.getWebGLRenderingContext(e,i),this.program=null,this.vertexShaderSrc=["#ifdef GL_ES","precision lowp float;","#endif","attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute vec4 aColor;","uniform mat4 projectionMatrix;","varying vec2 vTextureCoord;","varying vec4 vColor;","void main(void){","    gl_Position = projectionMatrix * vec4(aVertexPosition, 0.0, 1.0);","    vTextureCoord = aTextureCoord;","    vColor = aColor;","}"].join("\n"),this.fragmentShaderSrc=["#ifdef GL_ES","precision lowp float;","#endif","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D uSampler;","void main(void){","    gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;","}"].join("\n"),this.projectionMatrix=new Float32Array([2/this.stage.renderWidth,0,0,0,0,-2/this.stage.renderHeight,0,0,0,0,1,0,-1,1,0,1]),this.paramsGlBuffer=null,this.program=null,this.vertexPositionAttribute=null,this.textureCoordAttribute=null,this.colorAttribute=null,this.indicesGlBuffer=null,this.frameCounter=0,this.initShaderProgram()}var has=Object.prototype.hasOwnProperty,prefix="~";Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(prefix=!1)),EventEmitter.prototype.eventNames=function(){var t,e,i=[];if(0===this._eventsCount)return i;for(e in t=this._events)has.call(t,e)&&i.push(prefix?e.slice(1):e);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(t)):i},EventEmitter.prototype.listeners=function(t,e){var i=prefix?prefix+t:t,o=this._events[i];if(e)return!!o;if(!o)return[];if(o.fn)return[o.fn];for(var r=0,s=o.length,n=new Array(s);r<s;r++)n[r]=o[r].fn;return n},EventEmitter.prototype.emit=function(t,e,i,o,r,s){var n=prefix?prefix+t:t;if(!this._events[n])return!1;var h,a,p=this._events[n],l=arguments.length;if(p.fn){switch(p.once&&this.removeListener(t,p.fn,void 0,!0),l){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,e),!0;case 3:return p.fn.call(p.context,e,i),!0;case 4:return p.fn.call(p.context,e,i,o),!0;case 5:return p.fn.call(p.context,e,i,o,r),!0;case 6:return p.fn.call(p.context,e,i,o,r,s),!0}for(a=1,h=new Array(l-1);a<l;a++)h[a-1]=arguments[a];p.fn.apply(p.context,h)}else{var u,c=p.length;for(a=0;a<c;a++)switch(p[a].once&&this.removeListener(t,p[a].fn,void 0,!0),l){case 1:p[a].fn.call(p[a].context);break;case 2:p[a].fn.call(p[a].context,e);break;case 3:p[a].fn.call(p[a].context,e,i);break;case 4:p[a].fn.call(p[a].context,e,i,o);break;default:if(!h)for(u=1,h=new Array(l-1);u<l;u++)h[u-1]=arguments[u];p[a].fn.apply(p[a].context,h)}}return!0},EventEmitter.prototype.on=function(t,e,i){var o=new EE(e,i||this),r=prefix?prefix+t:t;return this._events[r]?this._events[r].fn?this._events[r]=[this._events[r],o]:this._events[r].push(o):(this._events[r]=o,this._eventsCount++),this},EventEmitter.prototype.once=function(t,e,i){var o=new EE(e,i||this,!0),r=prefix?prefix+t:t;return this._events[r]?this._events[r].fn?this._events[r]=[this._events[r],o]:this._events[r].push(o):(this._events[r]=o,this._eventsCount++),this},EventEmitter.prototype.removeListener=function(t,e,i,o){var r=prefix?prefix+t:t;if(!this._events[r])return this;if(!e)return 0==--this._eventsCount?this._events=new Events:delete this._events[r],this;var s=this._events[r];if(s.fn)s.fn!==e||o&&!s.once||i&&s.context!==i||(0==--this._eventsCount?this._events=new Events:delete this._events[r]);else{for(var n=0,h=[],a=s.length;n<a;n++)(s[n].fn!==e||o&&!s[n].once||i&&s[n].context!==i)&&h.push(s[n]);h.length?this._events[r]=1===h.length?h[0]:h:0==--this._eventsCount?this._events=new Events:delete this._events[r]}return this},EventEmitter.prototype.removeAllListeners=function(t){var e;return t?(e=prefix?prefix+t:t,this._events[e]&&(0==--this._eventsCount?this._events=new Events:delete this._events[e])):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prototype.setMaxListeners=function(){return this},EventEmitter.prefixed=prefix,EventEmitter.EventEmitter=EventEmitter,"undefined"!=typeof module&&(module.exports=EventEmitter);var TextureProcess=function(t){this.workerPath=t,this.queue=new Map,this.worker=null};TextureProcess.prototype.init=function(t,e){if(this.options=t,!window.Worker)return e(new Error("Browser does not have Worker support."));try{var i=this.workerPath+"wpe-texture-worker.js";this.worker=new Worker(i)}catch(t){return console.error("Error starting web worker",t),e(t)}var o=this;this.worker.onmessage=function(t){o.receiveMessage(t)};var r=window.location.href,s=r.lastIndexOf("/");-1!==s&&(r=r.substr(0,s+1)),this.worker.postMessage({baseUrl:r,textServer:this.options.textServer}),console.log("Connected to texture Worker. Support: JPG and PNG."),e()},TextureProcess.prototype.isConnected=function(){return null!==this.worker},TextureProcess.prototype.destroy=function(){this.worker&&this.worker.terminate()},TextureProcess.prototype.receiveMessage=function(t){var e,i=t.data;if(this.textureMetaInfo){var o=t.data,r={w:this.textureMetaInfo.w,h:this.textureMetaInfo.h,premultiplyAlpha:!1,flipBlueRed:!1};this.textureMetaInfo.renderInfo&&(r.renderInfo=this.textureMetaInfo.renderInfo);var s=this.textureMetaInfo.id;this.textureMetaInfo=null,(e=this.queue.get(s))&&(this.queue.delete(s),e.cb(null,o,r))}else i.m?this.textureMetaInfo=i:i.err&&(e=this.queue.get(i.id))&&(this.queue.delete(i.id),e.cb(i.err))},TextureProcess.prototype.send=function(t,e,i){this.worker.postMessage({id:t,type:e,data:i})},TextureProcess.prototype.sendCancel=function(t){this.worker.postMessage({id:t,cancel:!0})},TextureProcess.prototype.loadTextureSourceString=function(t,e,i){return 0!==t.indexOf("data:")&&(this.hasNativeSupport?(this.add(0,t,e,i),e.cancelCb=this.cancel.bind(this),!0):(-1!==t.toLowerCase().indexOf(".jpg")||-1!==t.toLowerCase().indexOf(".png"))&&(this.add(0,t,e,i),e.cancelCb=this.cancel.bind(this),!0))},TextureProcess.prototype.loadText=function(t,e,i){return!!this.options.textServer&&(this.add(1,JSON.stringify(t.getRenderNonDefaults()),e,i),e.cancelCb=this.cancel.bind(this),!0)},TextureProcess.prototype.add=function(t,e,i,o){this.send(i.id,t,e),this.queue.set(i.id,{type:t,src:e,ts:i,cb:o})},TextureProcess.prototype.cancel=function(t){this.sendCancel(t.id);var e=this.queue.get(t.id);e&&e.cb&&(e.cb(null,null),this.queue.delete(t.id))};var isNode=!("undefined"==typeof module||!module.exports),Utils={};Utils.extendClass=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.parentConstructor=e},Utils.isFunction=function(t){return"function"==typeof t},Utils.isNumber=function(t){return"number"==typeof t},Utils.isInteger=function(t){return"number"==typeof t&&t%1==0},Utils.isBoolean=function(t){return!0===t||!1===t},Utils.isString=function(t){return"string"==typeof t},Utils.isArray=Array.isArray,Utils.cloneObj=function(t){for(var e=Object.keys(t),i={},o=0;o<e.length;o++)i[e[o]]=t[e[o]];return i},Utils.merge=function(t,e){for(var i=Object.keys(e),o=0;o<i.length;o++)t[i[o]]=e[i[o]];return t},Utils.isObject=function(t){var e=typeof t;return!!t&&("object"==e||"function"==e)},Utils.isPlainObject=function(t){var e=typeof t;return!!t&&"object"==e},Utils.getArrayIndex=function(t,e){return Utils.getModuloIndex(t,e.length)},Utils.getModuloIndex=function(t,e){if(0==e)return t;for(;t<0;)t+=Math.ceil(-t/e)*e;return t%=e},Utils.getDeepClone=function(t){var e,i;if(Utils.isFunction(t))return t;if(Utils.isArray(t)){i=[];o=Object.keys(t);for(e=0;e<o.length;e++)i[o[e]]=Utils.getDeepClone(t[o[e]]);return i}if(Utils.isObject(t)){i={};var o=Object.keys(t);for(e=0;e<o.length;e++)i[o[e]]=Utils.getDeepClone(t[o[e]]);return i}return t},Utils.setToArray=function(t){var e=[];return t.forEach(function(t){e.push(t)}),e},Utils.iteratorToArray=function(t){for(var e=[],i=t.next();!i.done;)e.push(i.value),i=t.next();return e},Utils.async={parallel:function(t,e){var i,o=t.length,r=!1,s=o,n=[];for(i=0;i<o;i++)!function(i){t[i](function(t,o){n[i]=o,t?r||(e(t),r=!0):0!=--s||r||(e(null,n),r=!0)})}(i)}},Utils.extendClass(Stage,EventEmitter),Stage.prototype.destroy=function(){this.adapter.stopAnimationLoop(),this.useTextureAtlas&&this.textureAtlas.destroy(),this.textureProcess&&this.textureProcess.destroy(),this.renderer.destroy(),this.textureManager.destroy(),this.destroyed=!0},Stage.prototype.setGlClearColor=function(t){Array.isArray(t)?this.glClearColor=t:this.glClearColor=StageUtils.getRgbaComponentsNormalized(t)},Stage.prototype.getCanvas=function(){return this.adapter.canvas},Stage.prototype.getTextRendererAdapter=function(){return this.textRendererAdapter},Stage.prototype.timeStart=function(t){this.measureCount[t]++,this.frameCounter!=this.measureLastFrameCounter[t]&&(this.measureLastFrameCounter[t]=this.frameCounter,this.measureTotalMs[t]+=this.measureMs[t],this.frameCounter%100==0&&(console.log(t+": "+(this.measureTotalMs[t]/100-("global"==t?4.5:0)).toFixed(3)+" ("+this.measureCount[t]/100+")"),this.measureTotalMs[t]=0,this.measureCount[t]=0),this.measureMs[t]=0),this.measureStart[t]=this.adapter.getHrTime()},Stage.prototype.timeEnd=function(t){var e=this.adapter.getHrTime();this.measureMs[t]+=e-this.measureStart[t]},Stage.prototype.stop=function(){this.adapter.stopAnimationLoop()},Stage.prototype.resume=function(){this.adapter.startAnimationLoop()},Stage.prototype.init=function(t){this.adapter.init&&this.adapter.init();var e=this,i=this.getRectangleTexture(),o=i.source;o.onload=function(){o.permanent=!0,e.useTextureAtlas&&e.textureAtlas.add(o),e.useTextureProcess?(console.log("Texture process config (text:"+(e.useTextureProcessTextGeneration?"yes":"no")+", image:"+(e.useTextureProcessImageFetching?"yes":"no")+")."),e.textureProcess.init(e.textureProcessOptions,function(i){i&&console.warn("Error connecting to texture process. Textures will be loaded on the main thread."),e.adapter.startAnimationLoop(function(){e.drawFrame()}),t&&t(e)})):(e.adapter.startAnimationLoop(function(){e.drawFrame()}),t&&t(e))},i.load()},Stage.prototype.getRectangleTexture=function(){return this.rectangleTexture},Stage.prototype.addActiveTransition=function(t){this.activeTransitions.add(t)},Stage.prototype.addActiveAnimation=function(t){this.activeAnimations.add(t)},Stage.prototype.drawFrame=function(){if(this.measureLongFrames&&this.logMeasureLongFrames(),this.measureFrameDistribution||this.measureInnerFrameDistribution){var t=this.adapter.getHrTime();if(this.profileLast&&this.measureFrameDistribution&&((e=Math.max(Math.round((t-this.profileLast)/16.6667)-1,0))>19&&(e=19),this.profile[e]++,this.frameCounter%100==0)){console.log("F "+this.profile.join(" "));for(i=0;i<20;i++)this.profile[i]=0}this.profileLast=t}if(this.measure&&this.timeStart("total"),this.fixedDt?this.dt=this.fixedDt:this.dt=this.startTime?.001*(this.currentTime-this.startTime):.02,this.startTime=this.currentTime,this.currentTime=(new Date).getTime(),this.measureDetails&&this.timeStart("frame start"),this._eventsCount&&this.emit("frameStart"),this.measureDetails&&this.timeEnd("frame start"),this.state=Stage.STATES.TRANSITIONS,t=this.adapter.getHrTime(),this.measureDetails&&this.timeStart("transitions"),this.progressTransitions(),this.measureDetails&&this.timeEnd("transitions"),this.state=Stage.STATES.ANIMATIONS,this.measureDetails&&this.timeStart("animations"),this.progressAnimations(),this.measureDetails&&this.timeEnd("animations"),this.measureDetails&&this.timeStart("update"),this.state=Stage.STATES.UPDATE,this._eventsCount&&this.emit("update"),this.measureDetails&&this.timeEnd("update"),this.textureManager.isFull()&&(console.log("clean up"),this.textureManager.freeUnusedTextureSources()),this.textureProcess&&this.textureProcess.process&&this.textureProcess.process(),this.measureDetails&&this.timeStart("perform updates"),this.performUpdates(),this.measureDetails&&this.timeEnd("perform updates"),this.measureLongFrames&&(this.longFrameComponents.lastFrameEnd=this.getHrTime()),this.renderNeeded&&(this.measureDetails&&this.timeStart("render"),this.renderer.render(),this.measureDetails&&this.timeEnd("render")),this.state=Stage.STATES.IDLE,this.measureDetails&&this.timeStart("frame end"),this._eventsCount&&this.emit("frameEnd"),this.measureDetails&&this.timeEnd("frame end"),this.measure&&this.timeEnd("total"),this.adapter.nextFrame(this.renderNeeded),this.measureInnerFrameDistribution){t=this.adapter.getHrTime()-this.profileLast;var e=Math.max(Math.round(t/16.66667)-1,0);if(e>19&&(e=19),this.innerProfile[e]++,this.frameCounter%100==0){console.log("I "+this.innerProfile.join(" "));for(var i=0;i<20;i++)this.innerProfile[i]=0}}this.frameCounter++},Stage.prototype.logMeasureLongFrames=function(){var t=0,e=0;this.longFrameComponents.lastFrameEnd?(e=this.longFrameComponents.lastFrameEnd-this.longFrameComponents.lastFrameStart,this.longFrameComponents.lastFrameStart=this.getHrTime(),t=this.longFrameComponents.lastFrameStart-this.longFrameComponents.lastFrameEnd):this.longFrameComponents.lastFrameStart=this.getHrTime();var i=e-(this.longFrameComponents.text+this.longFrameComponents.uploadRaw+this.longFrameComponents.uploadImage),o=" ["+this.longFrameComponents.nText+","+this.longFrameComponents.nUploadRaw+","+this.longFrameComponents.nUploadImage+"]";console.log(o+this.repeatChar(" ",12-o.length)+this.repeatChar("T",Math.round(this.longFrameComponents.text))+this.repeatChar("R",Math.round(this.longFrameComponents.uploadRaw))+this.repeatChar("I",Math.round(this.longFrameComponents.uploadImage))+this.repeatChar("O",Math.round(i))+this.repeatChar(".",Math.round(t))),this.longFrameComponents.text=0,this.longFrameComponents.uploadRaw=0,this.longFrameComponents.uploadImage=0,this.longFrameComponents.nText=0,this.longFrameComponents.nUploadRaw=0,this.longFrameComponents.nUploadImage=0},Stage.prototype.repeatChar=function(t,e){str="";for(var i=0;i<e;i++)str+=t;return str},Stage.prototype.getHrTime=function(){return this.adapter.getHrTime()},Stage.prototype.progressTransitions=function(){var t=this;this.activeTransitions.size&&this.activeTransitions.forEach(function(e){e.component.attached&&e.isActive()?e.progress(t.dt):t.activeTransitions.delete(e)})},Stage.prototype.progressAnimations=function(){var t=this;this.activeAnimations.size&&this.activeAnimations.forEach(function(e){e.subject&&e.subject.attached&&e.isActive()?(e.progress(t.dt),e.applyTransforms()):t.activeAnimations.delete(e)})},Stage.prototype.performUpdates=function(){this.useTextureAtlas&&this.textureAtlas.flush();var t=this.adapter.getUComponentContext();this.renderNeeded=t.updateAndFillVbo(this.zIndexUsage>0)},Stage.prototype.texture=function(t,e){return this.textureManager.getTexture(t,e)},Stage.prototype.component=function(t){var e=new Component(this);return t&&e.set(t),e},Stage.prototype.c=function(t){var e=new Component(this);return t&&e.set(t),e},Stage.prototype.animation=function(t){var e=new Animation(this);return t&&e.set(t),e},Stage.STATES={IDLE:0,TRANSITIONS:1,ANIMATIONS:2,UPDATE:3,RENDER:4},Stage.componentId=0,Stage.rectangleSource={src:function(t){return t(null,new Uint8Array([255,255,255,255]),{w:1,h:1})},id:"__whitepix"},Stage.W=1280,Stage.H=720;var StageUtils={};StageUtils.mergeNumbers=function(t,e,i){return t*i+e*(1-i)},StageUtils.rgb=function(t,e,i){return(t<<16)+(e<<8)+i+4278190080},StageUtils.rgba=function(t,e,i,o){return(t<<16)+(e<<8)+i+16777216*(255*o|0)},StageUtils.getRgbaString=function(t){return"rgba("+(t/65536|0)%256+","+(t/256|0)%256+","+t%256+","+((t/16777216|0)/255).toFixed(4)+")"},StageUtils.getRgbaComponentsNormalized=function(t){return[.003921569*((t/65536|0)%256),.003921569*((t/256|0)%256),.003921569*(t%256),.003921569*(t/16777216|0)]},StageUtils.getRgbaComponents=function(t){return[(t/65536|0)%256,(t/256|0)%256,t%256,t/16777216|0]},StageUtils.getArgbNumber=function(t){t[0]=Math.max(0,Math.min(255,t[0])),t[1]=Math.max(0,Math.min(255,t[1])),t[2]=Math.max(0,Math.min(255,t[2])),t[3]=Math.max(0,Math.min(255,t[3]));var e=((0|t[3])<<24)+((0|t[0])<<16)+((0|t[1])<<8)+(0|t[2]);return e<0&&(e=4294967295+e+1),e},StageUtils.mergeColors=function(t,e,i){return 16777216*((t/16777216|0)*i+(e/16777216|0)*(1-i)|0)+65536*((t/65536|0)%256*i+(e/65536|0)%256*(1-i)|0)+256*((t/256|0)%256*i+(e/256|0)%256*(1-i)|0)+(t%256*i+e%256*(1-i)|0)},StageUtils.mergeMultiColors=function(t,e){for(var i=0,o=0,r=0,s=0,n=0,h=t.length,a=0;a<h;a++){var p=(t[a]/65536|0)%256,l=(t[a]/256|0)%256,u=t[a]%256,c=t[a]/16777216|0;i+=p*e[a],o+=l*e[a],r+=u*e[a],s+=c*e[a],n+=e[a]}return n=1/n,16777216*(s*n|0)+65536*(i*n|0)+256*(o*n|0)+(r*n|0)},StageUtils.mergeMultiColorsEqual=function(t){for(var e=0,i=0,o=0,r=0,s=0,n=t.length,h=0;h<n;h++)e+=(t[h]/65536|0)%256,i+=(t[h]/256|0)%256,o+=t[h]%256,r+=t[h]/16777216|0,s+=1;return s=1/s,16777216*(r*s|0)+65536*(e*s|0)+256*(i*s|0)+(o*s|0)},StageUtils.rad=function(t){return t*(Math.PI/180)},StageUtils.getTimingBezier=function(t,e,i,o){var r=3*t,s=3*(i-t)-r,n=1-r-s,h=3*e,a=3*(o-e)-h,p=1-h-a;return function(t){if(t>=1)return 1;if(t<=0)return 0;for(var e,i,o,l=.5,u=0;u<20;u++){if(e=l*(l*(l*n+s)+r),(o=t-e)>-1e-8&&o<1e-8)return l*(l*(l*p+a)+h);if((i=l*(l*(3*n)+2*s)+r)>1e-10&&i<1e-10)break;l+=o/i}var c=0,d=1;for(u=0;u<20;u++){if(l=.5*(c+d),e=l*(l*(l*n+s)+r),(o=t-e)>-1e-8&&o<1e-8)return l*(l*(l*p+a)+h);o<0?d=l:c=l}}},StageUtils.getTimingFunction=function(t){switch(t){case"linear":return function(t){return t};case"ease":return StageUtils.getTimingBezier(.25,.1,.25,1);case"ease-in":return StageUtils.getTimingBezier(.42,0,1,1);case"ease-out":return StageUtils.getTimingBezier(0,0,.58,1);case"ease-in-out":return StageUtils.getTimingBezier(.42,0,.58,1);case"step-start":return function(){return 1};case"step-end":return function(t){return 1===t?1:0};default:var e="cubic-bezier(";if(t&&0===t.indexOf(e)){var i=t.substr(e.length,t.length-e.length-1).split(",");if(4!==i.length)return console.warn("Unknown timing function: "+t),function(t){return t};var o=parseFloat(i[0]),r=parseFloat(i[1]),s=parseFloat(i[2]),n=parseFloat(i[3]);return isNaN(o)||isNaN(r)||isNaN(s)||isNaN(n)?(console.warn("Unknown timing function: "+t),function(t){return t}):StageUtils.getTimingBezier(o,r,s,n)}return console.warn("Unknown timing function: "+t),function(t){return t}}},StageUtils.getSplineValueFunction=function(t,e,i,o,r,s,n,h){var a=o-i;n*=a,h*=a;var p=StageUtils.getSplineHelpers(t,e,r,s,n,h);return p?function(i){return 0==i?t:1==i?e:StageUtils.calculateSpline(p,i)}:function(i){return 0==i?t:1==i?e:e*i+t*(1-i)}},StageUtils.getSplineRgbaValueFunction=function(t,e,i,o,r,s,n,h){var a=o-i;n[0]*=a,n[1]*=a,n[2]*=a,n[3]*=a,h[0]*=a,h[1]*=a,h[2]*=a,h[3]*=a;var p=StageUtils.getRgbaComponents(t),l=StageUtils.getRgbaComponents(e),u=[StageUtils.getSplineHelpers(p[0],l[0],r,s,n[0],h[0]),StageUtils.getSplineHelpers(p[1],l[1],r,s,n[1],h[1]),StageUtils.getSplineHelpers(p[2],l[2],r,s,n[2],h[2]),StageUtils.getSplineHelpers(p[3],l[3],r,s,n[3],h[3])];return u[0]?function(i){return 0==i?t:1==i?e:StageUtils.getArgbNumber([Math.min(255,StageUtils.calculateSpline(u[0],i)),Math.min(255,StageUtils.calculateSpline(u[1],i)),Math.min(255,StageUtils.calculateSpline(u[2],i)),Math.min(255,StageUtils.calculateSpline(u[3],i))])}:function(i){return 0==i?t:1==i?e:StageUtils.mergeColors(e,t,i)}},StageUtils.getSplineHelpers=function(t,e,i,o,r,s){if(!i&&!o)return null;var n=i,h=t+r*i,a=1-o,p=e-s*o;return[3*n-3*a+1,-6*n+3*a,3*n,3*h-3*p+e-t,3*(p+t)-6*h,3*(h-t),t]},StageUtils.calculateSpline=function(t,e){var i=t[0],o=t[1],r=t[2],s=t[3],n=t[4],h=t[5],a=t[6];if(-2==i&&-2==s&&0==r&&0==h)return e;for(var p,l,u=.5,c=0;c<20;c++){if(p=u*(u*(u*i+o)+r),(l=e-p)>-1e-8&&l<1e-8)return u*(u*(u*s+n)+h)+a;var d=u*(u*(3*i)+2*o)+r;if(d>1e-10&&d<1e-10)break;u+=l/d}var g=0,f=1;for(c=0;c<20;c++){if(u=.5*(g+f),p=u*(u*(u*i+o)+r),(l=e-p)>-1e-8&&l<1e-8)return u*(u*(u*s+n)+h)+a;l<0?f=u:g=u}return u};var GeometryUtils={};GeometryUtils.dotprod=function(t,e,i,o){return t*i+e*o},GeometryUtils.pointInConvex=function(t,e,i){var o,r,s,n;for(r=t.length,o=0;o<=t.length-2;o+=2)if(s=t[(o+2)%r]-t[o],n=t[(o+3)%r]-t[o+1],GeometryUtils.dotprod(e-t[o],i-t[o+1],-n,s)<=0)return!1;return!0},GeometryUtils.intersectConvex=function(t,e){var i,o,r,s;r=t.length;var n,h=e,a=!1;for(i=0;i<=r-2;i+=2){var p=t[(i+2)%r]-t[i],l=t[(i+3)%r]-t[i+1],u=Math.sqrt(p*p+l*l);p/=u,l/=u,s=h.length,n=[];var c,d,g,f,m;for(o=0;o<=s-2;o+=2){var T=h[o]-t[i],x=h[o+1]-t[i+1],y=GeometryUtils.dotprod(T,x,-l,p);if(m=y>=-1e-9,o>=2){if(f!=m){var C=GeometryUtils.dotprod(h[o-2]-t[i],h[o-1]-t[i+1],p,l),b=C-(w=((_=GeometryUtils.dotprod(T,x,p,l))-C)/(y-d))*d,S=t[i]+b*p,v=t[i+1]+b*l;n.push(S,v),a=!0}}else g=m,c=y;if(m&&n.push(h[o],h[o+1]),o==s-2&&m!=g){var A=GeometryUtils.dotprod(h[0]-t[i],h[1]-t[i+1],p,l),_=GeometryUtils.dotprod(T,x,p,l),w=(_-A)/(y-c),b=A-w*c,S=t[i]+b*p,v=t[i+1]+b*l;n.push(S,v),a=!0}f=m,d=y}h=n}if(h.length)return a?h:e;var P=t[0],O=t[0],R=t[1],E=t[1],U=t[0],L=t[1];for(i=2;i<=r-2;i+=2)U+=t[i],L+=t[i+1],t[i]<P&&(P=t[i]),t[i]>O&&(O=t[i]),t[i+1]<R&&(R=t[i+1]),t[i+1]>E&&(E=t[i+1]);U/=.5*r,L/=.5*r;var I=e[0],B=e[0],F=e[1],M=e[1];s=e.length;var D=e[0],j=e[1];for(i=2;i<=s-2;i+=2)D+=e[i],j+=e[i+1],e[i]<I&&(I=e[i]),e[i]>B&&(B=e[i]),e[i+1]<F&&(F=e[i+1]),e[i+1]>M&&(M=e[i+1]);if(D/=.5*s,j/=.5*s,GeometryUtils.pointInConvex(e,U,L)){if(GeometryUtils.pointInConvex(t,D,j)){if(I<P||F<R||B>O||M>E)return t;if(I>P||F>R||B<O||M<E)return e;for(i=0;i<=r-2;i+=2)if(!GeometryUtils.pointInConvex(e,t[i],t[i+1]))return e;return t}return t}return GeometryUtils.pointInConvex(t,D,j)?e:[]},TextureManager.prototype.destroy=function(){for(var t=0,e=this.uploadedTextureSources.length;t<e;t++){var i=this.uploadedTextureSources[t];this.gl.deleteTexture(i.glTexture)}},TextureManager.prototype.loadTextureSourceString=function(t,e,i,o){!i&&this.stage.useTextureProcess&&this.stage.textureProcess.isConnected()&&this.stage.useTextureProcessImageFetching?this.stage.textureProcess.loadTextureSourceString(t,e,o)||this.stage.adapter.loadTextureSourceString(t,e,o):this.stage.adapter.loadTextureSourceString(t,e,o)},TextureManager.prototype.loadText=function(t,e,i,o){!i&&this.stage.useTextureProcess&&this.stage.textureProcess.isConnected()&&this.stage.useTextureProcessTextGeneration?this.stage.textureProcess.loadText(t,e,o)||this.stage.adapter.loadText(t,e,o):this.stage.adapter.loadText(t,e,o)},TextureManager.prototype.getTexture=function(t,e){var i,o,r=e&&e.id||null;if(Utils.isString(t)){if(r=r||t,!(o=this.textureSourceHashmap.get(r))){var s=this;o=this.getTextureSource(function(e,i,o){s.loadTextureSourceString(t,i,o,e)},r)}}else(o=r?this.textureSourceHashmap.get(r):null)||(t instanceof TextureSource?o=t:(o=this.getTextureSource(t,r),r&&this.textureSourceHashmap.set(r,o)));return i=new Texture(this,o),i.x=e&&e.x||0,i.y=e&&e.y||0,i.w=e&&e.w||0,i.h=e&&e.h||0,i.clipping=!!(i.x||i.y||i.w||i.h),i.precision=e&&e.precision||1,i},TextureManager.prototype.getTextureSource=function(t,e){var i=e?this.textureSourceHashmap.get(e):null;return i||(i=new TextureSource(this,t),e&&(i.lookupId=e,this.textureSourceHashmap.set(e,i))),i},TextureManager.prototype.uploadTextureSource=function(t,e,i){if(!t.glTexture){var o=this.gl,r=o.createTexture();if(o.bindTexture(o.TEXTURE_2D,r),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),this.stage.measureLongFrames)var s=this.stage.getHrTime();this.stage.adapter.uploadGlTexture(o,t,e),this.stage.measureLongFrames&&(!isNode&&(e instanceof ImageData||e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||window.ImageBitmap&&e instanceof ImageBitmap)?(this.stage.longFrameComponents.uploadImage+=this.stage.getHrTime()-s,this.stage.longFrameComponents.nUploadImage++):(this.stage.longFrameComponents.uploadRaw+=this.stage.getHrTime()-s,this.stage.longFrameComponents.nUploadRaw++)),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),t.glTexture=r,this.usedTextureMemory+=t.w*t.h,this.uploadedTextureSources.push(t)}},TextureManager.prototype.isFull=function(){return this.usedTextureMemory>=this.textureMemory},TextureManager.prototype.freeUnusedTextureSources=function(){for(var t=[],e=this.usedTextureMemory,i=0,o=this.uploadedTextureSources.length;i<o;i++){var r=this.uploadedTextureSources[i];r.permanent||0!==r.components.size?t.push(r):this.freeTextureSource(r)}var s=this;this.textureSourceHashmap.forEach(function(t){t.permanent||0!==t.components.size||s.freeTextureSource(t)}),this.uploadedTextureSources=t,console.log("freed "+((e-this.usedTextureMemory)/1e6).toFixed(2)+"M texture pixels from GPU memory. Remaining: "+this.usedTextureMemory)},TextureManager.prototype.freeTextureSource=function(t){t.glTexture&&(this.usedTextureMemory-=t.w*t.h,this.gl.deleteTexture(t.glTexture),t.glTexture=null),t.loadingSince=null,t.lookupId&&this.textureSourceHashmap.delete(t.lookupId)},TextureManager.prototype.removeTextureSource=function(t){this.freeTextureSource(t),t.loadingSince=null,t.lookupId&&this.textureSourceHashmap.delete(t.lookupId)},Texture.prototype._x=0,Texture.prototype._y=0,Texture.prototype._w=0,Texture.prototype._h=0,Texture.prototype._precision=1,Texture.prototype.clipping=!1,Texture.prototype.addComponent=function(t){this.components.add(t),this.source.addComponent(t)},Texture.prototype.removeComponent=function(t,e){this.components.delete(t),e&&this.source.removeComponent(t)},Texture.prototype.enableClipping=function(t,e,i,o){this._x===t&&this._y===e&&this._w===i&&this._h===o||(this._x=t,this._y=e,this._w=i,this._h=o,this.updateClipping(!0))},Texture.prototype.disableClipping=function(){(this._x||this._y||this._w||this._h)&&(this._x=0,this._y=0,this._w=0,this._h=0,this.updateClipping(!1))},Texture.prototype.updateClipping=function(t){this.clipping=!0===t||!1===t?t:!!(this._x||this._y||this._w||this._h);var e=this;this.components.forEach(function(t){t.displayedTexture===e&&t.onDisplayedTextureClippingChanged()})},Texture.prototype.updatePrecision=function(){var t=this;this.components.forEach(function(e){e.displayedTexture===t&&e.onPrecisionChanged()})},Texture.prototype.replaceTextureSource=function(t){var e=new Set(this.components),i=this;this.source=t;var o=this.source;e.forEach(function(r){var s=e.displayedTexture&&e.displayedTexture!==i&&e.displayedTexture.source===o;(s=s||e.texture&&e.texture!==i&&e.texture.source===o)||o.removeComponent(r),t.addComponent(r),t.glTexture&&(r.displayedTexture=i)})},Texture.prototype.load=function(t){this.source.load(!1!==t)},Texture.prototype.free=function(){this.source.free()},Texture.prototype.set=function(t){for(var e=Object.keys(t),i=0;i<e.length;i++){var o=t[e[i]];this.setSetting(e[i],o)}},Texture.prototype.setSetting=function(t,e){var i=Texture.SETTINGS[t];i?i.s(this,e):console.warn("Unknown texture property: "+t)},Texture.prototype.getNonDefaults=function(){var t={};return 0!==this.x&&(t.x=this.x),0!==this.y&&(t.y=this.y),0!==this.w&&(t.w=this.w),0!==this.h&&(t.h=this.h),1!==this.precision&&(t.precision=this.precision),t},Object.defineProperty(Texture.prototype,"x",{get:function(){return this._x},set:function(t){this._x!==t&&(this._x=t,this.updateClipping())}}),Object.defineProperty(Texture.prototype,"y",{get:function(){return this._y},set:function(t){this._y!==t&&(this._y=t,this.updateClipping())}}),Object.defineProperty(Texture.prototype,"w",{get:function(){return this._w},set:function(t){this._w!==t&&(this._w=t,this.updateClipping())}}),Object.defineProperty(Texture.prototype,"h",{get:function(){return this._h},set:function(t){this._h!==t&&(this._h=t,this.updateClipping())}}),Object.defineProperty(Texture.prototype,"precision",{get:function(){return this._precision},set:function(t){this._precision!==t&&(this._precision=t,this.updatePrecision())}}),Texture.SETTINGS={x:{s:function(t,e){t.x=e},m:StageUtils.mergeNumbers},y:{s:function(t,e){t.y=e},m:StageUtils.mergeNumbers},w:{s:function(t,e){t.w=e},m:StageUtils.mergeNumbers},h:{s:function(t,e){t.h=e},m:StageUtils.mergeNumbers},precision:{s:function(t,e){t.precision=e},m:StageUtils.mergeNumbers}},Texture.id=0;var TextureSource=function(t,e){this.manager=t,this.stage=t.stage,this.id=++TextureSource.id,this.loadCb=e,this.components=new Set};TextureSource.prototype.lookupId=null,TextureSource.prototype.cancelCb=null,TextureSource.prototype.loadingSince=0,TextureSource.prototype.inTextureAtlas=!1,TextureSource.prototype.textureAtlasX=0,TextureSource.prototype.textureAtlasY=0,TextureSource.prototype.w=0,TextureSource.prototype.h=0,TextureSource.prototype.glTexture=null,TextureSource.prototype.permanent=!1,TextureSource.prototype.onload=null,TextureSource.prototype.renderInfo=null,TextureSource.prototype.getRenderWidth=function(){return this.w},TextureSource.prototype.getRenderHeight=function(){return this.h},TextureSource.prototype.addComponent=function(t){this.components.has(t)||(this.components.add(t),this.glTexture&&this.stage.useTextureAtlas&&this.stage.textureAtlas.addActiveTextureSource(this),1===this.components.size&&(this.manager.textureSourceIdHashmap.set(this.id,this),this.lookupId&&(this.manager.textureSourceHashmap.has(this.lookupId)||this.manager.textureSourceHashmap.set(this.lookupId,this)),this.becomesVisible()))},TextureSource.prototype.removeComponent=function(t){this.components.delete(t)&&(this.components.size||(this.stage.useTextureAtlas&&this.stage.textureAtlas.removeActiveTextureSource(this),this.manager.textureSourceIdHashmap.delete(this.id),this.becomesInvisible()))},TextureSource.prototype.becomesVisible=function(){this.load(!1)},TextureSource.prototype.becomesInvisible=function(){this.isLoading()&&this.cancelCb&&this.cancelCb(this)},TextureSource.prototype.load=function(t){if(this.isLoading()&&t&&(this.cancelCb&&this.cancelCb(this),this.loadingSince=0),!this.glTexture&&!this.isLoading()){var e=this;this.loadingSince=(new Date).getTime(),this.loadCb(function(t,i,o){e.manager.stage.destroyed||(e.loadingSince=0,t?e.onError(t):i&&e.setSource(i,o))},this,!!t)}},TextureSource.prototype.isLoading=function(){return this.loadingSince>0},TextureSource.prototype.setSource=function(t,e){if(this.w=t.width||e&&e.w||0,this.h=t.height||e&&e.h||0,this.w>2048||this.h>2048)console.error("Texture size too large: "+t.width+"x"+t.height+" (max allowed is 2048x2048)");else{e&&e.renderInfo&&(this.renderInfo=e.renderInfo);var i={premultiplyAlpha:!0,flipBlueRed:!1};e&&e.hasOwnProperty("premultiplyAlpha")&&(i.premultiplyAlpha=e.premultiplyAlpha),e&&e.hasOwnProperty("flipBlueRed")&&(i.flipBlueRed=e.flipBlueRed),this.manager.uploadTextureSource(this,t,i),this.onLoad()}},TextureSource.prototype.isVisible=function(){return this.components.size>0},TextureSource.prototype.onLoad=function(){this.isVisible()&&this.stage.useTextureAtlas&&this.stage.textureAtlas.addActiveTextureSource(this),this.components.forEach(function(t){t.onTextureSourceLoaded()}),this.onload&&this.onload(),this.onload=null},TextureSource.prototype.onError=function(t){console.error("texture load error",t,this.id),this.components.forEach(function(e){e.onTextureSourceLoadError(t)})},TextureSource.prototype.onAddedToTextureAtlas=function(t,e){this.inTextureAtlas=!0,this.textureAtlasX=t,this.textureAtlasY=e,this.components.forEach(function(t){t.onTextureSourceAddedToTextureAtlas()})},TextureSource.prototype.onRemovedFromTextureAtlas=function(){this.inTextureAtlas=!1,this.components.forEach(function(t){t.onTextureSourceRemovedFromTextureAtlas()})},TextureSource.prototype.free=function(){this.manager.freeTextureSource(this)},TextureSource.id=0,TextureAtlas.prototype.destroy=function(){this.gl.deleteTexture(this.texture),this.gl.deleteFramebuffer(this.framebuffer),this.gl.deleteBuffer(this.paramsGlBuffer),this.gl.deleteBuffer(this.indicesGlBuffer),this.gl.deleteProgram(this.program)},TextureAtlas.prototype.initShaderProgram=function(){var t=this.gl,e=this.glCompile(t.VERTEX_SHADER,this.vertexShaderSrc),i=this.glCompile(t.FRAGMENT_SHADER,this.fragmentShaderSrc);this.program=t.createProgram(),t.attachShader(this.program,e),t.attachShader(this.program,i),t.linkProgram(this.program),t.getProgramParameter(this.program,t.LINK_STATUS)||(console.error("Error: Could not initialize shader."),console.error("gl.VALIDATE_STATUS",t.getProgramParameter(this.program,t.VALIDATE_STATUS)),console.error("gl.getError()",t.getError()),""!==t.getProgramInfoLog(this.program)&&console.warn("Warning: gl.getProgramInfoLog()",t.getProgramInfoLog(this.program)),t.deleteProgram(this.program),this.program=null),t.useProgram(this.program),t.deleteShader(e),t.deleteShader(i),this.vertexPositionAttribute=t.getAttribLocation(this.program,"aVertexPosition"),this.textureCoordAttribute=t.getAttribLocation(this.program,"aTextureCoord"),this.paramsBuffer=new ArrayBuffer(576e3),this.allCoords=new Float32Array(this.paramsBuffer),this.allTexCoords=new Float32Array(this.paramsBuffer),this.allIndices=new Uint16Array(54e3);for(var o=0,r=0;o<54e3;o+=6,r+=4)this.allIndices[o]=r,this.allIndices[o+1]=r+1,this.allIndices[o+2]=r+2,this.allIndices[o+3]=r,this.allIndices[o+4]=r+2,this.allIndices[o+5]=r+3;this.indicesGlBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indicesGlBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.allIndices,t.STATIC_DRAW);var s=t.getUniformLocation(this.program,"projectionMatrix");t.uniformMatrix4fv(s,!1,this.projectionMatrix)},TextureAtlas.prototype.glCompile=function(t,e){var i=this.gl.createShader(t);return this.gl.shaderSource(i,e),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(console.log(this.gl.getShaderInfoLog(i)),null)},TextureAtlas.prototype.uploadTextureSources=function(t){var e,i=t.length;for(i>1e3&&(i=1e3),e=0;e<i;e++){var o=t[e].w,r=t[e].h,s=t[e].textureAtlasX,n=t[e].textureAtlasY,h=1/o,a=1/r,p=16*e*9;this.allCoords[p+0]=s,this.allCoords[p+1]=n,this.allCoords[p+4]=s+o,this.allCoords[p+5]=n,this.allCoords[p+8]=s+o,this.allCoords[p+9]=n+r,this.allCoords[p+12]=s,this.allCoords[p+13]=n+r,this.allCoords[p+16]=s,this.allCoords[p+17]=n-1,this.allCoords[p+20]=s+o,this.allCoords[p+21]=n-1,this.allCoords[p+24]=s+o,this.allCoords[p+25]=n,this.allCoords[p+28]=s,this.allCoords[p+29]=n,this.allCoords[p+32]=s,this.allCoords[p+33]=n+r,this.allCoords[p+36]=s+o,this.allCoords[p+37]=n+r,this.allCoords[p+40]=s+o,this.allCoords[p+41]=n+r+1,this.allCoords[p+44]=s,this.allCoords[p+45]=n+r+1,this.allCoords[p+48]=s-1,this.allCoords[p+49]=n,this.allCoords[p+52]=s,this.allCoords[p+53]=n,this.allCoords[p+56]=s,this.allCoords[p+57]=n+r,this.allCoords[p+60]=s-1,this.allCoords[p+61]=n+r,this.allCoords[p+64]=s+o,this.allCoords[p+65]=n,this.allCoords[p+68]=s+o+1,this.allCoords[p+69]=n,this.allCoords[p+72]=s+o+1,this.allCoords[p+73]=n+r,this.allCoords[p+76]=s+o,this.allCoords[p+77]=n+r,this.allCoords[p+80]=s-1,this.allCoords[p+81]=n-1,this.allCoords[p+84]=s,this.allCoords[p+85]=n-1,this.allCoords[p+88]=s,this.allCoords[p+89]=n,this.allCoords[p+92]=s-1,this.allCoords[p+93]=n,this.allCoords[p+96]=s+o,this.allCoords[p+97]=n-1,this.allCoords[p+100]=s+o+1,this.allCoords[p+101]=n-1,this.allCoords[p+104]=s+o+1,this.allCoords[p+105]=n,this.allCoords[p+108]=s+o,this.allCoords[p+109]=n,this.allCoords[p+112]=s+o,this.allCoords[p+113]=n+r,this.allCoords[p+116]=s+o+1,this.allCoords[p+117]=n+r,this.allCoords[p+120]=s+o+1,this.allCoords[p+121]=n+r+1,this.allCoords[p+124]=s+o,this.allCoords[p+125]=n+r+1,this.allCoords[p+128]=s-1,this.allCoords[p+129]=n+r,this.allCoords[p+132]=s,this.allCoords[p+133]=n+r,this.allCoords[p+136]=s,this.allCoords[p+137]=n+r+1,this.allCoords[p+140]=s-1,this.allCoords[p+141]=n+r+1,this.allTexCoords[p+2]=0,this.allTexCoords[p+3]=0,this.allTexCoords[p+6]=1,this.allTexCoords[p+7]=0,this.allTexCoords[p+10]=1,this.allTexCoords[p+11]=1,this.allTexCoords[p+14]=0,this.allTexCoords[p+15]=1,this.allTexCoords[p+18]=0,this.allTexCoords[p+19]=0,this.allTexCoords[p+22]=1,this.allTexCoords[p+23]=0,this.allTexCoords[p+26]=1,this.allTexCoords[p+27]=a,this.allTexCoords[p+30]=0,this.allTexCoords[p+31]=a,this.allTexCoords[p+34]=0,this.allTexCoords[p+35]=1-a,this.allTexCoords[p+38]=1,this.allTexCoords[p+39]=1-a,this.allTexCoords[p+42]=1,this.allTexCoords[p+43]=1,this.allTexCoords[p+46]=0,this.allTexCoords[p+47]=1,this.allTexCoords[p+50]=0,this.allTexCoords[p+51]=0,this.allTexCoords[p+54]=h,this.allTexCoords[p+55]=0,this.allTexCoords[p+58]=h,this.allTexCoords[p+59]=1,this.allTexCoords[p+62]=0,this.allTexCoords[p+63]=1,this.allTexCoords[p+66]=1-h,this.allTexCoords[p+67]=0,this.allTexCoords[p+70]=1,this.allTexCoords[p+71]=0,this.allTexCoords[p+74]=1,this.allTexCoords[p+75]=1,this.allTexCoords[p+78]=1-h,this.allTexCoords[p+79]=1,this.allTexCoords[p+82]=0,this.allTexCoords[p+83]=0,this.allTexCoords[p+86]=h,this.allTexCoords[p+87]=0,this.allTexCoords[p+90]=h,this.allTexCoords[p+91]=a,this.allTexCoords[p+94]=0,this.allTexCoords[p+95]=a,this.allTexCoords[p+98]=1-h,this.allTexCoords[p+99]=0,this.allTexCoords[p+102]=1,this.allTexCoords[p+103]=0,this.allTexCoords[p+106]=1,this.allTexCoords[p+107]=a,this.allTexCoords[p+110]=1-h,this.allTexCoords[p+111]=a,this.allTexCoords[p+114]=1-h,this.allTexCoords[p+115]=1-a,this.allTexCoords[p+118]=1,this.allTexCoords[p+119]=1-a,this.allTexCoords[p+122]=1,this.allTexCoords[p+123]=1,this.allTexCoords[p+126]=1-h,this.allTexCoords[p+127]=1,this.allTexCoords[p+130]=0,this.allTexCoords[p+131]=1-a,this.allTexCoords[p+134]=h,this.allTexCoords[p+135]=1-a,this.allTexCoords[p+138]=h,this.allTexCoords[p+139]=1,this.allTexCoords[p+142]=0,this.allTexCoords[p+143]=1}var l=this.gl;l.bindFramebuffer(l.FRAMEBUFFER,this.framebuffer),l.useProgram(this.program),l.viewport(0,0,this.w,this.h),l.blendFunc(l.ONE,l.ZERO),l.enable(l.BLEND),l.disable(l.DEPTH_TEST),this.paramsGlBuffer=this.paramsGlBuffer||l.createBuffer(),l.bindBuffer(l.ARRAY_BUFFER,this.paramsGlBuffer);var u=new DataView(this.paramsBuffer,0,576*i);for(l.bufferData(l.ARRAY_BUFFER,u,l.DYNAMIC_DRAW),l.vertexAttribPointer(this.vertexPositionAttribute,2,l.FLOAT,!1,16,0),l.vertexAttribPointer(this.textureCoordAttribute,2,l.FLOAT,!1,16,8),l.enableVertexAttribArray(this.vertexPositionAttribute),l.enableVertexAttribArray(this.textureCoordAttribute),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,this.indicesGlBuffer),e=0;e<i;e++)l.bindTexture(l.TEXTURE_2D,t[e].glTexture),l.drawElements(l.TRIANGLES,54,l.UNSIGNED_SHORT,6*e*9*2);l.disableVertexAttribArray(this.vertexPositionAttribute),l.disableVertexAttribArray(this.textureCoordAttribute)},TextureAtlas.prototype.allocate=function(t){return this.activeTree.add(t)},TextureAtlas.prototype.addActiveTextureSource=function(t){1===t.id||t.w*t.h<this.pixelsLimit&&(this.activeTextureSources.has(t)||(this.activeTextureSources.add(t),this.addedTextureSources.has(t)||this.add(t)))},TextureAtlas.prototype.removeActiveTextureSource=function(t){if(this.activeTextureSources.has(t)){this.activeTextureSources.delete(t);var e=this.uploads.indexOf(t);e>=0&&(this.uploads.splice(e,1),t.onRemovedFromTextureAtlas(),this.addedTextureSources.delete(t)),this.addedTextureSources.has(t)&&(this.wastedPixels+=t.w*t.h)}},TextureAtlas.prototype.add=function(t){var e=this.allocate(t);return e?(this.addedTextureSources.add(t),t.onAddedToTextureAtlas(e.x+1,e.y+1),this.uploads.push(t),!0):(this.defragNeeded=!0,!1)},TextureAtlas.prototype.defragment=function(){console.log("defragment texture atlas");var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer),t.viewport(0,0,this.w,this.h),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),this.activeTree.reset(),this.uploads=[],this.wastedPixels=0,this.lastDefragFrame=this.stage.frameCounter,this.defragNeeded=!1,this.addedTextureSources.forEach(function(t){t.onRemovedFromTextureAtlas()}),this.addedTextureSources.clear(),this.add(this.stage.rectangleTexture.source);var e=this;this.activeTextureSources.forEach(function(t){e.add(t)})},TextureAtlas.prototype.flush=function(){this.defragNeeded&&this.wastedPixels>=this.minWastedPixels&&this.lastDefragFrame<this.stage.frameCounter-300&&this.defragment(),this.uploads.length&&(this.lastImportFrame=this.stage.frameCounter,this.uploadTextureSources(this.uploads),this.uploads=[])},TextureAtlasTree.prototype.reset=function(){this.root={x:0,y:0,w:this.w,h:this.h},this.spaces=new Set([this.root]),this.maxH=this.h},TextureAtlasTree.prototype.add=function(t){var e=t.w+2,i=t.h+2;if(i>this.maxH)return!1;var o=0,r=null,s=0;return this.spaces.forEach(function(t){t.h>s&&(s=t.h),t.w>=e&&t.h>=i&&(!o||o>e*i)&&(o=e*i,r=t)}),this.maxH=s,!!r&&(this.useNode(r,t),r)},TextureAtlasTree.prototype.findNode=function(t,e,i){return t?t.o?this.findNode(t.r,e,i)||this.findNode(t.d,e,i):e<=t.w&&i<=t.h?t:null:null},TextureAtlasTree.prototype.useNode=function(t,e){var i=e.w+2,o=e.h+2;t.w>i&&(t.r={x:t.x+i,y:t.y,w:t.w-i,h:o},this.spaces.add(t.r)),t.h>o&&(t.d={x:t.x,y:t.y+o,w:t.w,h:t.h-o},this.spaces.add(t.d)),this.spaces.delete(t),t.o=e},TextureAtlasTree.prototype.getTextures=function(){for(var t=[this.root],e=[],i=1;i;){var o=t.pop();i--,o.o&&(e.push(o.o),o.r&&(t.push(o.r),i++),o.d&&(t.push(o.d),i++))}return e};var Component=function(t){EventEmitter.call(this),this.id=Stage.componentId++,this.uComponent=t.adapter.getUComponentContext().createUComponentForComponent(this),this.stage=t,this._children=[],this._tags=new ComponentTags(this)};Utils.extendClass(Component,EventEmitter),Component.prototype.active=!1,Component.prototype.attached=!1,Component.prototype.parent=null,Component.prototype.hasChildren=!1,Component.prototype._clipping=!1,Component.prototype._displayedTexture=null,Component.prototype._renderWidth=0,Component.prototype._renderHeight=0,Component.prototype.hasBorders=!1,Component.prototype._colorTopLeft=4294967295,Component.prototype._colorTopRight=4294967295,Component.prototype._colorBottomLeft=4294967295,Component.prototype._colorBottomRight=4294967295,Component.prototype.transitions=null,Component.prototype.transitionSet=null,Component.prototype.animationSet=null,Component.prototype._x=0,Component.prototype._y=0,Component.prototype._w=0,Component.prototype._h=0,Component.prototype._scaleX=1,Component.prototype._scaleY=1,Component.prototype._pivotX=.5,Component.prototype._pivotY=.5,Component.prototype._mountX=0,Component.prototype._mountY=0,Component.prototype._alpha=1,Component.prototype._rotation=0,Component.prototype._borderWidthTop=0,Component.prototype._borderWidthBottom=0,Component.prototype._borderWidthLeft=0,Component.prototype._borderWidthRight=0,Component.prototype._borderColorTop=4294967295,Component.prototype._borderColorBottom=4294967295,Component.prototype._borderColorLeft=4294967295,Component.prototype._borderColorRight=4294967295,Component.prototype._visible=!0,Component.prototype.textRenderer=null,Component.prototype._texture=null,Component.prototype._displayedTexture=null,Component.prototype._src=null,Component.prototype.clipping=!1,Component.prototype._zIndex=0,Component.prototype._forceZIndexContext=!1,Component.prototype._turtler=null,Component.prototype._turtleInvisible=!1,Component.prototype.notifyActivate=null,Component.prototype.notifyDeactivate=null,Component.prototype.rotationCache=0,Component.prototype._sr=0,Component.prototype._cr=1,Component.prototype.setAsRoot=function(){this.updateActiveFlag(),this.updateAttachedFlag(),this.uComponent.setAsRoot()},Component.prototype.setParent=function(t){this.parent!==t&&(this.parent&&(this.parent.hasChildren=this.parent._children.length>1,this._tags.unsetParent()),this.parent=t,t&&(t.hasChildren=!0,this._tags.setParent(t._tags)),this.updateActiveFlag(),this.updateAttachedFlag())},Component.prototype.add=function(t){if(t instanceof Component)return this.addChild(t),t;if(Utils.isArray(t)){for(var e=0,i=t.length;e<i;e++)this.add(t[e]);return null}if(Utils.isPlainObject(t)){var o=this.stage.c(t);return this.addChild(o),o}},Component.prototype.addChild=function(t){if(t.parent===this&&this._children.indexOf(t)>=0)return t;this.addChildAt(t,this._children.length)},Component.prototype.addChildren=function(t){var e,i=t.length;for(e=0;e<i;e++)this.addChild(t[e])},Component.prototype.setChildren=function(t){this.removeChildren(),this.addChildren(t)},Component.prototype.addChildAt=function(t,e){if(t!==this){if(!(e>=0&&e<=this._children.length))throw new Error(t+"addChildAt: The index "+e+" supplied is out of bounds "+this.children.length);t.parent===this&&this._children.indexOf(t)===e||(t.parent&&t.parent.removeChild(t),t.setParent(this),this._children.splice(e,0,t),this.uComponent.insertChild(e,t.uComponent))}},Component.prototype.getChildIndex=function(t){return this._children.indexOf(t)},Component.prototype.removeChild=function(t){var e=this._children.indexOf(t);-1!==e&&this.removeChildAt(e)},Component.prototype.removeChildAt=function(t){var e=this._children[t];return e.setParent(null),this._children.splice(t,1),this.uComponent.removeChild(t),e},Component.prototype.removeChildren=function(){var t=this._children.length;if(t){for(var e=0;e<t;e++)this._children[e].setParent(null);this._children.splice(0,t),this.uComponent.clearChildren()}},Component.prototype.getDepth=function(){var t=0,e=this;do{t++,e=e.parent}while(e);return t},Component.prototype.getAncestor=function(t){for(var e=this;t>0&&e.parent;)e=e.parent,t--;return e},Component.prototype.getAncestorAtDepth=function(t){var e=this.getDepth()-t;return e<0?null:this.getAncestor(e)},Component.prototype.isAncestorOf=function(t){for(var e=t;e.parent;){if(this===e)return!0;e=e.parent}return!1},Component.prototype.getSharedAncestor=function(t){var e=this,i=t,o=e.getDepth(),r=i.getDepth();o>r?e=e.getAncestor(o-r):r>o&&(i=i.getAncestor(r-o));do{if(e===i)return e;e=e.parent,i=i.parent}while(e&&i);return null},Component.prototype.isActive=function(){return this._visible&&this._alpha>0&&(this.parent?this.parent.active:this.stage.root===this)},Component.prototype.isAttached=function(){return this.parent?this.parent.attached:this.stage.root===this},Component.prototype.updateActiveFlag=function(){var t=this.isActive();if(this.active!==t){if(t){0!=this.zIndex&&this.stage.zIndexUsage++;var e=null;this.texture&&this.texture.source.glTexture?(e=this.texture,this.texture.addComponent(this)):this.displayedTexture&&this.displayedTexture.source.glTexture&&(e=this.displayedTexture),this.displayedTexture=e,this.checkForResize(),this._updateTextureCoords(),this.active=t,this.texture&&this.texture.addComponent(this),this.displayedTexture&&this.displayedTexture!==this.texture&&this.displayedTexture.addComponent(this)}else 0!=this.zIndex&&this.stage.zIndexUsage--,this.texture&&this.texture.removeComponent(this,!0),this.displayedTexture&&this.displayedTexture.removeComponent(this,!0),this.active=t;var i=this._children.length;if(i>0)for(var o=0;o<i;o++)this._children[o].updateActiveFlag();t?this.notifyActivate&&this.notifyActivate():this.notifyDeactivate&&this.notifyDeactivate()}},Component.prototype.updateAttachedFlag=function(){var t=this.isAttached();if(this.attached!==t){if(this.attached=t,t){var e=this;this.transitionSet&&this.transitionSet.forEach(function(t){t.isActive()&&e.stage.addActiveTransition(t)}),this.animationSet&&this.animationSet.forEach(function(t){t.isActive()&&e.stage.addActiveAnimation(t)})}var i=this._children.length;if(i>0)for(var o=0;o<i;o++)this._children[o].updateAttachedFlag()}},Component.prototype.addAnimation=function(t){this.animationSet||(this.animationSet=new Set),this.animationSet.add(t)},Component.prototype.removeAnimation=function(t){this.animationSet.delete(t)},Component.prototype.animation=function(t){var e=this.stage.animation(t);return e.subject=this,e},Component.prototype.a=function(t){return this.animation(t)},Component.prototype.transition=function(t,e){var i=Component.propAliases.get(t);if(e||null===e){if(i){for(var o=0,r=i.length;o<r;o++)this.setPropertyTransition(i[o],e);return e?this.getPropertyTransition(i[0]):null}return this.setPropertyTransition(t,e)}return this.getPropertyTransition(t,e)},Component.prototype.t=function(t,e){this.transition(t,e)},Component.prototype.fastForward=function(t){var e=Component.propAliases.get(t);e||(e=[t]);for(var i=0,o=e.length;i<o;i++){var r=e[i],s=Component.SETTINGS[r];if(s&&s.m){var n=this.getPropertyTransition(r);n&&n.updateTargetValue(s.g(this),s.g(this))}else console.warn("Unknown transition property: "+r)}},Component.prototype.getRenderWidth=function(){return this.active?this._renderWidth:this._getRenderWidth()},Component.prototype._getRenderWidth=function(){return this._w?this._w:this.texture&&this.texture.source.glTexture?this.texture.w||this.texture.source.w/this.texture.precision:this.displayedTexture?this.displayedTexture.w||this.displayedTexture.source.w/this.displayedTexture.precision:0},Component.prototype.getRenderHeight=function(){return this.active?this._renderHeight:this._getRenderHeight()},Component.prototype._getRenderHeight=function(){return this._h?this._h:this.texture&&this.texture.source.glTexture?(this.texture.h||this.texture.source.h)/this.texture.precision:this.displayedTexture?(this.displayedTexture.h||this.displayedTexture.source.h)/this.displayedTexture.precision:0},Component.prototype.setPropertyTransition=function(t,e){var i=Component.getPropertyIndex(t);if(-1==i)throw new Error("Unknown transition property: "+t);if(e)this.transitions||(this.transitions=new Array(Component.nTransitions),this.transitionSet=new Set),this.transitions[i]||(this.transitions[i]=new Transition(this,t),this.transitionSet.add(this.transitions[i])),this.transitions[i].set(e);else if(this.transitions&&this.transitions[i]){var o=Component.SETTINGS[t];o.sf(this,o.g(this)),this.stage.activeTransitions.delete(this.transitions[i]),this.transitionSet.delete(this.transitions[i]),this.transitions[i]=null}return this.transitions[i]},Component.prototype.getPropertyTransition=function(t){var e=Component.getPropertyIndex(t);if(-1==e)throw new Error("Unknown transition property: "+t);return this.transitions&&this.transitions[e]?this.transitions[e]:null},Component.prototype.getCornerPoints=function(){return this.uComponent.getCornerPoints()},Component.prototype.getLocationString=function(){var t;if(this.parent&&(t=this.parent._children.indexOf(this))>=0){var e=this.getTags();return this.parent.getLocationString()+":"+t+"["+this.id+"]"+(e.length?"("+e.join(",")+")":"")}return""},Component.prototype.getTags=function(){return this._tags.getLocalTags()},Component.prototype.setTags=function(t){this._tags.setTags(t)},Component.prototype.addTag=function(t){this._tags.addTag(t)},Component.prototype.removeTag=function(t){this._tags.removeTag(t)},Component.prototype.hasTag=function(t){return this._tags.hasTag(t)},Component.prototype.tag=function(t){return this._tags.tag(t)},Component.prototype.mtag=function(t){return this._tags.mtag(t)},Component.prototype.stag=function(t,e){for(var i=this.mtag(t),o=i.length,r=0;r<o;r++)i[r].set(e)},Component.prototype.onTextureSourceLoaded=function(){this.displayedTexture=this.texture},Component.prototype.onTextureSourceLoadError=function(t){this._eventsCount&&this.emit("txError",t,this.texture.source)},Component.prototype.onTextureSourceAddedToTextureAtlas=function(){this._updateTextureCoords()},Component.prototype.onTextureSourceRemovedFromTextureAtlas=function(){this._updateTextureCoords()},Component.prototype.onDisplayedTextureClippingChanged=function(){this._renderWidth=this._getRenderWidth(),this._renderHeight=this._getRenderHeight(),this._updateLocalDimensions(),this._updateTextureCoords()},Component.prototype.onPrecisionChanged=function(){this._renderWidth=this._getRenderWidth(),this._renderHeight=this._getRenderHeight(),this._updateLocalDimensions()},Component.prototype.set=function(t){for(var e=Object.keys(t),i=0;i<e.length;i++){var o=t[e[i]];this.setSetting(e[i],o)}},Component.prototype.setSetting=function(t,e){var i=Component.propAliases.get(t);if(i)for(var o=0,r=i.length;o<r;o++)this.setSetting(i[o],e);else switch(t){case"transitions":if(!Utils.isObject(e))throw new TypeError("Transitions must be object.");for(var s in e)this.transition(s,e[s]);break;default:var n=Component.SETTINGS[t];if(n)n.s(this,e);else{if(!(n=Component.FINAL_SETTINGS[t]))throw new Error("Unknown component property: "+t);n.sf(this,e)}}},Component.prototype.toString=function(){var t=this.getSettingsObject();return Component.getPrettyJsonified(t,"")},Component.getPrettyJsonified=function(t,e){var i=t.children;delete t.children;var o=["color","colorTopLeft","colorTopRight","colorBottomLeft","colorBottomRight","borderColor","borderColorTop","borderColorBottom","borderColorLeft","borderColorRight"],r=JSON.stringify(t,function(t,e){return-1!==o.indexOf(t)?"COLOR["+e.toString(16)+"]":e});if(r=r.replace(/"COLOR\[([a-f0-9]{1,8})\]"/g,"0x$1"),i&&i.length){var s="{}"===r;r=r.substr(0,r.length-1)+(s?"":",")+'"children":[\n';for(var n=i.length,h=0;h<n;h++)r+=Component.getPrettyJsonified(i[h],e+"  ")+(h<n-1?",":"")+"\n";r+=e+"]}"}return e+r},Component.prototype.getSettingsObject=function(){var t=this.getNonDefaults();return this.hasChildren&&(t.children=this._children.map(function(t){return t.getSettingsObject()})),t},Component.prototype.getNonDefaults=function(){var t={};if(this._tags&&this._tags.tags&&(t.tags=this.getTags()),0!==this.x&&(t.x=this.x),0!==this.y&&(t.y=this.y),0!==this.w&&(t.w=this.w),0!==this.h&&(t.h=this.h),1!==this.alpha&&(t.alpha=this.alpha),0!==this.rotation&&(t.rotation=this.rotation),!0!==this.visible&&(t.visible=this.visible),!1!==this.clipping&&(t.clipping=this.clipping),this.zIndex&&(t.zIndex=this.zIndex),!1!==this.forceZIndexContext&&(t.forceZIndexContext=this.forceZIndexContext),this.textRenderer&&(t.text=this.textRenderer.settings.getNonDefaults()),this.src&&(t.src=this.src),this.rect&&(t.rect=!0),1!==this.scaleX&&this.scaleX===this.scaleY?t.scale=this.scaleX:(1!==this.scaleX&&(t.scaleX=this.scaleX),1!==this.scaleY&&(t.scaleY=this.scaleY)),.5!==this.pivotX&&(t.pivotX=this.pivotX),.5!==this.pivotY&&(t.pivotY=this.pivotY),0!==this.mountX&&(t.mountX=this.mountX),0!==this.mountY&&(t.mountY=this.mountY),0!==this.borderWidthTop&&this.borderWidthTop===this.borderWidthBottom&&this.borderWidthTop===this.borderWidthLeft&&this.borderWidthTop===this.borderWidthRight?t.borderWidth=this.borderWidthTop:(0!==this.borderWidthTop&&(t.borderWidthTop=this.borderWidthTop),0!==this.borderWidthBottom&&(t.borderWidthBottom=this.borderWidthBottom),0!==this.borderWidthLeft&&(t.borderWidthLeft=this.borderWidthLeft),0!==this.borderWidthRight&&(t.borderWidthRight=this.borderWidthRight)),4294967295!==this.borderColorTop&&this.borderColorTop===this.borderColorBottom&&this.borderColorTop===this.borderColorLeft&&this.borderColorTop===this.borderColorRight?t.borderColor=this.borderColorTop:(4294967295!==this.borderColorTop&&(t.borderColorTop=this.borderColorTop),4294967295!==this.borderColorBottom&&(t.borderColorBottom=this.borderColorBottom),4294967295!==this.borderColorLeft&&(t.borderColorLeft=this.borderColorLeft),4294967295!==this.borderColorRight&&(t.borderColorRight=this.borderColorRight)),4294967295!==this.colorTopLeft&&this.colorTopLeft===this.colorTopRight&&this.colorTopLeft===this.colorBottomLeft&&this.colorTopLeft===this.colorBottomRight?t.color=this.colorTopLeft:(4294967295!==this.colorTopLeft&&(t.colorTopLeft=this.colorTopLeft),4294967295!==this.colorTopRight&&(t.colorTopRight=this.colorTopRight),4294967295!==this.colorBottomLeft&&(t.colorBottomLeft=this.colorBottomLeft),4294967295!==this.colorBottomRight&&(t.colorBottomRight=this.colorBottomRight)),this.texture){var e=this.texture.getNonDefaults();Object.keys(e).length&&(t.texture=e)}return t},Component.prototype.hasEqualColors=function(){return this._colorTopLeft===this._colorTopRight&&this._colorTopLeft===this._colorBottomRight&&this._colorTopLeft===this._colorBottomLeft},Component.prototype.checkForResize=function(){var t=this._renderWidth,e=this._renderHeight;this._renderWidth=this._getRenderWidth(),this._renderHeight=this._getRenderHeight(),t===this._renderWidth&&e===this._renderHeight||this._updateLocalDimensions()},Component.propAliases=new Map,Component.propAliases.set("scale",["scaleX","scaleY"]),Component.propAliases.set("borderWidth",["borderWidthTop","borderWidthBottom","borderWidthLeft","borderWidthRight"]),Component.propAliases.set("borderColor",["borderColorTop","borderColorBottom","borderColorLeft","borderColorRight"]),Component.propAliases.set("color",["colorTopLeft","colorTopRight","colorBottomLeft","colorBottomRight"]),Component.propAliases.set("colorTop",["colorTopLeft","colorTopRight"]),Component.propAliases.set("colorBottom",["colorBottomLeft","colorBottomRight"]),Component.propAliases.set("colorLeft",["colorTopLeft","colorBottomLeft"]),Component.propAliases.set("colorRight",["colorTopRight","colorBottomRight"]),Object.defineProperty(Component.prototype,"renderWidth",{get:function(){return this.getRenderWidth()}}),Object.defineProperty(Component.prototype,"renderHeight",{get:function(){return this.getRenderHeight()}}),Object.defineProperty(Component.prototype,"x",{get:function(){return this.transitions&&this.transitions[0]?this.transitions[0].targetValue:this.X},set:function(t){this.transitions&&this.transitions[0]?this.setTransitionTargetValue(this.transitions[0],t,this.X):this.X=t}}),Object.defineProperty(Component.prototype,"X",{get:function(){return this._x},set:function(t){var e=this._x;e!==t&&(this._x=t,this._updateLocalTranslateDelta(t-e,0))}}),Object.defineProperty(Component.prototype,"y",{get:function(){return this.transitions&&this.transitions[1]?this.transitions[1].targetValue:this.Y},set:function(t){this.transitions&&this.transitions[1]?this.setTransitionTargetValue(this.transitions[1],t,this.Y):this.Y=t}}),Object.defineProperty(Component.prototype,"Y",{get:function(){return this._y},set:function(t){var e=this._y;e!==t&&(this._y=t,this._updateLocalTranslateDelta(0,t-e))}}),Object.defineProperty(Component.prototype,"w",{get:function(){return this.transitions&&this.transitions[2]?this.transitions[2].targetValue:this.W},set:function(t){this.transitions&&this.transitions[2]?this.setTransitionTargetValue(this.transitions[2],t,this.W):this.W=t}}),Object.defineProperty(Component.prototype,"W",{get:function(){return this._w},set:function(t){this._w!==t&&(this._w=t,this._renderWidth=this._getRenderWidth(),this._updateLocalDimensions())}}),Object.defineProperty(Component.prototype,"h",{get:function(){return this.transitions&&this.transitions[3]?this.transitions[3].targetValue:this.H},set:function(t){this.transitions&&this.transitions[3]?this.setTransitionTargetValue(this.transitions[3],t,this.H):this.H=t}}),Object.defineProperty(Component.prototype,"H",{get:function(){return this._h},set:function(t){this._h!==t&&(this._h=t,this._renderHeight=this._getRenderHeight(),this._updateLocalDimensions())}}),Object.defineProperty(Component.prototype,"scaleX",{get:function(){return this.transitions&&this.transitions[4]?this.transitions[4].targetValue:this.SCALEX},set:function(t){this.transitions&&this.transitions[4]?this.setTransitionTargetValue(this.transitions[4],t,this.SCALEX):this.SCALEX=t}}),Object.defineProperty(Component.prototype,"SCALEX",{get:function(){return this._scaleX},set:function(t){this._scaleX!==t&&(this._scaleX=t,this._updateLocalTransform())}}),Object.defineProperty(Component.prototype,"scaleY",{get:function(){return this.transitions&&this.transitions[5]?this.transitions[5].targetValue:this.SCALEY},set:function(t){this.transitions&&this.transitions[5]?this.setTransitionTargetValue(this.transitions[5],t,this.SCALEY):this.SCALEY=t}}),Object.defineProperty(Component.prototype,"SCALEY",{get:function(){return this._scaleY},set:function(t){this._scaleY!==t&&(this._scaleY=t,this._updateLocalTransform())}}),Object.defineProperty(Component.prototype,"pivotX",{get:function(){return this.transitions&&this.transitions[6]?this.transitions.get("pivotX").targetValue:this.PIVOTX},set:function(t){this.transitions&&this.transitions[6]?this.setTransitionTargetValue(this.transitions[6],t,this.PIVOTX):this.PIVOTX=t}}),Object.defineProperty(Component.prototype,"PIVOTX",{get:function(){return this._pivotX},set:function(t){this._pivotX!==t&&(this._pivotX=t,this._updateLocalTranslate())}}),Object.defineProperty(Component.prototype,"pivotY",{get:function(){return this.transitions&&this.transitions[7]?this.transitions[7].targetValue:this.PIVOTY},set:function(t){this.transitions&&this.transitions[7]?this.setTransitionTargetValue(this.transitions[7],t,this.PIVOTY):this.PIVOTY=t}}),Object.defineProperty(Component.prototype,"PIVOTY",{get:function(){return this._pivotY},set:function(t){this._pivotY!==t&&(this._pivotY=t,this._updateLocalTranslate())}}),Object.defineProperty(Component.prototype,"mountX",{get:function(){return this.transitions&&this.transitions[8]?this.transitions[8].targetValue:this.MOUNTX},set:function(t){this.transitions&&this.transitions[8]?this.setTransitionTargetValue(this.transitions[8],t,this.MOUNTX):this.MOUNTX=t}}),Object.defineProperty(Component.prototype,"MOUNTX",{get:function(){return this._mountX},set:function(t){this._mountX!==t&&(this._mountX=t,this._updateLocalTranslate())}}),Object.defineProperty(Component.prototype,"mountY",{get:function(){return this.transitions&&this.transitions[9]?this.transitions[9].targetValue:this.MOUNTY},set:function(t){this.transitions&&this.transitions[9]?this.setTransitionTargetValue(this.transitions[9],t,this.MOUNTY):this.MOUNTY=t}}),Object.defineProperty(Component.prototype,"MOUNTY",{get:function(){return this._mountY},set:function(t){this._mountY!==t&&(this._mountY=t,this._updateLocalTranslate())}}),Object.defineProperty(Component.prototype,"alpha",{get:function(){return this.transitions&&this.transitions[10]?this.transitions[10].targetValue:this.ALPHA},set:function(t){this.transitions&&this.transitions[10]?this.setTransitionTargetValue(this.transitions[10],t,this.ALPHA):this.ALPHA=t}}),Object.defineProperty(Component.prototype,"ALPHA",{get:function(){return this._alpha},set:function(t){t>1?t=1:t<0&&(t=0),t<1e-14&&(t=0);var e=this._alpha;e!==t&&(this._alpha=t,this._updateLocalAlpha(),0===e!=(0===t)&&this.updateActiveFlag())}}),Object.defineProperty(Component.prototype,"rotation",{get:function(){return this.transitions&&this.transitions[11]?this.transitions[11].targetValue:this.ROTATION},set:function(t){this.transitions&&this.transitions[11]?this.setTransitionTargetValue(this.transitions[11],t,this.ROTATION):this.ROTATION=t}}),Object.defineProperty(Component.prototype,"ROTATION",{get:function(){return this._rotation},set:function(t){this._rotation!==t&&(this._rotation=t,this._updateLocalTransform())}}),Object.defineProperty(Component.prototype,"borderWidthTop",{get:function(){return this.transitions&&this.transitions[12]?this.transitions[12].targetValue:this.BORDERWIDTHTOP},set:function(t){this.transitions&&this.transitions[12]?this.setTransitionTargetValue(this.transitions[12],t,this.BORDERWIDTHTOP):this.BORDERWIDTHTOP=t}}),Object.defineProperty(Component.prototype,"BORDERWIDTHTOP",{get:function(){return this._borderWidthTop},set:function(t){var e=this._borderWidthTop;e!==t&&(this._borderWidthTop=t,0===e!=(0===t)&&(this.hasBorders=this._borderWidthTop||this._borderWidthBottom||this._borderWidthLeft||this._borderWidthRight),this.uComponent.setBorderTop(this._borderWidthTop,this._borderColorTop))}}),Object.defineProperty(Component.prototype,"borderWidthBottom",{get:function(){return this.transitions&&this.transitions[13]?this.transitions[13].targetValue:this.BORDERWIDTHBOTTOM},set:function(t){this.transitions&&this.transitions[13]?this.setTransitionTargetValue(this.transitions[13],t,this.BORDERWIDTHBOTTOM):this.BORDERWIDTHBOTTOM=t}}),Object.defineProperty(Component.prototype,"BORDERWIDTHBOTTOM",{get:function(){return this._borderWidthBottom},set:function(t){var e=this._borderWidthBottom;e!==t&&(this._borderWidthBottom=t,0===e!=(0===t)&&(this.hasBorders=this._borderWidthBottom||this._borderWidthBottom||this._borderWidthLeft||this._borderWidthRight),this.uComponent.setBorderBottom(this._borderWidthBottom,this._borderColorBottom))}}),Object.defineProperty(Component.prototype,"borderWidthLeft",{get:function(){return this.transitions&&this.transitions[14]?this.transitions[14].targetValue:this.BORDERWIDTHLEFT},set:function(t){this.transitions&&this.transitions[14]?this.setTransitionTargetValue(this.transitions[14],t,this.BORDERWIDTHLEFT):this.BORDERWIDTHLEFT=t}}),Object.defineProperty(Component.prototype,"BORDERWIDTHLEFT",{get:function(){return this._borderWidthLeft},set:function(t){var e=this._borderWidthLeft;e!==t&&(this._borderWidthLeft=t,0===e!=(0===t)&&(this.hasBorders=this._borderWidthLeft||this._borderWidthBottom||this._borderWidthLeft||this._borderWidthRight),this.uComponent.setBorderLeft(this._borderWidthLeft,this._borderColorLeft))}}),Object.defineProperty(Component.prototype,"borderWidthRight",{get:function(){return this.transitions&&this.transitions[15]?this.transitions[15].targetValue:this.BORDERWIDTHRIGHT},set:function(t){this.transitions&&this.transitions[15]?this.setTransitionTargetValue(this.transitions[15],t,this.BORDERWIDTHRIGHT):this.BORDERWIDTHRIGHT=t}}),Object.defineProperty(Component.prototype,"BORDERWIDTHRIGHT",{get:function(){return this._borderWidthRight},set:function(t){var e=this._borderWidthRight;e!==t&&(this._borderWidthRight=t,0===e!=(0===t)&&(this.hasBorders=this._borderWidthRight||this._borderWidthBottom||this._borderWidthRight||this._borderWidthRight),this.uComponent.setBorderRight(this._borderWidthRight,this._borderColorRight))}}),Object.defineProperty(Component.prototype,"borderColorTop",{get:function(){return this.transitions&&this.transitions[16]?this.transitions[16].targetValue:this.BORDERCOLORTOP},set:function(t){this.transitions&&this.transitions[16]?this.setTransitionTargetValue(this.transitions[16],t,this.BORDERCOLORTOP):this.BORDERCOLORTOP=t}}),Object.defineProperty(Component.prototype,"BORDERCOLORTOP",{get:function(){return this._borderColorTop},set:function(t){this._borderColorTop!==t&&(this._borderColorTop=t,this.uComponent.setBorderTop(this._borderWidthTop,this._borderColorTop))}}),Object.defineProperty(Component.prototype,"borderColorBottom",{get:function(){return this.transitions&&this.transitions[17]?this.transitions[17].targetValue:this.BORDERCOLORBOTTOM},set:function(t){this.transitions&&this.transitions[17]?this.setTransitionTargetValue(this.transitions[17],t,this.BORDERCOLORBOTTOM):this.BORDERCOLORBOTTOM=t}}),Object.defineProperty(Component.prototype,"BORDERCOLORBOTTOM",{get:function(){return this._borderColorBottom},set:function(t){this._borderColorBottom!==t&&(this._borderColorBottom=t,this.uComponent.setBorderBottom(this._borderWidthBottom,this._borderColorBottom))}}),Object.defineProperty(Component.prototype,"borderColorLeft",{get:function(){return this.transitions&&this.transitions[18]?this.transitions[18].targetValue:this.BORDERCOLORLEFT},set:function(t){this.transitions&&this.transitions[18]?this.setTransitionTargetValue(this.transitions[18],t,this.BORDERCOLORLEFT):this.BORDERCOLORLEFT=t}}),Object.defineProperty(Component.prototype,"BORDERCOLORLEFT",{get:function(){return this._borderColorLeft},set:function(t){this._borderColorLeft!==t&&(this._borderColorLeft=t,this.uComponent.setBorderLeft(this._borderWidthLeft,this._borderColorLeft))}}),Object.defineProperty(Component.prototype,"borderColorRight",{get:function(){return this.transitions&&this.transitions[19]?this.transitions[19].targetValue:this.BORDERCOLORRIGHT},set:function(t){this.transitions&&this.transitions[19]?this.setTransitionTargetValue(this.transitions[19],t,this.BORDERCOLORRIGHT):this.BORDERCOLORRIGHT=t}}),Object.defineProperty(Component.prototype,"BORDERCOLORRIGHT",{get:function(){return this._borderColorRight},set:function(t){this._borderColorRight!==t&&(this._borderColorRight=t,this.uComponent.setBorderRight(this._borderWidthRight,this._borderColorRight))}}),Object.defineProperty(Component.prototype,"colorTopLeft",{get:function(){return this.transitions&&this.transitions[20]?this.transitions[20].targetValue:this.COLORTOPLEFT},set:function(t){this.transitions&&this.transitions[20]?this.setTransitionTargetValue(this.transitions[20],t,this.COLORTOPLEFT):this.COLORTOPLEFT=t}}),Object.defineProperty(Component.prototype,"COLORTOPLEFT",{get:function(){return this._colorTopLeft},set:function(t){this._colorTopLeft!==t&&(this._colorTopLeft=t,this.uComponent.setColorUl(t))}}),Object.defineProperty(Component.prototype,"colorTopRight",{get:function(){return this.transitions&&this.transitions[21]?this.transitions[21].targetValue:this.COLORTOPRIGHT},set:function(t){this.transitions&&this.transitions[21]?this.setTransitionTargetValue(this.transitions[21],t,this.COLORTOPRIGHT):this.COLORTOPRIGHT=t}}),Object.defineProperty(Component.prototype,"COLORTOPRIGHT",{get:function(){return this._colorTopRight},set:function(t){this._colorTopRight!==t&&(this._colorTopRight=t,this.uComponent.setColorUr(t))}}),Object.defineProperty(Component.prototype,"colorBottomLeft",{get:function(){return this.transitions&&this.transitions[22]?this.transitions[22].targetValue:this.COLORBOTTOMLEFT},set:function(t){this.transitions&&this.transitions[22]?this.setTransitionTargetValue(this.transitions[22],t,this.COLORBOTTOMLEFT):this.COLORBOTTOMLEFT=t}}),Object.defineProperty(Component.prototype,"COLORBOTTOMLEFT",{get:function(){return this._colorBottomLeft},set:function(t){this._colorBottomLeft!==t&&(this._colorBottomLeft=t,this.uComponent.setColorBl(t))}}),Object.defineProperty(Component.prototype,"colorBottomRight",{get:function(){return this.transitions&&this.transitions[23]?this.transitions[23].targetValue:this.COLORBOTTOMRIGHT},set:function(t){this.transitions&&this.transitions[23]?this.setTransitionTargetValue(this.transitions[23],t,this.COLORBOTTOMRIGHT):this.COLORBOTTOMRIGHT=t}}),Object.defineProperty(Component.prototype,"COLORBOTTOMRIGHT",{get:function(){return this._colorBottomRight},set:function(t){this._colorBottomRight!==t&&(this._colorBottomRight=t,this.uComponent.setColorBr(t))}}),Object.defineProperty(Component.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible!==t&&(this._visible=!!t,this._updateLocalAlpha(),this.updateActiveFlag())}}),Object.defineProperty(Component.prototype,"clipping",{get:function(){return this._clipping},set:function(t){this._clipping!==t&&(this._clipping=t,this.uComponent.setClipping(t))}}),Object.defineProperty(Component.prototype,"zIndex",{get:function(){return this._zIndex},set:function(t){var e=this._zIndex;e!==t&&(this._zIndex=t,this.active&&(0!==e&&0===t?this.stage.zIndexUsage--:0===e&&0!==t&&this.stage.zIndexUsage++),this.uComponent.setZIndex(this.zIndex))}}),Object.defineProperty(Component.prototype,"forceZIndexContext",{get:function(){return this._forceZIndexContext},set:function(t){this._forceZIndexContext!==t&&(this._forceZIndexContext=t,this.uComponent.setForceZIndexContext(this.forceZIndexContext))}}),Object.defineProperty(Component.prototype,"scale",{get:function(){return this.scaleX},set:function(t){this.scaleX=t,this.scaleY=t}}),Object.defineProperty(Component.prototype,"borderWidth",{get:function(){return this.borderWidthTop},set:function(t){this.borderWidthTop=t,this.borderWidthBottom=t,this.borderWidthLeft=t,this.borderWidthRight=t}}),Object.defineProperty(Component.prototype,"borderColor",{get:function(){return this.borderColorTop},set:function(t){this.borderColorTop=t,this.borderColorBottom=t,this.borderColorLeft=t,this.borderColorRight=t}}),Object.defineProperty(Component.prototype,"texture",{get:function(){return this._texture},set:function(t){if(null===t||t instanceof Texture){var e=this._texture;if(t!==e){if(null!==t&&!(t instanceof Texture))throw new Error("incorrect value for texture");this._texture=t,this.active&&e&&this.displayedTexture!==e&&e.removeComponent(this,!(t&&e.source===t.source||this.displayedTexture&&this.displayedTexture.source===e.source)),t?(this.active&&t.addComponent(this),t.source.glTexture&&(this.displayedTexture=t)):this.displayedTexture=null}}else Utils.isPlainObject(t)&&this._texture&&this._texture.set(t)}}),Object.defineProperty(Component.prototype,"displayedTexture",{get:function(){return this._displayedTexture},set:function(t){if(null===t||t instanceof Texture){var e=this._displayedTexture;t!==e&&(this.active&&e&&e!==this.texture&&e.removeComponent(this,!t||e.source!==t.source),this._displayedTexture=t,this.checkForResize(),t?(this._eventsCount&&this.emit("txLoaded",t),this._updateTextureCoords(),this.stage.uComponentContext.setDisplayedTextureSource(this.uComponent,t.source)):(this._eventsCount&&this.emit("txUnloaded",t),this.stage.uComponentContext.setDisplayedTextureSource(this.uComponent,null)))}else Utils.isPlainObject(t)&&this._displayedTexture&&this._displayedTexture.set(t)}}),Object.defineProperty(Component.prototype,"color",{get:function(){return this.colorTopLeft},set:function(t){this.colorTopLeft=t,this.colorTopRight=t,this.colorBottomLeft=t,this.colorBottomRight=t}}),Object.defineProperty(Component.prototype,"colorTop",{get:function(){return this.colorTopLeft},set:function(t){this.colorTopLeft=t,this.colorTopRight=t}}),Object.defineProperty(Component.prototype,"colorBottom",{get:function(){return this.colorBottomLeft},set:function(t){this.colorBottomLeft=t,this.colorBottomRight=t}}),Object.defineProperty(Component.prototype,"colorLeft",{get:function(){return this.colorTopLeft},set:function(t){this.colorTopLeft=t,this.colorBottomLeft=t}}),Object.defineProperty(Component.prototype,"colorRight",{get:function(){return this.colorTopRight},set:function(t){this.colorTopRight=t,this.colorBottomRight=t}}),Object.defineProperty(Component.prototype,"src",{get:function(){return this._src},set:function(t){var e=this._src;e&&e===t&&this.texture&&this.texture.source.renderInfo&&this.texture.source.renderInfo.src===t||(t?(this.texture=this.stage.textureManager.getTexture(t),this._src=t):(e&&(this.texture=null),this._src=null))}}),Object.defineProperty(Component.prototype,"text",{get:function(){return this.textRenderer||(this.textRenderer=new ComponentText(this)),this.textRenderer},set:function(t){null===t?this.textRenderer&&(this.textRenderer=null,this.texture=null):(this.textRenderer||(this.textRenderer=new ComponentText(this)),Utils.isString(t)?this.textRenderer.text=t:this.textRenderer.set(t))}}),Object.defineProperty(Component.prototype,"rect",{get:function(){return this.texture===this.stage.getRectangleTexture()},set:function(t){this.texture=t?this.stage.getRectangleTexture():null}}),Object.defineProperty(Component.prototype,"tags",{get:function(){return this.getTags()},set:function(t){this.setTags(t)}}),Object.defineProperty(Component.prototype,"children",{get:function(){return this._children},set:function(t){var e=this.stage;if(!Utils.isArray(t))throw new TypeError("Children must be array.");for(var i=[],o=0,r=t.length;o<r;o++)t[o]instanceof Component?i[o]=t[o]:i[o]=e.c(t[o]);this.setChildren(i)}}),Object.defineProperty(Component.prototype,"turtler",{get:function(){return this._turtler},set:function(t){this._turtler!==t&&(this._turtler=t,this.uComponent.setHasTurtler(!!t))}}),Object.defineProperty(Component.prototype,"turtleInvisible",{get:function(){return this._turtleInvisible},set:function(t){this._turtleInvisible!==t&&(this._turtleInvisible=t,this.uComponent.setTurtleInvisible(!!t))}}),Component.prototype.setTransitionTargetValue=function(t,e,i){t.updateTargetValue(e,i)},Component.prototype._updateLocalTransform=function(){0!==this._rotation&&this._rotation%(2*Math.PI)?(this._rotation!==this.rotationCache&&(this.rotationCache=this._rotation,this._sr=Math.sin(this._rotation),this._cr=Math.cos(this._rotation)),this.uComponent.setLocalTransform(this._cr*this._scaleX,-this._sr*this._scaleY,this._sr*this._scaleX,this._cr*this._scaleY)):this.uComponent.setLocalTransform(this._scaleX,0,0,this._scaleY),this._updateLocalTranslate()},Component.prototype._updateLocalTranslate=function(){var t=this._pivotX*this._renderWidth,e=this._pivotY*this._renderHeight,i=this._x-(t*this.uComponent.getLocalTa()+e*this.uComponent.getLocalTb())+t,o=this._y-(t*this.uComponent.getLocalTc()+e*this.uComponent.getLocalTd())+e;i-=this._mountX*this._renderWidth,o-=this._mountY*this._renderHeight,this.uComponent.setLocalTranslate(i,o)},Component.prototype._updateLocalTranslateDelta=function(t,e){this.uComponent.addLocalTranslate(t,e)},Component.prototype._updateLocalAlpha=function(){this.uComponent.setLocalAlpha(this._visible?this._alpha:0)},Component.prototype._updateLocalDimensions=function(){this.uComponent.setDimensions(this._renderWidth,this._renderHeight),this._updateLocalTranslate()},Component.prototype.textureIsLoaded=function(){return!!this.texture&&!!this.texture.source.glTexture},Component.prototype.loadTexture=function(t){this.texture&&this.texture.load(t)},Component.prototype._updateTextureCoords=function(){if(this.displayedTexture&&this.displayedTexture.source){var t=this.displayedTexture,e=this.displayedTexture.source,i=0,o=0,r=1,s=1;if(t.clipping){var n,h,a,p,l=e.getRenderWidth(),u=e.getRenderHeight();n=1/l,h=1/u,a=t.w?t.w*n:(l-t.x)*n,p=t.h?t.h*h:(u-t.y)*h,n*=t.x,h*=t.y,i=Math.min(1,Math.max(0,n)),o=Math.min(1,Math.max(h)),r=Math.min(1,Math.max(r*a+n)),s=Math.min(1,Math.max(s*p+h))}if(e.inTextureAtlas){var c=488281e-9*e.textureAtlasX,d=488281e-9*e.textureAtlasY;i=c,o=d,r=r*(488281e-9*e.w)+c,s=s*(488281e-9*e.h)+d}this.uComponent.setTextureCoords(i,o,r,s),this.uComponent.setInTextureAtlas(e.inTextureAtlas)}},Component.getPropertyIndex=function(t){return Component.SETTINGS[t]?Component.SETTINGS[t].i:-1},Component.getPropertyIndexFinal=function(t){return Component.FINAL_SETTINGS[t]?Component.FINAL_SETTINGS[t].i:-1},Component.SETTINGS={x:{i:0,s:function(t,e){t.x=e},g:function(t){return t.x},sf:function(t,e){t.X=e},gf:function(t){return t.X},m:StageUtils.mergeNumbers},y:{i:1,s:function(t,e){t.y=e},g:function(t){return t.y},sf:function(t,e){t.Y=e},gf:function(t){return t.Y},m:StageUtils.mergeNumbers},w:{i:2,s:function(t,e){t.w=e},g:function(t){return t.w},sf:function(t,e){t.W=e},gf:function(t){return t.W},m:StageUtils.mergeNumbers},h:{i:3,s:function(t,e){t.h=e},g:function(t){return t.h},sf:function(t,e){t.H=e},gf:function(t){return t.H},m:StageUtils.mergeNumbers},scaleX:{i:4,s:function(t,e){t.scaleX=e},g:function(t){return t.scaleX},sf:function(t,e){t.SCALEX=e},gf:function(t){return t.SCALEX},m:StageUtils.mergeNumbers},scaleY:{i:5,s:function(t,e){t.scaleY=e},g:function(t){return t.scaleY},sf:function(t,e){t.SCALEY=e},gf:function(t){return t.SCALEY},m:StageUtils.mergeNumbers},pivotX:{i:6,s:function(t,e){t.pivotX=e},g:function(t){return t.pivotX},sf:function(t,e){t.PIVOTX=e},gf:function(t){return t.PIVOTX},m:StageUtils.mergeNumbers},pivotY:{i:7,s:function(t,e){t.pivotY=e},g:function(t){return t.pivotY},sf:function(t,e){t.PIVOTY=e},gf:function(t){return t.PIVOTY},m:StageUtils.mergeNumbers},mountX:{i:8,s:function(t,e){t.mountX=e},g:function(t){return t.mountX},sf:function(t,e){t.MOUNTX=e},gf:function(t){return t.MOUNTX},m:StageUtils.mergeNumbers},mountY:{i:9,s:function(t,e){t.mountY=e},g:function(t){return t.mountY},sf:function(t,e){t.MOUNTY=e},gf:function(t){return t.MOUNTY},m:StageUtils.mergeNumbers},alpha:{i:10,s:function(t,e){t.alpha=e},g:function(t){return t.alpha},sf:function(t,e){t.ALPHA=e},gf:function(t){return t.ALPHA},m:StageUtils.mergeNumbers},rotation:{i:11,s:function(t,e){t.rotation=e},g:function(t){return t.rotation},sf:function(t,e){t.ROTATION=e},gf:function(t){return t.ROTATION},m:StageUtils.mergeNumbers},borderWidthTop:{i:12,s:function(t,e){t.borderWidthTop=e},g:function(t){return t.borderWidthTop},sf:function(t,e){t.BORDERWIDTHTOP=e},gf:function(t){return t.BORDERWIDTHTOP},m:StageUtils.mergeNumbers},borderWidthBottom:{i:13,s:function(t,e){t.borderWidthBottom=e},g:function(t){return t.borderWidthBottom},sf:function(t,e){t.BORDERWIDTHBOTTOM=e},gf:function(t){return t.BORDERWIDTHBOTTOM},m:StageUtils.mergeNumbers},borderWidthLeft:{i:14,s:function(t,e){t.borderWidthLeft=e},g:function(t){return t.borderWidthLeft},sf:function(t,e){t.BORDERWIDTHLEFT=e},gf:function(t){return t.BORDERWIDTHLEFT},m:StageUtils.mergeNumbers},borderWidthRight:{i:15,s:function(t,e){t.borderWidthRight=e},g:function(t){return t.borderWidthRight},sf:function(t,e){t.BORDERWIDTHRIGHT=e},gf:function(t){return t.BORDERWIDTHRIGHT},m:StageUtils.mergeNumbers},borderColorTop:{i:16,s:function(t,e){t.borderColorTop=e},g:function(t){return t.borderColorTop},sf:function(t,e){t.BORDERCOLORTOP=e},gf:function(t){return t.BORDERCOLORTOP},m:StageUtils.mergeColors},borderColorBottom:{i:17,s:function(t,e){t.borderColorBottom=e},g:function(t){return t.borderColorBottom},sf:function(t,e){t.BORDERCOLORBOTTOM=e},gf:function(t){return t.BORDERCOLORBOTTOM},m:StageUtils.mergeColors},borderColorLeft:{i:18,s:function(t,e){t.borderColorLeft=e},g:function(t){return t.borderColorLeft},sf:function(t,e){t.BORDERCOLORLEFT=e},gf:function(t){return t.BORDERCOLORLEFT},m:StageUtils.mergeColors},borderColorRight:{i:19,s:function(t,e){t.borderColorRight=e},g:function(t){return t.borderColorRight},sf:function(t,e){t.BORDERCOLORRIGHT=e},gf:function(t){return t.BORDERCOLORRIGHT},m:StageUtils.mergeColors},colorTopLeft:{i:20,s:function(t,e){t.colorTopLeft=e},g:function(t){return t.colorTopLeft},sf:function(t,e){t.COLORTOPLEFT=e},gf:function(t){return t.COLORTOPLEFT},m:StageUtils.mergeColors},colorTopRight:{i:21,s:function(t,e){t.colorTopRight=e},g:function(t){return t.colorTopRight},sf:function(t,e){t.COLORTOPRIGHT=e},gf:function(t){return t.COLORTOPRIGHT},m:StageUtils.mergeColors},colorBottomLeft:{i:22,s:function(t,e){t.colorBottomLeft=e},g:function(t){return t.colorBottomLeft},sf:function(t,e){t.COLORBOTTOMLEFT=e},gf:function(t){return t.COLORBOTTOMLEFT},m:StageUtils.mergeColors},colorBottomRight:{i:23,s:function(t,e){t.colorBottomRight=e},g:function(t){return t.colorBottomRight},sf:function(t,e){t.COLORBOTTOMRIGHT=e},gf:function(t){return t.COLORBOTTOMRIGHT},m:StageUtils.mergeColors},visible:{s:function(t,e){t.visible=e},g:function(t){return t.visible},sf:function(t,e){t.VISIBLE=e},gf:function(t){return t.VISIBLE},m:null},zIndex:{s:function(t,e){t.zIndex=e},g:function(t){return t.zIndex},sf:function(t,e){t.VISIBLE=e},gf:function(t){return t.VISIBLE},m:null},forceZIndexContext:{s:function(t,e){t.forceZIndexContext=e},g:function(t){return t.forceZIndexContext},sf:function(t,e){t.FORCEZINDEXCONTEXT=e},gf:function(t){return t.FORCEZINDEXCONTEXT},m:null},clipping:{s:function(t,e){t.clipping=e},g:function(t){return t.clipping},sf:function(t,e){t.CLIPPING=e},gf:function(t){return t.CLIPPING},m:null},rect:{s:function(t,e){t.rect=e},g:function(t){return t.rect},m:null},src:{s:function(t,e){t.src=e},g:function(t){return t.src},m:null},text:{s:function(t,e){t.text=e},g:function(t){return t.text},m:null},texture:{s:function(t,e){t.texture=e},g:function(t){return t.src},m:null},tag:{s:function(t,e){t.tags=e},g:function(t){return t.tags},m:null},tags:{s:function(t,e){t.tags=e},g:function(t){return t.tags},m:null},children:{s:function(t,e){t.children=e},g:function(t){return t.children},m:null},turtler:{s:function(t,e){t.turtler=e},g:function(t){return t.turtler},m:null},turtleInvisible:{s:function(t,e){t.turtleInvisible=e},g:function(t){return t.turtleInvisible},m:null}},Component.FINAL_SETTINGS={};for(var key in Component.SETTINGS)Component.SETTINGS.hasOwnProperty(key)&&Component.SETTINGS[key].sf&&(Component.FINAL_SETTINGS[key.toUpperCase()]=Component.SETTINGS[key]);Component.nTransitions=24;var ComponentTags=function(t){this.component=t};ComponentTags.prototype.parent=null,ComponentTags.prototype.tags=null,ComponentTags.prototype.treeTags=null,ComponentTags.prototype.cache=null,ComponentTags.prototype.tagToComplex=null,ComponentTags.prototype.clearCache=function(t){if(this.cache&&(this.cache.delete(t),this.tagToComplex)){var e=this.tagToComplex.get(t);if(e){for(var i=0,o=e.length;i<o;i++)this.cache.delete(e[i]);this.tagToComplex.delete(t)}}},ComponentTags.prototype.unsetParent=function(){var t=null,e=0;if(this.treeTags&&(t=Utils.iteratorToArray(this.treeTags.keys()),(e=t.length)>0))for(var i=0;i<e;i++)for(var o=this.treeTags.get(t[i]),r=this;r=r.parent;){var s=r.treeTags.get(t[i]);o.forEach(function(t){s.delete(t)}),r.clearCache(t[i])}},ComponentTags.prototype.setParent=function(t){if(this.parent=t,this.treeTags&&this.treeTags.size){var e=this;this.treeTags.forEach(function(t,i){for(var o=e;o=o.parent;){o.treeTags||(o.treeTags=new Map);var r=o.treeTags.get(i);r||(r=new Set,o.treeTags.set(i,r)),t.forEach(function(t){r.add(t)}),o.clearCache(i)}})}},ComponentTags.prototype.getLocalTags=function(){return this.tags?this.tags:[]},ComponentTags.prototype.setTags=function(t){Utils.isArray(t)||(t=[t]);var e,i=t.length,o=[],r=[];for(e=0;e<i;e++)this.hasTag(t[e])||r.push(t[e]);var s=this.tags||[];for(i=s.length,e=0;e<i;e++)-1==t.indexOf(s[e])&&o.push(s[e]);for(e=0;e<o.length;e++)this.removeTag(o[e]);for(e=0;e<r.length;e++)this.addTag(r[e])},ComponentTags.prototype.addTag=function(t){if(this.tags||(this.tags=[]),-1===this.tags.indexOf(t)){this.tags.push(t);var e=this;do{if(e.treeTags||(e.treeTags=new Map),!(i=e.treeTags.get(t))){var i=new Set;e.treeTags.set(t,i)}i.add(this.component),e.clearCache(t)}while(e=e.parent)}},ComponentTags.prototype.removeTag=function(t){var e=this.tags.indexOf(t);if(-1!==e){this.tags.splice(e,1);var i=this;do{var o=i.treeTags.get(t);o&&(o.delete(this.component),i.clearCache(t))}while(i=i.parent)}},ComponentTags.prototype.hasTag=function(t){return this.tags&&-1!==this.tags.indexOf(t)},ComponentTags.prototype.tag=function(t){return this.mtag(t)[0]},ComponentTags.prototype.get=function(t){if(!this.treeTags)return[];var e=this.treeTags.get(t);return e?Utils.setToArray(e):[]},ComponentTags.prototype.mtag=function(t){var e=null;if(this.cache&&(e=this.cache.get(t)),!e){if(t.indexOf(".")>=0){var i=t.split(".");e=this.get(i[0]);for(var o=1,r=i.length;e.length&&o<r;){for(var s=[],n=0,h=e.length;n<h;n++)s=s.concat(e[n]._tags.get(i[o]));e=s,o++}}else e=this.get(t);this.cache||(this.cache=new Map),this.cache.set(t,e)}return e},ComponentText.prototype.updatingTexture=!1,ComponentText.prototype.texture=null,ComponentText.prototype.set=function(t){this.settings.set(t),this.settings.hasUpdates&&this.updateTexture()},ComponentText.prototype.updateTexture=function(){if(""!=this.settings.text){if(this.settings.hasUpdates=!1,!this.updatingTexture||this.component.texture!==this.texture){this.updatingTexture=!0;var t=this;this.component.texture=this.texture=this.stage.texture(function(e,i,o){t.updatingTexture=!1,e(null,null);var r=t.getFinalizedSettings(),s=t.createTextureSource(r);t.texture.precision=r.precision,s.load(o||r.sync),t.texture.replaceTextureSource(s)})}}else this.component.texture=null},ComponentText.prototype.getFinalizedSettings=function(){var t=this.settings.clone();return t.finalize(this.component),t},ComponentText.prototype.createTextureSource=function(t){var e=this,i=this.stage.textureManager;return e.stage.textureManager.getTextureSource(function(o,r,s){if(e.stage.measureLongFrames)var n=e.stage.getHrTime();i.loadText(t,r,s,o),e.stage.measureLongFrames&&(e.stage.longFrameComponents.text+=e.stage.getHrTime()-n,e.stage.longFrameComponents.nText++)},t.getTextureId())},ComponentText.prototype.measure=function(){var t=new TextRenderer(this.stage.drawingCanvasFactory,this.settings.clone());return!t.settings.w&&this.component.w&&(t.settings.w=this.component.w),!t.settings.h&&this.component.h&&(t.settings.h=this.component.h),t.draw(!0).renderInfo},Object.defineProperty(ComponentText.prototype,"renderInfo",{get:function(){return this.texture&&this.texture.source?this.texture.source.renderInfo:{}}}),Object.defineProperty(ComponentText.prototype,"text",{get:function(){return this.settings.text},set:function(t){this.settings.text=t,null===t?this.component.text=null:this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"w",{get:function(){return this.settings.w},set:function(t){this.settings.w=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"h",{get:function(){return this.settings.h},set:function(t){this.settings.h=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"fontStyle",{get:function(){return this.settings.fontStyle},set:function(t){this.settings.fontStyle=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"fontSize",{get:function(){return this.settings.fontSize},set:function(t){this.settings.fontSize=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"fontFace",{get:function(){return this.settings.fontFace},set:function(t){this.settings.fontFace=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"wordWrap",{get:function(){return this.settings.wordWrap},set:function(t){this.settings.wordWrap=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"wordWrapWidth",{get:function(){return this.settings.wordWrapWidth},set:function(t){this.settings.wordWrapWidth=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"lineHeight",{get:function(){return this.settings.lineHeight},set:function(t){this.settings.lineHeight=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"textBaseline",{get:function(){return this.settings.textBaseline},set:function(t){this.settings.textBaseline=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"textAlign",{get:function(){return this.settings.textAlign},set:function(t){this.settings.textAlign=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"offsetY",{get:function(){return this.settings.offsetY},set:function(t){this.settings.offsetY=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"maxLines",{get:function(){return this.settings.maxLines},set:function(t){this.settings.maxLines=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"maxLinesSuffix",{get:function(){return this.settings.maxLinesSuffix},set:function(t){this.settings.maxLinesSuffix=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"precision",{get:function(){return this.settings.precision},set:function(t){this.settings.precision=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"textColor",{get:function(){return this.settings.textColor},set:function(t){this.settings.textColor=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"paddingLeft",{get:function(){return this.settings.paddingLeft},set:function(t){this.settings.paddingLeft=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"paddingRight",{get:function(){return this.settings.paddingRight},set:function(t){this.settings.paddingRight=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"shadow",{get:function(){return this.settings.shadow},set:function(t){this.settings.shadow=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"shadowColor",{get:function(){return this.settings.shadowColor},set:function(t){this.settings.shadowColor=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"shadowOffsetX",{get:function(){return this.settings.shadowOffsetX},set:function(t){this.settings.shadowOffsetX=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"shadowOffsetY",{get:function(){return this.settings.shadowOffsetY},set:function(t){this.settings.shadowOffsetY=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"shadowBlur",{get:function(){return this.settings.shadowBlur},set:function(t){this.settings.shadowBlur=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"highlight",{get:function(){return this.settings.highlight},set:function(t){this.settings.highlight=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"highlightHeight",{get:function(){return this.settings.highlightHeight},set:function(t){this.settings.highlightHeight=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"highlightColor",{get:function(){return this.settings.highlightColor},set:function(t){this.settings.highlightColor=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"highlightOffset",{get:function(){return this.settings.highlightOffset},set:function(t){this.settings.highlightOffset=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"highlightPaddingLeft",{get:function(){return this.settings.highlightPaddingLeft},set:function(t){this.settings.highlightPaddingLeft=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"highlightPaddingRight",{get:function(){return this.settings.highlightPaddingRight},set:function(t){this.settings.highlightPaddingRight=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"cutSx",{get:function(){return this.settings.cutSx},set:function(t){this.settings.cutSx=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"cutEx",{get:function(){return this.settings.cutEx},set:function(t){this.settings.cutEx=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"cutSy",{get:function(){return this.settings.cutSy},set:function(t){this.settings.cutSy=t,this.settings.hasUpdates&&this.updateTexture()}}),Object.defineProperty(ComponentText.prototype,"cutEy",{get:function(){return this.settings.cutEy},set:function(t){this.settings.cutEy=t,this.settings.hasUpdates&&this.updateTexture()}}),TextRenderer.prototype.getPrecision=function(){return this.settings.precision},TextRenderer.prototype.setFontProperties=function(t){var e=this.settings.fontFace,i='"'+(Utils.isArray(e)?this.settings.fontFace.join('","'):e)+'"',o=t?this.getPrecision():1;this.context.font=this.settings.fontStyle+" "+this.settings.fontSize*o+"px "+i,this.context.textBaseline=this.settings.textBaseline},TextRenderer.prototype.createCanvas=function(){this.canvas=this.drawingCanvasFactory(),this.context=this.canvas.getContext("2d")},TextRenderer.prototype.unlinkCanvas=function(){this.canvas=null,this.context=null},TextRenderer.prototype.draw=function(t){this.createCanvas();var e={};this.setFontProperties(!1);var i=this.settings.w||2048/this.getPrecision(),o=i-(this.settings.paddingLeft+this.settings.paddingRight);o<10&&(i+=10-o,o+=10-o);var r,s=this.settings.wordWrapWidth||o;if(this.settings.wordWrap)r=this.wrapText(this.settings.text,s);else for(var n=(r={l:this.settings.text.split(/(?:\r\n|\r|\n)/),n:[]}).l.length,h=0;h<n-1;h++)r.n.push(h);var a=r.l;if(this.settings.maxLines&&a.length>this.settings.maxLines){var p=a.slice(0,this.settings.maxLines),l=null;if(this.settings.maxLinesSuffix){var u=this.wrapText(p[p.length-1]+this.settings.maxLinesSuffix,s);p[p.length-1]=u.l[0],l=[u.l.length>1?u.l[1]:""]}else l=[""];var n=a.length,c=0,d=r.n.length;for(h=this.settings.maxLines;h<n;h++)l[c]+=(l[c]?" ":"")+a[h],h+1<d&&r.n[h+1]&&c++;e.remainingText=l.join("\n"),e.moreTextLines=!0,a=p}else e.moreTextLines=!1,e.remainingText="";for(var g=0,f=[],h=0;h<a.length;h++){var m=this.context.measureText(a[h]).width;f.push(m),g=Math.max(g,m)}e.lineWidths=f,this.settings.w||(i=g+this.settings.paddingLeft+this.settings.paddingRight,o=g);var T,x=this.settings.lineHeight||this.settings.fontSize;T=this.settings.h?this.settings.h:x*(a.length-1)+.5*this.settings.fontSize+Math.max(x,this.settings.fontSize)+this.settings.offsetY;var y=null===this.settings.offsetY?this.settings.fontSize:this.settings.offsetY,C=this.getPrecision();if(e.w=i*C,e.h=T*C,e.lines=a,e.precision=C,!t){i||(i=1),T||(T=1),(this.settings.cutSx||this.settings.cutEx)&&(i=Math.min(i,this.settings.cutEx-this.settings.cutSx)),(this.settings.cutSy||this.settings.cutEy)&&(T=Math.min(T,this.settings.cutEy-this.settings.cutSy)),this.canvas.width=Math.ceil(i*C),this.canvas.height=Math.ceil(T*C),this.setFontProperties(!0),(this.settings.cutSx||this.settings.cutSy)&&this.context.translate(-this.settings.cutSx*C,-this.settings.cutSy*C);var b,S,v=[];for(h=0;h<a.length;h++)b=0,S=h*x+y,"right"===this.settings.textAlign?b+=o-f[h]:"center"===this.settings.textAlign&&(b+=(o-f[h])/2),b+=this.settings.paddingLeft,v.push({text:a[h],x:b*C,y:S*C,w:f[h]*C});if(this.settings.highlight){var A=this.settings.highlightColor||0,_=this.settings.highlightHeight||1.5*this.settings.fontSize,w=null!==this.settings.highlightOffset?this.settings.highlightOffset:-.5*this.settings.fontSize,P=null!==this.settings.highlightPaddingLeft?this.settings.highlightPaddingLeft:this.settings.paddingLeft,O=null!==this.settings.highlightPaddingRight?this.settings.highlightPaddingRight:this.settings.paddingRight;for(this.context.fillStyle=StageUtils.getRgbaString(A),h=0;h<v.length;h++){E=v[h];this.context.fillRect((E.x-P)*C,(E.y+w)*C,(E.w+O+P)*C,_*C)}}var R=null;for(this.settings.shadow&&(R=[this.context.shadowColor,this.context.shadowOffsetX,this.context.shadowOffsetY,this.context.shadowBlur],this.context.shadowColor=StageUtils.getRgbaString(this.settings.shadowColor),this.context.shadowOffsetX=this.settings.shadowOffsetX*C,this.context.shadowOffsetY=this.settings.shadowOffsetY*C,this.context.shadowBlur=this.settings.shadowBlur*C),this.context.fillStyle=StageUtils.getRgbaString(this.settings.textColor),h=0;h<v.length;h++){var E=v[h];this.context.fillText(E.text,E.x,E.y)}R&&(this.context.shadowColor=R[0],this.context.shadowOffsetX=R[1],this.context.shadowOffsetY=R[2],this.context.shadowBlur=R[3]),(this.settings.cutSx||this.settings.cutSy)&&this.context.translate(this.settings.cutSx,this.settings.cutSy)}var U=this.canvas;return this.unlinkCanvas(),{renderInfo:e,canvas:U}},TextRenderer.prototype.wrapText=function(t,e){for(var i=t.split(/\r?\n/g),o=[],r=[],s=0;s<i.length;s++){for(var n=[],h="",a=e,p=i[s].split(" "),l=0;l<p.length;l++){var u=this.context.measureText(p[l]).width,c=u+this.context.measureText(" ").width;0===l||c>a?(l>0&&(n.push(h),h=""),h+=p[l],a=e-u):(a-=c,h+=" "+p[l])}h&&(n.push(h),h=""),o=o.concat(n),s<i.length-1&&r.push(o.length)}return{l:o,n:r}};var TextRendererSettings=function(){};TextRendererSettings.prototype._text="",TextRendererSettings.prototype._w=0,TextRendererSettings.prototype._h=0,TextRendererSettings.prototype._fontStyle="normal",TextRendererSettings.prototype._fontSize=40,TextRendererSettings.prototype._fontFace=null,TextRendererSettings.prototype._wordWrap=!0,TextRendererSettings.prototype._wordWrapWidth=0,TextRendererSettings.prototype._lineHeight=null,TextRendererSettings.prototype._textBaseline="alphabetic",TextRendererSettings.prototype._textAlign="left",TextRendererSettings.prototype._offsetY=null,TextRendererSettings.prototype._maxLines=0,TextRendererSettings.prototype._maxLinesSuffix="..",TextRendererSettings.prototype._precision=null,TextRendererSettings.prototype._textColor=4294967295,TextRendererSettings.prototype._paddingLeft=0,TextRendererSettings.prototype._paddingRight=0,TextRendererSettings.prototype._shadow=!1,TextRendererSettings.prototype._shadowColor=4278190080,TextRendererSettings.prototype._shadowOffsetX=0,TextRendererSettings.prototype._shadowOffsetY=0,TextRendererSettings.prototype._shadowBlur=5,TextRendererSettings.prototype._highlight=!1,TextRendererSettings.prototype._highlightHeight=0,TextRendererSettings.prototype._highlightColor=4278190080,TextRendererSettings.prototype._highlightOffset=null,TextRendererSettings.prototype._highlightPaddingLeft=null,TextRendererSettings.prototype._highlightPaddingRight=null,TextRendererSettings.prototype._cutSx=0,TextRendererSettings.prototype._cutEx=0,TextRendererSettings.prototype._cutSy=0,TextRendererSettings.prototype._cutEy=0,TextRendererSettings.prototype._sync=!1,TextRendererSettings.prototype.hasUpdates=!1,TextRendererSettings.prototype.set=function(t){for(var e=Object.keys(t),i=0;i<e.length;i++){var o=t[e[i]];this.setSetting(e[i],o)}},TextRendererSettings.prototype.setSetting=function(t,e){var i=TextRendererSettings.SETTINGS[t];i?i.s(this,e):console.warn("Unknown text property: "+t)},TextRendererSettings.prototype.finalize=function(t){!this.w&&t.w&&(this.w=t.w),!this.h&&t.h&&(this.h=t.h),null===this.fontFace&&(this.fontFace=t.stage.defaultFontFace),null===this.precision&&(this.precision=t.stage.defaultPrecision)},TextRendererSettings.prototype.getNonDefaults=function(){var t={};return""!==this.text&&(t.text=this.text),0!==this.w&&(t.w=this.w),0!==this.h&&(t.h=this.h),"normal"!==this.fontStyle&&(t.fontStyle=this.fontStyle),40!==this.fontSize&&(t.fontSize=this.fontSize),null!==this.fontFace&&(t.fontFace=this.fontFace),!0!==this.wordWrap&&(t.wordWrap=this.wordWrap),0!==this.wordWrapWidth&&(t.wordWrapWidth=this.wordWrapWidth),null!==this.lineHeight&&(t.lineHeight=this.lineHeight),"alphabetic"!==this.textBaseline&&(t.textBaseline=this.textBaseline),"left"!==this.textAlign&&(t.textAlign=this.textAlign),null!==this.offsetY&&(t.offsetY=this.offsetY),0!==this.maxLines&&(t.maxLines=this.maxLines),".."!==this.maxLinesSuffix&&(t.maxLinesSuffix=this.maxLinesSuffix),null!==this.precision&&(t.precision=this.precision),4294967295!==this.textColor&&(t.textColor=this.textColor),0!==this.paddingLeft&&(t.paddingLeft=this.paddingLeft),0!==this.paddingRight&&(t.paddingRight=this.paddingRight),!1!==this.shadow&&(t.shadow=this.shadow),4278190080!==this.shadowColor&&(t.shadowColor=this.shadowColor),0!==this.shadowOffsetX&&(t.shadowOffsetX=this.shadowOffsetX),0!==this.shadowOffsetY&&(t.shadowOffsetY=this.shadowOffsetY),5!==this.shadowBlur&&(t.shadowBlur=this.shadowBlur),!1!==this.highlight&&(t.highlight=this.highlight),0!==this.highlightHeight&&(t.highlightHeight=this.highlightHeight),4278190080!==this.highlightColor&&(t.highlightColor=this.highlightColor),null!==this.highlightOffset&&(t.highlightOffset=this.highlightOffset),null!==this.highlightPaddingLeft&&(t.highlightPaddingLeft=this.highlightPaddingLeft),null!==this.highlightPaddingRight&&(t.highlightPaddingRight=this.highlightPaddingRight),this.cutSx&&(t.cutSx=this.cutSx),this.cutEx&&(t.cutEx=this.cutEx),this.cutSy&&(t.cutSy=this.cutSy),this.cutEy&&(t.cutEy=this.cutEy),this.sync&&(t.sync=this.sync),t},TextRendererSettings.prototype.getRenderNonDefaults=function(){var t=this.getNonDefaults();return delete t.sync,t},TextRendererSettings.prototype.getTextureId=function(){var t=[];return 0!==this.w&&t.push("w "+this.w),0!==this.h&&t.push("h "+this.h),"normal"!==this.fontStyle&&t.push("fS"+this.fontStyle),40!==this.fontSize&&t.push("fs"+this.fontSize),null!==this.fontFace&&t.push("ff"+(Utils.isArray(this.fontFace)?this.fontFace.join(","):this.fontFace)),!0!==this.wordWrap&&t.push("wr"+(this.wordWrap?1:0)),0!==this.wordWrapWidth&&t.push("ww"+this.wordWrapWidth),null!==this.lineHeight&&t.push("lh"+this.lineHeight),"alphabetic"!==this.textBaseline&&t.push("tb"+this.textBaseline),"left"!==this.textAlign&&t.push("ta"+this.textAlign),null!==this.offsetY&&t.push("oy"+this.offsetY),0!==this.maxLines&&t.push("ml"+this.maxLines),".."!==this.maxLinesSuffix&&t.push("ms"+this.maxLinesSuffix),null!==this.precision&&t.push("pc"+this.precision),4294967295!==this.textColor&&t.push("co"+this.textColor.toString(16)),0!==this.paddingLeft&&t.push("pl"+this.paddingLeft),0!==this.paddingRight&&t.push("pr"+this.paddingRight),!1!==this.shadow&&t.push("sh"+(this.shadow?1:0)),4278190080!==this.shadowColor&&t.push("sc"+this.shadowColor.toString(16)),0!==this.shadowOffsetX&&t.push("sx"+this.shadowOffsetX),0!==this.shadowOffsetY&&t.push("sy"+this.shadowOffsetY),5!==this.shadowBlur&&t.push("sb"+this.shadowBlur),!1!==this.highlight&&t.push("hL"+(this.highlight?1:0)),0!==this.highlightHeight&&t.push("hh"+this.highlightHeight),4278190080!==this.highlightColor&&t.push("hc"+this.highlightColor.toString(16)),null!==this.highlightOffset&&t.push("ho"+this.highlightOffset),null!==this.highlightPaddingLeft&&t.push("hl"+this.highlightPaddingLeft),null!==this.highlightPaddingRight&&t.push("hr"+this.highlightPaddingRight),this.cutSx&&t.push("csx"+this.cutSx),this.cutEx&&t.push("cex"+this.cutEx),this.cutSy&&t.push("csy"+this.cutSy),this.cutEy&&t.push("cey"+this.cutEy),this.sync&&t.push("sync"),"TX$"+t.join("|")+":"+this.text},TextRendererSettings.prototype.clone=function(){var t=new TextRendererSettings;return t.set(this.getNonDefaults()),t},TextRendererSettings.prototype.notifyUpdate=function(){this.hasUpdates=!0},Object.defineProperty(TextRendererSettings.prototype,"text",{get:function(){return this._text},set:function(t){this._text!==t&&(this._text=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"w",{get:function(){return this._w},set:function(t){this._w!==t&&(this._w=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"h",{get:function(){return this._h},set:function(t){this._h!==t&&(this._h=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"fontStyle",{get:function(){return this._fontStyle},set:function(t){this._fontStyle!==t&&(this._fontStyle=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"fontFace",{get:function(){return this._fontFace},set:function(t){this._fontFace!==t&&(this._fontFace=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"wordWrap",{get:function(){return this._wordWrap},set:function(t){this._wordWrap!==t&&(this._wordWrap=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"wordWrapWidth",{get:function(){return this._wordWrapWidth},set:function(t){this._wordWrapWidth!==t&&(this._wordWrapWidth=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"textBaseline",{get:function(){return this._textBaseline},set:function(t){this._textBaseline!==t&&(this._textBaseline=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"textAlign",{get:function(){return this._textAlign},set:function(t){this._textAlign!==t&&(this._textAlign=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"offsetY",{get:function(){return this._offsetY},set:function(t){this._offsetY!==t&&(this._offsetY=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"maxLines",{get:function(){return this._maxLines},set:function(t){this._maxLines!==t&&(this._maxLines=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"maxLinesSuffix",{get:function(){return this._maxLinesSuffix},set:function(t){this._maxLinesSuffix!==t&&(this._maxLinesSuffix=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"precision",{get:function(){return this._precision},set:function(t){this._precision!==t&&(this._precision=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"textColor",{get:function(){return this._textColor},set:function(t){this._textColor!==t&&(this._textColor=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"paddingLeft",{get:function(){return this._paddingLeft},set:function(t){this._paddingLeft!==t&&(this._paddingLeft=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"paddingRight",{get:function(){return this._paddingRight},set:function(t){this._paddingRight!==t&&(this._paddingRight=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"shadow",{get:function(){return this._shadow},set:function(t){this._shadow!==t&&(this._shadow=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"shadowColor",{get:function(){return this._shadowColor},set:function(t){this._shadowColor!==t&&(this._shadowColor=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"shadowOffsetX",{get:function(){return this._shadowOffsetX},set:function(t){this._shadowOffsetX!==t&&(this._shadowOffsetX=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"shadowOffsetY",{get:function(){return this._shadowOffsetY},set:function(t){this._shadowOffsetY!==t&&(this._shadowOffsetY=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"shadowBlur",{get:function(){return this._shadowBlur},set:function(t){this._shadowBlur!==t&&(this._shadowBlur=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"highlight",{get:function(){return this._highlight},set:function(t){this._highlight!==t&&(this._highlight=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"highlightHeight",{get:function(){return this._highlightHeight},set:function(t){this._highlightHeight!==t&&(this._highlightHeight=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"highlightColor",{get:function(){return this._highlightColor},set:function(t){this._highlightColor!==t&&(this._highlightColor=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"highlightOffset",{get:function(){return this._highlightOffset},set:function(t){this._highlightOffset!==t&&(this._highlightOffset=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"highlightPaddingLeft",{get:function(){return this._highlightPaddingLeft},set:function(t){this._highlightPaddingLeft!==t&&(this._highlightPaddingLeft=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"highlightPaddingRight",{get:function(){return this._highlightPaddingRight},set:function(t){this._highlightPaddingRight!==t&&(this._highlightPaddingRight=t,this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"cutSx",{get:function(){return this._cutSx},set:function(t){this._cutSx!==t&&(this._cutSx=Math.max(0,t),this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"cutEx",{get:function(){return this._cutEx},set:function(t){this._cutEx!==t&&(this._cutEx=Math.max(0,t),this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"cutSy",{get:function(){return this._cutSy},set:function(t){this._cutSy!==t&&(this._cutSy=Math.max(0,t),this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"cutEy",{get:function(){return this._cutEy},set:function(t){this._cutEy!==t&&(this._cutEy=Math.max(0,t),this.notifyUpdate())}}),Object.defineProperty(TextRendererSettings.prototype,"sync",{get:function(){return this._sync},set:function(t){this._sync!==t&&(this._sync=t)}}),TextRendererSettings.SETTINGS={text:{s:function(t,e){t.text=e},m:null},w:{s:function(t,e){t.w=e},m:null},h:{s:function(t,e){t.h=e},m:null},fontStyle:{s:function(t,e){t.fontStyle=e},m:null},fontSize:{s:function(t,e){t.fontSize=e},m:null},fontFace:{s:function(t,e){t.fontFace=e},m:null},wordWrap:{s:function(t,e){t.wordWrap=e},m:null},wordWrapWidth:{s:function(t,e){t.wordWrapWidth=e},m:null},lineHeight:{s:function(t,e){t.lineHeight=e},m:null},textBaseline:{s:function(t,e){t.textBaseline=e},m:null},textAlign:{s:function(t,e){t.textAlign=e},m:null},offsetY:{s:function(t,e){t.offsetY=e},m:null},maxLines:{s:function(t,e){t.maxLines=e},m:null},maxLinesSuffix:{s:function(t,e){t.maxLinesSuffix=e},m:null},precision:{s:function(t,e){t.precision=e},m:null},textColor:{s:function(t,e){t.textColor=e},m:null},paddingLeft:{s:function(t,e){t.paddingLeft=e},m:null},paddingRight:{s:function(t,e){t.paddingRight=e},m:null},shadow:{s:function(t,e){t.shadow=e},m:null},shadowColor:{s:function(t,e){t.shadowColor=e},m:null},shadowOffsetX:{s:function(t,e){t.shadowOffsetX=e},m:null},shadowOffsetY:{s:function(t,e){t.shadowOffsetY=e},m:null},shadowBlur:{s:function(t,e){t.shadowBlur=e},m:null},highlight:{s:function(t,e){t.highlight=e},m:null},highlightHeight:{s:function(t,e){t.highlightHeight=e},m:null},highlightColor:{s:function(t,e){t.highlightColor=e},m:null},highlightOffset:{s:function(t,e){t.highlightOffset=e},m:null},highlightPaddingLeft:{s:function(t,e){t.highlightPaddingLeft=e},m:null},highlightPaddingRight:{s:function(t,e){t.highlightPaddingRight=e},m:null},cutSx:{s:function(t,e){t.cutSx=e},m:null},cutEx:{s:function(t,e){t.cutEx=e},m:null},cutSy:{s:function(t,e){t.cutSy=e},m:null},cutEy:{s:function(t,e){t.cutEy=e},m:null},sync:{s:function(t,e){t.sync=e},m:null}},Utils.extendClass(GenericTransition,EventEmitter),GenericTransition.prototype._delay=0,GenericTransition.prototype._duration=1,GenericTransition.prototype.delayLeft=0,GenericTransition.prototype.p=1,GenericTransition.prototype.reset=function(t,e,i){this.startValue=t,this.targetValue=e,this.p=i,this.isActive()?this.activate():1===i&&(this.setValue(this.getDrawValue()),this.invokeListeners())},GenericTransition.prototype.isActive=function(){return this.p<1},GenericTransition.prototype.updateTargetValue=function(t,e){t===e?this.reset(e,t,1):(this.targetValue=t,this.startValue=e,this.p=0,this.delayLeft=this.delay,this._eventsCount&&this.emit("start"),this.isActive()&&this.activate())},GenericTransition.prototype.activate=function(){},GenericTransition.prototype.progress=function(t){if(this.p<1){if(this.delayLeft>0){if(this.delayLeft-=t,!(this.delayLeft<0))return;t=-this.delayLeft,this.delayLeft=0,this._eventsCount&&this.emit("delayEnd")}0==this.duration?this.p=1:this.p+=t/this.duration,this.p>=1&&(this.p=1)}this.setValue(this.getDrawValue()),this.invokeListeners()},GenericTransition.prototype.invokeListeners=function(){this._eventsCount&&this.emit("progress",this.p),1===this.p&&this._eventsCount&&this.emit("finish")},GenericTransition.prototype.setValuesDynamic=function(t,e){var i=this._timingFunctionImpl(this.p);1==i?this.targetValue=t:0==i?(this.targetValue=t,this.startValue=e,this.targetValue=t):(this.targetValue=t,this.targetValue=t,this.startValue=t-(t-e)/(1-i))},GenericTransition.prototype.set=function(t){for(var e=Object.keys(t),i=0;i<e.length;i++){var o=e[i],r=t[o];this.setSetting(o,r)}},GenericTransition.prototype.setSetting=function(t,e){if(void 0===this[t])throw new TypeError("Unknown property:"+t);this[t]=e},GenericTransition.prototype.getProgress=function(){return this.p},GenericTransition.prototype.getDrawValue=function(){if(this.p>=1)return this.targetValue;var t=this._timingFunctionImpl(this.p);return this.getMergedValue(t)},GenericTransition.prototype.setValue=function(t){},GenericTransition.prototype.getMergedValue=function(t){return this.targetValue*t+this.startValue*(1-t)},Object.defineProperty(GenericTransition.prototype,"delay",{get:function(){return this._delay},set:function(t){if(!Utils.isNumber(t))throw new TypeError("delay must be a number");this._delay=t}}),Object.defineProperty(GenericTransition.prototype,"duration",{get:function(){return this._duration},set:function(t){if(!Utils.isNumber(t))throw new TypeError("duration must be a number");this._duration=t}}),Object.defineProperty(GenericTransition.prototype,"timingFunction",{get:function(){return this._timingFunction},set:function(t){t!==this._timingFunction&&(this._timingFunction=t,this._timingFunctionImpl=StageUtils.getTimingFunction(t))}}),Utils.extendClass(Transition,GenericTransition),Transition.prototype.setValue=function(t){this.valueSetterFunction(this.component,t)},Transition.prototype.getMergedValue=function(t){return this.mergeFunction(this.targetValue,this.startValue,t)},Transition.prototype.activate=function(){this.component.stage.addActiveTransition(this)},GenericAnimation.prototype._subject=null,GenericAnimation.prototype.p=0,GenericAnimation.prototype.duration=0,GenericAnimation.prototype.set=function(t){for(var e=Object.keys(t),i=0;i<e.length;i++){var o=e[i],r=t[o];this.setSetting(o,r)}},GenericAnimation.prototype.setSetting=function(t,e){switch(t){case"actions":this.actions=[];for(var i=0,o=e.length;i<o;i++)this.add(e[i]);break;default:if(void 0===this[t])throw new TypeError("Unknown property:"+t);this[t]=e}},GenericAnimation.prototype.add=function(t){var e=new AnimationAction(this);return e.set(t),this.actions.push(e),e},GenericAnimation.prototype.remove=function(t){var e=this.actions.indexOf(t);e>=0&&this.actions.splice(e,1)},GenericAnimation.prototype.get=function(t){return this.actions[t]},GenericAnimation.prototype.getProgress=function(){return this.p},GenericAnimation.prototype.getFrameForProgress=function(t){return Math.round(t*this.duration*60)},GenericAnimation.prototype.applyTransforms=function(){for(var t=this.actions.length,e=0;e<t;e++)this.actions[e].applyTransforms(this.p,1)},GenericAnimation.prototype.resetTransforms=function(){for(var t=this.actions.length,e=0;e<t;e++)this.actions[e].resetTransforms()},Object.defineProperty(GenericAnimation.prototype,"subject",{get:function(){return this._subject},set:function(t){this._subject=t}}),AnimationAction.prototype._resetValue=null,AnimationAction.prototype.hasResetValue=!1,AnimationAction.prototype.mergeFunction=null,AnimationAction.prototype.tags="",AnimationAction.prototype.getAnimatedComponents=function(){var t=this.tags.length;return this.animation.subject&&t?1===t?""==this.tags[0]?[this.animation.subject]:this.animation.subject.mtag(this.tags[0]):this.getAnimatedMultiComponents():[]},AnimationAction.prototype.getAnimatedMultiComponents=function(){var t,e,i,o=this.tags.length,r=[];for(t=0;t<o;t++)if(""===this.tags[t])r.push(this.animation.subject);else{var s=this.animation.subject.mtag(this.tags[t]);for(i=s.length,e=0;e<i;e++)r.push(s[e])}return r},AnimationAction.prototype.setValue=function(t){this._items.parseDefinition(t)},AnimationAction.prototype.getItem=function(t){var e=this._items.length;if(!e)return null;if(t<this._items[0].p)return null;for(var i=0;i<e;i++)if(this._items[i].p<=t&&t<this._items[i].pe)return this._items[i];return this._items[e-1]},AnimationAction.prototype.getResetValue=function(){return this.hasResetValue?this.resetValue:this._items.length?this._items.lv[0]:0},AnimationAction.prototype.applyTransforms=function(t){if(this._properties.length){var e=this.getAnimatedComponents();if(e.length){var i=this._items.getCurrentValue();if(void 0!==i){if(1!==t){var o=this.getResetValue();this.mergeFunction&&(i=this.mergeFunction(i,o,t))}for(var r=this._properties.length,s=e.length,n=0;n<r;n++)for(var h=0;h<s;h++)this._properties[n].s&&this._properties[n].s(e[h],i)}}}},AnimationAction.prototype.resetTransforms=function(){if(this._properties.length)for(var t=this.getResetValue(),e=this._properties.length,i=this.getAnimatedComponents(),o=i.length,r=0;r<e;r++)for(var s=0;s<o;s++)this._properties[r].s&&this._properties[r].s(i[s],t)},AnimationAction.prototype.set=function(t){for(var e=Object.keys(t),i=0;i<e.length;i++){var o=e[i],r=t[o];this.setSetting(o,r)}},AnimationAction.prototype.setSetting=function(t,e){switch(t){case"value":case"v":this.value=e;break;default:if(void 0===this[t])throw new TypeError("Unknown property:"+t);this[t]=e}},Object.defineProperty(AnimationAction.prototype,"tags",{get:function(){return this._tags},set:function(t){Utils.isArray(t)||(t=[t]),this._tags=t}}),Object.defineProperty(AnimationAction.prototype,"tag",{get:function(){return this.tags},set:function(t){this.tags=t}}),Object.defineProperty(AnimationAction.prototype,"t",{get:function(){return this.tags},set:function(t){this.tags=t}}),Object.defineProperty(AnimationAction.prototype,"properties",{get:function(){return this._properties.map(function(t){return t.name})},set:function(t){var e=t;Utils.isArray(t)||(e=[e]);for(var i=[],o=e.length,r=0;r<o;r++){if(t=e[r],!Utils.isString(t))throw new TypeError("property must be a string");if(Component.propAliases.has(t))for(var s=Component.propAliases.get(t),n=0,h=s.length;n<h;n++)i.push({n:s[n]});else i.push({n:t})}this.mergeFunction=null;var a=!1;for(r=0,o=i.length;r<o;r++){var p=i[r],l=p.n,u=l.indexOf(".");u>=0?(p.o=l.substr(0,u),p.n=l.substr(u+1)):p.o="component";var c=null;switch(p.o){case"text":(c=TextRendererSettings.SETTINGS[p.n])&&(p.s=function(t,e){c.s(t.text,e)});break;case"displayedTexture":(c=Texture.SETTINGS[p.n])&&(p.s=function(t,e){t.displayedTexture&&c.s(t.displayedTexture,e)});break;case"texture":(c=Texture.SETTINGS[p.n])&&(p.s=function(t,e){t.texture&&c.s(t.texture,e)});break;case"component":(c=Component.SETTINGS[p.n])&&(p.s=c.s)}c?0==r?this.mergeFunction=c.m:c.m!==this.mergeFunction&&(a=!0):(console.error("Unknown animation property:"+(p.o?p.o+".":"")+p.n),i.splice(r,1),r--,o--)}a&&(console.error("You can't mix mergable and non-mergable properties in an animation action ("+i.map(function(t){return(t.o?t.o+".":"")+t.n}).join(",")+")"),this.mergeFunction=null),this._properties=i}}),Object.defineProperty(AnimationAction.prototype,"property",{get:function(){return this.properties},set:function(t){this.properties=t}}),Object.defineProperty(AnimationAction.prototype,"p",{get:function(){return this.properties},set:function(t){this.properties=t}}),Object.defineProperty(AnimationAction.prototype,"value",{set:function(t){this.setValue(t)}}),Object.defineProperty(AnimationAction.prototype,"v",{set:function(t){this.value=t}}),Object.defineProperty(AnimationAction.prototype,"resetValue",{get:function(){return this._resetValue},set:function(t){this._resetValue=t,this.hasResetValue=!0}}),Object.defineProperty(AnimationAction.prototype,"rv",{get:function(){return this.resetValue},set:function(t){this.resetValue=t}});var AnimationActionItems=function(t){this.animationAction=t,this.clear()};AnimationActionItems.prototype.clear=function(){this.p=[],this.pe=[],this.idp=[],this.f=[],this.v=[],this.lv=[],this.sm=[],this.s=[],this.ve=[],this.sme=[],this.se=[],this.length=0},AnimationActionItems.prototype.push=function(t){this.p.push(t.p||0),this.pe.push(t.pe||0),this.idp.push(t.idp||0),this.f.push(t.f||!1),this.v.push(t.hasOwnProperty("v")?t.v:0),this.lv.push(t.lv||0),this.sm.push(t.sm||0),this.s.push(t.s||0),this.ve.push(t.ve||0),this.sme.push(t.sme||0),this.se.push(t.se||0),this.length++},AnimationActionItems.prototype.parseDefinition=function(t){var e,i;Utils.isPlainObject(t)||(t={0:t});var o=[];for(var r in t)if(t.hasOwnProperty(r)){var s=t[r];Utils.isPlainObject(s)||(s={v:s});var n=parseFloat(r);!isNaN(n)&&n>=0&&n<=2&&(s.p=n,s.f=Utils.isFunction(s.v),s.lv=s.f?s.v(0,0):s.v,o.push(s))}for(i=(o=o.sort(function(t,e){return t.p-e.p})).length,e=0;e<i;e++){g=e==i-1;if(o[e].hasOwnProperty("pe")){var h=e<i-1?o[e+1].p:1;o[e].pe>h&&(o[e].pe=h)}else o[e].pe=g?o[e].p<=1?1:2:o[e+1].p;o[e].pe===o[e].p?o[e].idp=0:o[e].idp=1/(o[e].pe-o[e].p)}if(this.animationAction.mergeFunction){var a=this.animationAction.mergeFunction===StageUtils.mergeColors;for(e=0;e<i;e++)if(o[e].hasOwnProperty("sm")||(o[e].sm=.5),!o[e].hasOwnProperty("s"))if(0===e||e===i-1||1===o[e].p)o[e].s=a?[0,0,0,0]:0;else{var p=o[e-1],l=o[e+1];if(p.p===l.p)o[e].s=a?[0,0,0,0]:0;else if(a){var u=StageUtils.getRgbaComponents(l.lv),c=StageUtils.getRgbaComponents(p.lv),d=1/(l.p-p.p);o[e].s=[d*(u[0]-c[0]),d*(u[1]-c[1]),d*(u[2]-c[2]),d*(u[3]-c[3])]}else o[e].s=(l.lv-p.lv)/(l.p-p.p)}for(e=0;e<i-1;e++)if(!o[e].f){var g=e===i-1;o[e].hasOwnProperty("sme")||(o[e].sme=g?.5:o[e+1].sm),o[e].hasOwnProperty("se")||(o[e].se=g?a?[0,0,0,0]:0:o[e+1].s),o[e].hasOwnProperty("ve")||(o[e].ve=g?o[e].lv:o[e+1].lv),o[e].v=a?StageUtils.getSplineRgbaValueFunction(o[e].v,o[e].ve,o[e].p,o[e].pe,o[e].sm,o[e].sme,o[e].s,o[e].se):StageUtils.getSplineValueFunction(o[e].v,o[e].ve,o[e].p,o[e].pe,o[e].sm,o[e].sme,o[e].s,o[e].se),o[e].f=!0}}for(this.length&&this.clear(),e=0,i=o.length;e<i;e++)this.push(o[e])},AnimationActionItems.prototype.getCurrentItem=function(){var t=this.animationAction.animation.p,e=this.length;if(!e)return-1;if(t<this.p[0])return-1;for(var i=0;i<e;i++)if(this.p[i]<=t&&t<this.pe[i])return i;return e-1},AnimationActionItems.prototype.getCurrentValue=function(){var t=this.animationAction.animation.p,e=this.getCurrentItem();if(-1!=e){if(this.f[e]){var i=(t-this.p[e])*this.idp[e];return this.v[e](i)}return this.v[e]}};var Animation=function(t){GenericAnimation.call(this,t),EventEmitter.call(this),this._stopMethodOptions={},this.stoppingProgressTransition=new GenericTransition(0)};Utils.extendClass(Animation,GenericAnimation),Animation.prototype=Object.assign(Animation.prototype,EventEmitter.prototype),Animation.STATES={IDLE:0,PLAYING:1,STOPPING:2,STOPPED:3,FINISHED:4},Animation.STOP_METHODS={FADE:"fade",REVERSE:"reverse",FORWARD:"forward",IMMEDIATE:"immediate",ONETOTWO:"onetotwo"},Animation.prototype._delay=0,Animation.prototype._duration=1,Animation.prototype._repeat=0,Animation.prototype._repeatOffset=0,Animation.prototype._repeatDelay=0,Animation.prototype.delayLeft=0,Animation.prototype.repeatsLeft=0,Animation.prototype._autostop=!1,Animation.prototype._stopMethod=Animation.STOP_METHODS.FADE,Animation.prototype.stopDelayLeft=0,Animation.prototype.state=Animation.STATES.IDLE,Animation.prototype.isActive=function(){return this.subject&&(this.state==Animation.STATES.PLAYING||this.state==Animation.STATES.STOPPING)},Animation.prototype.activate=function(){this.component.stage.addActiveAnimation(this)},Animation.prototype.progress=function(t){if(this.subject)if(this.state!=Animation.STATES.STOPPING){if(this.state==Animation.STATES.PLAYING){if(this.delayLeft>0){if(this.delayLeft-=t,!(this.delayLeft<0))return;t=-this.delayLeft,this.delayLeft=0,this._eventsCount&&this.emit("delayEnd")}0===this.duration?this.p=1:this.duration>0&&(this.p+=t/this.duration),this.p>=1?-1==this.repeat||this.repeatsLeft>0?(this.repeatsLeft>0&&this.repeatsLeft--,this.p=this.repeatOffset,this.repeatDelay&&(this.delayLeft=this.repeatDelay),this._eventsCount&&this.emit("repeat",this.repeatsLeft)):(this.p=1,this.state=Animation.STATES.FINISHED,this._eventsCount&&this.emit("finish"),this.autostop&&this.stop()):this._eventsCount&&this.emit("progress",this.p)}}else this.stopProgress(t)},Animation.prototype.stopProgress=function(t){var e=void 0===this.stopMethodOptions.duration?this.duration:this.stopMethodOptions.duration;if(this.delayLeft>0&&(this.state=Animation.STATES.STOPPED,this._eventsCount&&this.emit("stopFinish")),this.stopDelayLeft>0){if(this.stopDelayLeft-=t,!(this.stopDelayLeft<0))return;t=-this.stopDelayLeft,this.stopDelayLeft=0,this._eventsCount&&this.emit("stopDelayEnd")}this.stopMethod==Animation.STOP_METHODS.IMMEDIATE?(this.state=Animation.STATES.STOPPED,this._eventsCount&&this.emit("stop"),this._eventsCount&&this.emit("stopFinish")):this.stopMethod==Animation.STOP_METHODS.REVERSE?(0===e?this.p=0:e>0&&(this.p-=t/e),this.p<=0&&(this.p=0,this.state=Animation.STATES.STOPPED,this._eventsCount&&this.emit("stopFinish"))):this.stopMethod==Animation.STOP_METHODS.FADE?(this.stoppingProgressTransition.progress(t),this.stoppingProgressTransition.p>=1&&(this.state=Animation.STATES.STOPPED,this._eventsCount&&this.emit("stopFinish"))):this.stopMethod==Animation.STOP_METHODS.ONETOTWO?this.p<2&&(0===e?this.p=2:e>0&&(this.p<1?this.p+=t/this.duration:this.p+=t/e),this.p>=2?(this.p=2,this.state=Animation.STATES.STOPPED,this._eventsCount&&this.emit("stopFinish")):this._eventsCount&&this.emit("progress",this.p)):this.p<1&&(0==e?this.p=1:this.p+=t/e,this.p>=1?this.stopMethod==Animation.STOP_METHODS.FORWARD?(this.p=1,this.state=Animation.STATES.STOPPED,this._eventsCount&&this.emit("stopFinish")):this.repeatsLeft>0?(this.repeatsLeft--,this.p=0,this._eventsCount&&this.emit("repeat",this.repeatsLeft)):(this.p=1,this.state=Animation.STATES.STOPPED,this._eventsCount&&this.emit("stopFinish")):this._eventsCount&&this.emit("progress",this.p))},Animation.prototype.start=function(){this.p=0,this.delayLeft=this.delay,this.repeatsLeft=this.repeat,this.state=Animation.STATES.PLAYING,this._eventsCount&&this.emit("start"),this.subject&&this.stage.addActiveAnimation(this)},Animation.prototype.fastForward=function(){this.state===Animation.STATES.PLAYING?(this.delayLeft=0,this.p=1):this.state===Animation.STATES.STOPPING&&(this.stopDelayLeft=0,this.p=0)},Animation.prototype.play=function(){this.state==Animation.STATES.STOPPING&&this.stopMethod==Animation.STOP_METHODS.REVERSE?(this.state=Animation.STATES.PLAYING,this._eventsCount&&this.emit("stopContinue")):this.state!=Animation.STATES.PLAYING&&this.state!=Animation.STATES.FINISHED&&this.start()},Animation.prototype.replay=function(){this.state==Animation.STATES.FINISHED?this.start():this.play()},Animation.prototype.isPlaying=function(){return this.state===Animation.STATES.PLAYING},Animation.prototype.isStopping=function(){return this.state===Animation.STATES.STOPPING},Animation.prototype.skipDelay=function(){this.delayLeft=0,this.stopDelayLeft=0},Animation.prototype.stop=function(){this.state!==Animation.STATES.STOPPED&&this.state!==Animation.STATES.IDLE&&(this.subject&&this.stage.addActiveAnimation(this),this.stopDelayLeft=this.stopMethodOptions.delay||0,this.stopMethod==Animation.STOP_METHODS.IMMEDIATE&&!this.stopDelayLeft||this.delayLeft>0?(this.state=Animation.STATES.STOPPING,this._eventsCount&&this.emit("stop")):(this.stopMethod==Animation.STOP_METHODS.FADE&&(this.stopMethodOptions.duration&&(this.stoppingProgressTransition.duration=this.stopMethodOptions.duration),this.stopMethodOptions.timingFunction&&(this.stoppingProgressTransition.timingFunction=this.stopMethodOptions.timingFunction),this.stoppingProgressTransition.reset(0,1,0)),this.state=Animation.STATES.STOPPING,this._eventsCount&&this.emit("stop")))},Animation.prototype.stopNow=function(){this.state===Animation.STATES.STOPPED&&this.state===Animation.STATES.IDLE||(this.state=Animation.STATES.STOPPING,this.p=0,this._eventsCount&&this.emit("stop"),this.resetTransforms(),this.state=Animation.STATES.STOPPED,this._eventsCount&&this.emit("stopFinish"))},Animation.prototype.applyTransforms=function(){if(this.state==Animation.STATES.STOPPED)for(var t=this.actions.length,e=0;e<t;e++)this.actions[e].resetTransforms();else{var i=1;this.state==Animation.STATES.STOPPING&&this.stopMethod==Animation.STOP_METHODS.FADE&&(i=1-this.stoppingProgressTransition.getDrawValue());for(var t=this.actions.length,e=0;e<t;e++)this.actions[e].applyTransforms(i)}},Object.defineProperty(Animation.prototype,"delay",{get:function(){return this._delay},set:function(t){if(!Utils.isNumber(t))throw new TypeError("delay must be a number");this._delay=t}}),Object.defineProperty(Animation.prototype,"repeatDelay",{get:function(){return this._repeatDelay},set:function(t){if(!Utils.isNumber(t))throw new TypeError("repeatDelay must be a number");this._repeatDelay=t}}),Object.defineProperty(Animation.prototype,"duration",{get:function(){return this._duration},set:function(t){if(!Utils.isNumber(t))throw new TypeError("duration must be a number");this._duration=t}}),Object.defineProperty(Animation.prototype,"repeat",{get:function(){return this._repeat},set:function(t){if(!Utils.isInteger(t)||t<-1)throw new TypeError("repeat must be a positive integer, 0 or -1");this._repeat=t}}),Object.defineProperty(Animation.prototype,"repeatOffset",{get:function(){return this._repeatOffset},set:function(t){if(!Utils.isNumber(t)||t<0)throw new TypeError("repeatOffset must be a positive number");this._repeatOffset=t}}),Object.defineProperty(Animation.prototype,"stopMethod",{get:function(){return this._stopMethod},set:function(t){this._stopMethod=t}}),Object.defineProperty(Animation.prototype,"autostop",{get:function(){return this._autostop},set:function(t){if(!Utils.isBoolean(t))throw new TypeError("autostop must be a boolean");this._autostop=t}}),Object.defineProperty(Animation.prototype,"stopMethodOptions",{get:function(){return this._stopMethodOptions},set:function(t){if(!Utils.isObject(t))throw new TypeError("stopMethodOptions must be an object");this._stopMethodOptions=t}}),Object.defineProperty(Animation.prototype,"subject",{get:function(){return this._subject},set:function(t){t!==this._subject&&(this._subject&&this._subject.removeAnimation(this),t&&t.addAnimation(this),this._subject=t,this.isActive()&&this.activate())}}),Renderer.prototype.destroy=function(){this.gl.deleteBuffer(this.paramsGlBuffer),this.gl.deleteBuffer(this.indicesGlBuffer),this.gl.deleteProgram(this.program)},Renderer.prototype.initShaderProgram=function(){var t=this.gl,e=this.glCompile(t.VERTEX_SHADER,this.vertexShaderSrc),i=this.glCompile(t.FRAGMENT_SHADER,this.fragmentShaderSrc);this.program=t.createProgram(),t.attachShader(this.program,e),t.attachShader(this.program,i),t.linkProgram(this.program),t.getProgramParameter(this.program,t.LINK_STATUS)||(console.error("Error: Could not initialize shader."),console.error("gl.VALIDATE_STATUS",t.getProgramParameter(this.program,t.VALIDATE_STATUS)),console.error("gl.getError()",t.getError()),""!==t.getProgramInfoLog(this.program)&&console.warn("Warning: gl.getProgramInfoLog()",t.getProgramInfoLog(this.program)),t.deleteProgram(this.program),this.program=null),t.useProgram(this.program),t.deleteShader(e),t.deleteShader(i),this.vertexPositionAttribute=t.getAttribLocation(this.program,"aVertexPosition"),this.textureCoordAttribute=t.getAttribLocation(this.program,"aTextureCoord"),this.colorAttribute=t.getAttribLocation(this.program,"aColor"),this.allIndices=new Uint16Array(1e5);for(var o=0,r=0;o<6*Renderer.MAX_QUADS;o+=6,r+=4)this.allIndices[o]=r,this.allIndices[o+1]=r+1,this.allIndices[o+2]=r+2,this.allIndices[o+3]=r,this.allIndices[o+4]=r+2,this.allIndices[o+5]=r+3;this.paramsGlBuffer=t.createBuffer(),this.indicesGlBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indicesGlBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.allIndices,t.STATIC_DRAW);var s=t.getUniformLocation(this.program,"projectionMatrix");t.uniformMatrix4fv(s,!1,this.projectionMatrix)},Renderer.prototype.render=function(){var t=this.gl;t.isContextLost&&t.isContextLost()?console.error("WebGL context lost"):this.renderItems()},Renderer.prototype.renderItems=function(){var t,e=this.gl,i=this.stage.adapter.getUComponentContext();this.stage.measureDetails&&this.stage.timeStart("setup"),e.useProgram(this.program),e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,this.w,this.h),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND),e.disable(e.DEPTH_TEST),e.clearColor(this.stage.glClearColor[0],this.stage.glClearColor[1],this.stage.glClearColor[2],this.stage.glClearColor[3]),e.clear(e.COLOR_BUFFER_BIT),this.stage.measureDetails&&this.stage.timeEnd("setup"),this.stage.measureDetails&&this.stage.timeStart("buffer");var o=new DataView(i.getVboParamsBuffer(),0,4*i.getVboIndex());e.bindBuffer(e.ARRAY_BUFFER,this.paramsGlBuffer),e.bufferData(e.ARRAY_BUFFER,o,e.DYNAMIC_DRAW),this.stage.measureDetails&&this.stage.timeEnd("buffer");var r=i.getVboGlTextures(),s=i.getVboGlTextureRepeats(),n=i.getVboGlTexturesCount();if(this.stage.measureDetails&&this.stage.timeStart("renderGl"),n){e.bindBuffer(e.ARRAY_BUFFER,this.paramsGlBuffer),e.vertexAttribPointer(this.vertexPositionAttribute,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(this.textureCoordAttribute,2,e.UNSIGNED_SHORT,!0,16,8),e.vertexAttribPointer(this.colorAttribute,4,e.UNSIGNED_BYTE,!0,16,12),e.enableVertexAttribArray(this.vertexPositionAttribute),e.enableVertexAttribArray(this.textureCoordAttribute),e.enableVertexAttribArray(this.colorAttribute),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indicesGlBuffer);var h=0;for(t=0;t<n;t++)e.bindTexture(e.TEXTURE_2D,r[t]),e.drawElements(e.TRIANGLES,6*s[t],e.UNSIGNED_SHORT,6*h*2),h+=s[t];e.disableVertexAttribArray(this.vertexPositionAttribute),e.disableVertexAttribArray(this.textureCoordAttribute),e.disableVertexAttribArray(this.colorAttribute)}this.stage.measureDetails&&this.stage.timeEnd("renderGl")},Renderer.prototype.glCompile=function(t,e){var i=this.gl.createShader(t);return this.gl.shaderSource(i,e),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(console.log(this.gl.getShaderInfoLog(i)),null)},Renderer.MAX_QUADS=16384;var UComponent=function(t){this.ctx=t,this.children=[],this.zIndexedChildren=[]};UComponent.prototype.component=null,UComponent.prototype.hasTurtler=!1,UComponent.prototype.branchHasTurtlers=!1,UComponent.prototype.parent=null,UComponent.prototype.hasUpdates=!1,UComponent.prototype.recalc=0,UComponent.prototype.worldAlpha=1,UComponent.prototype.updateTreeOrder=0,UComponent.prototype.hasBorders=!1,UComponent.prototype.hasChildren=!1,UComponent.prototype.worldPx=UComponent.prototype.localPx=0,UComponent.prototype.worldPy=UComponent.prototype.localPy=0,UComponent.prototype.worldTa=UComponent.prototype.localTa=1,UComponent.prototype.worldTb=UComponent.prototype.localTb=0,UComponent.prototype.worldTc=UComponent.prototype.localTc=0,UComponent.prototype.worldTd=UComponent.prototype.localTd=1,UComponent.prototype.isComplex=!1,UComponent.prototype.localAlpha=1,UComponent.prototype.w=0,UComponent.prototype.h=0,UComponent.prototype.clipping=!1,UComponent.prototype.clippingParent=null,UComponent.prototype.clippingSquare=!1,UComponent.prototype.clippingSquareMinX=0,UComponent.prototype.clippingSquareMaxX=0,UComponent.prototype.clippingSquareMinY=0,UComponent.prototype.clippingSquareMaxY=0,UComponent.prototype.clippingEmpty=!1,UComponent.prototype.clippingNoEffect=!1,UComponent.prototype.clippingArea=null,UComponent.prototype.displayedTextureSource=null,UComponent.prototype.colorUl=UComponent.prototype.colorUr=UComponent.prototype.colorBl=UComponent.prototype.colorBr=4294967295,UComponent.prototype.txCoordsUl=0,UComponent.prototype.txCoordsUr=65535,UComponent.prototype.txCoordsBr=4294967295,UComponent.prototype.txCoordsBl=4294901760,UComponent.prototype.ulx=0,UComponent.prototype.uly=0,UComponent.prototype.brx=1,UComponent.prototype.bry=1,UComponent.prototype.inTextureAtlas=!1,UComponent.prototype.zIndex=0,UComponent.prototype.forceZIndexContext=!1,UComponent.prototype.zContextUsage=0,UComponent.prototype.zParent=null,UComponent.prototype.zSort=!1,UComponent.prototype.borderTop=null,UComponent.prototype.borderBottom=null,UComponent.prototype.borderLeft=null,UComponent.prototype.borderRight=null,UComponent.prototype.isBorder=!1,UComponent.prototype.isRoot=!1,UComponent.prototype.setRecalc=function(t){if(this.recalc|=t,this.worldAlpha){this.ctx.staticStage=!1;var e=this;do{e.hasUpdates=!0}while((e=e.parent)&&!e.hasUpdates)}else this.hasUpdates=!0},UComponent.prototype.setRecalcForced=function(t,e){if(this.recalc|=t,this.worldAlpha||e){this.ctx.staticStage=!1;var i=this;do{i.hasUpdates=!0}while((i=i.parent)&&!i.hasUpdates)}else this.hasUpdates=!0},UComponent.prototype.setParent=function(t){if(t!==this.parent){var e=this.isZContext(),i=this.parent;this.parent=t,this.setRecalc(7),0===this.zIndex?this.setZParent(t):this.setZParent(t?t.findZContext():null),e!==this.isZContext()&&(this.isZContext()?this.enableZContext(i.findZContext()):this.disableZContext());var o=t?t.clipping?t:t.clippingParent:null;this.isBorder&&o===this.parent&&(o=o.clippingParent),o!==this.clippingParent&&this.setClippingParent(o),this.branchHasTurtlers&&(t&&t.setBranchHasTurtlers(),i&&i.checkBranchHasTurtlers())}},UComponent.prototype.insertChild=function(t,e){this.children.splice(t,0,e),this.hasChildren=!0,e.setParent(this)},UComponent.prototype.removeChild=function(t){var e=this.children[t];this.children.splice(t,1),this.hasChildren=this.children.length>0,e.setParent(null)},UComponent.prototype.clearChildren=function(){for(var t=0,e=this.children.length;t<e;t++)this.children[t].setParent(null);this.children.splice(0),this.zIndexedChildren.splice(0),this.hasChildren=!1},UComponent.prototype.setLocalTransform=function(t,e,i,o){this.setRecalc(4),this.localTa=t,this.localTb=e,this.localTc=i,this.localTd=o,this.isComplex=0!=e||0!=i},UComponent.prototype.setLocalTranslate=function(t,e){this.setRecalc(2),this.turtle&&(this.localPx!==t&&(this.turtle.x=t),this.localPy!==e&&(this.turtle.y=e)),this.localPx=t,this.localPy=e},UComponent.prototype.addLocalTranslate=function(t,e){this.setLocalTranslate(this.localPx+t,this.localPy+e)},UComponent.prototype.setLocalAlpha=function(t){this.setRecalcForced(1,this.parent&&this.parent.worldAlpha&&t),t<1e-14&&(t=0),this.localAlpha=t},UComponent.prototype.setTurtleInvisible=function(t){if(!this.parent||this.parent.shouldRunTurtle()){var e=this.shouldRunTurtle();this.turtleInvisible=t,this.shouldRunTurtle()!==e&&(this.ctx.staticStage=!1)}else this.turtleInvisible=t},UComponent.prototype.setDimensions=function(t,e){this.turtle&&(this.w!==t&&(this.turtle.w=t),this.h!==e&&(this.turtle.h=e)),this.w=t,this.h=e,this.setRecalc(2),this.updateBorderDimensions()},UComponent.prototype.updateBorderDimensions=function(){var t=this.w,e=this.h,i=0,o=0;null!==this.borderLeft&&(this.borderLeft.setDimensions(this.borderLeft.w,e),this.borderLeft.setLocalTranslate(-this.borderLeft.w,0),i=this.borderLeft.w),null!==this.borderRight&&(this.borderRight.setDimensions(this.borderRight.w,e),this.borderRight.setLocalTranslate(t,0),o=this.borderRight.w),null!==this.borderTop&&(this.borderTop.setDimensions(t+i+o,this.borderTop.h),this.borderTop.setLocalTranslate(0-i,-this.borderTop.h)),null!==this.borderBottom&&(this.borderBottom.setDimensions(t+i+o,this.borderBottom.h),this.borderBottom.setLocalTranslate(0-i,e))},UComponent.prototype.setTextureCoords=function(t,e,i,o){this.worldAlpha&&(this.ctx.staticStage=!1),this.ulx=t,this.uly=e,this.brx=i,this.bry=o,this.txCoordsUl=(65535*t+.5|0)+65536*(65535*e+.5|0),this.txCoordsUr=(65535*i+.5|0)+65536*(65535*e+.5|0),this.txCoordsBl=(65535*t+.5|0)+65536*(65535*o+.5|0),this.txCoordsBr=(65535*i+.5|0)+65536*(65535*o+.5|0)},UComponent.prototype.setDisplayedTextureSource=function(t){this.worldAlpha&&(this.ctx.staticStage=!1),this.displayedTextureSource=t},UComponent.prototype.setInTextureAtlas=function(t){this.worldAlpha&&(this.ctx.staticStage=!1),this.inTextureAtlas=t},UComponent.prototype.setAsRoot=function(){this.parent=new UComponent,this.isRoot=!0,this.ctx.root=this},UComponent.prototype.isAncestorOf=function(t){for(var e=t;e=e.parent;)if(this===e)return!0;return!1},UComponent.prototype.isZContext=function(){return this.forceZIndexContext||0!==this.zIndex||this.isRoot||!this.parent},UComponent.prototype.findZContext=function(){return this.isZContext()?this:this.parent.findZContext()},UComponent.prototype.setZParent=function(t){if(this.zParent!==t){if(null!==this.zParent&&(0!==this.zIndex&&this.zParent.decZContextUsage(),this.zParent.zContextUsage>0)){var e=this.zParent.zIndexedChildren.indexOf(this);this.zParent.zIndexedChildren.splice(e,1)}if(null!==t){var i=t.zContextUsage>0;0!==this.zIndex&&t.incZContextUsage(),t.zContextUsage>0&&((i||this.parent!==t)&&t.zIndexedChildren.push(this),t.zSort=!0)}this.zParent=t}},UComponent.prototype.incZContextUsage=function(){if(1==++this.zContextUsage)for(var t=0,e=this.children.length;t<e;t++)this.zIndexedChildren.push(this.children[t])},UComponent.prototype.decZContextUsage=function(){0===--this.zContextUsage&&(this.zSort=!1,this.zIndexedChildren.splice(0))},UComponent.prototype.setZIndex=function(t){this.worldAlpha&&(this.ctx.staticStage=!1);var e=this.zParent,i=this.isZContext();0===t&&0!==this.zIndex?this.parent===this.zParent?this.zParent.decZContextUsage():e=this.parent:0!==t&&0===this.zIndex?(e=this.parent?this.parent.findZContext():null)===this.zParent&&this.zParent&&(this.zParent.incZContextUsage(),this.zParent.zSort=!0):t!==this.zIndex&&(this.zParent.zSort=!0),e!==this.zParent&&this.setZParent(null),this.zIndex=t,e!==this.zParent&&this.setZParent(e),i!==this.isZContext()&&(this.isZContext()?this.enableZContext(this.parent.findZContext()):this.disableZContext())},UComponent.prototype.setForceZIndexContext=function(t){this.worldAlpha&&(this.ctx.staticStage=!1);var e=this.isZContext();this.forceZIndexContext=t,e!==this.isZContext()&&(this.isZContext()?this.enableZContext(this.parent.findZContext()):this.disableZContext())},UComponent.prototype.enableZContext=function(t){if(t.zContextUsage>0){var e=this;t.zIndexedChildren.slice().forEach(function(t){e.isAncestorOf(t)&&0!==t.zIndex&&t.setZParent(e)})}},UComponent.prototype.disableZContext=function(){if(this.zContextUsage>0){var t=this.parent.findZContext();this.zIndexedChildren.slice().forEach(function(e){0!==e.zIndex&&e.setZParent(t)})}},UComponent.prototype.setClipping=function(t){t!==this.clipping&&(this.setRecalc(8),this.clipping=t,this.setChildrenClippingParent(t?this:this.clippingParent))},UComponent.prototype.setChildrenClippingParent=function(t){for(var e=0,i=this.children.length;e<i;e++)this.children[e].setClippingParent(t)},UComponent.prototype.setClippingParent=function(t){if(this.clippingParent!==t){if(this.setRecalc(8),this.clippingParent=t,!this.clipping)for(var e=0,i=this.children.length;e<i;e++)this.children[e].setClippingParent(t);this.hasBorders&&(this.borderTop&&this.borderTop.setClippingParent(t),this.borderBottom&&this.borderBottom.setClippingParent(t),this.borderLeft&&this.borderLeft.setClippingParent(t),this.borderRight&&this.borderRight.setClippingParent(t))}},UComponent.prototype.setColorUl=function(t){this.worldAlpha&&(this.ctx.staticStage=!1),this.colorUl=t},UComponent.prototype.setColorUr=function(t){this.worldAlpha&&(this.ctx.staticStage=!1),this.colorUr=t},UComponent.prototype.setColorBl=function(t){this.worldAlpha&&(this.ctx.staticStage=!1),this.colorBl=t},UComponent.prototype.setColorBr=function(t){this.worldAlpha&&(this.ctx.staticStage=!1),this.colorBr=t},UComponent.prototype.setBorderTop=function(t,e){this.worldAlpha&&(this.ctx.staticStage=!1),null===this.borderTop&&(this.borderTop=this.ctx.createUComponent(),this.borderTop.isBorder=!0,this.borderTop.setParent(this),this.borderTop.displayedTextureSource=this.ctx.rectangleTextureSource,this.borderTop.setTextureCoords(0,0,0,0)),this.borderTop.setDimensions(this.w,t),this.borderTop.setLocalTranslate(0,-t),this.borderTop.colorUl=e,this.borderTop.colorUr=e,this.borderTop.colorBr=e,this.borderTop.colorBl=e,this.updateBorderDimensions(),this.updateHasBorders()},UComponent.prototype.setBorderBottom=function(t,e){this.worldAlpha&&(this.ctx.staticStage=!1),null===this.borderBottom&&(this.borderBottom=this.ctx.createUComponent(),this.borderBottom.isBorder=!0,this.borderBottom.setParent(this),this.borderBottom.displayedTextureSource=this.ctx.rectangleTextureSource,this.borderBottom.setTextureCoords(0,0,0,0)),this.borderBottom.setDimensions(this.w,t),this.borderBottom.setLocalTranslate(0,this.h),this.borderBottom.colorUl=e,this.borderBottom.colorUr=e,this.borderBottom.colorBr=e,this.borderBottom.colorBl=e,this.updateBorderDimensions(),this.updateHasBorders()},UComponent.prototype.setBorderLeft=function(t,e){this.worldAlpha&&(this.ctx.staticStage=!1),null===this.borderLeft&&(this.borderLeft=this.ctx.createUComponent(),this.borderLeft.isBorder=!0,this.borderLeft.setParent(this),this.borderLeft.displayedTextureSource=this.ctx.rectangleTextureSource,this.borderLeft.setTextureCoords(0,0,0,0)),this.borderLeft.setDimensions(t,this.h),this.borderLeft.setLocalTranslate(-t,0),this.borderLeft.colorUl=e,this.borderLeft.colorUr=e,this.borderLeft.colorBr=e,this.borderLeft.colorBl=e,this.updateBorderDimensions(),this.updateHasBorders()},UComponent.prototype.setBorderRight=function(t,e){this.worldAlpha&&(this.ctx.staticStage=!1),null===this.borderRight&&(this.borderRight=this.ctx.createUComponent(),this.borderRight.isBorder=!0,this.borderRight.setParent(this),this.borderRight.displayedTextureSource=this.ctx.rectangleTextureSource,this.borderRight.setTextureCoords(0,0,0,0)),this.borderRight.setDimensions(t,this.h),this.borderRight.setLocalTranslate(this.w,0),this.borderRight.colorUl=e,this.borderRight.colorUr=e,this.borderRight.colorBr=e,this.borderRight.colorBl=e,this.updateBorderDimensions(),this.updateHasBorders()},UComponent.prototype.updateHasBorders=function(){this.hasBorders=null!==this.borderTop&&this.borderTop.h||null!==this.borderBottom&&this.borderBottom.h||null!==this.borderLeft&&this.borderLeft.w||null!==this.borderRight&&this.borderRight.w},UComponent.prototype.getTurtle=function(){return this.turtle||(this.turtle=new Turtle(this)),this.turtle},UComponent.prototype.isVisible=function(){return this.localAlpha>1e-14},UComponent.prototype.shouldRunTurtle=function(){return this.isVisible()||this.turtleInvisible},UComponent.prototype.runTurtles=function(){if(this.shouldRunTurtle()){if(this.turtle&&(this.turtle.fresh=!1),this.hasTurtler){var t=this.getTurtle();t.altered&&(t.update(),t.altered=!1),this.component.turtler(t),t.altered&&this.setRecalc(2)}if(this.hasChildren)for(var e=0,i=this.children.length;e<i;e++)this.children[e].branchHasTurtlers&&this.children[e].runTurtles()}},UComponent.prototype.update=function(){this.recalc|=this.parent.recalc,this.zSort&&this.ctx.updateTreeOrderForceUpdate++;var t=this.ctx.updateTreeOrderForceUpdate>0;if(1&this.recalc&&(t=this.worldAlpha&&!(this.parent.worldAlpha&&this.localAlpha),this.worldAlpha=this.parent.worldAlpha*this.localAlpha,this.worldAlpha<1e-14&&(this.worldAlpha=0)),this.worldAlpha||t){if(this.turtle&&this.turtle.altered&&this.turtle.swapRealValues(),6&this.recalc&&(this.worldPx=this.parent.worldPx+this.localPx*this.parent.worldTa,this.worldPy=this.parent.worldPy+this.localPy*this.parent.worldTd),4&this.recalc&&(this.worldTa=this.localTa*this.parent.worldTa,this.worldTb=this.localTd*this.parent.worldTb,this.worldTc=this.localTa*this.parent.worldTc,this.worldTd=this.localTd*this.parent.worldTd,this.isComplex&&(this.worldTa+=this.localTc*this.parent.worldTb,this.worldTb+=this.localTb*this.parent.worldTa,this.worldTc+=this.localTc*this.parent.worldTd,this.worldTd+=this.localTb*this.parent.worldTc)),6&this.recalc&&(0!==this.parent.worldTb||0!==this.parent.worldTc)&&(this.worldPx+=this.localPy*this.parent.worldTb,this.worldPy+=this.localPx*this.parent.worldTc),14&this.recalc&&(this.clippingParent||this.clipping)){var e,i,o,r,s,n,h=this.clippingParent;if(h&&h.clippingEmpty)this.clippingEmpty=!0,this.clippingArea=null,this.clippingNoEffect=!1;else if(this.clippingNoEffect=!1,this.clippingEmpty=!1,this.clippingArea=null,h)if(h.clippingSquare&&0===this.worldTb&&0===this.worldTc&&this.worldTa>0&&this.worldTd>0)this.clippingSquare=!0,o=this.worldPx+this.w*this.worldTa,r=this.worldPy+this.h*this.worldTd,this.clippingSquareMinX=this.worldPx,this.clippingSquareMaxX=o,this.clippingSquareMinY=this.worldPy,this.clippingSquareMaxY=r,this.clippingSquareMinX>=h.clippingSquareMinX&&this.clippingSquareMaxX<=h.clippingSquareMaxX&&this.clippingSquareMinY>=h.clippingSquareMinY&&this.clippingSquareMaxY<=h.clippingSquareMaxY?(this.clippingNoEffect=!0,this.clipping&&(this.clippingSquareMinX=this.worldPx,this.clippingSquareMaxX=o,this.clippingSquareMinY=this.worldPy,this.clippingSquareMaxY=r)):(this.clippingSquareMinX=Math.max(this.clippingSquareMinX,h.clippingSquareMinX),this.clippingSquareMaxX=Math.min(this.clippingSquareMaxX,h.clippingSquareMaxX),this.clippingSquareMinY=Math.max(this.clippingSquareMinY,h.clippingSquareMinY),this.clippingSquareMaxY=Math.min(this.clippingSquareMaxY,h.clippingSquareMaxY),(this.clippingSquareMaxX<this.clippingSquareMinX||this.clippingSquareMaxY<this.clippingSquareMinY)&&(this.clippingEmpty=!0));else{e=this.worldPx+this.w*this.worldTa,i=this.worldPy+this.w*this.worldTc,o=this.worldPx+this.w*this.worldTa+this.h*this.worldTb,r=this.worldPy+this.w*this.worldTc+this.h*this.worldTd,s=this.worldPx+this.h*this.worldTb,n=this.worldPy+this.h*this.worldTd,this.clippingSquare=!1;var a=[this.worldPx,this.worldPy,e,i,o,r,s,n];h.clippingSquare&&!h.clippingArea&&(h.clippingArea=[h.clippingSquareMinX,h.clippingSquareMinY,h.clippingSquareMaxX,h.clippingSquareMinY,h.clippingSquareMaxX,h.clippingSquareMaxY,h.clippingSquareMinX,h.clippingSquareMaxY]),this.clippingArea=GeometryUtils.intersectConvex(h.clippingArea,a),this.clippingEmpty=0===this.clippingArea.length,this.clippingNoEffect=a===this.clippingArea}else e=this.worldPx+this.w*this.worldTa,n=this.worldPy+this.h*this.worldTd,0===this.worldTb&&0===this.worldTc&&this.worldTa>0&&this.worldTd>0?(this.clippingSquare=!0,this.clipping&&(this.clippingSquareMinX=this.worldPx,this.clippingSquareMaxX=e,this.clippingSquareMinY=this.worldPy,this.clippingSquareMaxY=n),this.clippingEmpty=!1,this.clippingNoEffect=!0):(i=this.worldPy+this.w*this.worldTc,o=this.worldPx+this.w*this.worldTa+this.h*this.worldTb,r=this.worldPy+this.w*this.worldTc+this.h*this.worldTd,s=this.worldPx+this.h*this.worldTb,this.clippingSquare=!1,this.clipping&&(this.clippingArea=[this.worldPx,this.worldPy,e,i,o,r,s,n]),this.clippingEmpty=!1,this.clippingNoEffect=!0)}if(this.ctx.useZIndexing?this.updateTreeOrder=this.ctx.updateTreeOrder++:this.displayedTextureSource&&this.addToVbo(),this.recalc=7&this.recalc,this.hasBorders&&(this.turtle&&this.turtle.altered&&this.updateBorderDimensions(),null!==this.borderTop&&this.borderTop.h&&this.borderTop.update(),null!==this.borderBottom&&this.borderBottom.h&&this.borderBottom.update(),null!==this.borderLeft&&this.borderLeft.w&&this.borderLeft.update(),null!==this.borderRight&&this.borderRight.w&&this.borderRight.update()),this.ctx.useZIndexing||this.turtle&&this.turtle.altered&&this.turtle.restoreRealValues(),this.hasChildren)for(var p=0,l=this.children.length;p<l;p++)this.ctx.updateTreeOrderForceUpdate>0||this.recalc||this.children[p].hasUpdates?this.children[p].update():this.ctx.useZIndexing||this.children[p].fillVbo();this.recalc=0,this.hasUpdates=!1}this.zSort&&this.ctx.updateTreeOrderForceUpdate--},UComponent.prototype.sortZIndexedChildren=function(){for(var t=1,e=this.zIndexedChildren.length;t<e;t++){for(var i=this.zIndexedChildren[t],o=t-1;o>=0;){var r=this.zIndexedChildren[o];if(!(i.zIndex===r.zIndex?i.updateTreeOrder<r.updateTreeOrder:i.zIndex<r.zIndex))break;this.zIndexedChildren[o+1]=this.zIndexedChildren[o],o--}this.zIndexedChildren[o+1]=i}},UComponent.prototype.addToVbo=function(){var t=this.ctx.vboIndex,e=this.ctx.vboBufferFloat,i=this.ctx.vboBufferUint;if(this.clippingParent&&!this.clippingNoEffect)this.clippingEmpty||this.addToVboClipped();else if(0!==this.worldTb||0!==this.worldTc)t<262144&&(e[t++]=this.worldPx,e[t++]=this.worldPy,i[t++]=this.txCoordsUl,i[t++]=getColorInt(this.colorUl,this.worldAlpha),e[t++]=this.worldPx+this.w*this.worldTa,e[t++]=this.worldPy+this.w*this.worldTc,i[t++]=this.txCoordsUr,i[t++]=getColorInt(this.colorUr,this.worldAlpha),e[t++]=this.worldPx+this.w*this.worldTa+this.h*this.worldTb,e[t++]=this.worldPy+this.w*this.worldTc+this.h*this.worldTd,i[t++]=this.txCoordsBr,i[t++]=getColorInt(this.colorBr,this.worldAlpha),e[t++]=this.worldPx+this.h*this.worldTb,e[t++]=this.worldPy+this.h*this.worldTd,i[t++]=this.txCoordsBl,i[t++]=getColorInt(this.colorBl,this.worldAlpha),this.ctx.addVboTextureSource(this,1));else{var o=this.worldPx+this.w*this.worldTa,r=this.worldPy+this.h*this.worldTd;t<262144&&(e[t++]=this.worldPx,e[t++]=this.worldPy,i[t++]=this.txCoordsUl,i[t++]=getColorInt(this.colorUl,this.worldAlpha),e[t++]=o,e[t++]=this.worldPy,i[t++]=this.txCoordsUr,i[t++]=getColorInt(this.colorUr,this.worldAlpha),e[t++]=o,e[t++]=r,i[t++]=this.txCoordsBr,i[t++]=getColorInt(this.colorBr,this.worldAlpha),e[t++]=this.worldPx,e[t++]=r,i[t++]=this.txCoordsBl,i[t++]=getColorInt(this.colorBl,this.worldAlpha),this.ctx.addVboTextureSource(this,1))}},UComponent.prototype.addToVboClipped=function(){var t=this.ctx.vboIndex,e=this.ctx.vboBufferFloat,i=this.ctx.vboBufferUint,o=getColorInt(this.colorUl,this.worldAlpha);if(this.clippingSquare){var r=this.w*this.worldTa,s=this.h*this.worldTd,n=1/(r*s),h=s*n,a=r*n,p=h*(this.clippingSquareMinX-this.worldPx),l=a*(this.clippingSquareMinY-this.worldPy),u=h*(this.clippingSquareMaxX-this.worldPx),c=a*(this.clippingSquareMaxY-this.worldPy),d=this.ulx*(1-p)+this.brx*p,g=this.uly*(1-l)+this.bry*l,f=this.ulx*(1-u)+this.brx*u,m=this.uly*(1-c)+this.bry*c;t<262144&&(e[t++]=this.clippingSquareMinX,e[t++]=this.clippingSquareMinY,i[t++]=getVboTextureCoords(d,g),i[t++]=o,e[t++]=this.clippingSquareMaxX,e[t++]=this.clippingSquareMinY,i[t++]=getVboTextureCoords(f,g),i[t++]=o,e[t++]=this.clippingSquareMaxX,e[t++]=this.clippingSquareMaxY,i[t++]=getVboTextureCoords(f,m),i[t++]=o,e[t++]=this.clippingSquareMinX,e[t++]=this.clippingSquareMaxY,i[t++]=getVboTextureCoords(d,m),i[t++]=o,this.ctx.addVboTextureSource(this,1))}else{r=this.w*this.worldTa;var T=this.w*this.worldTc,x=this.h*this.worldTb;h=(s=this.h*this.worldTd)*(n=1/(r*s-x*T));var y=-x*n,C=-T*n;a=r*n;var b=Math.ceil((this.clippingArea.length/2-2)/2);if(1===b){p=h*(this.clippingArea[0]-this.worldPx)+y*(this.clippingArea[1]-this.worldPy),l=C*(this.clippingArea[0]-this.worldPx)+a*(this.clippingArea[1]-this.worldPy);var S=h*(this.clippingArea[2]-this.worldPx)+y*(this.clippingArea[3]-this.worldPy),v=C*(this.clippingArea[2]-this.worldPx)+a*(this.clippingArea[3]-this.worldPy);u=h*(this.clippingArea[4]-this.worldPx)+y*(this.clippingArea[5]-this.worldPy),c=C*(this.clippingArea[4]-this.worldPx)+a*(this.clippingArea[5]-this.worldPy),w=this.clippingArea.length<=6?4:6;var A=h*(this.clippingArea[w]-this.worldPx)+y*(this.clippingArea[w+1]-this.worldPy),_=C*(this.clippingArea[w]-this.worldPx)+a*(this.clippingArea[w+1]-this.worldPy);t<262144&&(e[t++]=this.clippingArea[0],e[t++]=this.clippingArea[1],i[t++]=getVboTextureCoords(this.ulx*(1-p)+this.brx*p,this.uly*(1-l)+this.bry*l),i[t++]=o,e[t++]=this.clippingArea[2],e[t++]=this.clippingArea[3],i[t++]=getVboTextureCoords(this.ulx*(1-S)+this.brx*S,this.uly*(1-v)+this.bry*v),i[t++]=o,e[t++]=this.clippingArea[4],e[t++]=this.clippingArea[5],i[t++]=getVboTextureCoords(this.ulx*(1-u)+this.brx*u,this.uly*(1-c)+this.bry*c),i[t++]=o,e[t++]=this.clippingArea[w],e[t++]=this.clippingArea[w+1],i[t++]=getVboTextureCoords(this.ulx*(1-A)+this.brx*A,this.uly*(1-_)+this.bry*_),i[t++]=o,this.ctx.addVboTextureSource(this,1))}else for(var w,P=0;P<b;P++){var O=4*P+2;(w=O+4)>=this.clippingArea.length&&(w-=2),p=h*(this.clippingArea[0]-this.worldPx)+y*(this.clippingArea[1]-this.worldPy),l=C*(this.clippingArea[0]-this.worldPx)+a*(this.clippingArea[1]-this.worldPy),S=h*(this.clippingArea[O]-this.worldPx)+y*(this.clippingArea[O+1]-this.worldPy),v=C*(this.clippingArea[O]-this.worldPx)+a*(this.clippingArea[O+1]-this.worldPy),u=h*(this.clippingArea[O+2]-this.worldPx)+y*(this.clippingArea[O+3]-this.worldPy),c=C*(this.clippingArea[O+2]-this.worldPx)+a*(this.clippingArea[O+3]-this.worldPy),A=h*(this.clippingArea[w]-this.worldPx)+y*(this.clippingArea[w+1]-this.worldPy),_=C*(this.clippingArea[w]-this.worldPx)+a*(this.clippingArea[w+1]-this.worldPy),t<262144&&(e[t++]=this.clippingArea[0],e[t++]=this.clippingArea[1],i[t++]=getVboTextureCoords(this.ulx*(1-p)+this.brx*p,this.uly*(1-l)+this.bry*l),i[t++]=o,e[t++]=this.clippingArea[O],e[t++]=this.clippingArea[O+1],i[t++]=getVboTextureCoords(this.ulx*(1-S)+this.brx*S,this.uly*(1-v)+this.bry*v),i[t++]=o,e[t++]=this.clippingArea[O+2],e[t++]=this.clippingArea[O+3],i[t++]=getVboTextureCoords(this.ulx*(1-u)+this.brx*u,this.uly*(1-c)+this.bry*c),i[t++]=o,e[t++]=this.clippingArea[w],e[t++]=this.clippingArea[w+1],i[t++]=getVboTextureCoords(this.ulx*(1-A)+this.brx*A,this.uly*(1-_)+this.bry*_),i[t++]=o,this.ctx.addVboTextureSource(this,1))}}},UComponent.prototype.fillVbo=function(){if(this.zSort&&(this.sortZIndexedChildren(),this.zSort=!1),this.worldAlpha&&(this.displayedTextureSource&&this.addToVbo(),this.hasBorders&&(null!==this.borderTop&&this.borderTop.h&&this.borderTop.addToVbo(),null!==this.borderBottom&&this.borderBottom.h&&this.borderBottom.addToVbo(),null!==this.borderLeft&&this.borderLeft.w&&this.borderLeft.addToVbo(),null!==this.borderRight&&this.borderRight.w&&this.borderRight.addToVbo()),this.turtle&&this.turtle.altered&&this.turtle.restoreRealValues(),this.hasChildren))if(this.zContextUsage)for(var t=0,e=this.zIndexedChildren.length;t<e;t++)this.zIndexedChildren[t].fillVbo();else for(var t=0,e=this.children.length;t<e;t++)0===this.children[t].zIndex&&this.children[t].fillVbo()},UComponent.prototype.getLocalTa=function(){return this.localTa},UComponent.prototype.getLocalTb=function(){return this.localTb},UComponent.prototype.getLocalTc=function(){return this.localTc},UComponent.prototype.getLocalTd=function(){return this.localTd},UComponent.prototype.getCornerPoints=function(){return[this.worldPx,this.worldPy,this.worldPx+this.w*this.worldTa,this.worldPy+this.w*this.worldTc,this.worldPx+this.w*this.worldTa+this.h*this.worldTb,this.worldPy+this.w*this.worldTc+this.h*this.worldTd,this.worldPx+this.h*this.worldTb,this.worldPy+this.h*this.worldTd]},UComponent.prototype.setHasTurtler=function(t){this.hasTurtler=t,this.setRecalc(2),this.hasTurtler?this.setBranchHasTurtlers():this.checkBranchHasTurtlers()},UComponent.prototype.setBranchHasTurtlers=function(){var t=this;do{t.branchHasTurtlers=!0}while((t=t.parent)&&!t.branchHasTurtlers)},UComponent.prototype.checkBranchHasTurtlers=function(){for(var t=!1,e=0,i=this.children.length;e<i;e++)t=t||this.children[e].branchHasTurtlers;t?this.setBranchHasTurtlers():this.branchHasTurtlers=!1};var getColorInt=function(t,e){var i=(t/16777216|0)*e|0;return((t>>16&255)*i>>8&255)+((65280&t)*i>>8&65280)+(((255&t)<<16)*i>>8&16711680)+(i<<24)},getVboTextureCoords=function(t,e){return(65535*t+.5|0)+65536*(65535*e+.5|0)},UComponentContext=function(){this.vboGlTextures=[],this.vboGlTextureRepeats=[],this.lastVboGlTexture=null,this.textureAtlasGlTexture=null,this.rectangleTextureSource=null,this.rectangleTextureSourceInTextureAtlas=!1,this.vboParamsBuffer=new ArrayBuffer(2097152),this.vboBufferFloat=new Float32Array(this.vboParamsBuffer),this.vboBufferUint=new Uint32Array(this.vboParamsBuffer),this.vboIndex=0,this.n=0,this.useZIndexing=!1,this.root=null,this.updateTreeOrder=0,this.updateTreeOrderForceUpdate=0,this.staticStage=!1,this.debugTextureAtlas=null};UComponentContext.prototype.setStage=function(t){if(this.textureAtlasGlTexture=t.textureAtlas?t.textureAtlas.texture:null,this.rectangleTextureSource=t.getRectangleTexture().source,t.debugTextureAtlas){this.debugTextureAtlas=this.createUComponent(),this.debugTextureAtlas.displayedTextureSource=this.rectangleTextureSource,this.debugTextureAtlas.setInTextureAtlas(!0);var e=Math.min(t.w,t.h);this.debugTextureAtlas.setDimensions(e,e)}},UComponentContext.prototype.createUComponentForComponent=function(t){var e=new UComponent(this);return e.component=t,e},UComponentContext.prototype.createUComponent=function(){return new UComponent(this)},UComponentContext.prototype.setDisplayedTextureSource=function(t,e){t.setDisplayedTextureSource(e)},UComponentContext.prototype.reset=function(){this.vboIndex=0,this.vboGlTextures=[],this.vboGlTextureRepeats=[],this.lastVboGlTexture=null,this.rectangleTextureSourceInTextureAtlas=this.rectangleTextureSource.inTextureAtlas,this.n=0,this.updateTreeOrder=0},UComponentContext.prototype.addVboTextureSource=function(t,e){var i;i=t.isBorder?this.rectangleTextureSourceInTextureAtlas?this.textureAtlasGlTexture:this.rectangleTextureSource.glTexture:t.inTextureAtlas?this.textureAtlasGlTexture:t.displayedTextureSource.glTexture,this.lastVboGlTexture!==i?(this.vboGlTextures.push(i),this.vboGlTextureRepeats.push(e),this.n++,this.lastVboGlTexture=i):this.vboGlTextureRepeats[this.n-1]+=e,this.vboIndex+=16*e},UComponentContext.prototype.getVboIndex=function(){return this.vboIndex},UComponentContext.prototype.getVboParamsBuffer=function(){return this.vboParamsBuffer},UComponentContext.prototype.getVboGlTextures=function(){return this.vboGlTextures},UComponentContext.prototype.getVboGlTextureRepeats=function(){return this.vboGlTextureRepeats},UComponentContext.prototype.getVboGlTexturesCount=function(){return this.vboGlTextures.length},UComponentContext.prototype.updateAndFillVbo=function(t){var e=!this.staticStage;return this.staticStage||(this.useZIndexing=t,this.reset(),this.root.branchHasTurtlers&&this.root.runTurtles(),this.root.update(),this.useZIndexing&&this.root.fillVbo(),this.debugTextureAtlas&&this.debugTextureAtlas.addToVbo(),this.staticStage=!0),e},Object.defineProperty(UComponentContext.prototype,"staticStage",{get:function(){return this._staticStage},set:function(t){this._staticStage=t}});var isNode=!("undefined"==typeof module||!module.exports),Turtle=function(t){this.c=t,this.update()};Turtle.prototype._x=0,Turtle.prototype._y=0,Turtle.prototype._w=0,Turtle.prototype._h=0,Turtle.prototype.altered=!1,Turtle.prototype.swapRealValues=function(){var t;t=this.c.localPx,this.c.localPx=this._x,this._x=t,t=this.c.localPy,this.c.localPy=this._y,this._y=t,t=this.c.w,this.c.w=this._w,this._w=t,t=this.c.h,this.c.h=this._h,this._h=t},Turtle.prototype.restoreRealValues=function(){this.c.localPx=this._x,this.c.localPy=this._y,this.c.w=this._w,this.c.h=this._h},Turtle.prototype.update=function(){this._x=this.c.localPx,this._y=this.c.localPy,this._w=this.c.w,this._h=this.c.h},Object.defineProperty(Turtle.prototype,"x",{get:function(){return this._x},set:function(t){this._x!==t&&(this.altered=!0,this._x=t)}}),Object.defineProperty(Turtle.prototype,"y",{get:function(){return this._y},set:function(t){this._y!==t&&(this.altered=!0,this._y=t)}}),Object.defineProperty(Turtle.prototype,"w",{get:function(){return this._w},set:function(t){this._w!==t&&(this.altered=!0,this._w=t)}}),Object.defineProperty(Turtle.prototype,"h",{get:function(){return this._h},set:function(t){this._h!==t&&(this.altered=!0,this._h=t)}}),Object.defineProperty(Turtle.prototype,"parent",{get:function(){if(this.c.parent)return this.c.parent.getTurtle()}}),Object.defineProperty(Turtle.prototype,"sw",{get:function(){return this.c.component.stage.w}}),Object.defineProperty(Turtle.prototype,"sh",{get:function(){return this.c.component.stage.h}}),Object.defineProperty(Turtle.prototype,"index",{get:function(){return this.c.parent.children.indexOf(this.c)}}),Object.defineProperty(Turtle.prototype,"visible",{get:function(){return this.c.isVisible()}}),Object.defineProperty(Turtle.prototype,"last",{get:function(){if(!this.c.parent)return!0;var t=this.c.parent.children,e=t.length-1;do{if(t[e]===this.c)return!0;if(t[e].shouldRunTurtle())return!1}while(--e>0);return!0}}),Object.defineProperty(Turtle.prototype,"prev",{get:function(){if(this.c.parent){var t=this.index;if(t>0)for(;--t>=0;)if(this.c.parent.children[t].shouldRunTurtle())return this.c.parent.children[t].getTurtle()}return null}}),Object.defineProperty(Turtle.prototype,"prevs",{get:function(){if(this.c.parent){var t=this.c.parent.children.indexOf(this.c);if(t>0){for(var e=[];t-- >=0;){var i=this.c.parent.children[t];i.shouldRunTurtle()&&e.push(i.getTurtle())}return e}return[]}return[]}}),Object.defineProperty(Turtle.prototype,"component",{get:function(){return this.c.component}});var Tools={};Tools.getRoundRect=function(t,e,i,o,r,s,n,h){void 0===n&&(n=!0),void 0===r&&(r=0);var a=t.adapter.getDrawingCanvas(),p=a.getContext("2d");p.imageSmoothingEnabled=!0;var l="rect"+[e,i,o,r,s,n?1:0,h].join(",");return t.texture(function(t){a.width=e+r+2,a.height=i+r+2,p.beginPath();var l=.5*r+1,u=.5*r+1;p.moveTo(l+o,u),p.lineTo(l+e-o,u),p.arcTo(l+e,u,l+e,u+o,o),p.lineTo(l+e,u+i-o),p.arcTo(l+e,u+i,l+e-o,u+i,o),p.lineTo(l+o,u+i),p.arcTo(l,u+i,l,u+i-o,o),p.lineTo(l,u+o),p.arcTo(l,u,l+o,u,o),n&&(Utils.isNumber(h)&&(h="#"+h.toString(16)),p.fillStyle=h||"white",p.fill()),r&&(Utils.isNumber(s)&&(s="#"+s.toString(16)),p.strokeStyle=s||"white",p.lineWidth=r,p.stroke()),t(null,a,{})},{id:l})};var WebAdapter=function(){this.animationFunction=function(){},this.animationLoopStopped=!1,this.canvas=null,this.uComponentContext=new UComponentContext,this.glClearColor=[0,0,0,0]};WebAdapter.prototype.init=function(){this.uComponentContext.setStage(this.stage)},WebAdapter.prototype.startAnimationLoop=function(t){this.animationFunction=t||this.animationFunction,this.animationLoopStopped=!1,this.loop()},WebAdapter.prototype.stopAnimationLoop=function(){this.animationLoopStopped=!0},WebAdapter.prototype.loop=function(){var t=this,e=function(){t.animationLoopStopped||(t.animationFunction(),requestAnimationFrame(e))};e()},WebAdapter.prototype.uploadGlTexture=function(t,e,i){i instanceof ImageData||i instanceof HTMLImageElement||i instanceof HTMLCanvasElement||i instanceof HTMLVideoElement||window.ImageBitmap&&i instanceof ImageBitmap?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e.w,e.h,0,t.RGBA,t.UNSIGNED_BYTE,i)},WebAdapter.prototype.loadTextureSourceString=function(t,e,i){var o=new Image;"data:"!=t.substr(0,5)&&(o.crossOrigin="Anonymous"),o.onerror=function(t){return i("Image load error")},o.onload=function(){i(null,o,{renderInfo:{src:t}})},o.src=t},WebAdapter.prototype.loadText=function(t,e,i){var o=new TextRenderer(this.stage.drawingCanvasFactory,t).draw(),r={renderInfo:o.renderInfo,precision:o.renderInfo.precision};i(null,o.canvas,r)},WebAdapter.prototype.getHrTime=function(){return window.performance?window.performance.now():(new Date).getTime()},WebAdapter.prototype.getWebGLRenderingContext=function(t,e){var i;(i=this.stage.reuseCanvas?this.stage.reuseCanvas:document.createElement("canvas")).width=t,i.height=e;var o={alpha:!0,antialias:!1,premultipliedAlpha:!0,stencil:!0,preserveDrawingBuffer:!1},r=i.getContext("webgl",o)||i.getContext("experimental-webgl",o);if(!r)throw new Error("This browser does not support webGL.");return this.canvas=i,r},WebAdapter.prototype.getDrawingCanvas=function(){return this.textCanvas||(this.textCanvas=document.createElement("canvas")),this.textCanvas},WebAdapter.prototype.getUComponentContext=function(){return this.uComponentContext},WebAdapter.prototype.nextFrame=function(t){},WebAdapter.prototype.getTextureProcess=function(){var t=document.getElementsByTagName("script"),e=this.stage.textureProcessWorkerPath;if(!e)for(var i=0;i<t.length;i++){var o=t.item(i);if(o.src){var r=/^(.+\/)(wpe(\.min)?|WebAdapter)\.js$/.exec(o.src);r&&(e=r[1])}}return new TextureProcess(e)};